---
title: Redisé›†ç¾¤ä¸é«˜å¯ç”¨
---

# 06 - Redisé›†ç¾¤ä¸é«˜å¯ç”¨

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£Redisä¸»ä»å¤åˆ¶åŸç†
- æŒæ¡Rediså“¨å…µæ¨¡å¼
- äº†è§£Redis Clusteré›†ç¾¤
- å­¦ä¼šé«˜å¯ç”¨æ–¹æ¡ˆé€‰æ‹©

## 1ï¸âƒ£ ä¸»ä»å¤åˆ¶

### ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶ï¼Ÿ

ä¸€ä¸ªMasterèŠ‚ç‚¹ï¼Œå¤šä¸ªSlaveèŠ‚ç‚¹ï¼Œæ•°æ®ä»Masterå¤åˆ¶åˆ°Slaveã€‚

```
Master (å†™)
  â†“
  â”œâ”€ Slave1 (è¯»)
  â”œâ”€ Slave2 (è¯»)
  â””â”€ Slave3 (è¯»)
```

### ä½œç”¨

- ğŸ“– **è¯»å†™åˆ†ç¦»** - Masterå†™ï¼ŒSlaveè¯»
- ğŸ’¾ **æ•°æ®å¤‡ä»½** - æ•°æ®å†—ä½™
- ğŸš€ **é«˜å¯ç”¨** - Masteræ•…éšœï¼ŒSlaveå¯å‡çº§

### é…ç½®ä¸»ä»å¤åˆ¶

**Masteré…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š**
```conf
# redis.conf
bind 0.0.0.0
port 6379
```

**Slaveé…ç½®ï¼š**
```conf
# redis.conf
port 6380
replicaof 127.0.0.1 6379
masterauth password  # å¦‚æœMasteræœ‰å¯†ç 
```

**è¿è¡Œæ—¶é…ç½®ï¼š**
```bash
# è¿æ¥åˆ°Slave
redis-cli -p 6380

# è®¾ç½®ä¸ºä»èŠ‚ç‚¹
SLAVEOF 127.0.0.1 6379

# å–æ¶ˆä»èŠ‚ç‚¹
SLAVEOF NO ONE
```

### å¤åˆ¶åŸç†

**å…¨é‡åŒæ­¥ï¼š**
```
1. Slaveå‘é€PSYNCå‘½ä»¤
2. Masteræ‰§è¡ŒBGSAVEç”ŸæˆRDB
3. Masterå‘é€RDBæ–‡ä»¶ç»™Slave
4. SlaveåŠ è½½RDBæ–‡ä»¶
5. Masterå‘é€ç¼“å†²åŒºå‘½ä»¤ç»™Slave
```

**å¢é‡åŒæ­¥ï¼š**
```
Masterå†™å‘½ä»¤ â†’ å¤åˆ¶åˆ°Slave
```

### æŸ¥çœ‹å¤åˆ¶çŠ¶æ€

```bash
# åœ¨Masterä¸ŠæŸ¥çœ‹
INFO replication

# è¾“å‡ºï¼š
# role:master
# connected_slaves:2
# slave0:ip=127.0.0.1,port=6380,state=online
```

## 2ï¸âƒ£ å“¨å…µæ¨¡å¼

### ä»€ä¹ˆæ˜¯å“¨å…µï¼Ÿ

Sentinelï¼ˆå“¨å…µï¼‰æ˜¯Redisçš„é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œç›‘æ§ä¸»ä»èŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚

```
Sentinel1 â”€â”€â”
Sentinel2 â”€â”€â”¼â”€â”€ ç›‘æ§ â†’ Master
Sentinel3 â”€â”€â”˜              â†“
                        Slave1, Slave2
```

### ä½œç”¨

- ğŸ” **ç›‘æ§** - æ£€æŸ¥Masterå’ŒSlaveæ˜¯å¦æ­£å¸¸
- ğŸ“¢ **é€šçŸ¥** - æ•…éšœæ—¶é€šçŸ¥ç®¡ç†å‘˜
- ğŸ”„ **æ•…éšœè½¬ç§»** - Masteræ•…éšœæ—¶ï¼Œè‡ªåŠ¨é€‰ä¸¾æ–°Master
- ğŸ“¡ **é…ç½®ä¸­å¿ƒ** - å®¢æˆ·ç«¯è¿æ¥Sentinelè·å–Masteråœ°å€

### å“¨å…µé…ç½®

**sentinel.confï¼š**
```conf
# å“¨å…µç«¯å£
port 26379

# ç›‘æ§Master
# sentinel monitor <master-name> <ip> <port> <quorum>
sentinel monitor mymaster 127.0.0.1 6379 2

# Masterå¯†ç 
sentinel auth-pass mymaster yourpassword

# ä¸»è§‚ä¸‹çº¿æ—¶é—´ï¼ˆ30ç§’ï¼‰
sentinel down-after-milliseconds mymaster 30000

# æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´
sentinel failover-timeout mymaster 180000

# åŒæ—¶è¿›è¡Œå¤åˆ¶çš„Slaveæ•°é‡
sentinel parallel-syncs mymaster 1
```

**å¯åŠ¨å“¨å…µï¼š**
```bash
redis-sentinel sentinel.conf
```

### æ•…éšœè½¬ç§»æµç¨‹

```
1. ä¸»è§‚ä¸‹çº¿ï¼šå•ä¸ªSentinelè®¤ä¸ºMasterä¸‹çº¿
2. å®¢è§‚ä¸‹çº¿ï¼šå¤šä¸ªSentinelï¼ˆâ‰¥quorumï¼‰ç¡®è®¤ä¸‹çº¿
3. é€‰ä¸¾Leaderï¼šSentinelé€‰ä¸¾å‡ºLeader
4. æ•…éšœè½¬ç§»ï¼šLeaderæ‰§è¡Œè½¬ç§»
   - é€‰æ‹©ä¸€ä¸ªSlaveå‡çº§ä¸ºMaster
   - å…¶ä»–Slaveæ”¹ä¸ºå¤åˆ¶æ–°Master
   - é€šçŸ¥å®¢æˆ·ç«¯æ–°Masteråœ°å€
```

### Spring Bootæ•´åˆ

```yaml
spring:
  redis:
    sentinel:
      master: mymaster
      nodes:
        - 127.0.0.1:26379
        - 127.0.0.1:26380
        - 127.0.0.1:26381
    password: yourpassword
```

## 3ï¸âƒ£ Redis Cluster

### ä»€ä¹ˆæ˜¯Redis Clusterï¼Ÿ

Rediså®˜æ–¹çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆï¼Œæ•°æ®è‡ªåŠ¨åˆ†ç‰‡ï¼Œæ”¯æŒé«˜å¯ç”¨ã€‚

```
Node1 (0-5460)
Node2 (5461-10922)
Node3 (10923-16383)
```

### ç‰¹ç‚¹

- ğŸ”¢ **æ•°æ®åˆ†ç‰‡** - 16384ä¸ªå“ˆå¸Œæ§½
- ğŸŒ **å»ä¸­å¿ƒåŒ–** - æ— éœ€ä»£ç†ï¼ŒèŠ‚ç‚¹é—´é€šä¿¡
- ğŸ”„ **é«˜å¯ç”¨** - ä¸»ä»å¤åˆ¶ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
- ğŸš€ **å¯æ‰©å±•** - åŠ¨æ€æ·»åŠ /åˆ é™¤èŠ‚ç‚¹

### é›†ç¾¤æ­å»º

**èŠ‚ç‚¹é…ç½®ï¼š**
```conf
# redis-6379.conf
port 6379
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-node-timeout 15000
```

**åˆ›å»ºé›†ç¾¤ï¼š**
```bash
# åˆ›å»º6èŠ‚ç‚¹é›†ç¾¤ï¼ˆ3ä¸»3ä»ï¼‰
redis-cli --cluster create \
  127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 \
  127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 \
  --cluster-replicas 1
```

### æ•°æ®åˆ†ç‰‡åŸç†

**æ§½ä½è®¡ç®—ï¼š**
```
HASH_SLOT = CRC16(key) % 16384
```

**ç¤ºä¾‹ï¼š**
```bash
# key "user:1001" è®¡ç®—æ§½ä½
CRC16("user:1001") % 16384 = 5460

# å­˜å‚¨åˆ°è´Ÿè´£5460æ§½ä½çš„èŠ‚ç‚¹
```

### é›†ç¾¤æ“ä½œ

```bash
# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
redis-cli --cluster check 127.0.0.1:6379

# æ·»åŠ èŠ‚ç‚¹
redis-cli --cluster add-node 127.0.0.1:6385 127.0.0.1:6379

# é‡æ–°åˆ†ç‰‡
redis-cli --cluster reshard 127.0.0.1:6379

# åˆ é™¤èŠ‚ç‚¹
redis-cli --cluster del-node 127.0.0.1:6379 <node-id>
```

### Spring Bootæ•´åˆ

```yaml
spring:
  redis:
    cluster:
      nodes:
        - 127.0.0.1:6379
        - 127.0.0.1:6380
        - 127.0.0.1:6381
        - 127.0.0.1:6382
        - 127.0.0.1:6383
        - 127.0.0.1:6384
      max-redirects: 3
    password: yourpassword
```

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | ä¸»ä»å¤åˆ¶ | å“¨å…µæ¨¡å¼ | Cluster |
|------|---------|---------|---------|
| é«˜å¯ç”¨ | âŒ | âœ… | âœ… |
| è‡ªåŠ¨æ•…éšœè½¬ç§» | âŒ | âœ… | âœ… |
| æ•°æ®åˆ†ç‰‡ | âŒ | âŒ | âœ… |
| æ¨ªå‘æ‰©å±• | âŒ | âŒ | âœ… |
| é…ç½®å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ |
| é€‚ç”¨åœºæ™¯ | è¯»å¤šå†™å°‘ | é«˜å¯ç”¨ | å¤§æ•°æ®é‡ |

## ğŸ’¡ æœ€ä½³å®è·µ

1. **å°è§„æ¨¡** - ä¸»ä»å¤åˆ¶ + å“¨å…µ
2. **å¤§è§„æ¨¡** - Redis Cluster
3. **å®šæœŸå¤‡ä»½** - RDB + AOF
4. **ç›‘æ§å‘Šè­¦** - å®æ—¶ç›‘æ§é›†ç¾¤çŠ¶æ€
5. **åˆç†åˆ†ç‰‡** - é¿å…çƒ­ç‚¹æ•°æ®

---

**Redisæ•™ç¨‹å®Œç»“ï¼** ç»§ç»­å­¦ä¹  â†’ [MyBatisæ¡†æ¶](../mybatis/)
