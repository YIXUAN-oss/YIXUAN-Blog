---
title: ç¼“å­˜ç­–ç•¥ä¸å®æˆ˜
---

# 05 - ç¼“å­˜ç­–ç•¥ä¸å®æˆ˜

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£å¸¸è§çš„ç¼“å­˜é—®é¢˜
- æŒæ¡ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©çš„è§£å†³æ–¹æ¡ˆ
- å­¦ä¼šç¼“å­˜æ›´æ–°ç­–ç•¥
- æŒæ¡åˆ†å¸ƒå¼é”çš„å®ç°

## âš ï¸ ç¼“å­˜ä¸‰å¤§é—®é¢˜

### 1. ç¼“å­˜ç©¿é€

**é—®é¢˜æè¿°ï¼š**
æŸ¥è¯¢ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å’Œæ•°æ®åº“éƒ½æ²¡æœ‰ï¼Œå¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“ã€‚

```
è¯·æ±‚ â†’ ç¼“å­˜(æ— ) â†’ æ•°æ®åº“(æ— ) â†’ è¿”å›null
```

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ1ï¼šç¼“å­˜ç©ºå¯¹è±¡
```java
public User getUserById(Long id) {
    String key = "user:" + id;
    
    // ä»ç¼“å­˜è·å–
    User user = (User) redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    user = userMapper.selectById(id);
    
    if (user != null) {
        // å­˜å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
    } else {
        // ç¼“å­˜ç©ºå¯¹è±¡ï¼Œè¿‡æœŸæ—¶é—´çŸ­
        redisTemplate.opsForValue().set(key, new User(), 5, TimeUnit.MINUTES);
    }
    
    return user;
}
```

#### æ–¹æ¡ˆ2ï¼šå¸ƒéš†è¿‡æ»¤å™¨
```java
@Component
public class BloomFilterService {
    
    private BitSet bitSet = new BitSet(1000000);
    
    // åˆå§‹åŒ–ï¼Œå°†æ‰€æœ‰ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
    @PostConstruct
    public void init() {
        List<Long> userIds = userMapper.selectAllIds();
        for (Long id : userIds) {
            add(id);
        }
    }
    
    // æ·»åŠ å…ƒç´ 
    public void add(Long id) {
        int hash1 = hash1(id);
        int hash2 = hash2(id);
        int hash3 = hash3(id);
        bitSet.set(hash1, true);
        bitSet.set(hash2, true);
        bitSet.set(hash3, true);
    }
    
    // åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨
    public boolean contains(Long id) {
        int hash1 = hash1(id);
        int hash2 = hash2(id);
        int hash3 = hash3(id);
        return bitSet.get(hash1) && bitSet.get(hash2) && bitSet.get(hash3);
    }
}

public User getUserById(Long id) {
    // å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
    if (!bloomFilterService.contains(id)) {
        return null;
    }
    
    // ç»§ç»­æŸ¥è¯¢ç¼“å­˜å’Œæ•°æ®åº“
    // ...
}
```

### 2. ç¼“å­˜å‡»ç©¿

**é—®é¢˜æè¿°ï¼š**
çƒ­ç‚¹æ•°æ®è¿‡æœŸï¼Œå¤§é‡è¯·æ±‚åŒæ—¶è®¿é—®ï¼Œå¯¼è‡´ç¬é—´å‹åŠ›å…¨éƒ¨æ‰“åˆ°æ•°æ®åº“ã€‚

```
çƒ­ç‚¹keyè¿‡æœŸ â†’ å¤§é‡è¯·æ±‚ â†’ æ•°æ®åº“å‹åŠ›éª¤å¢
```

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ1ï¼šäº’æ–¥é”
```java
public User getUserById(Long id) {
    String key = "user:" + id;
    String lockKey = "lock:user:" + id;
    
    // ä»ç¼“å­˜è·å–
    User user = (User) redisTemplate.opsForValue().get(key);
    if (user != null) {
        return user;
    }
    
    // è·å–åˆ†å¸ƒå¼é”
    Boolean lock = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);
    
    if (Boolean.TRUE.equals(lock)) {
        try {
            // æŸ¥è¯¢æ•°æ®åº“
            user = userMapper.selectById(id);
            if (user != null) {
                redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
            }
            return user;
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(lockKey);
        }
    } else {
        // æ²¡è·å–åˆ°é”ï¼Œç­‰å¾…åé‡è¯•
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return getUserById(id);
    }
}
```

#### æ–¹æ¡ˆ2ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ
```java
// é€»è¾‘è¿‡æœŸ
public User getUserById(Long id) {
    String key = "user:" + id;
    
    // è·å–ç¼“å­˜æ•°æ®ï¼ˆåŒ…å«é€»è¾‘è¿‡æœŸæ—¶é—´ï¼‰
    CacheData data = (CacheData) redisTemplate.opsForValue().get(key);
    
    if (data == null) {
        return loadAndCache(id);
    }
    
    // æ£€æŸ¥é€»è¾‘è¿‡æœŸ
    if (data.getExpireTime().isBefore(LocalDateTime.now())) {
        // å¼‚æ­¥æ›´æ–°ç¼“å­˜
        threadPool.execute(() -> loadAndCache(id));
    }
    
    return (User) data.getData();
}
```

### 3. ç¼“å­˜é›ªå´©

**é—®é¢˜æè¿°ï¼š**
å¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œæˆ–Rediså®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚æ‰“åˆ°æ•°æ®åº“ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ1ï¼šè¿‡æœŸæ—¶é—´éšæœºåŒ–
```java
// è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
Random random = new Random();
int expire = 30 + random.nextInt(10); // 30-40åˆ†é’Ÿ
redisTemplate.opsForValue().set(key, user, expire, TimeUnit.MINUTES);
```

#### æ–¹æ¡ˆ2ï¼šRedisé›†ç¾¤
```yaml
# ä½¿ç”¨Redisé›†ç¾¤ï¼Œæé«˜å¯ç”¨æ€§
spring:
  redis:
    cluster:
      nodes:
        - 192.168.1.101:6379
        - 192.168.1.102:6379
        - 192.168.1.103:6379
```

#### æ–¹æ¡ˆ3ï¼šå¤šçº§ç¼“å­˜
```java
// æœ¬åœ°ç¼“å­˜ + Redisç¼“å­˜
@Service
public class UserService {
    
    private LoadingCache<Long, User> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(10, TimeUnit.MINUTES)
        .build(id -> getUserFromRedisOrDB(id));
    
    public User getUserById(Long id) {
        return localCache.get(id);
    }
}
```

## ğŸ”„ ç¼“å­˜æ›´æ–°ç­–ç•¥

### 1. Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰

**æ¨èç­–ç•¥ï¼š**
```java
// è¯»æ“ä½œ
public User getUser(Long id) {
    // 1. è¯»ç¼“å­˜
    User user = getFromCache(id);
    if (user != null) {
        return user;
    }
    
    // 2. è¯»æ•°æ®åº“
    user = getFromDB(id);
    
    // 3. å†™ç¼“å­˜
    setCache(id, user);
    return user;
}

// å†™æ“ä½œ
public void updateUser(User user) {
    // 1. æ›´æ–°æ•°æ®åº“
    updateDB(user);
    
    // 2. åˆ é™¤ç¼“å­˜
    deleteCache(user.getId());
}
```

### 2. Read/Write Through

ç”±ç¼“å­˜å±‚ç»Ÿä¸€ç®¡ç†æ•°æ®åº“è¯»å†™ã€‚

### 3. Write Behind

å¼‚æ­¥æ›´æ–°æ•°æ®åº“ï¼Œæé«˜æ€§èƒ½ã€‚

## ğŸ”’ åˆ†å¸ƒå¼é”

### Redissonå®ç°

```xml
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.23.0</version>
</dependency>
```

```java
@Service
public class StockService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void deductStock(Long productId, Integer count) {
        String lockKey = "lock:stock:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // è·å–é”ï¼Œç­‰å¾…10ç§’ï¼Œé”30ç§’è‡ªåŠ¨é‡Šæ”¾
            boolean isLock = lock.tryLock(10, 30, TimeUnit.SECONDS);
            
            if (isLock) {
                // ä¸šåŠ¡é€»è¾‘
                Integer stock = getStock(productId);
                if (stock >= count) {
                    updateStock(productId, stock - count);
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            lock.unlock();
        }
    }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´** - åŠ éšæœºå€¼é˜²æ­¢é›ªå´©
2. **ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨** - é˜²æ­¢ç¼“å­˜ç©¿é€
3. **çƒ­ç‚¹æ•°æ®é¢„åŠ è½½** - æå‰ç¼“å­˜
4. **ç›‘æ§å‘Šè­¦** - åŠæ—¶å‘ç°é—®é¢˜
5. **é™æµé™çº§** - ä¿æŠ¤æ•°æ®åº“

---

**ä¸‹ä¸€èŠ‚ï¼š** [06-Redisé›†ç¾¤ä¸é«˜å¯ç”¨](06-Redisé›†ç¾¤ä¸é«˜å¯ç”¨.md)
