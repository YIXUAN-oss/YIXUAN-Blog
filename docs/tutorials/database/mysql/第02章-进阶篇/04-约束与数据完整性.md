# 约束与数据完整性

> 约束是保证数据准确性和一致性的重要机制。本章将深入讲解MySQL中的各种约束类型及其应用。

## 📋 本章目录

- [一、约束概述](#一约束概述)
- [二、主键约束](#二主键约束)
- [三、外键约束](#三外键约束)
- [四、唯一约束](#四唯一约束)
- [五、非空约束](#五非空约束)
- [六、默认约束](#六默认约束)
- [七、检查约束](#七检查约束)
- [八、综合应用案例](#八综合应用案例)

---

## 一、约束概述

### 1.1 什么是约束？

**约束（Constraint）** 是作用于表中字段上的规则，用于限制存储在表中的数据，保证数据的正确性、有效性和完整性。

### 1.2 约束的分类

| 约束类型 | 关键字 | 说明 |
|---------|--------|------|
| **主键约束** | `PRIMARY KEY` | 唯一标识，非空且唯一 |
| **外键约束** | `FOREIGN KEY` | 建立表间关系，保证引用完整性 |
| **唯一约束** | `UNIQUE` | 保证数据唯一，可以为NULL |
| **非空约束** | `NOT NULL` | 不允许为NULL |
| **默认约束** | `DEFAULT` | 设置默认值 |
| **检查约束** | `CHECK` | 保证字段值满足条件（MySQL 8.0.16+） |

### 1.3 约束的作用

- ✅ **保证数据准确性**：防止非法数据插入
- ✅ **维护数据一致性**：确保数据符合业务规则
- ✅ **建立表间关系**：通过外键维护关联
- ✅ **提高数据质量**：在数据库层面把关

---

## 二、主键约束

### 2.1 主键的特点

- 🔑 **唯一标识**：每条记录的主键值必须唯一
- ❌ **非空**：主键值不能为NULL
- 🎯 **一张表只能有一个主键**
- ⚡ **自动创建索引**：提高查询效率

### 2.2 创建主键

#### 方式一：创建表时定义

```sql
-- 单字段主键
CREATE TABLE students (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    age INT
);

-- 或使用AUTO_INCREMENT自增
CREATE TABLE students (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50),
    age INT
);

-- 在字段列表后定义
CREATE TABLE students (
    id INT,
    name VARCHAR(50),
    age INT,
    PRIMARY KEY (id)
);

-- 联合主键（多个字段组合）
CREATE TABLE student_courses (
    student_id INT,
    course_id INT,
    score DECIMAL(5,2),
    PRIMARY KEY (student_id, course_id)
);
```

#### 方式二：修改表添加主键

```sql
-- 添加主键
ALTER TABLE students ADD PRIMARY KEY (id);

-- 添加自增主键
ALTER TABLE students 
MODIFY id INT AUTO_INCREMENT,
ADD PRIMARY KEY (id);
```

### 2.3 删除主键

```sql
-- 先删除自增属性
ALTER TABLE students MODIFY id INT;

-- 再删除主键
ALTER TABLE students DROP PRIMARY KEY;
```

### 2.4 AUTO_INCREMENT自增

```sql
-- 创建自增主键
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    customer_name VARCHAR(50),
    order_date DATE
);

-- 插入数据（自动生成ID）
INSERT INTO orders (customer_name, order_date) 
VALUES ('张三', '2024-01-01');

-- 指定起始值
ALTER TABLE orders AUTO_INCREMENT = 1000;

-- 查询下一个自增值
SELECT AUTO_INCREMENT 
FROM information_schema.TABLES 
WHERE TABLE_NAME = 'orders';
```

---

## 三、外键约束

### 3.1 外键的作用

外键用于建立两个表之间的连接，保证数据的**引用完整性**。

**示例关系**：
- 员工表（employees）：员工信息
- 部门表（departments）：部门信息
- 关系：员工属于某个部门

### 3.2 创建外键

#### 方式一：创建表时定义

```sql
-- 先创建父表（被引用的表）
CREATE TABLE departments (
    dept_id INT PRIMARY KEY AUTO_INCREMENT,
    dept_name VARCHAR(50) NOT NULL
);

-- 再创建子表（引用的表）
CREATE TABLE employees (
    emp_id INT PRIMARY KEY AUTO_INCREMENT,
    emp_name VARCHAR(50) NOT NULL,
    dept_id INT,
    FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
);
```

#### 方式二：修改表添加外键

```sql
-- 添加外键约束
ALTER TABLE employees 
ADD CONSTRAINT fk_emp_dept 
FOREIGN KEY (dept_id) REFERENCES departments(dept_id);
```

### 3.3 外键的级联操作

| 选项 | 说明 |
|------|------|
| `CASCADE` | 级联操作（父表删除/更新时，子表同步操作） |
| `SET NULL` | 父表删除/更新时，子表外键设为NULL |
| `RESTRICT` | 有子表记录时，拒绝父表删除/更新（默认） |
| `NO ACTION` | 同RESTRICT |
| `SET DEFAULT` | 设置为默认值（InnoDB不支持） |

**示例：**

```sql
CREATE TABLE employees (
    emp_id INT PRIMARY KEY AUTO_INCREMENT,
    emp_name VARCHAR(50),
    dept_id INT,
    FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
        ON DELETE CASCADE      -- 删除部门时，删除该部门所有员工
        ON UPDATE CASCADE      -- 更新部门ID时，同步更新员工表
);

-- 或者设置为NULL
CREATE TABLE employees (
    emp_id INT PRIMARY KEY AUTO_INCREMENT,
    emp_name VARCHAR(50),
    dept_id INT,
    FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
        ON DELETE SET NULL     -- 删除部门时，员工的dept_id设为NULL
        ON UPDATE SET NULL
);
```

### 3.4 删除外键

```sql
-- 删除外键（需要知道外键名称）
ALTER TABLE employees DROP FOREIGN KEY fk_emp_dept;

-- 查看外键名称
SHOW CREATE TABLE employees;
```

### 3.5 外键使用注意事项

⚠️ **注意**：
1. 外键字段的数据类型必须与主表主键一致
2. 外键字段可以为NULL（除非设置NOT NULL）
3. 只有InnoDB引擎支持外键
4. 外键会影响性能，大型系统可考虑在应用层维护关系

---

## 四、唯一约束

### 4.1 唯一约束的特点

- ✅ 保证字段值唯一
- ✅ 可以为NULL（NULL不参与唯一性检查）
- ✅ 一张表可以有多个唯一约束
- ⚡ 自动创建唯一索引

### 4.2 创建唯一约束

```sql
-- 方式一：创建表时定义
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,      -- 唯一约束
    email VARCHAR(100) UNIQUE,                 -- 唯一约束
    phone VARCHAR(20),
    UNIQUE (phone)                             -- 或在后面定义
);

-- 联合唯一约束
CREATE TABLE user_roles (
    user_id INT,
    role_id INT,
    UNIQUE (user_id, role_id)  -- 组合必须唯一
);

-- 方式二：修改表添加
ALTER TABLE users ADD UNIQUE (email);

-- 指定约束名
ALTER TABLE users 
ADD CONSTRAINT uk_email UNIQUE (email);
```

### 4.3 删除唯一约束

```sql
-- 删除唯一约束（通过索引名）
ALTER TABLE users DROP INDEX email;

-- 删除命名的约束
ALTER TABLE users DROP INDEX uk_email;
```

### 4.4 主键 vs 唯一约束

| 特性 | 主键 PRIMARY KEY | 唯一约束 UNIQUE |
|------|-----------------|----------------|
| 唯一性 | ✅ | ✅ |
| 可为NULL | ❌ | ✅ |
| 数量限制 | 一张表只能一个 | 可以有多个 |
| 自动创建索引 | ✅ | ✅ |

---

## 五、非空约束

### 5.1 非空约束的作用

- ❌ 不允许字段值为NULL
- ✅ 保证数据完整性

### 5.2 创建非空约束

```sql
-- 创建表时定义
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,        -- 非空
    email VARCHAR(100) NOT NULL,      -- 非空
    phone VARCHAR(20)                 -- 可为空
);

-- 修改表添加非空约束
ALTER TABLE employees MODIFY phone VARCHAR(20) NOT NULL;
```

### 5.3 删除非空约束

```sql
-- 修改字段为允许NULL
ALTER TABLE employees MODIFY phone VARCHAR(20) NULL;
```

---

## 六、默认约束

### 6.1 默认约束的作用

当插入数据时未指定字段值，自动使用默认值。

### 6.2 创建默认约束

```sql
-- 创建表时定义
CREATE TABLE articles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    view_count INT DEFAULT 0,              -- 默认为0
    status TINYINT DEFAULT 1,              -- 默认为1
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,          -- 默认当前时间
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
               ON UPDATE CURRENT_TIMESTAMP                   -- 自动更新
);

-- 修改表添加默认值
ALTER TABLE articles 
ALTER COLUMN status SET DEFAULT 1;
```

### 6.3 删除默认约束

```sql
ALTER TABLE articles 
ALTER COLUMN status DROP DEFAULT;
```

### 6.4 常用默认值

```sql
-- 数值默认值
price DECIMAL(10,2) DEFAULT 0.00

-- 字符串默认值
gender CHAR(1) DEFAULT '男'
status VARCHAR(20) DEFAULT 'active'

-- 日期时间默认值
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

-- 布尔默认值（TINYINT）
is_deleted TINYINT DEFAULT 0
```

---

## 七、检查约束

### 7.1 检查约束的作用

检查约束用于限制字段值必须满足指定条件（MySQL 8.0.16+支持）。

### 7.2 创建检查约束

```sql
-- 创建表时定义
CREATE TABLE employees (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    age INT CHECK (age >= 18 AND age <= 65),              -- 年龄范围
    salary DECIMAL(10,2) CHECK (salary > 0),              -- 薪资大于0
    gender CHAR(1) CHECK (gender IN ('男', '女')),        -- 性别限制
    email VARCHAR(100),
    CONSTRAINT chk_email CHECK (email LIKE '%@%.%')       -- 邮箱格式
);

-- 修改表添加检查约束
ALTER TABLE employees 
ADD CONSTRAINT chk_age CHECK (age BETWEEN 18 AND 65);
```

### 7.3 删除检查约束

```sql
ALTER TABLE employees DROP CHECK chk_age;
```

### 7.4 常用检查约束示例

```sql
-- 范围检查
age INT CHECK (age >= 0 AND age <= 150)
score DECIMAL(5,2) CHECK (score >= 0 AND score <= 100)

-- 枚举检查
status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'banned'))
level TINYINT CHECK (level IN (1, 2, 3, 4, 5))

-- 格式检查
phone VARCHAR(20) CHECK (phone REGEXP '^1[3-9][0-9]{9}$')
email VARCHAR(100) CHECK (email LIKE '%@%.%')

-- 逻辑检查
start_date DATE,
end_date DATE,
CHECK (end_date > start_date)
```

---

## 八、综合应用案例

### 案例1：完整的用户表

```sql
CREATE TABLE users (
    -- 主键约束 + 自增
    user_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    
    -- 非空 + 唯一约束
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    
    -- 非空约束
    password VARCHAR(100) NOT NULL COMMENT '密码',
    
    -- 唯一约束 + 检查约束
    email VARCHAR(100) UNIQUE 
        CHECK (email LIKE '%@%.%') COMMENT '邮箱',
    
    -- 唯一约束 + 检查约束
    phone VARCHAR(20) UNIQUE 
        CHECK (phone REGEXP '^1[3-9][0-9]{9}$') COMMENT '手机号',
    
    -- 检查约束
    age INT CHECK (age >= 18 AND age <= 120) COMMENT '年龄',
    
    -- 检查约束（枚举）
    gender CHAR(1) DEFAULT '男' 
        CHECK (gender IN ('男', '女')) COMMENT '性别',
    
    -- 默认约束
    status TINYINT DEFAULT 1 
        CHECK (status IN (0, 1)) COMMENT '状态：0-禁用，1-启用',
    
    -- 默认约束（时间戳）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP 
               ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) COMMENT '用户表';
```

### 案例2：订单和订单详情（外键）

```sql
-- 订单表
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    order_no VARCHAR(50) NOT NULL UNIQUE,
    total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount >= 0),
    status TINYINT DEFAULT 1 CHECK (status IN (1,2,3,4,5)),
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) 
        ON DELETE RESTRICT 
        ON UPDATE CASCADE
) COMMENT '订单表';

-- 订单详情表
CREATE TABLE order_items (
    item_id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL CHECK (quantity > 0),
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    subtotal DECIMAL(10,2) NOT NULL CHECK (subtotal >= 0),
    FOREIGN KEY (order_id) REFERENCES orders(order_id) 
        ON DELETE CASCADE 
        ON UPDATE CASCADE
) COMMENT '订单详情表';
```

### 案例3：学生选课系统

```sql
-- 学生表
CREATE TABLE students (
    student_id INT PRIMARY KEY AUTO_INCREMENT,
    student_no VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL,
    gender CHAR(1) CHECK (gender IN ('男', '女')),
    birth_date DATE,
    major VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 课程表
CREATE TABLE courses (
    course_id INT PRIMARY KEY AUTO_INCREMENT,
    course_no VARCHAR(20) NOT NULL UNIQUE,
    course_name VARCHAR(100) NOT NULL,
    credits DECIMAL(3,1) CHECK (credits > 0),
    max_students INT CHECK (max_students > 0)
);

-- 选课表（联合主键 + 外键）
CREATE TABLE enrollments (
    student_id INT,
    course_id INT,
    score DECIMAL(5,2) CHECK (score >= 0 AND score <= 100),
    enroll_date DATE NOT NULL,
    PRIMARY KEY (student_id, course_id),
    FOREIGN KEY (student_id) REFERENCES students(student_id) 
        ON DELETE CASCADE,
    FOREIGN KEY (course_id) REFERENCES courses(course_id) 
        ON DELETE CASCADE
);
```

---

## 九、本章总结

### 核心要点

1. **主键约束**：唯一标识，非空且唯一，一表一个
2. **外键约束**：维护表间关系，保证引用完整性
3. **唯一约束**：保证数据唯一，可以为NULL
4. **非空约束**：字段值不能为NULL
5. **默认约束**：未指定值时使用默认值
6. **检查约束**：限制字段值满足条件

### 约束使用建议

- ✅ 合理使用约束保证数据质量
- ✅ 主键尽量使用自增整数
- ✅ 外键谨慎使用，注意性能影响
- ✅ 唯一约束用于保证业务唯一性
- ✅ 重要字段添加非空约束
- ✅ 检查约束减轻应用层负担

---

## 练习题

```sql
-- 1. 创建员工表，包含各种约束
CREATE TABLE employees (
    emp_id INT PRIMARY KEY AUTO_INCREMENT,
    emp_no VARCHAR(20) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE CHECK (email LIKE '%@%.%'),
    age INT CHECK (age >= 18 AND age <= 65),
    salary DECIMAL(10,2) CHECK (salary > 0),
    dept_id INT,
    status TINYINT DEFAULT 1 CHECK (status IN (0, 1)),
    FOREIGN KEY (dept_id) REFERENCES departments(dept_id)
);

-- 2. 插入测试数据
INSERT INTO employees (emp_no, name, email, age, salary, dept_id) 
VALUES ('E001', '张三', 'zhangsan@example.com', 28, 8000, 1);

-- 3. 尝试插入违反约束的数据（会失败）
INSERT INTO employees (emp_no, name, age) 
VALUES ('E001', '李四', 17);  -- 违反唯一约束和年龄检查
```

---

**下一章：[第05章 - 多表查询与连接](05-多表查询与连接.md)** →
