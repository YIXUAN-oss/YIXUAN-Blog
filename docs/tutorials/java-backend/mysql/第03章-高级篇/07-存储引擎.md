# 存储引擎

> 存储引擎是MySQL的核心组件，决定了数据的存储方式和性能特征。本章将深入学习MySQL的存储引擎。

## 📋 本章目录

- [一、MySQL体系结构](#一mysql体系结构)
- [二、存储引擎概述](#二存储引擎概述)
- [三、InnoDB引擎](#三innodb引擎)
- [四、MyISAM引擎](#四myisam引擎)
- [五、其他存储引擎](#五其他存储引擎)
- [六、存储引擎的选择](#六存储引擎的选择)

---

## 一、MySQL体系结构

### 1.1 MySQL整体架构

MySQL采用**分层架构**，从上到下分为四层：

```
┌─────────────────────────────────────┐
│   连接层 (Connection Layer)         │
│   - 连接处理、授权认证、安全管理     │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   服务层 (Service Layer)            │
│   - SQL接口、解析器、优化器、缓存    │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   引擎层 (Storage Engine Layer)     │
│   - InnoDB、MyISAM、Memory等        │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   存储层 (File System Layer)        │
│   - 数据文件、日志文件等             │
└─────────────────────────────────────┘
```

### 1.2 各层职责

**1. 连接层**
- 客户端连接处理
- 用户认证和授权
- 连接池管理

**2. 服务层**
- SQL接口：接收SQL语句
- 解析器：语法分析、语义分析
- 优化器：生成执行计划
- 查询缓存（MySQL 8.0已移除）

**3. 引擎层**
- 存储数据
- 建立索引
- 提供读写接口
- **可插拔式架构**

**4. 存储层**
- 物理文件存储
- 日志文件管理

---

## 二、存储引擎概述

### 2.1 什么是存储引擎？

**存储引擎**是MySQL中用于存储数据、建立索引、更新/查询数据的技术实现方式。

**重要特性：**
- ✅ 存储引擎是**基于表的**，不是基于库的
- ✅ 同一个数据库中不同表可以使用不同的存储引擎
- ✅ MySQL支持可插拔式存储引擎

### 2.2 查看存储引擎

```sql
-- 查看支持的存储引擎
SHOW ENGINES;

-- 查看默认存储引擎
SHOW VARIABLES LIKE 'default_storage_engine';

-- 查看表的存储引擎
SHOW TABLE STATUS FROM database_name;
SHOW CREATE TABLE table_name;
```

### 2.3 指定存储引擎

```sql
-- 创建表时指定
CREATE TABLE my_table (
    id INT PRIMARY KEY,
    name VARCHAR(50)
) ENGINE = InnoDB;

-- 修改表的存储引擎
ALTER TABLE my_table ENGINE = MyISAM;
```

---

## 三、InnoDB引擎

### 3.1 InnoDB简介

**InnoDB** 是MySQL 5.5及以后版本的**默认存储引擎**，也是最重要的存储引擎。

### 3.2 InnoDB的特点

| 特性 | 说明 |
|------|------|
| **事务支持** | ✅ 完整的ACID支持 |
| **锁机制** | ✅ 行级锁，并发性能好 |
| **外键约束** | ✅ 支持FOREIGN KEY |
| **崩溃恢复** | ✅ 自动崩溃恢复 |
| **MVCC** | ✅ 多版本并发控制 |
| **索引类型** | B+Tree索引（聚集索引） |

### 3.3 InnoDB架构

**核心组件：**

1. **缓冲池（Buffer Pool）**
   - 缓存数据页和索引页
   - 提高读写性能
   - 默认128MB

2. **日志文件**
   - `redo log`：重做日志，保证持久性
   - `undo log`：回滚日志，保证原子性
   - `binlog`：二进制日志，用于复制和恢复

3. **表空间**
   - 系统表空间：`ibdata1`
   - 独立表空间：`表名.ibd`

### 3.4 InnoDB文件结构

```sql
-- 查看是否开启独立表空间
SHOW VARIABLES LIKE 'innodb_file_per_table';

-- 独立表空间模式（推荐）
innodb_file_per_table = ON

-- 表文件：table_name.ibd
-- 包含：表结构、数据、索引
```

**文件说明：**
- `表名.ibd`：存储表结构、数据、索引
- `表名.sdi`：表结构定义文件（JSON格式）

### 3.5 InnoDB的优势

**1. 事务支持**
```sql
START TRANSACTION;
UPDATE account SET balance = balance - 100 WHERE id = 1;
UPDATE account SET balance = balance + 100 WHERE id = 2;
COMMIT;  -- 保证原子性
```

**2. 行级锁**
```sql
-- 多个事务可以同时修改不同行
-- 事务A：
UPDATE users SET name = 'A' WHERE id = 1;

-- 事务B：（不会被阻塞）
UPDATE users SET name = 'B' WHERE id = 2;
```

**3. 外键约束**
```sql
CREATE TABLE orders (
    id INT PRIMARY KEY,
    user_id INT,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

**4. 崩溃恢复**
- 使用redo log自动恢复未提交的数据
- 使用undo log回滚未完成的事务

### 3.6 InnoDB适用场景

✅ **推荐使用场景：**
- 需要事务支持（转账、订单）
- 需要外键约束
- 高并发读写
- 频繁的UPDATE/DELETE操作
- 对数据一致性要求高

---

## 四、MyISAM引擎

### 4.1 MyISAM简介

**MyISAM** 是MySQL 5.5之前的默认存储引擎，现在较少使用。

### 4.2 MyISAM的特点

| 特性 | 说明 |
|------|------|
| **事务支持** | ❌ 不支持事务 |
| **锁机制** | ❌ 表级锁，并发性能差 |
| **外键约束** | ❌ 不支持 |
| **崩溃恢复** | ❌ 无自动恢复 |
| **访问速度** | ✅ 读取速度快 |
| **存储空间** | ✅ 占用空间小 |

### 4.3 MyISAM文件结构

每个MyISAM表对应3个文件：

```
table_name.MYD  -- 数据文件（MyData）
table_name.MYI  -- 索引文件（MyIndex）
table_name.sdi  -- 表结构文件
```

### 4.4 MyISAM vs InnoDB

| 特性 | InnoDB | MyISAM |
|------|--------|--------|
| 事务 | ✅ 支持 | ❌ 不支持 |
| 外键 | ✅ 支持 | ❌ 不支持 |
| 锁 | 行级锁 | 表级锁 |
| 崩溃恢复 | ✅ 自动 | ❌ 需手动 |
| 读性能 | 良好 | 优秀 |
| 写性能 | 优秀 | 一般 |
| 存储空间 | 较大 | 较小 |

### 4.5 MyISAM适用场景

✅ **适用场景：**
- 以SELECT、INSERT为主
- 没有事务需求
- 并发要求不高
- 只读应用或日志系统

❌ **不适用场景：**
- 需要事务
- 高并发写入
- 频繁UPDATE/DELETE

---

## 五、其他存储引擎

### 5.1 Memory引擎

**特点：**
- 💾 数据存储在内存中
- ⚡ 访问速度极快
- ❌ 数据不持久化（重启丢失）
- 🔒 表级锁
- 📊 默认使用Hash索引

**使用场景：**
- 临时表
- 缓存表
- 会话数据
- 中间结果集

**示例：**
```sql
CREATE TABLE cache_table (
    id INT PRIMARY KEY,
    data VARCHAR(100)
) ENGINE = Memory;
```

### 5.2 CSV引擎

**特点：**
- 📄 数据存储为CSV文件
- 📤 方便数据导入导出
- ❌ 不支持索引

**使用场景：**
- 数据交换
- 日志存储

### 5.3 Archive引擎

**特点：**
- 🗜️ 高度压缩存储
- 📥 只支持INSERT和SELECT
- ❌ 不支持索引

**使用场景：**
- 历史数据归档
- 日志记录

---

## 六、存储引擎的选择

### 6.1 选择决策树

```
需要事务支持？
├─ 是 → InnoDB
└─ 否 ↓

需要外键约束？
├─ 是 → InnoDB
└─ 否 ↓

高并发读写？
├─ 是 → InnoDB
└─ 否 ↓

只读或日志？
├─ 是 → MyISAM 或 Archive
└─ 否 ↓

临时数据？
└─ 是 → Memory
```

### 6.2 各引擎推荐场景

**InnoDB（首选）：**
- ✅ 几乎所有OLTP应用
- ✅ 电商订单系统
- ✅ 金融交易系统
- ✅ 用户管理系统
- ✅ 内容管理系统

**MyISAM：**
- ✅ 只读应用
- ✅ 数据仓库（历史数据）
- ✅ 日志系统
- ✅ 统计分析（低并发）

**Memory：**
- ✅ 会话缓存
- ✅ 临时计算结果
- ✅ 实时统计数据

**Archive：**
- ✅ 历史数据归档
- ✅ 审计日志
- ✅ 只写不改的数据

### 6.3 实际应用建议

**大多数情况：使用InnoDB**

```sql
-- 推荐配置
[mysqld]
default_storage_engine = InnoDB
innodb_file_per_table = ON
innodb_buffer_pool_size = 1G  -- 根据内存调整
```

**混合使用：**
```sql
-- 核心业务表：InnoDB
CREATE TABLE orders (...) ENGINE=InnoDB;
CREATE TABLE users (...) ENGINE=InnoDB;

-- 日志表：MyISAM（或Archive）
CREATE TABLE access_log (...) ENGINE=MyISAM;

-- 临时表：Memory
CREATE TEMPORARY TABLE temp_result (...) ENGINE=Memory;
```

---

## 七、本章总结

### 核心要点

1. **MySQL架构**：连接层→服务层→引擎层→存储层
2. **InnoDB**：默认引擎，支持事务、外键、行锁
3. **MyISAM**：不支持事务，表锁，读性能好
4. **Memory**：内存存储，速度快，数据不持久
5. **存储引擎可插拔**：不同表可用不同引擎

### 选择建议

| 场景 | 推荐引擎 | 理由 |
|------|---------|------|
| 大多数应用 | InnoDB | 事务、并发、可靠性 |
| 只读应用 | MyISAM | 读性能好 |
| 临时数据 | Memory | 速度快 |
| 归档数据 | Archive | 高压缩比 |

### 最佳实践

1. ✅ **优先使用InnoDB**（除非有特殊需求）
2. ✅ **开启独立表空间**（innodb_file_per_table=ON）
3. ✅ **合理配置缓冲池**（innodb_buffer_pool_size）
4. ✅ **避免混用引擎**（同一业务用同一引擎）
5. ✅ **定期备份**（尤其是MyISAM）

---

## 练习题

```sql
-- 1. 查看当前数据库支持的存储引擎
SHOW ENGINES;

-- 2. 查看表的存储引擎
SHOW TABLE STATUS LIKE 'table_name';

-- 3. 创建不同引擎的表
CREATE TABLE innodb_table (...) ENGINE=InnoDB;
CREATE TABLE myisam_table (...) ENGINE=MyISAM;
CREATE TABLE memory_table (...) ENGINE=Memory;

-- 4. 修改表的存储引擎
ALTER TABLE myisam_table ENGINE=InnoDB;

-- 5. 比较不同引擎的性能差异（自行测试）
```

---

**下一章：[第08章 - 索引原理与优化](08-索引原理与优化.md)** →
