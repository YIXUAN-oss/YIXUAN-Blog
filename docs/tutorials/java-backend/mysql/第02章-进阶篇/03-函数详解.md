# 函数详解

> MySQL提供了丰富的内置函数，帮助我们更高效地处理数据。本章将详细介绍常用函数的使用方法和应用场景。

## 📋 本章目录

- [一、字符串函数](#一字符串函数)
- [二、数值函数](#二数值函数)
- [三、日期时间函数](#三日期时间函数)
- [四、流程控制函数](#四流程控制函数)
- [五、聚合函数](#五聚合函数)
- [六、综合应用案例](#六综合应用案例)

---

## 一、字符串函数

### 1.1 常用字符串函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `CONCAT(s1,s2,...)` | 字符串拼接 | `CONCAT('Hello', 'World')` → 'HelloWorld' |
| `CONCAT_WS(sep,s1,s2,...)` | 带分隔符拼接 | `CONCAT_WS('-','2024','01','01')` → '2024-01-01' |
| `LOWER(str)` | 转小写 | `LOWER('HELLO')` → 'hello' |
| `UPPER(str)` | 转大写 | `UPPER('hello')` → 'HELLO' |
| `LENGTH(str)` | 字符串长度（字节） | `LENGTH('你好')` → 6 |
| `CHAR_LENGTH(str)` | 字符串长度（字符） | `CHAR_LENGTH('你好')` → 2 |
| `TRIM(str)` | 去除首尾空格 | `TRIM(' hello ')` → 'hello' |
| `LTRIM(str)` | 去除左侧空格 | `LTRIM(' hello')` → 'hello' |
| `RTRIM(str)` | 去除右侧空格 | `RTRIM('hello ')` → 'hello' |
| `SUBSTRING(str,pos,len)` | 截取子串 | `SUBSTRING('hello',2,3)` → 'ell' |
| `REPLACE(str,old,new)` | 替换字符串 | `REPLACE('hello','l','L')` → 'heLLo' |
| `LPAD(str,len,pad)` | 左填充 | `LPAD('5',3,'0')` → '005' |
| `RPAD(str,len,pad)` | 右填充 | `RPAD('5',3,'0')` → '500' |
| `REVERSE(str)` | 反转字符串 | `REVERSE('hello')` → 'olleh' |
| `INSTR(str,substr)` | 查找子串位置 | `INSTR('hello','ll')` → 3 |

### 1.2 示例演示

```sql
-- 1. 字符串拼接
SELECT CONCAT('姓名：', name, '，年龄：', age) AS info 
FROM employees;

-- 使用分隔符拼接
SELECT CONCAT_WS(' - ', name, department, position) AS employee_info 
FROM employees;

-- 2. 大小写转换
SELECT 
    UPPER(name) AS uppercase_name,
    LOWER(email) AS lowercase_email
FROM users;

-- 3. 去除空格
SELECT TRIM('  hello world  ') AS trimmed;  -- 'hello world'

-- 4. 字符串截取
SELECT SUBSTRING('Hello World', 1, 5);  -- 'Hello'
SELECT SUBSTRING('Hello World', 7);     -- 'World'

-- 5. 字符串替换
SELECT REPLACE('www.mysql.com', 'mysql', 'baidu');  -- 'www.baidu.com'

-- 6. 左右填充（格式化数字）
SELECT LPAD(id, 6, '0') AS formatted_id FROM orders;
-- 1 → '000001'
-- 123 → '000123'

-- 7. 查找子串
SELECT name FROM users WHERE INSTR(email, '@gmail.com') > 0;
```

### 1.3 实际应用案例

```sql
-- 案例1：手机号码脱敏
SELECT 
    name,
    CONCAT(
        SUBSTRING(phone, 1, 3),
        '****',
        SUBSTRING(phone, 8, 4)
    ) AS masked_phone
FROM users;
-- 13812345678 → 138****5678

-- 案例2：生成订单编号
SELECT 
    CONCAT(
        'ORD',
        DATE_FORMAT(NOW(), '%Y%m%d'),
        LPAD(id, 6, '0')
    ) AS order_no
FROM orders;
-- ORD20240101000123

-- 案例3：邮箱域名统计
SELECT 
    SUBSTRING(email, INSTR(email, '@') + 1) AS domain,
    COUNT(*) AS user_count
FROM users
GROUP BY domain;
```

---

## 二、数值函数

### 2.1 常用数值函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `ABS(x)` | 绝对值 | `ABS(-5)` → 5 |
| `CEIL(x)` | 向上取整 | `CEIL(1.1)` → 2 |
| `FLOOR(x)` | 向下取整 | `FLOOR(1.9)` → 1 |
| `ROUND(x,d)` | 四舍五入 | `ROUND(3.1415, 2)` → 3.14 |
| `TRUNCATE(x,d)` | 截断小数 | `TRUNCATE(3.1415, 2)` → 3.14 |
| `MOD(x,y)` | 取模（余数） | `MOD(10, 3)` → 1 |
| `POWER(x,y)` | 幂运算 | `POWER(2, 3)` → 8 |
| `SQRT(x)` | 平方根 | `SQRT(16)` → 4 |
| `RAND()` | 随机数(0-1) | `RAND()` → 0.xxxxx |
| `SIGN(x)` | 符号 | `SIGN(-5)` → -1 |

### 2.2 示例演示

```sql
-- 1. 绝对值
SELECT ABS(-100);  -- 100

-- 2. 向上取整
SELECT CEIL(5.1);   -- 6
SELECT CEIL(5.9);   -- 6
SELECT CEIL(-5.1);  -- -5

-- 3. 向下取整
SELECT FLOOR(5.1);   -- 5
SELECT FLOOR(5.9);   -- 5
SELECT FLOOR(-5.1);  -- -6

-- 4. 四舍五入
SELECT ROUND(3.1415);       -- 3
SELECT ROUND(3.1415, 2);    -- 3.14
SELECT ROUND(3.1415, 3);    -- 3.142

-- 5. 取模运算
SELECT MOD(10, 3);  -- 1（10除以3余1）
SELECT 10 % 3;      -- 1（同上）

-- 6. 随机数
SELECT RAND();                    -- 0.xxxxx
SELECT RAND() * 100;              -- 0-100之间
SELECT FLOOR(RAND() * 100);       -- 0-99之间的整数
SELECT FLOOR(RAND() * 100) + 1;   -- 1-100之间的整数
```

### 2.3 实际应用案例

```sql
-- 案例1：价格计算（保留两位小数）
SELECT 
    product_name,
    price,
    ROUND(price * 0.8, 2) AS discount_price
FROM products;

-- 案例2：随机抽取10个用户
SELECT * FROM users 
ORDER BY RAND() 
LIMIT 10;

-- 案例3：计算商品评分
SELECT 
    product_id,
    ROUND(AVG(rating), 1) AS avg_rating
FROM reviews
GROUP BY product_id;

-- 案例4：分页页码计算
SELECT 
    CEIL(COUNT(*) / 10.0) AS total_pages 
FROM articles;
```

---

## 三、日期时间函数

### 3.1 常用日期函数

| 函数 | 说明 | 示例 |
|------|------|------|
| `NOW()` | 当前日期时间 | `NOW()` → '2024-01-01 12:30:45' |
| `CURDATE()` | 当前日期 | `CURDATE()` → '2024-01-01' |
| `CURTIME()` | 当前时间 | `CURTIME()` → '12:30:45' |
| `YEAR(date)` | 提取年份 | `YEAR(NOW())` → 2024 |
| `MONTH(date)` | 提取月份 | `MONTH(NOW())` → 1 |
| `DAY(date)` | 提取日 | `DAY(NOW())` → 1 |
| `HOUR(time)` | 提取小时 | `HOUR(NOW())` → 12 |
| `MINUTE(time)` | 提取分钟 | `MINUTE(NOW())` → 30 |
| `SECOND(time)` | 提取秒 | `SECOND(NOW())` → 45 |
| `DATE_ADD(date,INTERVAL n type)` | 日期加法 | `DATE_ADD(NOW(), INTERVAL 1 DAY)` |
| `DATE_SUB(date,INTERVAL n type)` | 日期减法 | `DATE_SUB(NOW(), INTERVAL 1 MONTH)` |
| `DATEDIFF(date1,date2)` | 日期差（天） | `DATEDIFF('2024-01-10','2024-01-01')` → 9 |
| `DATE_FORMAT(date,format)` | 格式化日期 | `DATE_FORMAT(NOW(),'%Y-%m-%d')` |

### 3.2 示例演示

```sql
-- 1. 获取当前时间
SELECT NOW();       -- 2024-01-01 12:30:45
SELECT CURDATE();   -- 2024-01-01
SELECT CURTIME();   -- 12:30:45

-- 2. 提取日期部分
SELECT 
    YEAR(NOW()) AS year,
    MONTH(NOW()) AS month,
    DAY(NOW()) AS day,
    HOUR(NOW()) AS hour;

-- 3. 日期加减
SELECT DATE_ADD(NOW(), INTERVAL 1 DAY);     -- 明天
SELECT DATE_ADD(NOW(), INTERVAL 1 WEEK);    -- 一周后
SELECT DATE_ADD(NOW(), INTERVAL 1 MONTH);   -- 一个月后
SELECT DATE_ADD(NOW(), INTERVAL 1 YEAR);    -- 一年后
SELECT DATE_SUB(NOW(), INTERVAL 1 DAY);     -- 昨天

-- 4. 日期差值
SELECT DATEDIFF('2024-12-31', '2024-01-01') AS days;  -- 365

-- 5. 日期格式化
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d');              -- 2024-01-01
SELECT DATE_FORMAT(NOW(), '%Y年%m月%d日');          -- 2024年01月01日
SELECT DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s');    -- 2024-01-01 12:30:45
SELECT DATE_FORMAT(NOW(), '%W, %M %d, %Y');        -- Monday, January 01, 2024
```

### 3.3 日期格式化符号

| 符号 | 说明 | 示例 |
|------|------|------|
| `%Y` | 四位年份 | 2024 |
| `%y` | 两位年份 | 24 |
| `%m` | 月份(01-12) | 01 |
| `%d` | 日(01-31) | 01 |
| `%H` | 小时(00-23) | 13 |
| `%i` | 分钟(00-59) | 30 |
| `%s` | 秒(00-59) | 45 |
| `%W` | 星期名 | Monday |
| `%M` | 月份名 | January |

### 3.4 实际应用案例

```sql
-- 案例1：查询今天注册的用户
SELECT * FROM users 
WHERE DATE(created_at) = CURDATE();

-- 案例2：查询本月订单
SELECT * FROM orders 
WHERE YEAR(order_date) = YEAR(NOW()) 
  AND MONTH(order_date) = MONTH(NOW());

-- 案例3：计算年龄
SELECT 
    name,
    birth_date,
    YEAR(CURDATE()) - YEAR(birth_date) AS age
FROM employees;

-- 案例4：查询最近7天的数据
SELECT * FROM articles 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 案例5：计算会员剩余天数
SELECT 
    username,
    expire_date,
    DATEDIFF(expire_date, CURDATE()) AS remaining_days
FROM members
WHERE expire_date > CURDATE();

-- 案例6：生成报表（按月统计）
SELECT 
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    COUNT(*) AS order_count,
    SUM(amount) AS total_amount
FROM orders
GROUP BY month
ORDER BY month;
```

---

## 四、流程控制函数

### 4.1 IF函数

**语法**：`IF(condition, value_if_true, value_if_false)`

```sql
-- 示例1：判断及格
SELECT 
    name,
    score,
    IF(score >= 60, '及格', '不及格') AS result
FROM students;

-- 示例2：判断性别
SELECT 
    name,
    IF(gender = 1, '男', '女') AS gender_text
FROM users;

-- 示例3：判断是否在职
SELECT 
    name,
    IF(status = 1, '在职', '离职') AS work_status
FROM employees;
```

### 4.2 IFNULL函数

**语法**：`IFNULL(value, default_value)`

```sql
-- 示例1：处理NULL值
SELECT 
    name,
    IFNULL(phone, '未填写') AS phone
FROM users;

-- 示例2：计算总价（含运费）
SELECT 
    order_id,
    price + IFNULL(shipping_fee, 0) AS total
FROM orders;

-- 示例3：显示默认头像
SELECT 
    username,
    IFNULL(avatar, 'default.jpg') AS avatar
FROM users;
```

### 4.3 CASE表达式

**语法一：简单CASE**
```sql
CASE expression
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ...
    ELSE default_result
END
```

**语法二：搜索CASE**
```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ...
    ELSE default_result
END
```

**示例：**

```sql
-- 示例1：等级评定
SELECT 
    name,
    score,
    CASE
        WHEN score >= 90 THEN '优秀'
        WHEN score >= 80 THEN '良好'
        WHEN score >= 60 THEN '及格'
        ELSE '不及格'
    END AS grade
FROM students;

-- 示例2：工作地址分类
SELECT 
    name,
    work_city,
    CASE work_city
        WHEN '北京' THEN '一线城市'
        WHEN '上海' THEN '一线城市'
        WHEN '广州' THEN '一线城市'
        WHEN '深圳' THEN '一线城市'
        ELSE '其他城市'
    END AS city_level
FROM employees;

-- 示例3：季度划分
SELECT 
    order_date,
    CASE
        WHEN MONTH(order_date) BETWEEN 1 AND 3 THEN 'Q1'
        WHEN MONTH(order_date) BETWEEN 4 AND 6 THEN 'Q2'
        WHEN MONTH(order_date) BETWEEN 7 AND 9 THEN 'Q3'
        ELSE 'Q4'
    END AS quarter
FROM orders;

-- 示例4：薪资调整
UPDATE employees
SET salary = CASE
    WHEN department = '技术部' THEN salary * 1.2
    WHEN department = '销售部' THEN salary * 1.15
    WHEN department = '市场部' THEN salary * 1.1
    ELSE salary * 1.05
END;
```

---

## 五、聚合函数

### 5.1 常用聚合函数

| 函数 | 说明 |
|------|------|
| `COUNT(*)` | 统计行数 |
| `COUNT(column)` | 统计非NULL值数量 |
| `SUM(column)` | 求和 |
| `AVG(column)` | 平均值 |
| `MAX(column)` | 最大值 |
| `MIN(column)` | 最小值 |
| `GROUP_CONCAT(column)` | 字符串聚合 |

### 5.2 示例演示

```sql
-- 统计订单总数
SELECT COUNT(*) AS total_orders FROM orders;

-- 计算总销售额
SELECT SUM(amount) AS total_sales FROM orders;

-- 计算平均分
SELECT AVG(score) AS avg_score FROM students;

-- 查找最高和最低价格
SELECT MAX(price) AS max_price, MIN(price) AS min_price FROM products;

-- 字符串聚合（拼接）
SELECT 
    department,
    GROUP_CONCAT(name SEPARATOR ', ') AS employees
FROM employees
GROUP BY department;
```

---

## 六、综合应用案例

### 案例1：用户信息格式化

```sql
SELECT 
    CONCAT(UPPER(SUBSTRING(name, 1, 1)), LOWER(SUBSTRING(name, 2))) AS formatted_name,
    CONCAT(
        SUBSTRING(phone, 1, 3),
        '-',
        SUBSTRING(phone, 4, 4),
        '-',
        SUBSTRING(phone, 8)
    ) AS formatted_phone,
    CONCAT(YEAR(CURDATE()) - YEAR(birth_date), '岁') AS age,
    IF(gender = 1, '男', '女') AS gender_text
FROM users;
```

### 案例2：订单数据分析

```sql
SELECT 
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    COUNT(*) AS order_count,
    ROUND(SUM(amount), 2) AS total_amount,
    ROUND(AVG(amount), 2) AS avg_amount,
    MAX(amount) AS max_amount,
    MIN(amount) AS min_amount
FROM orders
WHERE order_date >= DATE_SUB(NOW(), INTERVAL 6 MONTH)
GROUP BY month
ORDER BY month;
```

### 案例3：商品推荐标签

```sql
SELECT 
    product_name,
    price,
    CASE
        WHEN price < 100 THEN '经济实惠'
        WHEN price BETWEEN 100 AND 500 THEN '性价比之选'
        WHEN price BETWEEN 500 AND 1000 THEN '品质之选'
        ELSE '高端精品'
    END AS price_tag,
    CONCAT(ROUND(sales_count / 1000, 1), 'K+') AS sales_text,
    IF(stock > 100, '现货充足', '库存紧张') AS stock_status
FROM products;
```

---

## 七、本章总结

### 核心要点

1. **字符串函数**：拼接、截取、替换、格式化
2. **数值函数**：取整、四舍五入、随机数
3. **日期函数**：获取、计算、格式化日期
4. **流程函数**：IF、CASE条件判断

### 学习建议

1. ✅ 熟记常用函数的语法和用途
2. ✅ 多练习组合使用多个函数
3. ✅ 关注实际业务场景的应用
4. ✅ 注意NULL值的处理

---

## 练习题

```sql
-- 1. 将所有用户名转为大写
SELECT UPPER(username) FROM users;

-- 2. 查询姓"张"的用户（使用SUBSTRING）
SELECT * FROM users WHERE SUBSTRING(name, 1, 1) = '张';

-- 3. 计算所有商品的平均价格，保留2位小数
SELECT ROUND(AVG(price), 2) AS avg_price FROM products;

-- 4. 查询注册超过1年的用户
SELECT * FROM users 
WHERE DATEDIFF(NOW(), created_at) > 365;

-- 5. 根据年龄分组（少年、青年、中年、老年）
SELECT 
    name,
    CASE
        WHEN age < 18 THEN '少年'
        WHEN age < 35 THEN '青年'
        WHEN age < 60 THEN '中年'
        ELSE '老年'
    END AS age_group
FROM users;
```

---

**下一章：[第04章 - 约束与数据完整性](04-约束与数据完整性.md)** →
