---
title: 动态SQL
---

# 动态SQL

## 一、动态SQL简介

### 1.1 什么是动态SQL？

**动态 SQL** 是 MyBatis 的强大特性，可以根据条件动态拼接 SQL 语句。

**作用：**
- 避免拼接 SQL 字符串
- 简化复杂查询
- 提高代码可读性

### 1.2 动态SQL元素

| 元素 | 说明 |
|------|------|
| if | 条件判断 |
| choose | 多分支选择（类似switch） |
| when | choose的分支 |
| otherwise | choose的默认分支 |
| where | 动态WHERE子句 |
| set | 动态SET子句 |
| trim | 自定义字符串截取 |
| foreach | 循环 |
| bind | 创建变量 |

---

## 二、if（条件判断）

### 2.1 基本使用

```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <if test="username != null and username != ''">
        AND username LIKE #{username}
    </if>
    <if test="age != null">
        AND age = #{age}
    </if>
    <if test="email != null">
        AND email = #{email}
    </if>
</select>
```

### 2.2 test表达式

**支持的判断：**
```xml
<!-- 非空判断 -->
<if test="username != null">

<!-- 字符串非空 -->
<if test="username != null and username != ''">

<!-- 数字比较 -->
<if test="age > 18">

<!-- 布尔值 -->
<if test="enabled">

<!-- 集合非空 -->
<if test="list != null and list.size() > 0">
```

---

## 三、where（动态WHERE）

### 3.1 问题场景

**不使用 where：**
```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <if test="username != null">
        AND username = #{username}
    </if>
</select>
```

**问题：** WHERE 1=1 不优雅

### 3.2 使用where标签

```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    <where>
        <if test="username != null">
            AND username LIKE #{username}
        </if>
        <if test="age != null">
            AND age = #{age}
        </if>
        <if test="email != null">
            AND email = #{email}
        </if>
    </where>
</select>
```

**自动处理：**
- 自动添加 WHERE 关键字
- 自动删除开头的 AND 或 OR

---

## 四、set（动态SET）

### 4.1 动态更新

```xml
<update id="updateSelective">
    UPDATE user
    <set>
        <if test="username != null">
            username = #{username},
        </if>
        <if test="email != null">
            email = #{email},
        </if>
        <if test="age != null">
            age = #{age},
        </if>
    </set>
    WHERE id = #{id}
</update>
```

**自动处理：**
- 自动添加 SET 关键字
- 自动删除末尾的逗号

---

## 五、choose、when、otherwise

### 5.1 多分支选择

**类似 Java 的 switch：**
```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    WHERE 1=1
    <choose>
        <when test="username != null">
            AND username = #{username}
        </when>
        <when test="email != null">
            AND email = #{email}
        </when>
        <otherwise>
            AND age > 18
        </otherwise>
    </choose>
</select>
```

**执行逻辑：**
- 满足第一个 when 条件，执行并结束
- 不满足，检查下一个 when
- 都不满足，执行 otherwise

---

## 六、trim（自定义截取）

### 6.1 trim属性

```xml
<trim prefix="WHERE" prefixOverrides="AND |OR ">
    <if test="username != null">
        AND username = #{username}
    </if>
</trim>
```

**属性说明：**
- `prefix`：添加前缀
- `suffix`：添加后缀
- `prefixOverrides`：删除开头的内容
- `suffixOverrides`：删除结尾的内容

### 6.2 模拟where

```xml
<trim prefix="WHERE" prefixOverrides="AND |OR ">
    <if test="username != null">
        AND username = #{username}
    </if>
    <if test="age != null">
        AND age = #{age}
    </if>
</trim>
```

### 6.3 模拟set

```xml
<trim prefix="SET" suffixOverrides=",">
    <if test="username != null">
        username = #{username},
    </if>
    <if test="email != null">
        email = #{email},
    </if>
</trim>
```

---

## 七、foreach（循环）

### 7.1 IN查询

```xml
<select id="selectByIds" resultType="User">
    SELECT * FROM user
    WHERE id IN
    <foreach collection="ids" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

**生成SQL：**
```sql
SELECT * FROM user WHERE id IN (1, 2, 3, 4, 5)
```

### 7.2 批量插入

```xml
<insert id="insertBatch">
    INSERT INTO user (username, email, age) VALUES
    <foreach collection="list" item="user" separator=",">
        (#{user.username}, #{user.email}, #{user.age})
    </foreach>
</insert>
```

**生成SQL：**
```sql
INSERT INTO user (username, email, age) VALUES
    ('张三', 'zhangsan@example.com', 20),
    ('李四', 'lisi@example.com', 25)
```

### 7.3 foreach属性

| 属性 | 说明 |
|------|------|
| collection | 集合名称（list、array、map的key） |
| item | 集合中的元素变量名 |
| index | 索引变量名 |
| open | 开始字符 |
| close | 结束字符 |
| separator | 分隔符 |

### 7.4 collection参数

**List：**
```java
List<User> selectByList(@Param("list") List<Long> ids);
```
```xml
<foreach collection="list" item="id">
```

**Array：**
```java
List<User> selectByArray(Long[] ids);
```
```xml
<foreach collection="array" item="id">
```

**Map：**
```java
List<User> selectByMap(@Param("ids") List<Long> ids);
```
```xml
<foreach collection="ids" item="id">
```

---

## 八、bind（变量绑定）

### 8.1 创建变量

```xml
<select id="selectByUsername" resultType="User">
    <bind name="pattern" value="'%' + username + '%'"/>
    SELECT * FROM user
    WHERE username LIKE #{pattern}
</select>
```

**作用：**
- 创建临时变量
- 简化复杂表达式

### 8.2 模糊查询

**不使用 bind：**
```xml
<select id="selectByUsername" resultType="User">
    SELECT * FROM user
    WHERE username LIKE CONCAT('%', #{username}, '%')
</select>
```

**使用 bind：**
```xml
<select id="selectByUsername" resultType="User">
    <bind name="pattern" value="'%' + username + '%'"/>
    SELECT * FROM user
    WHERE username LIKE #{pattern}
</select>
```

---

## 九、实战案例

### 9.1 复杂查询

```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    <where>
        <!-- 用户名模糊查询 -->
        <if test="username != null and username != ''">
            <bind name="usernamePattern" value="'%' + username + '%'"/>
            AND username LIKE #{usernamePattern}
        </if>
        
        <!-- 年龄范围查询 -->
        <if test="minAge != null">
            AND age >= #{minAge}
        </if>
        <if test="maxAge != null">
            AND age &lt;= #{maxAge}
        </if>
        
        <!-- 邮箱查询 -->
        <choose>
            <when test="email != null">
                AND email = #{email}
            </when>
            <when test="emailDomain != null">
                AND email LIKE CONCAT('%@', #{emailDomain})
            </when>
        </choose>
        
        <!-- 状态查询 -->
        <if test="statuses != null and statuses.size() > 0">
            AND status IN
            <foreach collection="statuses" item="status" open="(" close=")" separator=",">
                #{status}
            </foreach>
        </if>
    </where>
    
    <!-- 动态排序 -->
    <if test="orderBy != null">
        ORDER BY ${orderBy}
        <if test="orderDirection != null">
            ${orderDirection}
        </if>
    </if>
</select>
```

### 9.2 批量更新

```xml
<update id="updateBatch">
    <foreach collection="list" item="user" separator=";">
        UPDATE user
        <set>
            <if test="user.username != null">
                username = #{user.username},
            </if>
            <if test="user.email != null">
                email = #{user.email},
            </if>
            <if test="user.age != null">
                age = #{user.age}
            </if>
        </set>
        WHERE id = #{user.id}
    </foreach>
</update>
```

**注意：** MySQL 需要开启批量执行：
```
jdbc:mysql://localhost:3306/test?allowMultiQueries=true
```

---

## 十、最佳实践

### 10.1 使用建议

**1. 优先使用 where、set**
```xml
<!-- ✅ 推荐 -->
<where>
    <if test="username != null">
        AND username = #{username}
    </if>
</where>

<!-- ❌ 不推荐 -->
WHERE 1=1
<if test="username != null">
    AND username = #{username}
</if>
```

**2. 字符串判空**
```xml
<!-- ✅ 完整判断 -->
<if test="username != null and username != ''">

<!-- ❌ 只判断null -->
<if test="username != null">
```

**3. 使用 bind 简化**
```xml
<!-- ✅ 使用 bind -->
<bind name="pattern" value="'%' + username + '%'"/>
WHERE username LIKE #{pattern}

<!-- ❌ 直接拼接 -->
WHERE username LIKE CONCAT('%', #{username}, '%')
```

**4. foreach 指定 collection**
```xml
<!-- ✅ 使用 @Param -->
List<User> selectByIds(@Param("ids") List<Long> ids);
<foreach collection="ids" item="id">

<!-- ❌ 默认名称（容易出错） -->
<foreach collection="list" item="id">
```

---

## 十一、总结

✅ **本章学习内容：**
- if 条件判断
- where、set 动态子句
- choose、when、otherwise 多分支
- trim 自定义截取
- foreach 循环
- bind 变量绑定
- 实战案例

✅ **核心要点：**
- 动态 SQL 简化复杂查询
- where 和 set 自动处理关键字
- foreach 用于 IN 和批量操作
- 字符串判空要完整

**下一章预告：** 我们将学习 MyBatis 高级映射。
