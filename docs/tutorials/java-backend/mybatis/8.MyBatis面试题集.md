---
title: MyBatisé¢è¯•é¢˜é›†
---

# MyBatisé¢è¯•é¢˜é›†

## ä¸€ã€åŸºç¡€æ¦‚å¿µ

### 1. ä»€ä¹ˆæ˜¯MyBatisï¼Ÿ

**ç­”ï¼š**

MyBatis æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰ SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- åŠè‡ªåŠ¨ ORM æ¡†æ¶
- SQL ä¸ä»£ç åˆ†ç¦»
- æ”¯æŒåŠ¨æ€ SQL
- ç®€åŒ– JDBC æ“ä½œ
- çµæ´»çš„ç»“æœæ˜ å°„

---

### 2. MyBatiså’ŒHibernateçš„åŒºåˆ«ï¼Ÿ

**ç­”ï¼š**

| ç‰¹æ€§ | MyBatis | Hibernate |
|------|---------|-----------|
| **ç±»å‹** | åŠè‡ªåŠ¨ ORM | å…¨è‡ªåŠ¨ ORM |
| **SQLæ§åˆ¶** | å®Œå…¨æ§åˆ¶ | è‡ªåŠ¨ç”Ÿæˆ |
| **å­¦ä¹ æ›²çº¿** | å¹³ç¼“ | é™¡å³­ |
| **æ€§èƒ½ä¼˜åŒ–** | å®¹æ˜“ | å›°éš¾ |
| **å¤æ‚æŸ¥è¯¢** | æ“…é•¿ | è¾ƒå¼± |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚ä¸šåŠ¡ | ç®€å•CRUD |

**é€‰æ‹©å»ºè®®ï¼š**
- éœ€è¦ SQL ä¼˜åŒ–ã€å¤æ‚æŸ¥è¯¢ â†’ MyBatis
- å¿«é€Ÿå¼€å‘ã€ç®€å• CRUD â†’ Hibernate

---

### 3. MyBatisçš„æ‰§è¡Œæµç¨‹ï¼Ÿ

**ç­”ï¼š**

```
1. è¯»å–é…ç½®æ–‡ä»¶ï¼ˆmybatis-config.xmlï¼‰
   â†“
2. åˆ›å»º SqlSessionFactory
   â†“
3. åˆ›å»º SqlSession
   â†“
4. è·å– Mapper æ¥å£ä»£ç†å¯¹è±¡
   â†“
5. æ‰§è¡Œ SQLï¼ˆé€šè¿‡ Mapper XMLï¼‰
   â†“
6. Executor æ‰§è¡Œ SQL
   â†“
7. StatementHandler å¤„ç† SQL
   â†“
8. ParameterHandler è®¾ç½®å‚æ•°
   â†“
9. ResultSetHandler å¤„ç†ç»“æœ
   â†“
10. è¿”å›ç»“æœ
```

---

## äºŒã€é…ç½®ç›¸å…³

### 4. #{}å’Œ${}çš„åŒºåˆ«ï¼Ÿ

**ç­”ï¼š**

| ç‰¹æ€§ | #{} | ${} |
|------|-----|-----|
| **å¤„ç†æ–¹å¼** | é¢„ç¼–è¯‘ï¼ˆå ä½ç¬¦ï¼‰ | å­—ç¬¦ä¸²æ‹¼æ¥ |
| **SQLæ³¨å…¥** | é˜²æ­¢ | å¯èƒ½ |
| **å¼•å·** | è‡ªåŠ¨æ·»åŠ  | ä¸æ·»åŠ  |
| **æ€§èƒ½** | å¥½ï¼ˆæœ‰ç¼“å­˜ï¼‰ | ä¸€èˆ¬ |
| **ä½¿ç”¨åœºæ™¯** | å‚æ•°å€¼ | åˆ—åã€è¡¨å |

**ç¤ºä¾‹ï¼š**
```xml
<!-- #{} æ¨è -->
SELECT * FROM user WHERE id = #{id}
<!-- ç”Ÿæˆï¼šSELECT * FROM user WHERE id = ? -->

<!-- ${} æ…ç”¨ -->
SELECT * FROM user ORDER BY ${column}
<!-- ç”Ÿæˆï¼šSELECT * FROM user ORDER BY username -->
```

**ä½¿ç”¨å»ºè®®ï¼š**
- 99% çš„æƒ…å†µä½¿ç”¨ #{}
- åŠ¨æ€åˆ—åã€è¡¨åä½¿ç”¨ ${}

---

### 5. resultTypeå’ŒresultMapçš„åŒºåˆ«ï¼Ÿ

**ç­”ï¼š**

**resultTypeï¼š**
- ç®€å•æ˜ å°„
- è‡ªåŠ¨æ˜ å°„ï¼ˆéœ€å¼€å¯é©¼å³°ï¼‰
- é€‚ç”¨äºå•è¡¨æŸ¥è¯¢
```xml
<select id="selectById" resultType="User">
    SELECT * FROM user WHERE id = #{id}
</select>
```

**resultMapï¼š**
- å¤æ‚æ˜ å°„
- æ‰‹åŠ¨é…ç½®
- é€‚ç”¨äºå¤šè¡¨å…³è”
```xml
<resultMap id="userResultMap" type="User">
    <id property="id" column="id"/>
    <result property="username" column="username"/>
    <association property="department" javaType="Department">
        <id property="id" column="dept_id"/>
        <result property="name" column="dept_name"/>
    </association>
</resultMap>
```

---

### 6. MyBatiså¦‚ä½•è·å–è‡ªå¢ä¸»é”®ï¼Ÿ

**ç­”ï¼š**

**æ–¹å¼ä¸€ï¼šuseGeneratedKeysï¼ˆæ¨èï¼‰**
```xml
<insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user (username, email) VALUES (#{username}, #{email})
</insert>
```

**æ–¹å¼äºŒï¼šselectKey**
```xml
<insert id="insert">
    <selectKey keyProperty="id" resultType="long" order="AFTER">
        SELECT LAST_INSERT_ID()
    </selectKey>
    INSERT INTO user (username, email) VALUES (#{username}, #{email})
</insert>
```

**ä½¿ç”¨ï¼š**
```java
User user = new User();
user.setUsername("å¼ ä¸‰");
userMapper.insert(user);
System.out.println("ç”Ÿæˆçš„IDï¼š" + user.getId());
```

---

## ä¸‰ã€åŠ¨æ€SQL

### 7. MyBatisçš„åŠ¨æ€SQLæœ‰å“ªäº›ï¼Ÿ

**ç­”ï¼š**

| å…ƒç´  | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| if | æ¡ä»¶åˆ¤æ–­ | `<if test="username != null">` |
| choose | å¤šåˆ†æ”¯ | `<choose><when><otherwise>` |
| where | åŠ¨æ€WHERE | `<where>` |
| set | åŠ¨æ€SET | `<set>` |
| trim | è‡ªå®šä¹‰æˆªå– | `<trim>` |
| foreach | å¾ªç¯ | `<foreach>` |
| bind | å˜é‡ç»‘å®š | `<bind>` |

**ç¤ºä¾‹ï¼š**
```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    <where>
        <if test="username != null">
            AND username LIKE #{username}
        </if>
        <if test="age != null">
            AND age = #{age}
        </if>
    </where>
</select>
```

---

### 8. foreachå¦‚ä½•ä½¿ç”¨ï¼Ÿ

**ç­”ï¼š**

**IN æŸ¥è¯¢ï¼š**
```xml
<select id="selectByIds" resultType="User">
    SELECT * FROM user WHERE id IN
    <foreach collection="ids" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</select>
```

**æ‰¹é‡æ’å…¥ï¼š**
```xml
<insert id="insertBatch">
    INSERT INTO user (username, email) VALUES
    <foreach collection="list" item="user" separator=",">
        (#{user.username}, #{user.email})
    </foreach>
</insert>
```

**å±æ€§è¯´æ˜ï¼š**
- `collection`ï¼šé›†åˆåç§°ï¼ˆlistã€arrayã€idsï¼‰
- `item`ï¼šå…ƒç´ å˜é‡å
- `open`ï¼šå¼€å§‹å­—ç¬¦
- `close`ï¼šç»“æŸå­—ç¬¦
- `separator`ï¼šåˆ†éš”ç¬¦

---

## å››ã€ç¼“å­˜æœºåˆ¶

### 9. MyBatisçš„ç¼“å­˜æœºåˆ¶ï¼Ÿ

**ç­”ï¼š**

**ä¸€çº§ç¼“å­˜ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼š**
- SqlSession çº§åˆ«
- åŒä¸€ä¸ª SqlSession å†…æœ‰æ•ˆ
- å­˜å‚¨åœ¨å†…å­˜ï¼ˆHashMapï¼‰
- SqlSession å…³é—­å¤±æ•ˆ

**äºŒçº§ç¼“å­˜ï¼ˆéœ€è¦é…ç½®ï¼‰ï¼š**
- Mapper çº§åˆ«
- åŒä¸€ä¸ª Mapper çš„æ‰€æœ‰ SqlSession å…±äº«
- éœ€è¦æ‰‹åŠ¨å¼€å¯
- å®ä½“ç±»å®ç° Serializable

**æŸ¥è¯¢é¡ºåºï¼š**
```
äºŒçº§ç¼“å­˜ â†’ ä¸€çº§ç¼“å­˜ â†’ æ•°æ®åº“
```

---

### 10. ä¸€çº§ç¼“å­˜ä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼Ÿ

**ç­”ï¼š**

**å¤±æ•ˆåœºæ™¯ï¼š**
1. **ä¸åŒçš„ SqlSession**
2. **åŒä¸€ä¸ª SqlSessionï¼Œä¸åŒçš„æŸ¥è¯¢æ¡ä»¶**
3. **æ‰§è¡Œäº†å¢åˆ æ”¹æ“ä½œ**
4. **æ‰‹åŠ¨æ¸…ç©ºç¼“å­˜ï¼ˆclearCacheï¼‰**

**ç¤ºä¾‹ï¼š**
```java
SqlSession session = SqlSessionUtil.getSqlSession();
UserMapper mapper = session.getMapper(UserMapper.class);

User user1 = mapper.selectById(1L);  // æŸ¥æ•°æ®åº“

// æ‰§è¡Œæ›´æ–°ï¼Œç¼“å­˜å¤±æ•ˆ
mapper.update(new User());

User user2 = mapper.selectById(1L);  // å†æ¬¡æŸ¥æ•°æ®åº“

session.close();
```

---

## äº”ã€é«˜çº§ç‰¹æ€§

### 11. MyBatiså¦‚ä½•å®ç°ä¸€å¯¹ä¸€å…³è”ï¼Ÿ

**ç­”ï¼š**

**æ–¹å¼ä¸€ï¼šåµŒå¥—æŸ¥è¯¢**
```xml
<resultMap id="userWithCard" type="User">
    <id property="id" column="id"/>
    <result property="username" column="username"/>
    <association property="idCard" column="card_id" 
                 select="selectCardById"/>
</resultMap>

<select id="selectById" resultMap="userWithCard">
    SELECT * FROM user WHERE id = #{id}
</select>

<select id="selectCardById" resultType="IdCard">
    SELECT * FROM id_card WHERE id = #{id}
</select>
```

**æ–¹å¼äºŒï¼šåµŒå¥—ç»“æœï¼ˆæ¨èï¼‰**
```xml
<resultMap id="userWithCard" type="User">
    <id property="id" column="id"/>
    <result property="username" column="username"/>
    <association property="idCard" javaType="IdCard">
        <id property="id" column="card_id"/>
        <result property="cardNumber" column="card_number"/>
    </association>
</resultMap>

<select id="selectById" resultMap="userWithCard">
    SELECT u.*, c.id as card_id, c.card_number
    FROM user u
    LEFT JOIN id_card c ON u.card_id = c.id
    WHERE u.id = #{id}
</select>
```

---

### 12. MyBatiså¦‚ä½•å®ç°ä¸€å¯¹å¤šå…³è”ï¼Ÿ

**ç­”ï¼š**

**ä½¿ç”¨ collectionï¼š**
```xml
<resultMap id="deptWithEmps" type="Department">
    <id property="id" column="id"/>
    <result property="deptName" column="dept_name"/>
    <collection property="employees" ofType="Employee">
        <id property="id" column="emp_id"/>
        <result property="empName" column="emp_name"/>
    </collection>
</resultMap>

<select id="selectById" resultMap="deptWithEmps">
    SELECT d.*, e.id as emp_id, e.emp_name
    FROM department d
    LEFT JOIN employee e ON d.id = e.dept_id
    WHERE d.id = #{id}
</select>
```

---

### 13. ä»€ä¹ˆæ˜¯å»¶è¿ŸåŠ è½½ï¼Ÿå¦‚ä½•å¼€å¯ï¼Ÿ

**ç­”ï¼š**

**å»¶è¿ŸåŠ è½½ï¼š** æŸ¥è¯¢ä¸»å¯¹è±¡æ—¶ï¼Œä¸ç«‹å³æŸ¥è¯¢å…³è”å¯¹è±¡ï¼Œåœ¨ä½¿ç”¨æ—¶æ‰æŸ¥è¯¢ã€‚

**å¼€å¯ï¼š**
```xml
<!-- å…¨å±€é…ç½® -->
<settings>
    <setting name="lazyLoadingEnabled" value="true"/>
    <setting name="aggressiveLazyLoading" value="false"/>
</settings>

<!-- Mapper é…ç½® -->
<association property="idCard" column="card_id" 
             select="selectCardById"
             fetchType="lazy"/>
```

**æ³¨æ„ï¼š** åªæœ‰åµŒå¥—æŸ¥è¯¢æ”¯æŒå»¶è¿ŸåŠ è½½ã€‚

---

## å…­ã€å®æˆ˜ç»éªŒ

### 14. MyBatiså¦‚ä½•é˜²æ­¢SQLæ³¨å…¥ï¼Ÿ

**ç­”ï¼š**

**1. ä½¿ç”¨ #{} é¢„ç¼–è¯‘**
```xml
<!-- âœ… æ¨è -->
SELECT * FROM user WHERE id = #{id}

<!-- âŒ ä¸æ¨è -->
SELECT * FROM user WHERE id = ${id}
```

**2. å‚æ•°éªŒè¯**
```java
if (id == null || id <= 0) {
    throw new IllegalArgumentException("IDä¸åˆæ³•");
}
```

**3. ç™½åå•æ ¡éªŒ**
```java
// åŠ¨æ€æ’åºæ—¶ï¼Œä½¿ç”¨ç™½åå•
List<String> allowedColumns = Arrays.asList("id", "username", "create_time");
if (!allowedColumns.contains(orderBy)) {
    throw new IllegalArgumentException("éæ³•çš„æ’åºå­—æ®µ");
}
```

---

### 15. MyBatisçš„N+1é—®é¢˜ï¼Ÿ

**ç­”ï¼š**

**é—®é¢˜ï¼š** åµŒå¥—æŸ¥è¯¢ä¼šå¯¼è‡´å¤šæ¬¡æŸ¥è¯¢æ•°æ®åº“ã€‚

**ç¤ºä¾‹ï¼š**
```
æŸ¥è¯¢10ä¸ªéƒ¨é—¨ï¼Œæ¯ä¸ªéƒ¨é—¨æŸ¥è¯¢å‘˜å·¥
SQL æ‰§è¡Œæ¬¡æ•°ï¼š1ï¼ˆæŸ¥éƒ¨é—¨ï¼‰+ 10ï¼ˆæŸ¥å‘˜å·¥ï¼‰= 11æ¬¡
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. **ä½¿ç”¨åµŒå¥—ç»“æœï¼ˆæ¨èï¼‰**
```xml
<!-- ä¸€æ¬¡JOINæŸ¥è¯¢ -->
<select id="selectById" resultMap="deptWithEmps">
    SELECT d.*, e.*
    FROM department d
    LEFT JOIN employee e ON d.id = e.dept_id
    WHERE d.id = #{id}
</select>
```

2. **å¼€å¯å»¶è¿ŸåŠ è½½**
```xml
<settings>
    <setting name="lazyLoadingEnabled" value="true"/>
</settings>
```

---

### 16. MyBatiså¦‚ä½•æ‰¹é‡æ’å…¥ï¼Ÿ

**ç­”ï¼š**

**æ–¹å¼ä¸€ï¼šforeach**
```xml
<insert id="insertBatch">
    INSERT INTO user (username, email) VALUES
    <foreach collection="list" item="user" separator=",">
        (#{user.username}, #{user.email})
    </foreach>
</insert>
```

**æ–¹å¼äºŒï¼šExecutorType.BATCH**
```java
SqlSession session = sqlSessionFactory.openSession(ExecutorType.BATCH);
UserMapper mapper = session.getMapper(UserMapper.class);

for (User user : users) {
    mapper.insert(user);
}

session.commit();
session.close();
```

---

## ä¸ƒã€ç»¼åˆé¢˜

### 17. MyBatisçš„æ ¸å¿ƒç»„ä»¶ï¼Ÿ

**ç­”ï¼š**

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| SqlSessionFactoryBuilder | æ„å»º SqlSessionFactory |
| SqlSessionFactory | åˆ›å»º SqlSession çš„å·¥å‚ |
| SqlSession | æ‰§è¡Œ SQL çš„ä¼šè¯ |
| Executor | æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œ SQL |
| StatementHandler | è¯­å¥å¤„ç†å™¨ |
| ParameterHandler | å‚æ•°å¤„ç†å™¨ |
| ResultSetHandler | ç»“æœå¤„ç†å™¨ |
| Mapper | SQL æ˜ å°„å™¨æ¥å£ |

---

### 18. SqlSessionæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ

**ç­”ï¼š**

**ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚**

**åŸå› ï¼š**
- SqlSession åŒ…å«äº†çŠ¶æ€
- ä¸€çº§ç¼“å­˜å­˜å‚¨åœ¨ SqlSession ä¸­

**ä½¿ç”¨å»ºè®®ï¼š**
- SqlSession åº”è¯¥æ˜¯æ–¹æ³•çº§åˆ«çš„
- ä½¿ç”¨ååŠæ—¶å…³é—­
- ä¸è¦åœ¨å…¨å±€æˆ–å•ä¾‹ä¸­ä½¿ç”¨

**æ­£ç¡®ä½¿ç”¨ï¼š**
```java
try (SqlSession session = sqlSessionFactory.openSession()) {
    UserMapper mapper = session.getMapper(UserMapper.class);
    // æ‰§è¡ŒSQL
}
```

---

### 19. MyBatisæ’ä»¶çš„åŸç†ï¼Ÿ

**ç­”ï¼š**

**åŸç†ï¼š** ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œæ‹¦æˆª Executorã€StatementHandlerã€ParameterHandlerã€ResultSetHandler çš„æ–¹æ³•ã€‚

**å¯æ‹¦æˆªçš„å¯¹è±¡å’Œæ–¹æ³•ï¼š**
- Executor (update, query, commit, rollback)
- ParameterHandler (getParameterObject, setParameters)
- ResultSetHandler (handleResultSets, handleOutputParameters)
- StatementHandler (prepare, parameterize, batch, update, query)

**è‡ªå®šä¹‰æ’ä»¶ï¼š**
```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, 
                      RowBounds.class, ResultHandler.class})
})
public class MyPlugin implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // å‰ç½®å¤„ç†
        Object result = invocation.proceed();
        // åç½®å¤„ç†
        return result;
    }
}
```

---

### 20. MyBatiså¦‚ä½•æ•´åˆSpringï¼Ÿ

**ç­”ï¼š**

**æ·»åŠ ä¾èµ–ï¼š**
```xml
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
</dependency>
```

**é…ç½®ï¼š**
```yaml
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.example.entity
  configuration:
    map-underscore-to-camel-case: true
```

**ä½¿ç”¨ï¼š**
```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    public User findById(Long id) {
        return userMapper.selectById(id);
    }
}
```

---

## å…«ã€æ€»ç»“

### é«˜é¢‘è€ƒç‚¹

âœ… **å¿…é¡»æŒæ¡ï¼š**
- MyBatis æ‰§è¡Œæµç¨‹
- #{} vs ${}
- resultType vs resultMap
- åŠ¨æ€ SQLï¼ˆifã€whereã€foreachï¼‰
- ä¸€çº§ç¼“å­˜ vs äºŒçº§ç¼“å­˜
- ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šæ˜ å°„

âœ… **åŠ åˆ†é¡¹ï¼š**
- N+1 é—®é¢˜è§£å†³
- SQL æ³¨å…¥é˜²æ­¢
- æ’ä»¶åŸç†
- æ‰¹é‡æ“ä½œ
- æ€§èƒ½ä¼˜åŒ–

### é¢è¯•æŠ€å·§

1. **å…ˆè¯´åŸç†ï¼Œå†ä¸¾ä¾‹å­**
2. **ç”»å›¾è¯´æ˜æ‰§è¡Œæµç¨‹**
3. **å¯¹æ¯” MyBatis å’Œ Hibernate**
4. **ç»“åˆé¡¹ç›®ç»éªŒ**
5. **è¯´æ˜æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**

---

**æ­å–œä½ å®Œæˆ MyBatis å­¦ä¹ ï¼ğŸ‰**
