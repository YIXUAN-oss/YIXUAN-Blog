---
title: 注解开发
---

# 注解开发

## 一、注解开发概述

### 1.1 注解 vs XML

| 特性 | 注解开发 | XML开发 |
|------|---------|--------|
| **代码量** | 少 | 多 |
| **灵活性** | 一般 | 强 |
| **维护性** | 一般 | 好 |
| **复杂SQL** | 不适合 | 适合 |
| **动态SQL** | 支持（较弱） | 支持（强） |
| **推荐场景** | 简单CRUD | 复杂查询 |

### 1.2 常用注解

| 注解 | 说明 |
|------|------|
| @Select | 查询 |
| @Insert | 插入 |
| @Update | 更新 |
| @Delete | 删除 |
| @Param | 参数映射 |
| @Results | 结果映射 |
| @Result | 字段映射 |
| @One | 一对一关联 |
| @Many | 一对多关联 |

---

## 二、基本CRUD

### 2.1 @Select

**简单查询：**
```java
public interface UserMapper {
    
    @Select("SELECT * FROM user WHERE id = #{id}")
    User selectById(Long id);
    
    @Select("SELECT * FROM user")
    List<User> selectAll();
}
```

**多个参数：**
```java
@Select("SELECT * FROM user WHERE username = #{username} AND age = #{age}")
User selectByUsernameAndAge(@Param("username") String username, 
                            @Param("age") Integer age);
```

### 2.2 @Insert

**基本插入：**
```java
@Insert("INSERT INTO user (username, email, age) VALUES (#{username}, #{email}, #{age})")
int insert(User user);
```

**获取自增主键：**
```java
@Insert("INSERT INTO user (username, email, age) VALUES (#{username}, #{email}, #{age})")
@Options(useGeneratedKeys = true, keyProperty = "id")
int insert(User user);
```

**批量插入：**
```java
@Insert("<script>" +
        "INSERT INTO user (username, email, age) VALUES " +
        "<foreach collection='list' item='user' separator=','>" +
        "(#{user.username}, #{user.email}, #{user.age})" +
        "</foreach>" +
        "</script>")
int insertBatch(List<User> users);
```

### 2.3 @Update

```java
@Update("UPDATE user SET username = #{username}, email = #{email}, age = #{age} WHERE id = #{id}")
int update(User user);
```

### 2.4 @Delete

```java
@Delete("DELETE FROM user WHERE id = #{id}")
int deleteById(Long id);
```

---

## 三、结果映射

### 3.1 自动映射

**开启驼峰命名：**
```xml
<settings>
    <setting name="mapUnderscoreToCamelCase" value="true"/>
</settings>
```

**自动映射：**
```java
@Select("SELECT * FROM user WHERE id = #{id}")
User selectById(Long id);  // create_time → createTime
```

### 3.2 @Results

**手动映射：**
```java
@Select("SELECT * FROM user WHERE id = #{id}")
@Results(id = "userResultMap", value = {
    @Result(property = "id", column = "id", id = true),
    @Result(property = "username", column = "username"),
    @Result(property = "email", column = "email"),
    @Result(property = "createTime", column = "create_time")
})
User selectById(Long id);
```

**复用映射：**
```java
@Select("SELECT * FROM user")
@ResultMap("userResultMap")  // 复用上面定义的映射
List<User> selectAll();
```

---

## 四、动态SQL

### 4.1 @SelectProvider

**提供者类：**
```java
public class UserSqlProvider {
    
    public String selectByCondition(Map<String, Object> params) {
        return new SQL() {{
            SELECT("*");
            FROM("user");
            if (params.get("username") != null) {
                WHERE("username LIKE #{username}");
            }
            if (params.get("age") != null) {
                WHERE("age = #{age}");
            }
        }}.toString();
    }
}
```

**使用：**
```java
@SelectProvider(type = UserSqlProvider.class, method = "selectByCondition")
List<User> selectByCondition(@Param("username") String username, 
                             @Param("age") Integer age);
```

### 4.2 @InsertProvider

```java
public class UserSqlProvider {
    
    public String insert(User user) {
        return new SQL() {{
            INSERT_INTO("user");
            VALUES("username", "#{username}");
            VALUES("email", "#{email}");
            if (user.getAge() != null) {
                VALUES("age", "#{age}");
            }
        }}.toString();
    }
}

@InsertProvider(type = UserSqlProvider.class, method = "insert")
int insert(User user);
```

### 4.3 Script 标签

**使用 XML 语法：**
```java
@Select("<script>" +
        "SELECT * FROM user" +
        "<where>" +
        "  <if test='username != null'>" +
        "    AND username LIKE #{username}" +
        "  </if>" +
        "  <if test='age != null'>" +
        "    AND age = #{age}" +
        "  </if>" +
        "</where>" +
        "</script>")
List<User> selectByCondition(@Param("username") String username, 
                             @Param("age") Integer age);
```

---

## 五、关联查询

### 5.1 一对一（@One）

**实体类：**
```java
@Data
public class User {
    private Long id;
    private String username;
    private IdCard idCard;  // 一对一
}
```

**Mapper：**
```java
@Select("SELECT * FROM user WHERE id = #{id}")
@Results({
    @Result(property = "id", column = "id", id = true),
    @Result(property = "username", column = "username"),
    @Result(property = "idCard", column = "card_id",
            one = @One(select = "selectCardById"))
})
User selectById(Long id);

@Select("SELECT * FROM id_card WHERE id = #{id}")
IdCard selectCardById(Long id);
```

### 5.2 一对多（@Many）

**实体类：**
```java
@Data
public class Department {
    private Long id;
    private String deptName;
    private List<Employee> employees;  // 一对多
}
```

**Mapper：**
```java
@Select("SELECT * FROM department WHERE id = #{id}")
@Results({
    @Result(property = "id", column = "id", id = true),
    @Result(property = "deptName", column = "dept_name"),
    @Result(property = "employees", column = "id",
            many = @Many(select = "selectEmployeesByDeptId"))
})
Department selectById(Long id);

@Select("SELECT * FROM employee WHERE dept_id = #{deptId}")
List<Employee> selectEmployeesByDeptId(Long deptId);
```

---

## 六、混合使用

### 6.1 注解 + XML

**Mapper 接口：**
```java
public interface UserMapper {
    
    // 简单查询用注解
    @Select("SELECT * FROM user WHERE id = #{id}")
    User selectById(Long id);
    
    // 复杂查询用 XML
    List<User> selectByComplexCondition(Map<String, Object> params);
}
```

**UserMapper.xml：**
```xml
<mapper namespace="com.example.mapper.UserMapper">
    
    <select id="selectByComplexCondition" resultType="User">
        SELECT u.*, d.dept_name
        FROM user u
        LEFT JOIN department d ON u.dept_id = d.id
        <where>
            <if test="username != null">
                AND u.username LIKE #{username}
            </if>
            <if test="deptId != null">
                AND u.dept_id = #{deptId}
            </if>
        </where>
    </select>
</mapper>
```

---

## 七、总结

✅ **本章学习内容：**
- 基本 CRUD 注解
- 结果映射（@Results）
- 动态 SQL（@SelectProvider）
- 关联查询（@One、@Many）
- 注解 + XML 混合使用

✅ **核心要点：**
- 简单 CRUD 用注解
- 复杂查询用 XML
- 推荐混合使用
- @Param 标注多个参数

**下一章预告：** 我们将整理 MyBatis 常见面试题。
