---
title: MyBatis基础入门
---

# MyBatis基础入门

## 一、MyBatis是什么？

### 1.1 MyBatis简介

**MyBatis** 是一款优秀的持久层框架，支持自定义 SQL、存储过程以及高级映射。

**前身：** iBatis（2010年迁移到Google Code并改名为MyBatis）

**核心特点：**
- 简化 JDBC 开发
- 半自动 ORM 框架
- SQL 与代码分离
- 支持动态 SQL
- 强大的结果映射

### 1.2 为什么使用MyBatis？

**JDBC 的缺点：**
```java
// JDBC 代码繁琐
Connection conn = DriverManager.getConnection(url, user, password);
PreparedStatement ps = conn.prepareStatement(
    "SELECT * FROM user WHERE id = ?");
ps.setLong(1, id);
ResultSet rs = ps.executeQuery();
User user = null;
if (rs.next()) {
    user = new User();
    user.setId(rs.getLong("id"));
    user.setUsername(rs.getString("username"));
    user.setEmail(rs.getString("email"));
    user.setAge(rs.getInt("age"));
}
rs.close();
ps.close();
conn.close();
```

**MyBatis 简化：**
```java
// MyBatis 代码简洁
User user = userMapper.selectById(id);
```

**MyBatis 的优势：**
- ✅ 简化 JDBC 操作
- ✅ SQL 灵活可控
- ✅ 自动参数映射
- ✅ 自动结果映射
- ✅ 支持复杂查询

---

## 二、MyBatis vs JDBC vs Hibernate

### 2.1 三者对比

| 特性 | JDBC | MyBatis | Hibernate |
|------|------|---------|-----------|
| **类型** | 原生 API | 半自动 ORM | 全自动 ORM |
| **SQL 控制** | 完全控制 | 完全控制 | 自动生成 |
| **代码量** | 很多 | 中等 | 少 |
| **学习曲线** | 平缓 | 平缓 | 陡峭 |
| **性能优化** | 容易 | 容易 | 困难 |
| **复杂查询** | 擅长 | 擅长 | 较弱 |
| **适用场景** | 简单项目 | 复杂业务 | 简单 CRUD |

### 2.2 选择建议

- **JDBC**：学习基础，不推荐项目使用
- **MyBatis**：复杂业务、SQL 优化要求高（推荐）
- **Hibernate**：简单 CRUD、快速开发

---

## 三、MyBatis工作原理

### 3.1 执行流程

```
1. 读取配置文件（mybatis-config.xml）
   ↓
2. 创建 SqlSessionFactory
   ↓
3. 创建 SqlSession
   ↓
4. 获取 Mapper 接口代理对象
   ↓
5. 执行 SQL（通过 Mapper XML）
   ↓
6. 处理结果集
   ↓
7. 返回结果
```

### 3.2 核心组件

| 组件 | 说明 |
|------|------|
| **SqlSessionFactoryBuilder** | 构建 SqlSessionFactory |
| **SqlSessionFactory** | 创建 SqlSession 的工厂 |
| **SqlSession** | 执行 SQL 的会话 |
| **Mapper** | SQL 映射器接口 |
| **Executor** | 执行器，执行 SQL |
| **StatementHandler** | 语句处理器 |
| **ParameterHandler** | 参数处理器 |
| **ResultSetHandler** | 结果处理器 |

---

## 四、创建第一个MyBatis项目

### 4.1 创建数据库

```sql
CREATE DATABASE mybatis_demo;

USE mybatis_demo;

CREATE TABLE user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100),
    age INT,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO user (username, email, age) VALUES
('张三', 'zhangsan@example.com', 20),
('李四', 'lisi@example.com', 25),
('王五', 'wangwu@example.com', 30);
```

### 4.2 创建Maven项目

**pom.xml：**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.example</groupId>
    <artifactId>mybatis-demo</artifactId>
    <version>1.0-SNAPSHOT</version>
    
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    
    <dependencies>
        <!-- MyBatis -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.13</version>
        </dependency>
        
        <!-- MySQL Driver -->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.33</version>
        </dependency>
        
        <!-- Lombok（可选） -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.30</version>
        </dependency>
        
        <!-- JUnit -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

### 4.3 创建配置文件

**resources/mybatis-config.xml：**
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    
    <!-- 设置 -->
    <settings>
        <!-- 开启驼峰命名映射 -->
        <setting name="mapUnderscoreToCamelCase" value="true"/>
        <!-- 打印SQL -->
        <setting name="logImpl" value="STDOUT_LOGGING"/>
    </settings>
    
    <!-- 类型别名 -->
    <typeAliases>
        <package name="com.example.entity"/>
    </typeAliases>
    
    <!-- 环境配置 -->
    <environments default="development">
        <environment id="development">
            <!-- 事务管理器 -->
            <transactionManager type="JDBC"/>
            <!-- 数据源 -->
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis_demo?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>
    
    <!-- 映射器 -->
    <mappers>
        <mapper resource="mapper/UserMapper.xml"/>
    </mappers>
</configuration>
```

### 4.4 创建实体类

**com/example/entity/User.java：**
```java
package com.example.entity;

import lombok.Data;
import java.util.Date;

@Data
public class User {
    private Long id;
    private String username;
    private String email;
    private Integer age;
    private Date createTime;
}
```

### 4.5 创建Mapper接口

**com/example/mapper/UserMapper.java：**
```java
package com.example.mapper;

import com.example.entity.User;
import java.util.List;

public interface UserMapper {
    
    // 查询所有
    List<User> selectAll();
    
    // 根据ID查询
    User selectById(Long id);
    
    // 插入
    int insert(User user);
    
    // 更新
    int update(User user);
    
    // 删除
    int deleteById(Long id);
}
```

### 4.6 创建Mapper XML

**resources/mapper/UserMapper.xml：**
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.UserMapper">
    
    <!-- 查询所有 -->
    <select id="selectAll" resultType="User">
        SELECT * FROM user
    </select>
    
    <!-- 根据ID查询 -->
    <select id="selectById" resultType="User">
        SELECT * FROM user WHERE id = #{id}
    </select>
    
    <!-- 插入 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (username, email, age)
        VALUES (#{username}, #{email}, #{age})
    </insert>
    
    <!-- 更新 -->
    <update id="update">
        UPDATE user
        SET username = #{username},
            email = #{email},
            age = #{age}
        WHERE id = #{id}
    </update>
    
    <!-- 删除 -->
    <delete id="deleteById">
        DELETE FROM user WHERE id = #{id}
    </delete>
</mapper>
```

### 4.7 工具类

**com/example/util/SqlSessionUtil.java：**
```java
package com.example.util;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;

public class SqlSessionUtil {
    
    private static SqlSessionFactory sqlSessionFactory;
    
    static {
        try {
            String resource = "mybatis-config.xml";
            InputStream inputStream = Resources.getResourceAsStream(resource);
            sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    public static SqlSession getSqlSession() {
        return sqlSessionFactory.openSession();
    }
    
    public static SqlSession getSqlSession(boolean autoCommit) {
        return sqlSessionFactory.openSession(autoCommit);
    }
}
```

### 4.8 测试

**com/example/test/UserMapperTest.java：**
```java
package com.example.test;

import com.example.entity.User;
import com.example.mapper.UserMapper;
import com.example.util.SqlSessionUtil;
import org.apache.ibatis.session.SqlSession;
import org.junit.Test;

import java.util.List;

public class UserMapperTest {
    
    @Test
    public void testSelectAll() {
        SqlSession session = SqlSessionUtil.getSqlSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        
        List<User> users = mapper.selectAll();
        users.forEach(System.out::println);
        
        session.close();
    }
    
    @Test
    public void testSelectById() {
        SqlSession session = SqlSessionUtil.getSqlSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        
        User user = mapper.selectById(1L);
        System.out.println(user);
        
        session.close();
    }
    
    @Test
    public void testInsert() {
        SqlSession session = SqlSessionUtil.getSqlSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        
        User user = new User();
        user.setUsername("赵六");
        user.setEmail("zhaoliu@example.com");
        user.setAge(28);
        
        int rows = mapper.insert(user);
        System.out.println("插入行数：" + rows);
        System.out.println("生成的ID：" + user.getId());
        
        session.commit();
        session.close();
    }
    
    @Test
    public void testUpdate() {
        SqlSession session = SqlSessionUtil.getSqlSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        
        User user = mapper.selectById(1L);
        user.setAge(21);
        
        mapper.update(user);
        session.commit();
        session.close();
    }
    
    @Test
    public void testDelete() {
        SqlSession session = SqlSessionUtil.getSqlSession();
        UserMapper mapper = session.getMapper(UserMapper.class);
        
        mapper.deleteById(4L);
        session.commit();
        session.close();
    }
}
```

---

## 五、核心组件详解

### 5.1 SqlSessionFactoryBuilder

**作用：** 构建 SqlSessionFactory

**用法：**
```java
String resource = "mybatis-config.xml";
InputStream inputStream = Resources.getResourceAsStream(resource);
SqlSessionFactory sqlSessionFactory = 
    new SqlSessionFactoryBuilder().build(inputStream);
```

**生命周期：** 方法局部变量

### 5.2 SqlSessionFactory

**作用：** 创建 SqlSession 的工厂

**特点：**
- 线程安全
- 单例模式
- 全局唯一

**用法：**
```java
SqlSession session = sqlSessionFactory.openSession();
SqlSession session = sqlSessionFactory.openSession(true); // 自动提交
```

### 5.3 SqlSession

**作用：** 执行 SQL 的会话

**特点：**
- 线程不安全
- 使用后需要关闭
- 方法级别

**用法：**
```java
try (SqlSession session = sqlSessionFactory.openSession()) {
    UserMapper mapper = session.getMapper(UserMapper.class);
    // 执行SQL
    session.commit(); // 手动提交
}
```

---

## 六、总结

✅ **本章学习内容：**
- MyBatis 是什么？
- MyBatis vs JDBC vs Hibernate
- MyBatis 工作原理
- 创建第一个项目
- 核心组件详解
- CRUD 基本操作

✅ **核心要点：**
- MyBatis 是半自动 ORM 框架
- SQL 与代码分离
- 自动参数和结果映射
- SqlSession 不是线程安全的

**下一章预告：** 我们将学习 MyBatis 配置文件详解。
