---
title: XML映射文件
---

# XML映射文件

## 一、Mapper XML基本结构

### 1.1 完整结构

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.UserMapper">
    
    <!-- SQL片段 -->
    <sql id="baseColumn">
        id, username, email, age, create_time
    </sql>
    
    <!-- 结果映射 -->
    <resultMap id="userResultMap" type="User">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
    </resultMap>
    
    <!-- 查询 -->
    <select id="selectById" resultType="User">
        SELECT * FROM user WHERE id = #{id}
    </select>
    
    <!-- 插入 -->
    <insert id="insert">
        INSERT INTO user (username, email) VALUES (#{username}, #{email})
    </insert>
    
    <!-- 更新 -->
    <update id="update">
        UPDATE user SET username = #{username} WHERE id = #{id}
    </update>
    
    <!-- 删除 -->
    <delete id="deleteById">
        DELETE FROM user WHERE id = #{id}
    </delete>
</mapper>
```

---

## 二、select（查询）

### 2.1 基本查询

```xml
<select id="selectById" resultType="User">
    SELECT * FROM user WHERE id = #{id}
</select>
```

**属性说明：**
- `id`：对应 Mapper 接口的方法名
- `resultType`：返回值类型
- `parameterType`：参数类型（可省略）

### 2.2 返回List

```xml
<select id="selectAll" resultType="User">
    SELECT * FROM user
</select>
```

**Mapper 接口：**
```java
List<User> selectAll();
```

### 2.3 返回Map

```xml
<select id="selectMap" resultType="map">
    SELECT id, username FROM user WHERE id = #{id}
</select>
```

**返回：**
```java
{id=1, username="张三"}
```

### 2.4 返回Map集合

```xml
<select id="selectAllMap" resultType="map">
    SELECT id, username FROM user
</select>
```

**Mapper 接口：**
```java
@MapKey("id")  // 指定 key
Map<Long, User> selectAllMap();
```

---

## 三、insert（插入）

### 3.1 基本插入

```xml
<insert id="insert">
    INSERT INTO user (username, email, age)
    VALUES (#{username}, #{email}, #{age})
</insert>
```

### 3.2 获取自增主键

**方式一：useGeneratedKeys（推荐）**
```xml
<insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user (username, email, age)
    VALUES (#{username}, #{email}, #{age})
</insert>
```

**使用：**
```java
User user = new User();
user.setUsername("张三");
userMapper.insert(user);
System.out.println("生成的ID：" + user.getId());
```

**方式二：selectKey**
```xml
<insert id="insert">
    <selectKey keyProperty="id" resultType="long" order="AFTER">
        SELECT LAST_INSERT_ID()
    </selectKey>
    INSERT INTO user (username, email, age)
    VALUES (#{username}, #{email}, #{age})
</insert>
```

### 3.3 批量插入

```xml
<insert id="insertBatch">
    INSERT INTO user (username, email, age) VALUES
    <foreach collection="list" item="user" separator=",">
        (#{user.username}, #{user.email}, #{user.age})
    </foreach>
</insert>
```

---

## 四、update（更新）

### 4.1 基本更新

```xml
<update id="update">
    UPDATE user
    SET username = #{username},
        email = #{email},
        age = #{age}
    WHERE id = #{id}
</update>
```

### 4.2 动态更新

```xml
<update id="updateSelective">
    UPDATE user
    <set>
        <if test="username != null">
            username = #{username},
        </if>
        <if test="email != null">
            email = #{email},
        </if>
        <if test="age != null">
            age = #{age}
        </if>
    </set>
    WHERE id = #{id}
</update>
```

---

## 五、delete（删除）

### 5.1 基本删除

```xml
<delete id="deleteById">
    DELETE FROM user WHERE id = #{id}
</delete>
```

### 5.2 批量删除

```xml
<delete id="deleteBatch">
    DELETE FROM user WHERE id IN
    <foreach collection="ids" item="id" open="(" close=")" separator=",">
        #{id}
    </foreach>
</delete>
```

---

## 六、参数映射

### 6.1 单个参数

```xml
<!-- 直接使用 #{参数名} -->
<select id="selectById" resultType="User">
    SELECT * FROM user WHERE id = #{id}
</select>
```

**Mapper接口：**
```java
User selectById(Long id);
User selectById(@Param("id") Long id);  // 推荐
```

### 6.2 多个参数

**方式一：@Param 注解（推荐）**
```java
List<User> selectByCondition(@Param("username") String username, 
                             @Param("age") Integer age);
```

```xml
<select id="selectByCondition" resultType="User">
    SELECT * FROM user
    WHERE username = #{username} AND age = #{age}
</select>
```

**方式二：Map**
```java
List<User> selectByMap(Map<String, Object> params);
```

```xml
<select id="selectByMap" resultType="User">
    SELECT * FROM user
    WHERE username = #{username} AND age = #{age}
</select>
```

**方式三：对象**
```java
List<User> selectByUser(User user);
```

```xml
<select id="selectByUser" resultType="User">
    SELECT * FROM user
    WHERE username = #{username} AND age = #{age}
</select>
```

### 6.3 #{} 和 ${}

**#{}：预编译（推荐）**
```xml
SELECT * FROM user WHERE id = #{id}
<!-- 生成SQL：SELECT * FROM user WHERE id = ? -->
```

**特点：**
- 防止 SQL 注入
- 自动添加引号
- 性能好

**${}：直接拼接**
```xml
SELECT * FROM user ORDER BY ${column}
<!-- 生成SQL：SELECT * FROM user ORDER BY username -->
```

**特点：**
- 可能 SQL 注入
- 不添加引号
- 用于动态列名、表名

**使用场景：**
- `#{}` - 参数值（99%的情况）
- `${}` - 动态列名、表名、ORDER BY

---

## 七、resultMap（结果映射）

### 7.1 基本映射

```xml
<resultMap id="userResultMap" type="User">
    <id property="id" column="id"/>
    <result property="username" column="username"/>
    <result property="email" column="email"/>
    <result property="age" column="age"/>
    <result property="createTime" column="create_time"/>
</resultMap>

<select id="selectById" resultMap="userResultMap">
    SELECT * FROM user WHERE id = #{id}
</select>
```

### 7.2 resultType vs resultMap

**resultType：**
- 简单映射
- 自动映射（开启驼峰）
- 单表查询

**resultMap：**
- 复杂映射
- 手动配置
- 多表关联

### 7.3 自动映射

**开启驼峰命名：**
```xml
<settings>
    <setting name="mapUnderscoreToCamelCase" value="true"/>
</settings>
```

**映射规则：**
```
create_time → createTime
user_name → userName
```

---

## 八、SQL片段

### 8.1 定义SQL片段

```xml
<sql id="baseColumn">
    id, username, email, age, create_time
</sql>

<sql id="whereCondition">
    <where>
        <if test="username != null">
            AND username LIKE #{username}
        </if>
        <if test="age != null">
            AND age = #{age}
        </if>
    </where>
</sql>
```

### 8.2 使用SQL片段

```xml
<select id="selectAll" resultType="User">
    SELECT <include refid="baseColumn"/>
    FROM user
</select>

<select id="selectByCondition" resultType="User">
    SELECT <include refid="baseColumn"/>
    FROM user
    <include refid="whereCondition"/>
</select>
```

---

## 九、总结

✅ **本章学习内容：**
- Mapper XML 基本结构
- select、insert、update、delete
- 参数映射（单个、多个）
- 结果映射（resultMap）
- #{} 和 ${}
- SQL 片段

✅ **核心要点：**
- 优先使用 #{} 防止SQL注入
- 使用 @Param 注解多个参数
- 开启驼峰命名自动映射
- SQL 片段提高代码复用

**下一章预告：** 我们将学习 MyBatis 动态 SQL。
