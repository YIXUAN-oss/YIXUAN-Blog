---
title: Sentinel熔断限流
---

# Sentinel熔断限流

## 一、熔断限流概述

### 1.1 为什么需要熔断限流？

**问题：**
- 服务雪崩
- 资源耗尽
- 系统崩溃

**解决方案：**
- **限流**：限制请求速率
- **熔断**：快速失败
- **降级**：返回降级数据

### 1.2 Sentinel简介

**Sentinel** 是阿里巴巴开源的流量控制组件。

**功能：**
- 流量控制
- 熔断降级
- 系统保护
- 热点参数限流

**官网：** https://sentinelguard.io/

---

## 二、Sentinel使用

### 2.1 添加依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    <version>2021.0.5.0</version>
</dependency>
```

### 2.2 配置文件

```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080  # 控制台地址
        port: 8719  # 与控制台交互的端口
```

### 2.3 下载控制台

```bash
java -jar sentinel-dashboard-1.8.6.jar
```

访问：http://localhost:8080

---

## 三、流量控制

### 3.1 @SentinelResource

```java
@RestController
public class HelloController {
    
    @GetMapping("/hello")
    @SentinelResource(value = "hello", blockHandler = "helloBlockHandler")
    public String hello() {
        return "Hello Sentinel";
    }
    
    // 限流处理方法
    public String helloBlockHandler(BlockException ex) {
        return "系统繁忙，请稍后再试";
    }
}
```

### 3.2 流控规则

**在控制台配置：**
- **资源名**：hello
- **阈值类型**：QPS
- **单机阈值**：10

**流控模式：**
- **直接**：直接限流
- **关联**：关联资源达到阈值限流
- **链路**：只记录指定链路的流量

**流控效果：**
- **快速失败**：直接拒绝
- **Warm Up**：预热
- **排队等待**：匀速排队

---

## 四、熔断降级

### 4.1 降级规则

```java
@GetMapping("/test")
@SentinelResource(value = "test", fallback = "testFallback")
public String test() {
    // 可能抛出异常的代码
    int i = 1 / 0;
    return "success";
}

// 降级处理方法
public String testFallback(Throwable throwable) {
    return "服务降级：" + throwable.getMessage();
}
```

**降级策略：**
- **慢调用比例**：响应时间超过阈值
- **异常比例**：异常比例超过阈值
- **异常数**：异常数超过阈值

---

## 五、热点参数限流

### 5.1 配置

```java
@GetMapping("/hot")
@SentinelResource(value = "hot", blockHandler = "hotBlockHandler")
public String hot(@RequestParam String id) {
    return "hot: " + id;
}

public String hotBlockHandler(String id, BlockException ex) {
    return "热点参数限流";
}
```

**控制台配置：**
- 参数索引：0
- 单机阈值：1
- 统计窗口时长：1秒

---

## 六、整合OpenFeign

### 6.1 配置

```yaml
feign:
  sentinel:
    enabled: true
```

### 6.2 Fallback

```java
@FeignClient(value = "user-service", fallback = UserClientFallback.class)
public interface UserClient {
    
    @GetMapping("/api/users/{id}")
    Result<User> getUserById(@PathVariable Long id);
}

@Component
public class UserClientFallback implements UserClient {
    
    @Override
    public Result<User> getUserById(Long id) {
        return Result.error("用户服务降级");
    }
}
```

---

## 七、规则持久化

### 7.1 使用Nacos

**添加依赖：**
```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

**配置：**
```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow:
          nacos:
            server-addr: localhost:8848
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
```

---

## 八、总结

✅ **本章学习内容：**
- 熔断限流概述
- Sentinel 使用
- 流量控制
- 熔断降级
- 热点参数限流
- 整合 OpenFeign

✅ **核心要点：**
- Sentinel 功能强大
- 支持流控和熔断
- 可视化控制台

**下一章预告：** 我们将整理 Spring Cloud 面试题。
