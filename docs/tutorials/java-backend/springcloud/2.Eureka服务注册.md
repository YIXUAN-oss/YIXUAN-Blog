---
title: Eureka服务注册
---

# Eureka服务注册

## 一、Eureka简介

### 1.1 什么是Eureka？

**Eureka** 是 Netflix 开源的服务注册与发现组件，Spring Cloud 将其集成在 spring-cloud-netflix 中。

**核心功能：**
- 服务注册
- 服务发现
- 健康检查
- 负载均衡

### 1.2 Eureka架构

```
┌──────────────┐     注册      ┌──────────────┐
│ 服务提供者    │ ──────────→  │ Eureka Server│
│ Provider     │               │  注册中心     │
└──────────────┘               └──────┬───────┘
                                      │
                               获取服务列表
                                      │
┌──────────────┐               ┌─────▼────────┐
│ 服务消费者    │ ←───调用────  │ 服务消费者    │
│ Consumer     │               │              │
└──────────────┘               └──────────────┘
```

**核心概念：**
- **Eureka Server**：注册中心，管理所有服务
- **Eureka Client**：服务提供者和消费者
- **服务注册**：服务启动时注册到 Eureka
- **服务发现**：从 Eureka 获取服务列表
- **心跳续约**：定时发送心跳保持注册状态

---

## 二、搭建Eureka Server

### 2.1 创建模块

**pom.xml：**
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

### 2.2 配置文件

**application.yml：**
```yaml
server:
  port: 7001

eureka:
  instance:
    hostname: localhost
  client:
    # 是否注册自己
    register-with-eureka: false
    # 是否从Eureka获取服务列表
    fetch-registry: false
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
```

### 2.3 启动类

```java
@SpringBootApplication
@EnableEurekaServer  // 启用 Eureka Server
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}
```

### 2.4 访问控制台

启动后访问：http://localhost:7001

---

## 三、服务注册

### 3.1 添加依赖

**用户服务 pom.xml：**
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

### 3.2 配置文件

**application.yml：**
```yaml
server:
  port: 8001

spring:
  application:
    name: user-service  # 服务名称

eureka:
  client:
    service-url:
      defaultZone: http://localhost:7001/eureka
  instance:
    # 显示IP地址
    prefer-ip-address: true
    # 实例ID
    instance-id: ${spring.application.name}:${server.port}
```

### 3.3 启动类

```java
@SpringBootApplication
@EnableEurekaClient  // 启用 Eureka Client
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

---

## 四、服务发现

### 4.1 创建订单服务

**application.yml：**
```yaml
server:
  port: 8002

spring:
  application:
    name: order-service

eureka:
  client:
    service-url:
      defaultZone: http://localhost:7001/eureka
```

### 4.2 配置RestTemplate

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // 负载均衡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### 4.3 服务调用

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @GetMapping("/{id}")
    public Result<Order> getOrderById(@PathVariable Long id) {
        // 通过服务名调用
        String url = "http://user-service/api/users/1";
        Result userResult = restTemplate.getForObject(url, Result.class);
        
        Order order = new Order();
        order.setId(id);
        order.setOrderNo("ORDER-" + id);
        order.setUser(userResult.getData());
        
        return Result.success(order);
    }
}
```

---

## 五、Eureka高可用

### 5.1 多实例配置

**Eureka Server 1（application-eureka1.yml）：**
```yaml
server:
  port: 7001

eureka:
  instance:
    hostname: eureka1
  client:
    service-url:
      defaultZone: http://eureka2:7002/eureka
```

**Eureka Server 2（application-eureka2.yml）：**
```yaml
server:
  port: 7002

eureka:
  instance:
    hostname: eureka2
  client:
    service-url:
      defaultZone: http://eureka1:7001/eureka
```

**客户端配置：**
```yaml
eureka:
  client:
    service-url:
      defaultZone: http://eureka1:7001/eureka,http://eureka2:7002/eureka
```

---

## 六、自我保护机制

### 6.1 什么是自我保护？

当 Eureka Server 在短时间内丢失过多客户端心跳时，会进入自我保护模式，不再剔除服务。

**触发条件：**
- 15分钟内心跳失败比例 > 85%

### 6.2 关闭自我保护

```yaml
eureka:
  server:
    # 关闭自我保护（生产环境不推荐）
    enable-self-preservation: false
    # 剔除间隔（默认60秒）
    eviction-interval-timer-in-ms: 2000
```

---

## 七、总结

✅ **本章学习内容：**
- Eureka 架构
- 搭建 Eureka Server
- 服务注册
- 服务发现
- Eureka 高可用
- 自我保护机制

✅ **核心要点：**
- Eureka Server 是注册中心
- 服务通过服务名调用
- 支持高可用集群

**下一章预告：** 我们将学习 Ribbon 负载均衡。
