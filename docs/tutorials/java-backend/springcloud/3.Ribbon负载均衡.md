---
title: Ribbon负载均衡
---

# Ribbon负载均衡

## 一、负载均衡概述

### 1.1 什么是负载均衡？

**负载均衡**：将请求分发到多个服务实例，提高系统的可用性和性能。

**类型：**
- **服务端负载均衡**：Nginx、HAProxy
- **客户端负载均衡**：Ribbon

### 1.2 Ribbon简介

**Ribbon** 是 Netflix 开源的客户端负载均衡组件。

**特点：**
- 客户端负载均衡
- 多种负载均衡策略
- 与 RestTemplate 集成
- 与 Eureka 集成

---

## 二、Ribbon使用

### 2.1 添加依赖

```xml
<!-- Eureka Client 已包含 Ribbon -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

### 2.2 配置RestTemplate

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // 启用负载均衡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### 2.3 服务调用

```java
@RestController
public class OrderController {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @GetMapping("/order/{id}")
    public String getOrder(@PathVariable Long id) {
        // 通过服务名调用（自动负载均衡）
        String url = "http://user-service/api/users/" + id;
        return restTemplate.getForObject(url, String.class);
    }
}
```

---

## 三、负载均衡策略

### 3.1 内置策略

| 策略 | 说明 |
|------|------|
| RoundRobinRule | 轮询（默认） |
| RandomRule | 随机 |
| RetryRule | 重试 |
| WeightedResponseTimeRule | 响应时间加权 |
| BestAvailableRule | 最低并发 |
| AvailabilityFilteringRule | 可用性过滤 |
| ZoneAvoidanceRule | 区域感知 |

### 3.2 全局配置

```java
@Configuration
public class RibbonConfig {
    
    @Bean
    public IRule ribbonRule() {
        // 使用随机策略
        return new RandomRule();
    }
}
```

### 3.3 配置文件配置

```yaml
# 全局配置
ribbon:
  NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule

# 指定服务配置
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
```

---

## 四、自定义负载均衡

### 4.1 自定义规则

```java
public class MyRule extends AbstractLoadBalancerRule {
    
    @Override
    public Server choose(Object key) {
        List<Server> servers = getLoadBalancer().getAllServers();
        // 自定义选择逻辑
        return servers.get(0);
    }
    
    @Override
    public void initWithNiwsConfig(IClientConfig clientConfig) {
    }
}
```

### 4.2 使用自定义规则

```java
@Bean
public IRule ribbonRule() {
    return new MyRule();
}
```

---

## 五、总结

✅ **本章学习内容：**
- 负载均衡概述
- Ribbon 使用
- 负载均衡策略
- 自定义负载均衡

✅ **核心要点：**
- Ribbon 客户端负载均衡
- @LoadBalanced 启用负载均衡
- 支持多种策略

**下一章预告：** 我们将学习 OpenFeign 服务调用。
