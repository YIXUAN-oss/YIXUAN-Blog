---
title: Gateway网关
---

# Gateway网关

## 一、网关概述

### 1.1 什么是网关？

**网关** 是微服务架构中的统一入口，负责路由转发、权限校验、限流等。

**功能：**
- 路由转发
- 权限认证
- 限流熔断
- 日志监控

### 1.2 Gateway简介

**Spring Cloud Gateway** 是 Spring Cloud 官方推出的网关组件。

**特点：**
- 基于 WebFlux（异步非阻塞）
- 性能优秀
- 功能强大

---

## 二、搭建Gateway

### 2.1 创建模块

**pom.xml：**
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
</dependencies>
```

### 2.2 配置文件

**application.yml：**
```yaml
server:
  port: 9000

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      routes:
        # 用户服务路由
        - id: user-route
          uri: lb://user-service  # lb:// 表示负载均衡
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix=1  # 去掉路径前缀
        
        # 订单服务路由
        - id: order-route
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            - StripPrefix=1

eureka:
  client:
    service-url:
      defaultZone: http://localhost:7001/eureka
```

### 2.3 启动类

```java
@SpringBootApplication
@EnableEurekaClient
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}
```

### 2.4 测试

```
访问：http://localhost:9000/user/api/users/1
转发到：http://user-service/api/users/1
```

---

## 三、断言工厂

### 3.1 常用断言

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-route
          uri: lb://user-service
          predicates:
            # 路径匹配
            - Path=/user/**
            
            # 请求方法
            - Method=GET,POST
            
            # 请求头
            - Header=X-Request-Id, \d+
            
            # 请求参数
            - Query=token
            
            # 时间
            - After=2024-01-01T00:00:00+08:00[Asia/Shanghai]
```

---

## 四、过滤器

### 4.1 内置过滤器

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-route
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            # 去掉路径前缀
            - StripPrefix=1
            
            # 添加请求头
            - AddRequestHeader=X-Request-Id, 1001
            
            # 添加请求参数
            - AddRequestParameter=token, abc
            
            # 重定向
            - RedirectTo=302, https://www.baidu.com
```

### 4.2 全局过滤器

```java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 获取请求
        ServerHttpRequest request = exchange.getRequest();
        
        // 获取token
        String token = request.getQueryParams().getFirst("token");
        
        if (token == null) {
            // 未授权
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete();
        }
        
        // 放行
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return 0;
    }
}
```

---

## 五、跨域配置

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true
```

---

## 六、总结

✅ **本章学习内容：**
- 网关概述
- Gateway 路由配置
- 断言工厂
- 过滤器
- 跨域配置

✅ **核心要点：**
- Gateway 是统一入口
- 支持路由转发
- 支持过滤器

**下一章预告：** 我们将学习 Config 配置中心。
