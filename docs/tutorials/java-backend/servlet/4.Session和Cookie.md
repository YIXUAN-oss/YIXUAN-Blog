---
title: Session和Cookie
---

# Session和Cookie

## 一、HTTP无状态协议

### 1.1 什么是无状态？

**HTTP 协议是无状态的**：服务器不会记录客户端的状态。

**问题：**
```
第1次请求：用户登录成功
第2次请求：服务器不知道用户是谁（忘记了）
```

**解决方案：** 使用 Session 和 Cookie 进行会话跟踪。

---

## 二、Cookie

### 2.1 Cookie概述

**Cookie**：客户端会话技术，数据存储在客户端（浏览器）。

**工作原理：**
```
1. 服务器创建 Cookie
2. 通过响应头发送给浏览器
3. 浏览器保存 Cookie
4. 下次请求时自动携带 Cookie
```

### 2.2 Cookie的使用

#### 2.2.1 创建和发送Cookie

```java
@WebServlet("/setCookie")
public class SetCookieServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) {
        
        // 创建 Cookie
        Cookie cookie = new Cookie("username", "zhangsan");
        
        // 设置有效期（秒）
        cookie.setMaxAge(60 * 60 * 24); // 1天
        
        // 设置路径
        cookie.setPath("/");
        
        // 发送到客户端
        resp.addCookie(cookie);
        
        resp.getWriter().println("Cookie 已设置");
    }
}
```

#### 2.2.2 获取Cookie

```java
@WebServlet("/getCookie")
public class GetCookieServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws IOException {
        
        // 获取所有 Cookie
        Cookie[] cookies = req.getCookies();
        
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                String name = cookie.getName();
                String value = cookie.getValue();
                System.out.println(name + " = " + value);
            }
        }
    }
}
```

### 2.3 Cookie的属性

| 属性 | 说明 | 示例 |
|------|------|------|
| **name** | Cookie 名称 | username |
| **value** | Cookie 值 | zhangsan |
| **maxAge** | 有效期（秒）| 3600 |
| **path** | 有效路径 | / |
| **domain** | 有效域名 | .example.com |
| **secure** | 是否仅 HTTPS | true/false |
| **httpOnly** | 是否禁止 JS 访问 | true/false |

**maxAge 说明：**
```java
cookie.setMaxAge(60);  // 60秒后过期
cookie.setMaxAge(0);   // 立即删除
cookie.setMaxAge(-1);  // 关闭浏览器删除（默认）
```

### 2.4 Cookie 的特点

**优点：**
- ✅ 数据存储在客户端，减轻服务器压力
- ✅ 简单易用

**缺点：**
- ❌ 安全性低（明文存储）
- ❌ 大小限制（4KB）
- ❌ 数量限制（20个/域名）
- ❌ 可能被禁用

---

## 三、Session

### 3.1 Session概述

**Session**：服务器端会话技术，数据存储在服务器。

**工作原理：**
```
1. 客户端第一次请求
2. 服务器创建 Session（生成唯一ID）
3. 服务器通过 Cookie 将 Session ID 发送给客户端
4. 客户端保存 Session ID
5. 后续请求携带 Session ID
6. 服务器根据 ID 找到对应的 Session
```

### 3.2 Session的使用

#### 3.2.1 获取Session

```java
// 获取 Session（如果没有则创建）
HttpSession session = req.getSession();

// 获取 Session（如果没有则返回 null）
HttpSession session = req.getSession(false);
```

#### 3.2.2 存取数据

```java
@WebServlet("/setSession")
public class SetSessionServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) {
        
        HttpSession session = req.getSession();
        
        // 存储数据
        session.setAttribute("username", "张三");
        session.setAttribute("user", new User("张三", 20));
        
        resp.getWriter().println("Session 已设置");
    }
}

@WebServlet("/getSession")
public class GetSessionServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) {
        
        HttpSession session = req.getSession();
        
        // 获取数据
        String username = (String) session.getAttribute("username");
        User user = (User) session.getAttribute("user");
        
        resp.getWriter().println("用户名：" + username);
    }
}
```

#### 3.2.3 删除数据

```java
// 删除指定属性
session.removeAttribute("username");

// 销毁 Session
session.invalidate();
```

### 3.3 Session 配置

#### 3.3.1 设置超时时间

**方式1：web.xml**
```xml
<session-config>
    <session-timeout>30</session-timeout> <!-- 30分钟 -->
</session-config>
```

**方式2：代码**
```java
session.setMaxInactiveInterval(60 * 30); // 30分钟（秒）
```

#### 3.3.2 获取Session信息

```java
// Session ID
String id = session.getId();

// 创建时间
long createTime = session.getCreationTime();

// 最后访问时间
long lastTime = session.getLastAccessedTime();

// 超时时间
int timeout = session.getMaxInactiveInterval();

// 是否新创建
boolean isNew = session.isNew();
```

### 3.4 Session 的特点

**优点：**
- ✅ 安全性高（数据在服务器）
- ✅ 存储容量大
- ✅ 可存储任意类型

**缺点：**
- ❌ 占用服务器资源
- ❌ 分布式环境需要特殊处理

---

## 四、Session vs Cookie

| 特性 | Cookie | Session |
|------|--------|---------|
| **存储位置** | 客户端 | 服务器 |
| **安全性** | 低 | 高 |
| **存储大小** | 4KB | 无限制 |
| **存储类型** | 只能字符串 | 任意类型 |
| **生命周期** | 可设置长期 | 默认关闭浏览器失效 |
| **服务器压力** | 小 | 大 |

**使用建议：**
- 不重要的数据用 Cookie
- 重要的数据用 Session
- 配合使用效果最佳

---

## 五、实战应用

### 5.1 用户登录

**LoginServlet.java：**
```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        
        // 验证用户
        if ("admin".equals(username) && "123456".equals(password)) {
            // 登录成功，保存用户信息到 Session
            HttpSession session = req.getSession();
            session.setAttribute("user", username);
            
            // 记住用户名（Cookie）
            String remember = req.getParameter("remember");
            if ("on".equals(remember)) {
                Cookie cookie = new Cookie("username", username);
                cookie.setMaxAge(60 * 60 * 24 * 7); // 7天
                resp.addCookie(cookie);
            }
            
            // 跳转到主页
            resp.sendRedirect(req.getContextPath() + "/index.jsp");
        } else {
            // 登录失败
            req.setAttribute("error", "用户名或密码错误");
            req.getRequestDispatcher("/login.jsp").forward(req, resp);
        }
    }
}
```

**login.jsp：**
```jsp
<%
    // 从 Cookie 获取用户名
    String savedUsername = "";
    Cookie[] cookies = request.getCookies();
    if (cookies != null) {
        for (Cookie cookie : cookies) {
            if ("username".equals(cookie.getName())) {
                savedUsername = cookie.getValue();
                break;
            }
        }
    }
%>

<form action="${pageContext.request.contextPath}/login" method="post">
    <input type="text" name="username" value="<%= savedUsername %>">
    <input type="password" name="password">
    <label><input type="checkbox" name="remember"> 记住用户名</label>
    <button type="submit">登录</button>
</form>
```

### 5.2 登录拦截

```java
@WebFilter("/admin/*")
public class LoginFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                         FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // 检查 Session 中是否有用户信息
        HttpSession session = req.getSession(false);
        if (session != null && session.getAttribute("user") != null) {
            // 已登录，放行
            chain.doFilter(request, response);
        } else {
            // 未登录，跳转到登录页
            resp.sendRedirect(req.getContextPath() + "/login.jsp");
        }
    }
}
```

### 5.3 退出登录

```java
@WebServlet("/logout")
public class LogoutServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws IOException {
        
        // 销毁 Session
        HttpSession session = req.getSession(false);
        if (session != null) {
            session.invalidate();
        }
        
        // 跳转到登录页
        resp.sendRedirect(req.getContextPath() + "/login.jsp");
    }
}
```

---

## 六、Session共享方案

### 6.1 问题

**分布式环境下，Session 不共享：**
```
用户 → 服务器1（Session1）
用户 → 服务器2（Session2）  ← 找不到 Session1
```

### 6.2 解决方案

**1. Session 复制**
- 各服务器间同步 Session
- 适用于小规模集群

**2. Session 粘滞**
- 同一用户始终访问同一服务器
- 负载均衡配置

**3. Session 统一存储（推荐）**
```
用户 → 服务器1 ↘
                 → Redis（统一存储 Session）
用户 → 服务器2 ↗
```

**Spring Session + Redis 示例：**
```xml
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

---

## 七、总结

✅ **本章学习内容：**
- HTTP 无状态协议
- Cookie 的使用和特点
- Session 的使用和特点
- Cookie vs Session
- 用户登录实战
- Session 共享方案

✅ **核心要点：**
- Cookie 存储在客户端，Session 存储在服务器
- Session 依赖 Cookie 传递 Session ID
- 重要数据用 Session，不重要数据用 Cookie
- 分布式环境使用 Redis 统一存储 Session

**下一章预告：** 我们将整理 Servlet 常见面试题。
