---
title: 数据访问
---

# 数据访问

## 一、整合MyBatis

### 1.1 添加依赖

```xml
<!-- MyBatis -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.3.1</version>
</dependency>

<!-- MySQL Driver -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.33</version>
</dependency>

<!-- Druid 连接池 -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.2.20</version>
</dependency>
```

### 1.2 配置数据源

```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 123456
    
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      validation-query: SELECT 1

mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.example.demo.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

### 1.3 创建实体类

```java
@Data
public class User {
    private Long id;
    private String username;
    private String email;
    private Integer age;
    private Date createTime;
    private Date updateTime;
}
```

### 1.4 创建 Mapper 接口

```java
@Mapper
public interface UserMapper {
    
    List<User> selectAll();
    
    User selectById(Long id);
    
    int insert(User user);
    
    int update(User user);
    
    int deleteById(Long id);
}
```

### 1.5 创建 Mapper XML

**resources/mapper/UserMapper.xml：**
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.UserMapper">
    
    <select id="selectAll" resultType="User">
        SELECT * FROM user
    </select>
    
    <select id="selectById" resultType="User">
        SELECT * FROM user WHERE id = #{id}
    </select>
    
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user (username, email, age, create_time)
        VALUES (#{username}, #{email}, #{age}, NOW())
    </insert>
    
    <update id="update">
        UPDATE user
        SET username = #{username},
            email = #{email},
            age = #{age},
            update_time = NOW()
        WHERE id = #{id}
    </update>
    
    <delete id="deleteById">
        DELETE FROM user WHERE id = #{id}
    </delete>
</mapper>
```

### 1.6 使用 Mapper

```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    public List<User> findAll() {
        return userMapper.selectAll();
    }
    
    public User findById(Long id) {
        return userMapper.selectById(id);
    }
    
    public void save(User user) {
        userMapper.insert(user);
    }
    
    public void update(User user) {
        userMapper.update(user);
    }
    
    public void deleteById(Long id) {
        userMapper.deleteById(id);
    }
}
```

---

## 二、整合MyBatis-Plus

### 2.1 添加依赖

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
    <version>3.5.4.1</version>
</dependency>
```

### 2.2 配置

```yaml
mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.example.demo.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0
```

### 2.3 实体类

```java
@Data
@TableName("user")
public class User {
    
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String username;
    private String email;
    private Integer age;
    
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;
    
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;
    
    @TableLogic
    private Integer deleted;
}
```

### 2.4 Mapper 接口

```java
@Mapper
public interface UserMapper extends BaseMapper<User> {
    // BaseMapper 提供了基础的 CRUD 方法
    // 无需编写 XML
}
```

### 2.5 使用 MyBatis-Plus

```java
@Service
public class UserService extends ServiceImpl<UserMapper, User> {
    
    // 继承 ServiceImpl，获得基础 CRUD 方法
    
    public List<User> findByAge(Integer age) {
        return lambdaQuery()
                .eq(User::getAge, age)
                .list();
    }
    
    public IPage<User> findByPage(Integer page, Integer size) {
        return page(new Page<>(page, size));
    }
}
```

### 2.6 条件构造器

```java
// 查询年龄大于20的用户
List<User> users = userMapper.selectList(
    new QueryWrapper<User>()
        .gt("age", 20)
);

// Lambda 方式
List<User> users = userMapper.selectList(
    new LambdaQueryWrapper<User>()
        .gt(User::getAge, 20)
);

// 分页查询
IPage<User> page = userMapper.selectPage(
    new Page<>(1, 10),
    new LambdaQueryWrapper<User>()
        .like(User::getUsername, "张")
);
```

---

## 三、JPA使用

### 3.1 添加依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

### 3.2 配置

```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
```

### 3.3 实体类

```java
@Entity
@Table(name = "user")
@Data
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, length = 50)
    private String username;
    
    @Column(length = 100)
    private String email;
    
    private Integer age;
    
    @CreationTimestamp
    private Date createTime;
    
    @UpdateTimestamp
    private Date updateTime;
}
```

### 3.4 Repository 接口

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // 根据用户名查询
    User findByUsername(String username);
    
    // 根据年龄查询
    List<User> findByAgeGreaterThan(Integer age);
    
    // 自定义查询
    @Query("SELECT u FROM User u WHERE u.username LIKE %?1%")
    List<User> findByUsernameLike(String username);
}
```

---

## 四、多数据源配置

### 4.1 配置文件

```yaml
spring:
  datasource:
    primary:
      jdbc-url: jdbc:mysql://localhost:3306/db1
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
    
    secondary:
      jdbc-url: jdbc:mysql://localhost:3306/db2
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
```

### 4.2 配置类

```java
@Configuration
public class DataSourceConfig {
    
    @Primary
    @Bean
    @ConfigurationProperties("spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.secondary")
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

### 4.3 MyBatis 配置

```java
@Configuration
@MapperScan(basePackages = "com.example.demo.mapper.primary", 
            sqlSessionFactoryRef = "primarySqlSessionFactory")
public class PrimaryDataSourceConfig {
    
    @Primary
    @Bean
    public SqlSessionFactory primarySqlSessionFactory(
            @Qualifier("primaryDataSource") DataSource dataSource) throws Exception {
        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
        bean.setDataSource(dataSource);
        return bean.getObject();
    }
}
```

---

## 五、事务管理

### 5.1 @Transactional 注解

```java
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Transactional
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        // 扣款
        userMapper.deduct(fromId, amount);
        
        // 模拟异常
        if (true) {
            throw new RuntimeException("转账失败");
        }
        
        // 加款
        userMapper.add(toId, amount);
    }
}
```

### 5.2 事务传播行为

```java
@Transactional(propagation = Propagation.REQUIRED)     // 默认
@Transactional(propagation = Propagation.REQUIRES_NEW) // 新事务
@Transactional(propagation = Propagation.NESTED)       // 嵌套事务
```

### 5.3 事务隔离级别

```java
@Transactional(isolation = Isolation.READ_COMMITTED)   // 读已提交
@Transactional(isolation = Isolation.REPEATABLE_READ)  // 可重复读（默认）
```

### 5.4 事务回滚

```java
@Transactional(rollbackFor = Exception.class)  // 所有异常回滚
@Transactional(noRollbackFor = RuntimeException.class) // 不回滚
```

---

## 六、总结

✅ **本章学习内容：**
- 整合 MyBatis
- 整合 MyBatis-Plus
- JPA 使用
- 多数据源配置
- 事务管理

✅ **核心要点：**
- MyBatis 需要编写 XML，灵活性高
- MyBatis-Plus 提供了通用 CRUD，开发效率高
- JPA 使用方法命名规则，学习成本低
- 使用 @Transactional 进行事务管理

**下一章预告：** 我们将学习 Spring Boot 整合 Redis。
