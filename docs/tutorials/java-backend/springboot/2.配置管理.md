---
title: 配置管理
---

# 配置管理

## 一、配置文件

### 1.1 配置文件格式

**Spring Boot 支持两种格式：**
- `application.properties`
- `application.yml` / `application.yaml`（推荐）

**优先级：** properties > yml > yaml

### 1.2 YAML 格式

**基本语法：**
```yaml
# 键值对
key: value

# 对象
user:
  name: 张三
  age: 20

# 数组
hobbies:
  - 篮球
  - 足球
  - 游泳

# 行内写法
user: {name: 张三, age: 20}
hobbies: [篮球, 足球, 游泳]
```

**注意事项：**
- 使用空格缩进，不能使用 Tab
- 冒号后必须有空格
- 大小写敏感

---

## 二、常用配置

### 2.1 服务器配置

```yaml
server:
  port: 8080                    # 端口
  servlet:
    context-path: /api          # 上下文路径
  tomcat:
    max-threads: 200            # 最大线程数
    uri-encoding: UTF-8         # URI 编码
```

### 2.2 数据源配置

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=utf8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
    
    # 连接池配置（HikariCP）
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      connection-timeout: 30000
```

### 2.3 日志配置

```yaml
logging:
  level:
    root: INFO                           # 全局日志级别
    com.example.demo: DEBUG              # 指定包日志级别
  file:
    name: logs/app.log                   # 日志文件
    max-size: 10MB                       # 单文件最大大小
    max-history: 30                      # 保留天数
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

---

## 三、读取配置

### 3.1 @Value 注解

**读取简单类型：**
```java
@RestController
public class ConfigController {
    
    @Value("${server.port}")
    private Integer port;
    
    @Value("${spring.application.name}")
    private String appName;
    
    @Value("${custom.message:默认值}")
    private String message;
    
    @GetMapping("/config")
    public Map<String, Object> config() {
        Map<String, Object> map = new HashMap<>();
        map.put("port", port);
        map.put("appName", appName);
        map.put("message", message);
        return map;
    }
}
```

### 3.2 @ConfigurationProperties

**定义配置类：**
```java
@Configuration
@ConfigurationProperties(prefix = "app")
@Data
public class AppConfig {
    private String name;
    private String version;
    private String description;
}
```

**配置文件：**
```yaml
app:
  name: Demo
  version: 1.0.0
  description: Spring Boot Demo
```

**使用配置：**
```java
@RestController
public class ConfigController {
    
    @Autowired
    private AppConfig appConfig;
    
    @GetMapping("/app-config")
    public AppConfig getAppConfig() {
        return appConfig;
    }
}
```

### 3.3 复杂对象配置

**配置类：**
```java
@Configuration
@ConfigurationProperties(prefix = "user")
@Data
public class UserConfig {
    private String name;
    private Integer age;
    private List<String> hobbies;
    private Map<String, String> contact;
    private Address address;
    
    @Data
    public static class Address {
        private String province;
        private String city;
    }
}
```

**配置文件：**
```yaml
user:
  name: 张三
  age: 20
  hobbies:
    - 篮球
    - 足球
  contact:
    phone: 13800138000
    email: test@example.com
  address:
    province: 北京
    city: 朝阳区
```

---

## 四、多环境配置

### 4.1 配置文件命名规则

```
application.yml              # 主配置文件
application-dev.yml          # 开发环境
application-test.yml         # 测试环境
application-prod.yml         # 生产环境
```

### 4.2 主配置文件

**application.yml：**
```yaml
spring:
  profiles:
    active: dev  # 激活开发环境
```

### 4.3 环境配置文件

**application-dev.yml：**
```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_dev
    username: root
    password: 123456

logging:
  level:
    root: DEBUG
```

**application-test.yml：**
```yaml
server:
  port: 8081

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_test
    username: test
    password: test123
```

**application-prod.yml：**
```yaml
server:
  port: 80

spring:
  datasource:
    url: jdbc:mysql://192.168.1.100:3306/test_prod
    username: prod
    password: prod@123
    
logging:
  level:
    root: WARN
```

### 4.4 激活环境

**方式1：配置文件**
```yaml
spring:
  profiles:
    active: dev
```

**方式2：命令行参数**
```bash
java -jar app.jar --spring.profiles.active=prod
```

**方式3：JVM 参数**
```bash
java -Dspring.profiles.active=prod -jar app.jar
```

**方式4：环境变量**
```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar app.jar
```

---

## 五、配置文件优先级

### 5.1 优先级顺序（从高到低）

```
1. 命令行参数
2. Java 系统属性（-Dkey=value）
3. 操作系统环境变量
4. jar 包外部的 application-{profile}.yml
5. jar 包内部的 application-{profile}.yml
6. jar 包外部的 application.yml
7. jar 包内部的 application.yml
8. @Configuration 类上的 @PropertySource
```

### 5.2 外部配置文件

**项目目录结构：**
```
project/
├── app.jar
├── config/
│   └── application.yml    # 优先级最高
└── application.yml        # 其次
```

**运行：**
```bash
java -jar app.jar
# 会依次加载：
# 1. config/application.yml
# 2. application.yml
# 3. jar 包内的配置
```

---

## 六、自定义配置

### 6.1 自定义 properties 文件

**创建 custom.properties：**
```properties
custom.name=Demo
custom.version=1.0.0
```

**读取配置：**
```java
@Configuration
@PropertySource("classpath:custom.properties")
@ConfigurationProperties(prefix = "custom")
@Data
public class CustomConfig {
    private String name;
    private String version;
}
```

### 6.2 读取 YAML 文件

```java
@Configuration
@ConfigurationProperties(prefix = "custom")
@Data
public class CustomConfig {
    private String name;
    private String version;
}

// 在主配置文件中引入
// application.yml
spring:
  config:
    import: classpath:custom.yml
```

---

## 七、配置加密

### 7.1 Jasypt 加密

**添加依赖：**
```xml
<dependency>
    <groupId>com.github.ulisesbocchio</groupId>
    <artifactId>jasypt-spring-boot-starter</artifactId>
    <version>3.0.5</version>
</dependency>
```

**配置：**
```yaml
jasypt:
  encryptor:
    password: mySecretKey  # 加密密钥
    algorithm: PBEWithMD5AndDES
```

**加密密码：**
```java
@SpringBootTest
public class JasyptTest {
    
    @Autowired
    private StringEncryptor encryptor;
    
    @Test
    public void encrypt() {
        String password = "123456";
        String encrypted = encryptor.encrypt(password);
        System.out.println("加密后：" + encrypted);
    }
}
```

**使用加密密码：**
```yaml
spring:
  datasource:
    password: ENC(加密后的密码)
```

---

## 八、配置元数据

### 8.1 添加依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-configuration-processor</artifactId>
    <optional>true</optional>
</dependency>
```

**作用：** IDEA 中会有代码提示和自动完成。

### 8.2 创建元数据

**自动生成：** 编译后会在 `META-INF/spring-configuration-metadata.json` 生成元数据。

---

## 九、实战练习

### 9.1 多环境配置实战

**目标：** 开发、测试、生产环境使用不同配置。

**application.yml：**
```yaml
spring:
  application:
    name: demo
  profiles:
    active: @spring.profiles.active@  # Maven 占位符
```

**application-dev.yml：**
```yaml
server:
  port: 8080

app:
  name: Demo开发环境
  
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/test_dev
```

**application-prod.yml：**
```yaml
server:
  port: 80

app:
  name: Demo生产环境
  
spring:
  datasource:
    url: jdbc:mysql://192.168.1.100:3306/test_prod
```

**pom.xml：**
```xml
<profiles>
    <profile>
        <id>dev</id>
        <properties>
            <spring.profiles.active>dev</spring.profiles.active>
        </properties>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
    </profile>
    
    <profile>
        <id>prod</id>
        <properties>
            <spring.profiles.active>prod</spring.profiles.active>
        </properties>
    </profile>
</profiles>
```

**打包：**
```bash
# 开发环境
mvn clean package

# 生产环境
mvn clean package -P prod
```

---

## 十、总结

✅ **本章学习内容：**
- 配置文件格式（properties、yml）
- 常用配置
- 读取配置（@Value、@ConfigurationProperties）
- 多环境配置
- 配置文件优先级
- 配置加密

✅ **核心要点：**
- 推荐使用 yml 格式
- 使用 @ConfigurationProperties 读取复杂配置
- 多环境配置提高部署灵活性
- 敏感信息要加密

**下一章预告：** 我们将学习 Spring Boot Web 开发。
