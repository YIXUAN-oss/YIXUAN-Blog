---
title: Maven进阶技巧
---

# Maven进阶技巧

## 一、常用插件详解

### 1.1 maven-compiler-plugin（编译插件）

**作用：** 编译 Java 源代码。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <version>3.8.1</version>
    <configuration>
        <!-- 源代码 JDK 版本 -->
        <source>1.8</source>
        <!-- 编译目标 JDK 版本 -->
        <target>1.8</target>
        <!-- 编码格式 -->
        <encoding>UTF-8</encoding>
        <!-- 显示编译警告 -->
        <showWarnings>true</showWarnings>
        <!-- 显示过时 API 警告 -->
        <showDeprecation>true</showDeprecation>
    </configuration>
</plugin>
```

### 1.2 maven-surefire-plugin（测试插件）

**作用：** 执行单元测试。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <version>2.22.2</version>
    <configuration>
        <!-- 跳过测试 -->
        <skipTests>false</skipTests>
        <!-- 包含的测试类 -->
        <includes>
            <include>**/*Test.java</include>
            <include>**/*Tests.java</include>
        </includes>
        <!-- 排除的测试类 -->
        <excludes>
            <exclude>**/IT*.java</exclude>
        </excludes>
        <!-- 并行执行测试 -->
        <parallel>classes</parallel>
        <threadCount>4</threadCount>
    </configuration>
</plugin>
```

### 1.3 maven-jar-plugin（打包插件）

**作用：** 打包为 JAR 文件。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-jar-plugin</artifactId>
    <version>3.2.0</version>
    <configuration>
        <archive>
            <manifest>
                <!-- 添加 classpath -->
                <addClasspath>true</addClasspath>
                <!-- classpath 前缀 -->
                <classpathPrefix>lib/</classpathPrefix>
                <!-- 主类 -->
                <mainClass>com.example.Main</mainClass>
            </manifest>
            <!-- 添加自定义信息 -->
            <manifestEntries>
                <Built-By>YourName</Built-By>
                <Build-Time>${maven.build.timestamp}</Build-Time>
            </manifestEntries>
        </archive>
    </configuration>
</plugin>
```

### 1.4 maven-shade-plugin（打包成可执行JAR）

**作用：** 打包所有依赖到一个 JAR 文件（Fat JAR / Uber JAR）。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-shade-plugin</artifactId>
    <version>3.2.4</version>
    <executions>
        <execution>
            <phase>package</phase>
            <goals>
                <goal>shade</goal>
            </goals>
            <configuration>
                <transformers>
                    <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                        <mainClass>com.example.Main</mainClass>
                    </transformer>
                </transformers>
            </configuration>
        </execution>
    </executions>
</plugin>
```

### 1.5 maven-assembly-plugin（自定义打包）

**作用：** 自定义打包格式。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-assembly-plugin</artifactId>
    <version>3.3.0</version>
    <configuration>
        <descriptorRefs>
            <descriptorRef>jar-with-dependencies</descriptorRef>
        </descriptorRefs>
        <archive>
            <manifest>
                <mainClass>com.example.Main</mainClass>
            </manifest>
        </archive>
    </configuration>
    <executions>
        <execution>
            <id>make-assembly</id>
            <phase>package</phase>
            <goals>
                <goal>single</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

### 1.6 maven-resources-plugin（资源插件）

**作用：** 复制资源文件。

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-resources-plugin</artifactId>
    <version>3.2.0</version>
    <configuration>
        <encoding>UTF-8</encoding>
        <!-- 启用资源过滤 -->
        <useDefaultDelimiters>false</useDefaultDelimiters>
        <delimiters>
            <delimiter>@</delimiter>
        </delimiters>
    </configuration>
</plugin>
```

### 1.7 maven-dependency-plugin（依赖插件）

**作用：** 管理和分析依赖。

**常用命令：**

```bash
# 查看依赖树
mvn dependency:tree

# 列出所有依赖
mvn dependency:list

# 分析依赖使用情况
mvn dependency:analyze

# 复制依赖到指定目录
mvn dependency:copy-dependencies -DoutputDirectory=lib
```

**配置示例：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-dependency-plugin</artifactId>
    <version>3.2.0</version>
    <executions>
        <execution>
            <id>copy-dependencies</id>
            <phase>package</phase>
            <goals>
                <goal>copy-dependencies</goal>
            </goals>
            <configuration>
                <outputDirectory>${project.build.directory}/lib</outputDirectory>
            </configuration>
        </execution>
    </executions>
</plugin>
```

### 1.8 spring-boot-maven-plugin

**作用：** Spring Boot 应用打包插件。

**配置示例：**

```xml
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <version>2.7.12</version>
    <configuration>
        <!-- 主类 -->
        <mainClass>com.example.Application</mainClass>
        <!-- 排除依赖 -->
        <excludes>
            <exclude>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
            </exclude>
        </excludes>
    </configuration>
    <executions>
        <execution>
            <goals>
                <goal>repackage</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

---

## 二、Maven Profile 多环境配置

### 2.1 Profile 概述

Profile 用于在不同环境下使用不同的配置。

**使用场景：**
- 开发环境（dev）
- 测试环境（test）
- 生产环境（prod）

### 2.2 定义 Profile

**在 pom.xml 中定义：**

```xml
<profiles>
    <!-- 开发环境 -->
    <profile>
        <id>dev</id>
        <activation>
            <activeByDefault>true</activeByDefault>
        </activation>
        <properties>
            <env>dev</env>
            <db.url>jdbc:mysql://localhost:3306/dev_db</db.url>
            <db.username>root</db.username>
            <db.password>dev_password</db.password>
        </properties>
    </profile>
    
    <!-- 测试环境 -->
    <profile>
        <id>test</id>
        <properties>
            <env>test</env>
            <db.url>jdbc:mysql://test-server:3306/test_db</db.url>
            <db.username>test_user</db.username>
            <db.password>test_password</db.password>
        </properties>
    </profile>
    
    <!-- 生产环境 -->
    <profile>
        <id>prod</id>
        <properties>
            <env>prod</env>
            <db.url>jdbc:mysql://prod-server:3306/prod_db</db.url>
            <db.username>prod_user</db.username>
            <db.password>prod_password</db.password>
        </properties>
    </profile>
</profiles>
```

### 2.3 激活 Profile

**方式1：命令行指定**

```bash
# 使用 dev 环境
mvn clean package -Pdev

# 使用 prod 环境
mvn clean package -Pprod

# 同时激活多个 Profile
mvn clean package -Pdev,debug
```

**方式2：默认激活**

```xml
<profile>
    <id>dev</id>
    <activation>
        <activeByDefault>true</activeByDefault>
    </activation>
</profile>
```

**方式3：条件激活**

```xml
<profile>
    <id>windows</id>
    <activation>
        <os>
            <family>Windows</family>
        </os>
    </activation>
</profile>

<profile>
    <id>jdk8</id>
    <activation>
        <jdk>1.8</jdk>
    </activation>
</profile>

<profile>
    <id>property-activation</id>
    <activation>
        <property>
            <name>env</name>
            <value>prod</value>
        </property>
    </activation>
</profile>
```

### 2.4 资源过滤

**配置资源过滤：**

```xml
<build>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
        </resource>
    </resources>
</build>
```

**application.properties：**

```properties
# 使用 ${} 引用 Profile 中的属性
spring.datasource.url=${db.url}
spring.datasource.username=${db.username}
spring.datasource.password=${db.password}
environment=${env}
```

**打包时属性会被替换：**

```bash
mvn clean package -Pprod
# 打包后 application.properties 中的值会被替换为 prod 环境的值
```

### 2.5 多环境配置文件

**目录结构：**

```
src/main/resources/
├── application.properties
├── config/
│   ├── application-dev.properties
│   ├── application-test.properties
│   └── application-prod.properties
```

**pom.xml 配置：**

```xml
<profiles>
    <profile>
        <id>dev</id>
        <properties>
            <profiles.active>dev</profiles.active>
        </properties>
    </profile>
    <profile>
        <id>prod</id>
        <properties>
            <profiles.active>prod</profiles.active>
        </properties>
    </profile>
</profiles>

<build>
    <resources>
        <resource>
            <directory>src/main/resources</directory>
            <filtering>true</filtering>
            <includes>
                <include>application.properties</include>
                <include>config/application-${profiles.active}.properties</include>
            </includes>
        </resource>
    </resources>
</build>
```

---

## 三、Maven 私服搭建（Nexus）

### 3.1 Nexus 简介

**Nexus** 是一个强大的 Maven 仓库管理器，用于搭建私服。

**使用私服的好处：**
- ✅ 加速依赖下载（缓存中央仓库）
- ✅ 管理公司内部依赖
- ✅ 控制依赖版本
- ✅ 节省带宽

### 3.2 安装 Nexus

**下载：**
```
官网：https://www.sonatype.com/products/nexus-repository
下载：nexus-3.x.x-unix.tar.gz
```

**安装（Linux）：**

```bash
# 解压
tar -zxvf nexus-3.x.x-unix.tar.gz
mv nexus-3.x.x /opt/nexus

# 启动
/opt/nexus/bin/nexus start

# 查看状态
/opt/nexus/bin/nexus status

# 停止
/opt/nexus/bin/nexus stop
```

**访问：**
```
URL: http://localhost:8081
默认账号: admin
默认密码: 在 /opt/sonatype-work/nexus3/admin.password 文件中
```

### 3.3 配置 Nexus 仓库

**仓库类型：**
- **hosted**：本地仓库，存储公司内部依赖
- **proxy**：代理仓库，代理中央仓库
- **group**：仓库组，组合多个仓库

**创建仓库组：**
1. 登录 Nexus
2. Repository → Repositories → Create repository
3. 选择 maven2 (group)
4. 添加成员仓库（maven-central、maven-releases、maven-snapshots）
5. 保存

### 3.4 配置 Maven 使用私服

**settings.xml 配置：**

```xml
<settings>
    <!-- 配置私服镜像 -->
    <mirrors>
        <mirror>
            <id>nexus</id>
            <mirrorOf>*</mirrorOf>
            <name>Nexus Repository</name>
            <url>http://localhost:8081/repository/maven-public/</url>
        </mirror>
    </mirrors>
    
    <!-- 配置私服认证 -->
    <servers>
        <server>
            <id>nexus-releases</id>
            <username>admin</username>
            <password>admin123</password>
        </server>
        <server>
            <id>nexus-snapshots</id>
            <username>admin</username>
            <password>admin123</password>
        </server>
    </servers>
</settings>
```

### 3.5 发布到私服

**pom.xml 配置：**

```xml
<distributionManagement>
    <!-- 发布 Release 版本 -->
    <repository>
        <id>nexus-releases</id>
        <name>Nexus Release Repository</name>
        <url>http://localhost:8081/repository/maven-releases/</url>
    </repository>
    
    <!-- 发布 Snapshot 版本 -->
    <snapshotRepository>
        <id>nexus-snapshots</id>
        <name>Nexus Snapshot Repository</name>
        <url>http://localhost:8081/repository/maven-snapshots/</url>
    </snapshotRepository>
</distributionManagement>
```

**发布命令：**

```bash
# 发布到私服
mvn clean deploy

# 跳过测试发布
mvn clean deploy -DskipTests
```

---

## 四、Maven 性能优化

### 4.1 并行构建

**启用并行构建：**

```bash
# 使用 4 个线程并行构建
mvn clean install -T 4

# 使用 CPU 核心数的线程
mvn clean install -T 1C
```

### 4.2 离线模式

**使用离线模式：**

```bash
# 不检查远程仓库更新
mvn clean install -o
```

### 4.3 跳过测试

```bash
# 跳过测试执行
mvn clean install -DskipTests

# 跳过测试编译和执行
mvn clean install -Dmaven.test.skip=true
```

### 4.4 增量编译

**配置增量编译：**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <version>3.8.1</version>
    <configuration>
        <useIncrementalCompilation>true</useIncrementalCompilation>
    </configuration>
</plugin>
```

### 4.5 调整内存

**设置 Maven 内存：**

```bash
# Linux/Mac
export MAVEN_OPTS="-Xms256m -Xmx1024m"

# Windows
set MAVEN_OPTS=-Xms256m -Xmx1024m
```

### 4.6 本地仓库清理

```bash
# 使用 Maven 插件清理
mvn dependency:purge-local-repository

# 手动删除
rm -rf ~/.m2/repository/com/example/my-app
```

---

## 五、CI/CD 集成

### 5.1 Jenkins 集成

**Jenkinsfile 示例：**

```groovy
pipeline {
    agent any
    
    tools {
        maven 'Maven 3.8.6'
        jdk 'JDK 8'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git 'https://github.com/example/project.git'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        
        stage('Package') {
            steps {
                sh 'mvn package -DskipTests'
            }
        }
        
        stage('Deploy') {
            steps {
                sh 'mvn deploy -DskipTests'
            }
        }
    }
    
    post {
        always {
            junit '**/target/surefire-reports/*.xml'
        }
    }
}
```

### 5.2 GitHub Actions 集成

**.github/workflows/maven.yml：**

```yaml
name: Maven Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up JDK 8
      uses: actions/setup-java@v2
      with:
        java-version: '8'
        distribution: 'adopt'
    
    - name: Cache Maven packages
      uses: actions/cache@v2
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Build with Maven
      run: mvn clean package
    
    - name: Run tests
      run: mvn test
```

### 5.3 GitLab CI 集成

**.gitlab-ci.yml：**

```yaml
image: maven:3.8.6-openjdk-8

stages:
  - build
  - test
  - deploy

cache:
  paths:
    - .m2/repository

build:
  stage: build
  script:
    - mvn clean compile

test:
  stage: test
  script:
    - mvn test

deploy:
  stage: deploy
  script:
    - mvn deploy -DskipTests
  only:
    - main
```

---

## 六、Maven 最佳实践

### 6.1 项目结构规范

```
project/
├── pom.xml
├── README.md
├── .gitignore
├── src/
│   ├── main/
│   │   ├── java/          # Java 源代码
│   │   ├── resources/     # 资源文件
│   │   └── webapp/        # Web 资源（Web项目）
│   └── test/
│       ├── java/          # 测试代码
│       └── resources/     # 测试资源
└── docs/                  # 文档
```

### 6.2 依赖管理规范

**1. 使用 dependencyManagement 统一版本**

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>2.7.12</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

**2. 使用属性管理版本号**

```xml
<properties>
    <spring.version>5.3.20</spring.version>
</properties>
```

**3. 避免使用 SNAPSHOT 到生产环境**

**4. 定期检查依赖更新和安全漏洞**

```bash
mvn versions:display-dependency-updates
mvn dependency:analyze
```

### 6.3 插件配置规范

**1. 在 pluginManagement 中管理版本**

```xml
<build>
    <pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
            </plugin>
        </plugins>
    </pluginManagement>
</build>
```

**2. 明确指定插件版本**

### 6.4 版本号规范

**语义化版本：** `主版本.次版本.修订号`

```
1.0.0 - 初始发布
1.1.0 - 新增功能
1.1.1 - Bug 修复
2.0.0 - 重大更新
```

### 6.5 .gitignore 配置

```
# Maven
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml

# IDE
.idea/
*.iml
.vscode/
.settings/
.classpath
.project

# OS
.DS_Store
Thumbs.db
```

---

## 七、故障排查技巧

### 7.1 查看详细日志

```bash
# 启用调试模式
mvn clean install -X

# 启用错误详情
mvn clean install -e
```

### 7.2 分析依赖

```bash
# 查看依赖树
mvn dependency:tree

# 查看冲突依赖
mvn dependency:tree -Dverbose

# 分析未使用的依赖
mvn dependency:analyze
```

### 7.3 清理缓存

```bash
# 清理项目
mvn clean

# 清理本地仓库
mvn dependency:purge-local-repository

# 强制更新快照
mvn clean install -U
```

---

## 八、总结

✅ **本章学习内容：**
- 常用 Maven 插件配置
- Maven Profile 多环境配置
- Maven 私服搭建和使用
- Maven 性能优化技巧
- CI/CD 集成
- Maven 最佳实践

✅ **核心技能：**
- 熟练配置各种 Maven 插件
- 掌握多环境配置管理
- 能够搭建和使用 Maven 私服
- 掌握 Maven 性能优化方法
- 了解 CI/CD 集成方案

**下一章预告：** 我们将整理 Maven 常见面试题，帮助你应对技术面试。
