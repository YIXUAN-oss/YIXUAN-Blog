---
title: SpringMVC核心技术
---

# SpringMVC核心技术

## 一、请求参数处理

### 1.1 @RequestParam

**获取请求参数：**
```java
@GetMapping("/user")
public String getUser(@RequestParam String name, 
                      @RequestParam Integer age) {
    return "user";
}

// 访问：/user?name=张三&age=20
```

**属性说明：**
```java
@RequestParam(
    value = "name",        // 参数名
    required = true,       // 是否必需（默认 true）
    defaultValue = "默认值" // 默认值
)
```

**示例：**
```java
@GetMapping("/search")
public String search(
    @RequestParam String keyword,
    @RequestParam(required = false, defaultValue = "1") Integer page,
    @RequestParam(required = false, defaultValue = "10") Integer size) {
    // keyword 必需，page 和 size 可选
    return "searchResult";
}
```

### 1.2 @PathVariable

**获取路径变量：**
```java
@GetMapping("/user/{id}")
public String getUser(@PathVariable Long id) {
    return "user";
}

// 访问：/user/123
```

**多个路径变量：**
```java
@GetMapping("/article/{categoryId}/{articleId}")
public String getArticle(@PathVariable Long categoryId,
                        @PathVariable Long articleId) {
    return "article";
}

// 访问：/article/10/100
```

### 1.3 @RequestBody

**获取请求体（JSON）：**
```java
@PostMapping("/user")
public String addUser(@RequestBody User user) {
    userService.save(user);
    return "success";
}

// 请求体：{"name":"张三","age":20}
```

### 1.4 @RequestHeader

**获取请求头：**
```java
@GetMapping("/test")
public String test(@RequestHeader("User-Agent") String userAgent) {
    System.out.println(userAgent);
    return "test";
}
```

### 1.5 @CookieValue

**获取Cookie：**
```java
@GetMapping("/test")
public String test(@CookieValue("JSESSIONID") String sessionId) {
    System.out.println(sessionId);
    return "test";
}
```

### 1.6 直接获取Servlet API

```java
@GetMapping("/test")
public String test(HttpServletRequest request, 
                   HttpServletResponse response,
                   HttpSession session) {
    // 可以直接使用原生 API
    String param = request.getParameter("name");
    return "test";
}
```

---

## 二、响应处理

### 2.1 返回页面

**返回视图名称：**
```java
@GetMapping("/user/list")
public String list(Model model) {
    model.addAttribute("users", userService.findAll());
    return "userList"; // 视图名称
}
```

**重定向：**
```java
@PostMapping("/user/add")
public String add(User user) {
    userService.save(user);
    return "redirect:/user/list"; // 重定向
}
```

**请求转发：**
```java
@GetMapping("/test")
public String test() {
    return "forward:/user/list"; // 请求转发
}
```

### 2.2 返回JSON

**方式1：@ResponseBody**
```java
@GetMapping("/user/{id}")
@ResponseBody
public User getUser(@PathVariable Long id) {
    return userService.findById(id);
}
```

**方式2：@RestController**
```java
@RestController // = @Controller + @ResponseBody
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
}
```

### 2.3 ResponseEntity

**自定义响应状态码和头：**
```java
@GetMapping("/user/{id}")
public ResponseEntity<User> getUser(@PathVariable Long id) {
    User user = userService.findById(id);
    if (user == null) {
        return ResponseEntity.notFound().build();
    }
    return ResponseEntity.ok(user);
}

// 自定义头
@GetMapping("/test")
public ResponseEntity<String> test() {
    HttpHeaders headers = new HttpHeaders();
    headers.add("Custom-Header", "value");
    return new ResponseEntity<>("Hello", headers, HttpStatus.OK);
}
```

---

## 三、拦截器（Interceptor）

### 3.1 拦截器概述

**拦截器 vs 过滤器：**

| 特性 | 过滤器（Filter） | 拦截器（Interceptor） |
|------|-----------------|---------------------|
| 规范 | Servlet 规范 | Spring MVC |
| 拦截范围 | 所有请求 | 只拦截 Controller |
| 依赖注入 | 不支持 | 支持 |
| 执行时机 | DispatcherServlet 之前 | Handler 之前 |

### 3.2 创建拦截器

```java
public class LoginInterceptor implements HandlerInterceptor {
    
    // 前置处理（在 Handler 执行之前）
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        System.out.println("preHandle");
        
        // 检查登录
        HttpSession session = request.getSession();
        if (session.getAttribute("user") != null) {
            return true; // 放行
        }
        
        // 未登录，跳转到登录页
        response.sendRedirect("/login");
        return false; // 拦截
    }
    
    // 后置处理（Handler 执行之后，视图渲染之前）
    @Override
    public void postHandle(HttpServletRequest request, 
                          HttpServletResponse response, 
                          Object handler, 
                          ModelAndView modelAndView) throws Exception {
        System.out.println("postHandle");
    }
    
    // 完成处理（视图渲染之后）
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) throws Exception {
        System.out.println("afterCompletion");
    }
}
```

### 3.3 注册拦截器

**XML 配置：**
```xml
<mvc:interceptors>
    <mvc:interceptor>
        <mvc:mapping path="/**"/>
        <mvc:exclude-mapping path="/login"/>
        <mvc:exclude-mapping path="/register"/>
        <bean class="com.example.interceptor.LoginInterceptor"/>
    </mvc:interceptor>
</mvc:interceptors>
```

**Java 配置：**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(new LoginInterceptor())
                .addPathPatterns("/**")
                .excludePathPatterns("/login", "/register");
    }
}
```

### 3.4 拦截器执行顺序

**单个拦截器：**
```
preHandle → Handler → postHandle → 视图渲染 → afterCompletion
```

**多个拦截器：**
```
Interceptor1.preHandle
Interceptor2.preHandle
Handler 执行
Interceptor2.postHandle
Interceptor1.postHandle
视图渲染
Interceptor2.afterCompletion
Interceptor1.afterCompletion
```

---

## 四、异常处理

### 4.1 @ExceptionHandler

**Controller 内部处理：**
```java
@Controller
public class UserController {
    
    @GetMapping("/user/{id}")
    public String getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        if (user == null) {
            throw new UserNotFoundException("用户不存在");
        }
        return "user";
    }
    
    // 处理当前 Controller 的异常
    @ExceptionHandler(UserNotFoundException.class)
    public String handleUserNotFound(UserNotFoundException ex, Model model) {
        model.addAttribute("error", ex.getMessage());
        return "error";
    }
}
```

### 4.2 @ControllerAdvice

**全局异常处理：**
```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    // 处理特定异常
    @ExceptionHandler(UserNotFoundException.class)
    public ModelAndView handleUserNotFound(UserNotFoundException ex) {
        ModelAndView mav = new ModelAndView();
        mav.addObject("error", ex.getMessage());
        mav.setViewName("error");
        return mav;
    }
    
    // 处理所有异常
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Map<String, Object> handleException(Exception ex) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 500);
        result.put("message", ex.getMessage());
        return result;
    }
}
```

### 4.3 RESTful 异常处理

```java
@RestControllerAdvice
public class RestExceptionHandler {
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleException(Exception ex) {
        ErrorResponse error = new ErrorResponse(
            500, 
            ex.getMessage(),
            System.currentTimeMillis()
        );
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                           .body(error);
    }
}
```

---

## 五、文件上传

### 5.1 配置文件上传解析器

**添加依赖：**
```xml
<dependency>
    <groupId>commons-fileupload</groupId>
    <artifactId>commons-fileupload</artifactId>
    <version>1.4</version>
</dependency>
```

**配置解析器：**
```xml
<bean id="multipartResolver" 
      class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
    <property name="maxUploadSize" value="10485760"/> <!-- 10MB -->
    <property name="defaultEncoding" value="UTF-8"/>
</bean>
```

### 5.2 单文件上传

**HTML 表单：**
```html
<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file">
    <button type="submit">上传</button>
</form>
```

**Controller：**
```java
@PostMapping("/upload")
public String upload(@RequestParam("file") MultipartFile file) 
        throws IOException {
    
    if (!file.isEmpty()) {
        // 获取文件名
        String fileName = file.getOriginalFilename();
        
        // 保存路径
        String savePath = "/uploads/" + fileName;
        File dest = new File(savePath);
        
        // 保存文件
        file.transferTo(dest);
        
        return "success";
    }
    return "error";
}
```

### 5.3 多文件上传

```java
@PostMapping("/upload/multiple")
public String uploadMultiple(@RequestParam("files") MultipartFile[] files) 
        throws IOException {
    
    for (MultipartFile file : files) {
        if (!file.isEmpty()) {
            String fileName = file.getOriginalFilename();
            file.transferTo(new File("/uploads/" + fileName));
        }
    }
    return "success";
}
```

---

## 六、文件下载

```java
@GetMapping("/download")
public ResponseEntity<Resource> download(@RequestParam String fileName) 
        throws IOException {
    
    // 文件路径
    Path filePath = Paths.get("/uploads/" + fileName);
    Resource resource = new UrlResource(filePath.toUri());
    
    if (resource.exists()) {
        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, 
                       "attachment; filename=\"" + fileName + "\"")
                .body(resource);
    }
    return ResponseEntity.notFound().build();
}
```

---

## 七、跨域配置

### 7.1 @CrossOrigin

**方法级别：**
```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @CrossOrigin(origins = "http://localhost:3000")
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
}
```

**类级别：**
```java
@RestController
@RequestMapping("/api/user")
@CrossOrigin(origins = "*")
public class UserController {
    // 所有方法都允许跨域
}
```

### 7.2 全局跨域配置

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:3000")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }
}
```

---

## 八、总结

✅ **本章学习内容：**
- 请求参数处理
- 响应处理
- 拦截器
- 异常处理
- 文件上传下载
- 跨域配置

✅ **核心要点：**
- 掌握各种参数注解的使用
- 理解拦截器的执行流程
- 使用 @ControllerAdvice 统一异常处理
- 配置文件上传和跨域

**下一章预告：** 我们将学习数据绑定与验证。
