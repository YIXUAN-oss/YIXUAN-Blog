---
title: å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹
---

# å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹

> æŒæ¡Pythonå¹¶å‘ç¼–ç¨‹ï¼Œæå‡ç¨‹åºæ€§èƒ½

## ğŸ“š å­¦ä¹ ç›®æ ‡

- ç†è§£çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«
- æŒæ¡ threading æ¨¡å—
- æŒæ¡ multiprocessing æ¨¡å—
- å­¦ä¼šä½¿ç”¨çº¿ç¨‹æ± å’Œè¿›ç¨‹æ± 
- ç†è§£ GIL çš„å½±å“

## 1. çº¿ç¨‹åŸºç¡€

### 1.1 åˆ›å»ºçº¿ç¨‹

```python
import threading
import time

def worker(name):
    print(f'çº¿ç¨‹ {name} å¼€å§‹')
    time.sleep(2)
    print(f'çº¿ç¨‹ {name} ç»“æŸ')

# åˆ›å»ºçº¿ç¨‹
t = threading.Thread(target=worker, args=('A',))
t.start()  # å¯åŠ¨çº¿ç¨‹
t.join()   # ç­‰å¾…çº¿ç¨‹ç»“æŸ

print('ä¸»çº¿ç¨‹ç»“æŸ')
```

### 1.2 ç»§æ‰¿ Thread ç±»

```python
class MyThread(threading.Thread):
    def __init__(self, name):
        super().__init__()
        self.name = name
    
    def run(self):
        print(f'{self.name} å¼€å§‹æ‰§è¡Œ')
        time.sleep(1)
        print(f'{self.name} æ‰§è¡Œå®Œæˆ')

# ä½¿ç”¨
t = MyThread('Worker-1')
t.start()
t.join()
```

### 1.3 å¤šä¸ªçº¿ç¨‹

```python
import threading

def print_numbers():
    for i in range(5):
        print(f'æ•°å­—: {i}')
        time.sleep(0.1)

def print_letters():
    for letter in 'ABCDE':
        print(f'å­—æ¯: {letter}')
        time.sleep(0.1)

# åˆ›å»ºå¤šä¸ªçº¿ç¨‹
t1 = threading.Thread(target=print_numbers)
t2 = threading.Thread(target=print_letters)

t1.start()
t2.start()

t1.join()
t2.join()
```

## 2. çº¿ç¨‹åŒæ­¥

### 2.1 Lock é”

```python
import threading

counter = 0
lock = threading.Lock()

def increment():
    global counter
    for _ in range(100000):
        lock.acquire()
        try:
            counter += 1
        finally:
            lock.release()

# æˆ–ä½¿ç”¨ with è¯­å¥
def increment_with():
    global counter
    for _ in range(100000):
        with lock:
            counter += 1

threads = [threading.Thread(target=increment) for _ in range(10)]

for t in threads:
    t.start()

for t in threads:
    t.join()

print(f'Counter: {counter}')
```

### 2.2 RLock å¯é‡å…¥é”

```python
import threading

rlock = threading.RLock()

def recursive_function(n):
    with rlock:
        if n > 0:
            print(n)
            recursive_function(n - 1)

t = threading.Thread(target=recursive_function, args=(5,))
t.start()
t.join()
```

### 2.3 Semaphore ä¿¡å·é‡

```python
import threading

# é™åˆ¶åŒæ—¶è®¿é—®çš„çº¿ç¨‹æ•°
semaphore = threading.Semaphore(3)

def access_resource(name):
    with semaphore:
        print(f'{name} è·å–èµ„æº')
        time.sleep(2)
        print(f'{name} é‡Šæ”¾èµ„æº')

threads = [threading.Thread(target=access_resource, args=(f'Thread-{i}',)) 
           for i in range(10)]

for t in threads:
    t.start()
```

### 2.4 Event äº‹ä»¶

```python
import threading

event = threading.Event()

def waiter():
    print('ç­‰å¾…äº‹ä»¶...')
    event.wait()  # é˜»å¡ç›´åˆ°äº‹ä»¶è¢«è®¾ç½®
    print('äº‹ä»¶å·²è§¦å‘!')

def setter():
    time.sleep(2)
    print('è®¾ç½®äº‹ä»¶')
    event.set()  # è§¦å‘äº‹ä»¶

t1 = threading.Thread(target=waiter)
t2 = threading.Thread(target=setter)

t1.start()
t2.start()
```

## 3. çº¿ç¨‹æ± 

### 3.1 ThreadPoolExecutor

```python
from concurrent.futures import ThreadPoolExecutor
import time

def task(n):
    print(f'ä»»åŠ¡ {n} å¼€å§‹')
    time.sleep(1)
    return n * n

# åˆ›å»ºçº¿ç¨‹æ± 
with ThreadPoolExecutor(max_workers=5) as executor:
    # æäº¤ä»»åŠ¡
    futures = [executor.submit(task, i) for i in range(10)]
    
    # è·å–ç»“æœ
    for future in futures:
        result = future.result()
        print(f'ç»“æœ: {result}')
```

### 3.2 map() æ–¹æ³•

```python
from concurrent.futures import ThreadPoolExecutor

def square(n):
    return n * n

with ThreadPoolExecutor(max_workers=5) as executor:
    results = executor.map(square, range(10))
    print(list(results))
```

## 4. è¿›ç¨‹åŸºç¡€

### 4.1 åˆ›å»ºè¿›ç¨‹

```python
from multiprocessing import Process
import os

def worker(name):
    print(f'è¿›ç¨‹ {name}, PID: {os.getpid()}')
    time.sleep(2)
    print(f'è¿›ç¨‹ {name} å®Œæˆ')

if __name__ == '__main__':
    p = Process(target=worker, args=('Worker-1',))
    p.start()
    p.join()
    print('ä¸»è¿›ç¨‹ç»“æŸ')
```

### 4.2 è¿›ç¨‹æ± 

```python
from multiprocessing import Pool

def square(n):
    return n * n

if __name__ == '__main__':
    with Pool(processes=4) as pool:
        results = pool.map(square, range(10))
        print(results)
```

### 4.3 ProcessPoolExecutor

```python
from concurrent.futures import ProcessPoolExecutor

def compute(n):
    return sum(i * i for i in range(n))

if __name__ == '__main__':
    with ProcessPoolExecutor(max_workers=4) as executor:
        results = executor.map(compute, [10**6, 10**6, 10**6])
        for result in results:
            print(result)
```

## 5. è¿›ç¨‹é—´é€šä¿¡

### 5.1 Queue é˜Ÿåˆ—

```python
from multiprocessing import Process, Queue

def producer(queue):
    for i in range(5):
        queue.put(i)
        print(f'ç”Ÿäº§: {i}')

def consumer(queue):
    while True:
        item = queue.get()
        if item is None:
            break
        print(f'æ¶ˆè´¹: {item}')

if __name__ == '__main__':
    queue = Queue()
    
    p1 = Process(target=producer, args=(queue,))
    p2 = Process(target=consumer, args=(queue,))
    
    p1.start()
    p2.start()
    
    p1.join()
    queue.put(None)  # å‘é€ç»“æŸä¿¡å·
    p2.join()
```

### 5.2 Pipe ç®¡é“

```python
from multiprocessing import Process, Pipe

def sender(conn):
    conn.send(['hello', 'world'])
    conn.close()

def receiver(conn):
    data = conn.recv()
    print(f'æ¥æ”¶åˆ°: {data}')

if __name__ == '__main__':
    parent_conn, child_conn = Pipe()
    
    p1 = Process(target=sender, args=(parent_conn,))
    p2 = Process(target=receiver, args=(child_conn,))
    
    p1.start()
    p2.start()
    
    p1.join()
    p2.join()
```

### 5.3 Manager å…±äº«æ•°æ®

```python
from multiprocessing import Process, Manager

def worker(shared_list, shared_dict):
    shared_list.append(1)
    shared_dict['key'] = 'value'

if __name__ == '__main__':
    with Manager() as manager:
        shared_list = manager.list()
        shared_dict = manager.dict()
        
        processes = [Process(target=worker, args=(shared_list, shared_dict)) 
                     for _ in range(5)]
        
        for p in processes:
            p.start()
        for p in processes:
            p.join()
        
        print(shared_list)
        print(shared_dict)
```

## 6. çº¿ç¨‹ vs è¿›ç¨‹

### 6.1 ä½•æ—¶ä½¿ç”¨çº¿ç¨‹

```python
# I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰
import threading
import requests

def download(url):
    response = requests.get(url)
    print(f'Downloaded {len(response.content)} bytes')

urls = ['https://example.com'] * 10

threads = [threading.Thread(target=download, args=(url,)) for url in urls]

for t in threads:
    t.start()
for t in threads:
    t.join()
```

### 6.2 ä½•æ—¶ä½¿ç”¨è¿›ç¨‹

```python
# CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆè®¡ç®—å¯†é›†ï¼‰
from multiprocessing import Pool

def compute_intensive(n):
    return sum(i * i for i in range(n))

if __name__ == '__main__':
    with Pool(processes=4) as pool:
        results = pool.map(compute_intensive, [10**7] * 4)
        print(sum(results))
```

## 7. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå¤šçº¿ç¨‹ä¸‹è½½

```python
import threading
import requests

def download_file(url, filename):
    response = requests.get(url)
    with open(filename, 'wb') as f:
        f.write(response.content)
    print(f'{filename} ä¸‹è½½å®Œæˆ')

urls = {
    'file1.jpg': 'https://example.com/image1.jpg',
    'file2.jpg': 'https://example.com/image2.jpg',
}

threads = []
for filename, url in urls.items():
    t = threading.Thread(target=download_file, args=(url, filename))
    threads.append(t)
    t.start()

for t in threads:
    t.join()

print('æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆ')
```

### æ¡ˆä¾‹2ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

```python
import threading
import queue
import time

def producer(q, name):
    for i in range(5):
        item = f'{name}-{i}'
        q.put(item)
        print(f'ç”Ÿäº§: {item}')
        time.sleep(0.5)

def consumer(q, name):
    while True:
        try:
            item = q.get(timeout=2)
            print(f'{name} æ¶ˆè´¹: {item}')
            q.task_done()
        except queue.Empty:
            break

q = queue.Queue()

# åˆ›å»ºç”Ÿäº§è€…
producers = [threading.Thread(target=producer, args=(q, f'Producer-{i}')) 
             for i in range(2)]

# åˆ›å»ºæ¶ˆè´¹è€…
consumers = [threading.Thread(target=consumer, args=(q, f'Consumer-{i}')) 
             for i in range(3)]

for p in producers:
    p.start()
for c in consumers:
    c.start()

for p in producers:
    p.join()
q.join()  # ç­‰å¾…é˜Ÿåˆ—ä¸ºç©º

print('å®Œæˆ')
```

## ğŸ“ ç»ƒä¹ é¢˜

1. å®ç°ä¸€ä¸ªå¤šçº¿ç¨‹ç½‘é¡µçˆ¬è™«
2. ä½¿ç”¨å¤šè¿›ç¨‹è¿›è¡Œå›¾åƒæ‰¹å¤„ç†
3. åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ç±»

---

**ä¸‹ä¸€èŠ‚ï¼š** è¿›å…¥[ç¬¬04ç«  æ•°æ®ç»“æ„ä¸ç®—æ³•](../ç¬¬04ç« -æ•°æ®ç»“æ„ä¸ç®—æ³•/)
