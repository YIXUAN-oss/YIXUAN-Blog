---
title: 文件操作
---

# 文件操作

> 掌握Python文件的读写操作，处理文本和二进制文件

## 📚 学习目标

- 理解文件操作的基本概念
- 掌握文件的打开、读取和写入
- 学会使用with语句管理文件
- 掌握文件路径操作
- 学习处理不同格式的文件

## 1. 文件的基本操作

### 1.1 打开文件

```python
# 基本语法
file = open('filename', 'mode', encoding='utf-8')

# 常用模式
# 'r'  - 只读（默认）
# 'w'  - 写入（会覆盖原文件）
# 'a'  - 追加
# 'r+' - 读写
# 'b'  - 二进制模式
# 't'  - 文本模式（默认）

# 示例
file = open('test.txt', 'r', encoding='utf-8')
print(file.read())
file.close()
```

### 1.2 关闭文件

```python
# 方式1：手动关闭
file = open('test.txt', 'r')
content = file.read()
file.close()  # 必须关闭！

# 方式2：使用 with 语句（推荐）
with open('test.txt', 'r', encoding='utf-8') as file:
    content = file.read()
    # 自动关闭文件，即使发生异常
```

## 2. 文件读取

### 2.1 read() - 读取全部内容

```python
# 读取整个文件
with open('test.txt', 'r', encoding='utf-8') as f:
    content = f.read()
    print(content)

# 读取指定字节数
with open('test.txt', 'r', encoding='utf-8') as f:
    content = f.read(10)  # 读取前10个字符
    print(content)
```

### 2.2 readline() - 读取一行

```python
with open('test.txt', 'r', encoding='utf-8') as f:
    line1 = f.readline()  # 读取第一行
    line2 = f.readline()  # 读取第二行
    print(line1, line2)
```

### 2.3 readlines() - 读取所有行

```python
with open('test.txt', 'r', encoding='utf-8') as f:
    lines = f.readlines()  # 返回列表
    for line in lines:
        print(line.strip())  # strip() 去除换行符
```

### 2.4 循环读取（推荐）

```python
# 内存友好的方式
with open('test.txt', 'r', encoding='utf-8') as f:
    for line in f:
        print(line.strip())
```

## 3. 文件写入

### 3.1 write() - 写入字符串

```python
# 写入模式（覆盖）
with open('output.txt', 'w', encoding='utf-8') as f:
    f.write('Hello, Python!\n')
    f.write('这是第二行\n')

# 追加模式
with open('output.txt', 'a', encoding='utf-8') as f:
    f.write('追加的内容\n')
```

### 3.2 writelines() - 写入多行

```python
lines = ['第一行\n', '第二行\n', '第三行\n']

with open('output.txt', 'w', encoding='utf-8') as f:
    f.writelines(lines)
```

### 3.3 实用示例：文件复制

```python
# 文本文件复制
with open('source.txt', 'r', encoding='utf-8') as source:
    with open('target.txt', 'w', encoding='utf-8') as target:
        content = source.read()
        target.write(content)

# 逐行复制（大文件）
with open('source.txt', 'r', encoding='utf-8') as source:
    with open('target.txt', 'w', encoding='utf-8') as target:
        for line in source:
            target.write(line)
```

## 4. 二进制文件操作

### 4.1 读写二进制文件

```python
# 读取二进制文件（图片、音频等）
with open('image.jpg', 'rb') as f:
    data = f.read()
    print(f'文件大小: {len(data)} 字节')

# 写入二进制文件
with open('copy_image.jpg', 'wb') as f:
    f.write(data)
```

### 4.2 文件复制（二进制）

```python
def copy_file(source, target):
    """复制任意类型文件"""
    with open(source, 'rb') as src:
        with open(target, 'wb') as dst:
            dst.write(src.read())

copy_file('original.jpg', 'backup.jpg')
```

## 5. 文件路径操作

### 5.1 os 模块

```python
import os

# 获取当前工作目录
print(os.getcwd())

# 改变工作目录
os.chdir('/path/to/directory')

# 列出目录内容
files = os.listdir('.')
print(files)

# 创建目录
os.mkdir('new_folder')
os.makedirs('parent/child/grandchild')  # 创建多级目录

# 删除目录
os.rmdir('empty_folder')  # 只能删除空目录

# 重命名
os.rename('old_name.txt', 'new_name.txt')

# 删除文件
os.remove('file.txt')

# 检查路径是否存在
if os.path.exists('file.txt'):
    print('文件存在')

# 判断是文件还是目录
print(os.path.isfile('test.txt'))
print(os.path.isdir('folder'))

# 获取文件大小
size = os.path.getsize('test.txt')
print(f'文件大小: {size} 字节')
```

### 5.2 os.path 模块

```python
import os.path

path = '/home/user/documents/file.txt'

# 路径拼接
new_path = os.path.join('folder', 'subfolder', 'file.txt')

# 分离路径和文件名
dir_name, file_name = os.path.split(path)
print(f'目录: {dir_name}')
print(f'文件名: {file_name}')

# 分离文件名和扩展名
name, ext = os.path.splitext('document.pdf')
print(f'名称: {name}, 扩展名: {ext}')

# 获取绝对路径
abs_path = os.path.abspath('file.txt')

# 获取文件所在目录
dir_path = os.path.dirname('/path/to/file.txt')

# 获取文件名
file_name = os.path.basename('/path/to/file.txt')
```

### 5.3 pathlib 模块（推荐）

```python
from pathlib import Path

# 创建路径对象
p = Path('folder/subfolder/file.txt')

# 路径拼接
path = Path('folder') / 'subfolder' / 'file.txt'

# 获取当前目录
current = Path.cwd()

# 获取家目录
home = Path.home()

# 创建目录
Path('new_folder').mkdir(exist_ok=True)
Path('parent/child').mkdir(parents=True, exist_ok=True)

# 读写文件
path = Path('test.txt')
path.write_text('Hello, World!', encoding='utf-8')
content = path.read_text(encoding='utf-8')

# 检查文件是否存在
if path.exists():
    print('文件存在')

# 判断是文件还是目录
print(path.is_file())
print(path.is_dir())

# 获取文件信息
print(f'文件名: {path.name}')
print(f'扩展名: {path.suffix}')
print(f'不含扩展名: {path.stem}')
print(f'父目录: {path.parent}')

# 遍历目录
for item in Path('.').iterdir():
    if item.is_file():
        print(f'文件: {item}')

# 递归查找文件
for txt_file in Path('.').rglob('*.txt'):
    print(txt_file)
```

## 6. 处理特殊格式文件

### 6.1 CSV 文件

```python
import csv

# 读取 CSV
with open('data.csv', 'r', encoding='utf-8') as f:
    reader = csv.reader(f)
    for row in reader:
        print(row)

# 写入 CSV
data = [
    ['姓名', '年龄', '城市'],
    ['张三', '25', '北京'],
    ['李四', '30', '上海']
]

with open('output.csv', 'w', newline='', encoding='utf-8') as f:
    writer = csv.writer(f)
    writer.writerows(data)

# 使用字典读写
with open('data.csv', 'r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    for row in reader:
        print(row['姓名'], row['年龄'])

with open('output.csv', 'w', newline='', encoding='utf-8') as f:
    fieldnames = ['姓名', '年龄', '城市']
    writer = csv.DictWriter(f, fieldnames=fieldnames)
    writer.writeheader()
    writer.writerow({'姓名': '王五', '年龄': '28', '城市': '深圳'})
```

### 6.2 JSON 文件

```python
import json

# 读取 JSON
with open('data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
    print(data)

# 写入 JSON
data = {
    'name': '张三',
    'age': 25,
    'skills': ['Python', 'Java', 'Go']
}

with open('output.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

# JSON 字符串转换
json_str = json.dumps(data, ensure_ascii=False, indent=2)
data_dict = json.loads(json_str)
```

### 6.3 文本文件编码处理

```python
# 读取不同编码的文件
encodings = ['utf-8', 'gbk', 'gb2312']

for encoding in encodings:
    try:
        with open('file.txt', 'r', encoding=encoding) as f:
            content = f.read()
            print(f'成功使用 {encoding} 编码读取')
            break
    except UnicodeDecodeError:
        continue

# 转换文件编码
def convert_encoding(input_file, output_file, from_enc, to_enc):
    with open(input_file, 'r', encoding=from_enc) as f:
        content = f.read()
    with open(output_file, 'w', encoding=to_enc) as f:
        f.write(content)

convert_encoding('gbk_file.txt', 'utf8_file.txt', 'gbk', 'utf-8')
```

## 7. 实战案例

### 案例1：统计文件行数和字数

```python
def count_file(filename):
    """统计文件的行数和字数"""
    with open(filename, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        line_count = len(lines)
        word_count = sum(len(line.split()) for line in lines)
        char_count = sum(len(line) for line in lines)
        
    print(f'行数: {line_count}')
    print(f'单词数: {word_count}')
    print(f'字符数: {char_count}')

count_file('document.txt')
```

### 案例2：批量重命名文件

```python
from pathlib import Path

def batch_rename(directory, old_ext, new_ext):
    """批量修改文件扩展名"""
    path = Path(directory)
    count = 0
    
    for file in path.glob(f'*.{old_ext}'):
        new_name = file.stem + f'.{new_ext}'
        file.rename(file.parent / new_name)
        count += 1
        print(f'重命名: {file.name} -> {new_name}')
    
    print(f'共重命名 {count} 个文件')

batch_rename('.', 'txt', 'md')
```

### 案例3：文件内容查找

```python
def search_in_file(filename, keyword):
    """在文件中搜索关键词"""
    with open(filename, 'r', encoding='utf-8') as f:
        for line_num, line in enumerate(f, 1):
            if keyword in line:
                print(f'第 {line_num} 行: {line.strip()}')

search_in_file('log.txt', 'ERROR')
```

### 案例4：日志文件分析

```python
from collections import Counter
from datetime import datetime

def analyze_log(log_file):
    """分析日志文件"""
    levels = []
    
    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            if 'ERROR' in line:
                levels.append('ERROR')
            elif 'WARNING' in line:
                levels.append('WARNING')
            elif 'INFO' in line:
                levels.append('INFO')
    
    # 统计各级别数量
    counter = Counter(levels)
    print('日志级别统计:')
    for level, count in counter.items():
        print(f'{level}: {count}')

analyze_log('app.log')
```

## 8. 常见问题

### 8.1 文件未关闭

```python
# ❌ 错误示例
f = open('file.txt', 'r')
content = f.read()
# 忘记关闭文件

# ✅ 正确示例
with open('file.txt', 'r') as f:
    content = f.read()
# 自动关闭
```

### 8.2 编码问题

```python
# ❌ 可能出错
with open('file.txt', 'r') as f:  # 使用默认编码
    content = f.read()

# ✅ 明确指定编码
with open('file.txt', 'r', encoding='utf-8') as f:
    content = f.read()
```

### 8.3 路径问题

```python
# ❌ 硬编码路径
file = open('C:\\Users\\user\\file.txt', 'r')

# ✅ 使用 pathlib
from pathlib import Path
file_path = Path.home() / 'documents' / 'file.txt'
with open(file_path, 'r', encoding='utf-8') as f:
    content = f.read()
```

## 💡 最佳实践

1. **始终使用 with 语句** - 自动管理文件资源
2. **明确指定编码** - 避免编码问题
3. **使用 pathlib** - 跨平台路径处理
4. **大文件逐行读取** - 避免内存溢出
5. **异常处理** - 处理文件不存在等异常情况

## 📝 练习题

1. 编写程序，读取一个文本文件，统计每个单词出现的次数
2. 实现一个文件备份工具，定期备份指定文件夹
3. 编写程序，合并多个文本文件的内容
4. 实现一个简单的日志记录器，将日志写入文件
5. 编写程序，将 CSV 文件转换为 JSON 格式

---

**下一节：** [迭代器与生成器](02-迭代器与生成器.md)
