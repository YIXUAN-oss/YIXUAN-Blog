---
title: ä¸Šä¸‹æ–‡ç®¡ç†å™¨
---

# ä¸Šä¸‹æ–‡ç®¡ç†å™¨

> æŒæ¡Pythonä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œä¼˜é›…åœ°ç®¡ç†èµ„æº

## ğŸ“š å­¦ä¹ ç›®æ ‡

- ç†è§£ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„æ¦‚å¿µ
- æŒæ¡ with è¯­å¥çš„ä½¿ç”¨
- å­¦ä¼šåˆ›å»ºè‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- æŒæ¡ contextlib æ¨¡å—

## 1. ä¸Šä¸‹æ–‡ç®¡ç†å™¨åŸºç¡€

### 1.1 with è¯­å¥

```python
# ä¸ä½¿ç”¨ with
file = open('test.txt', 'r')
try:
    content = file.read()
finally:
    file.close()

# ä½¿ç”¨ withï¼ˆæ¨èï¼‰
with open('test.txt', 'r', encoding='utf-8') as file:
    content = file.read()
# è‡ªåŠ¨å…³é—­æ–‡ä»¶
```

### 1.2 å·¥ä½œåŸç†

```python
# with è¯­å¥ä¼šè‡ªåŠ¨è°ƒç”¨ï¼š
# 1. __enter__() - è¿›å…¥æ—¶
# 2. __exit__()  - é€€å‡ºæ—¶

class MyContext:
    def __enter__(self):
        print('è¿›å…¥ä¸Šä¸‹æ–‡')
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        print('é€€å‡ºä¸Šä¸‹æ–‡')
        return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸

with MyContext() as ctx:
    print('æ‰§è¡Œä»£ç ')
```

## 2. è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### 2.1 ç±»æ–¹å¼å®ç°

```python
class DatabaseConnection:
    """æ•°æ®åº“è¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.connection = None
    
    def __enter__(self):
        print(f'è¿æ¥æ•°æ®åº“: {self.host}:{self.port}')
        self.connection = self._connect()
        return self.connection
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.connection:
            self.connection.close()
            print('å…³é—­æ•°æ®åº“è¿æ¥')
        
        if exc_type is not None:
            print(f'å‘ç”Ÿå¼‚å¸¸: {exc_type.__name__}: {exc_val}')
        
        return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸
    
    def _connect(self):
        # æ¨¡æ‹Ÿè¿æ¥
        return {'connected': True}

# ä½¿ç”¨
with DatabaseConnection('localhost', 3306) as conn:
    print(f'ä½¿ç”¨è¿æ¥: {conn}')
```

### 2.2 æ–‡ä»¶å†™å…¥ç®¡ç†å™¨

```python
class FileWriter:
    """æ–‡ä»¶å†™å…¥ç®¡ç†å™¨"""
    
    def __init__(self, filename):
        self.filename = filename
        self.file = None
    
    def __enter__(self):
        self.file = open(self.filename, 'w', encoding='utf-8')
        return self.file
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.file:
            self.file.close()
        return False

with FileWriter('output.txt') as f:
    f.write('Hello, World!')
```

## 3. contextlib æ¨¡å—

### 3.1 contextmanager è£…é¥°å™¨

```python
from contextlib import contextmanager

@contextmanager
def file_manager(filename, mode):
    """æ–‡ä»¶ç®¡ç†å™¨"""
    file = open(filename, mode, encoding='utf-8')
    try:
        yield file  # yield å‰é¢æ˜¯ __enter__
    finally:
        file.close()  # finally æ˜¯ __exit__

# ä½¿ç”¨
with file_manager('test.txt', 'w') as f:
    f.write('ä½¿ç”¨ contextmanager')
```

### 3.2 æ•°æ®åº“äº‹åŠ¡ç®¡ç†

```python
from contextlib import contextmanager

@contextmanager
def transaction(connection):
    """æ•°æ®åº“äº‹åŠ¡ç®¡ç†å™¨"""
    cursor = connection.cursor()
    try:
        yield cursor
        connection.commit()  # æäº¤äº‹åŠ¡
        print('äº‹åŠ¡æäº¤æˆåŠŸ')
    except Exception as e:
        connection.rollback()  # å›æ»šäº‹åŠ¡
        print(f'äº‹åŠ¡å›æ»š: {e}')
        raise
    finally:
        cursor.close()

# ä½¿ç”¨
with transaction(db_connection) as cursor:
    cursor.execute('INSERT INTO users VALUES (...)')
    cursor.execute('UPDATE accounts SET ...')
```

### 3.3 è®¡æ—¶å™¨

```python
from contextlib import contextmanager
import time

@contextmanager
def timer(name):
    """è®¡æ—¶ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    start = time.time()
    yield
    end = time.time()
    print(f'{name} è€—æ—¶: {end - start:.4f}ç§’')

# ä½¿ç”¨
with timer('æ•°æ®å¤„ç†'):
    # æ‰§è¡Œè€—æ—¶æ“ä½œ
    sum([i**2 for i in range(1000000)])
```

## 4. åµŒå¥—ä¸Šä¸‹æ–‡ç®¡ç†å™¨

### 4.1 å¤šä¸ª with è¯­å¥

```python
# æ–¹å¼1ï¼šåµŒå¥—
with open('input.txt', 'r') as in_file:
    with open('output.txt', 'w') as out_file:
        out_file.write(in_file.read())

# æ–¹å¼2ï¼šä¸€è¡Œï¼ˆPython 3.1+ï¼‰
with open('input.txt', 'r') as in_file, \
     open('output.txt', 'w') as out_file:
    out_file.write(in_file.read())
```

### 4.2 ExitStack

```python
from contextlib import ExitStack

def process_files(filenames):
    """åŒæ—¶å¤„ç†å¤šä¸ªæ–‡ä»¶"""
    with ExitStack() as stack:
        files = [stack.enter_context(open(fname, 'r')) 
                 for fname in filenames]
        
        for f in files:
            print(f.read())

process_files(['file1.txt', 'file2.txt', 'file3.txt'])
```

## 5. å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šä¸´æ—¶ç›®å½•

```python
import os
import tempfile
from contextlib import contextmanager

@contextmanager
def temporary_directory():
    """ä¸´æ—¶ç›®å½•ç®¡ç†å™¨"""
    temp_dir = tempfile.mkdtemp()
    print(f'åˆ›å»ºä¸´æ—¶ç›®å½•: {temp_dir}')
    try:
        yield temp_dir
    finally:
        import shutil
        shutil.rmtree(temp_dir)
        print(f'åˆ é™¤ä¸´æ—¶ç›®å½•: {temp_dir}')

# ä½¿ç”¨
with temporary_directory() as temp_dir:
    # åœ¨ä¸´æ—¶ç›®å½•ä¸­å·¥ä½œ
    file_path = os.path.join(temp_dir, 'temp.txt')
    with open(file_path, 'w') as f:
        f.write('ä¸´æ—¶æ•°æ®')
```

### æ¡ˆä¾‹2ï¼šçŠ¶æ€åˆ‡æ¢

```python
from contextlib import contextmanager

@contextmanager
def change_dir(path):
    """ä¸´æ—¶åˆ‡æ¢ç›®å½•"""
    old_dir = os.getcwd()
    os.chdir(path)
    try:
        yield
    finally:
        os.chdir(old_dir)

# ä½¿ç”¨
print(f'å½“å‰ç›®å½•: {os.getcwd()}')
with change_dir('/tmp'):
    print(f'ä¸´æ—¶ç›®å½•: {os.getcwd()}')
print(f'æ¢å¤ç›®å½•: {os.getcwd()}')
```

### æ¡ˆä¾‹3ï¼šèµ„æºé”

```python
import threading
from contextlib import contextmanager

@contextmanager
def acquire_lock(lock):
    """é”ç®¡ç†å™¨"""
    lock.acquire()
    print('è·å–é”')
    try:
        yield
    finally:
        lock.release()
        print('é‡Šæ”¾é”')

# ä½¿ç”¨
lock = threading.Lock()
with acquire_lock(lock):
    # æ‰§è¡Œéœ€è¦åŒæ­¥çš„ä»£ç 
    print('æ‰§è¡ŒåŒæ­¥æ“ä½œ')
```

## 6. å¼‚å¸¸å¤„ç†

### 6.1 æŠ‘åˆ¶å¼‚å¸¸

```python
class SuppressError:
    """æŠ‘åˆ¶ç‰¹å®šå¼‚å¸¸"""
    
    def __init__(self, *exceptions):
        self.exceptions = exceptions
    
    def __enter__(self):
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if exc_type is not None:
            if issubclass(exc_type, self.exceptions):
                print(f'æŠ‘åˆ¶å¼‚å¸¸: {exc_type.__name__}')
                return True  # æŠ‘åˆ¶å¼‚å¸¸
        return False

# ä½¿ç”¨
with SuppressError(ValueError, TypeError):
    int('abc')  # å¼‚å¸¸è¢«æŠ‘åˆ¶
    print('ç»§ç»­æ‰§è¡Œ')
```

### 6.2 suppress ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
from contextlib import suppress

# å¿½ç•¥ç‰¹å®šå¼‚å¸¸
with suppress(FileNotFoundError):
    os.remove('nonexistent_file.txt')

# ç­‰ä»·äº
try:
    os.remove('nonexistent_file.txt')
except FileNotFoundError:
    pass
```

## 7. æœ€ä½³å®è·µ

```python
# âœ… ä½¿ç”¨ with ç®¡ç†èµ„æº
with open('file.txt', 'r') as f:
    content = f.read()

# âœ… ä½¿ç”¨ contextmanager ç®€åŒ–ä»£ç 
from contextlib import contextmanager

@contextmanager
def managed_resource():
    resource = acquire_resource()
    try:
        yield resource
    finally:
        release_resource(resource)

# âœ… å¼‚å¸¸å¤„ç†
with open('file.txt', 'r') as f:
    try:
        content = f.read()
    except Exception as e:
        print(f'è¯»å–å¤±è´¥: {e}')
```

## ğŸ“ ç»ƒä¹ é¢˜

1. åˆ›å»ºä¸€ä¸ªè®¡æ—¶ä¸Šä¸‹æ–‡ç®¡ç†å™¨
2. å®ç°ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ç®¡ç†å™¨
3. ç¼–å†™ä¸€ä¸ªä¸´æ—¶ç¯å¢ƒå˜é‡ç®¡ç†å™¨

---

**ä¸‹ä¸€èŠ‚ï¼š** [æ­£åˆ™è¡¨è¾¾å¼](05-æ­£åˆ™è¡¨è¾¾å¼.md)
