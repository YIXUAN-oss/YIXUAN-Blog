---
title: 数据选择与索引
---

# 数据选择与索引

> 掌握Pandas的数据选择和索引技巧

## 📚 学习目标

- 掌握列选择方法
- 理解loc和iloc的区别
- 掌握布尔索引
- 学会使用query方法
- 理解多层索引

## 1. 列选择

```python
import pandas as pd

df = pd.DataFrame({
    'name': ['Alice', 'Bob', 'Charlie'],
    'age': [25, 30, 35],
    'city': ['NY', 'Paris', 'London'],
    'salary': [50000, 60000, 70000]
})

# 单列选择（返回Series）
name_col = df['name']
print(type(name_col))  # Series

# 属性访问
age_col = df.age

# 多列选择（返回DataFrame）
subset = df[['name', 'age']]
print(type(subset))  # DataFrame

# 选择所有列除了某些列
cols = df.columns.drop(['city'])
subset = df[cols]
```

## 2. 行选择

```python
# 切片选择
first_two = df[0:2]
print(first_two)

# 条件选择
young = df[df['age'] < 30]
print(young)

# 多条件
high_salary = df[(df['age'] > 25) & (df['salary'] > 55000)]
print(high_salary)
```

## 3. loc - 标签索引

```python
df = pd.DataFrame({
    'A': [1, 2, 3, 4],
    'B': [5, 6, 7, 8],
    'C': [9, 10, 11, 12]
}, index=['row1', 'row2', 'row3', 'row4'])

# 选择单行
print(df.loc['row1'])

# 选择多行
print(df.loc[['row1', 'row3']])

# 选择行和列
print(df.loc['row1', 'A'])
print(df.loc['row1':'row3', 'A':'B'])

# 选择所有行，部分列
print(df.loc[:, ['A', 'C']])

# 条件选择
print(df.loc[df['A'] > 2])

# 赋值
df.loc['row1', 'A'] = 100
```

## 4. iloc - 位置索引

```python
# 选择单行
print(df.iloc[0])

# 选择多行
print(df.iloc[[0, 2]])

# 切片
print(df.iloc[0:2])

# 选择行和列
print(df.iloc[0, 0])  # 第1行第1列
print(df.iloc[0:2, 0:2])  # 前2行前2列

# 选择所有行，部分列
print(df.iloc[:, [0, 2]])

# 负索引
print(df.iloc[-1])  # 最后一行
```

## 5. at 和 iat - 快速标量访问

```python
# at - 标签访问（更快）
value = df.at['row1', 'A']

# iat - 位置访问（更快）
value = df.iat[0, 0]

# 赋值
df.at['row1', 'A'] = 999
df.iat[0, 0] = 888
```

## 6. 布尔索引

```python
df = pd.DataFrame({
    'name': ['Alice', 'Bob', 'Charlie', 'David'],
    'age': [25, 30, 35, 40],
    'salary': [50000, 60000, 70000, 80000]
})

# 单条件
young = df[df['age'] < 35]

# 多条件（与）
result = df[(df['age'] > 25) & (df['salary'] > 55000)]

# 多条件（或）
result = df[(df['age'] < 30) | (df['salary'] > 70000)]

# 取反
result = df[~(df['age'] < 30)]

# isin 方法
names = ['Alice', 'Charlie']
result = df[df['name'].isin(names)]

# 字符串方法
result = df[df['name'].str.startswith('A')]
```

## 7. query 方法

```python
# 简洁的查询语法
result = df.query('age > 30')

# 多条件
result = df.query('age > 25 and salary > 55000')

# 使用变量
min_age = 30
result = df.query('age > @min_age')

# 字符串匹配
result = df.query('name == "Alice"')

# in 操作
result = df.query('age in [25, 35]')
```

## 8. 多层索引

### 8.1 创建多层索引

```python
# 从元组创建
index = pd.MultiIndex.from_tuples([
    ('A', 1), ('A', 2), ('B', 1), ('B', 2)
], names=['letter', 'number'])

df = pd.DataFrame({
    'value': [10, 20, 30, 40]
}, index=index)

print(df)
```

### 8.2 多层索引选择

```python
# 选择第一层
print(df.loc['A'])

# 选择多层
print(df.loc[('A', 1)])

# 使用slice
print(df.loc[('A', slice(None)), :])

# xs 方法
print(df.xs('A', level='letter'))
print(df.xs(1, level='number'))
```

### 8.3 多层索引操作

```python
# 重置索引
df_reset = df.reset_index()

# 设置索引
df_indexed = df_reset.set_index(['letter', 'number'])

# 交换层级
df_swapped = df.swaplevel()

# 排序
df_sorted = df.sort_index()
```

## 9. 实战示例

### 示例1：数据筛选

```python
# 学生成绩数据
scores = pd.DataFrame({
    'name': ['Alice', 'Bob', 'Charlie', 'David', 'Eve'],
    'math': [85, 92, 78, 95, 88],
    'english': [90, 85, 88, 92, 95],
    'science': [88, 90, 85, 98, 92]
})

# 找出数学成绩大于90的学生
high_math = scores[scores['math'] > 90]
print('数学成绩>90:\n', high_math)

# 找出数学和英语都大于85的学生
good_students = scores[(scores['math'] > 85) & (scores['english'] > 85)]
print('\n数学和英语都>85:\n', good_students)

# 找出任一科目大于90的学生
excellent = scores[(scores['math'] > 90) | 
                   (scores['english'] > 90) | 
                   (scores['science'] > 90)]
print('\n任一科目>90:\n', excellent)
```

### 示例2：条件赋值

```python
# 根据条件修改数据
df = pd.DataFrame({
    'score': [85, 92, 78, 95, 88]
})

# 将大于90的分数设为优秀
df.loc[df['score'] > 90, 'grade'] = 'A'
df.loc[(df['score'] >= 80) & (df['score'] <= 90), 'grade'] = 'B'
df.loc[df['score'] < 80, 'grade'] = 'C'

print(df)
```

### 示例3：复杂索引

```python
# 销售数据
sales = pd.DataFrame({
    'date': pd.date_range('2024-01-01', periods=10),
    'product': ['A', 'B', 'A', 'B', 'A', 'B', 'A', 'B', 'A', 'B'],
    'quantity': [10, 15, 12, 18, 14, 20, 16, 22, 18, 25],
    'price': [100, 150, 100, 150, 100, 150, 100, 150, 100, 150]
})

# 设置多层索引
sales_indexed = sales.set_index(['date', 'product'])

# 查询特定日期的产品A
result = sales_indexed.xs('A', level='product')
print(result.head())

# 查询特定日期范围
result = sales_indexed.loc['2024-01-01':'2024-01-05']
print(result)
```

## 10. 性能技巧

```python
import time

df = pd.DataFrame({
    'A': range(100000),
    'B': range(100000)
})

# 使用loc（推荐）
start = time.time()
result = df.loc[df['A'] > 50000]
print(f'loc耗时: {time.time() - start:.6f}秒')

# 使用布尔索引（快）
start = time.time()
result = df[df['A'] > 50000]
print(f'布尔索引耗时: {time.time() - start:.6f}秒')

# 使用query（更快）
start = time.time()
result = df.query('A > 50000')
print(f'query耗时: {time.time() - start:.6f}秒')
```

## 练习题

1. 选择DataFrame的第2到第5行
2. 选择年龄大于30且工资大于60000的员工
3. 使用query方法筛选数据
4. 创建多层索引并进行选择

---

**下一节：** [数据清洗](04-数据清洗.md)
