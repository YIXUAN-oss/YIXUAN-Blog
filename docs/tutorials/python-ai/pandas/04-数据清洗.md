---
title: 数据清洗
---

# 数据清洗

> 掌握数据清洗的核心技能

## 📚 学习目标

- 掌握缺失值处理
- 学会处理重复数据
- 掌握数据类型转换
- 学会字符串处理
- 掌握异常值处理

## 1. 处理缺失值

### 1.1 检测缺失值

```python
import pandas as pd
import numpy as np

df = pd.DataFrame({
    'A': [1, 2, np.nan, 4],
    'B': [5, np.nan, np.nan, 8],
    'C': [9, 10, 11, 12]
})

# 检测缺失值
print(df.isnull())
print(df.isna())  # 同义

# 统计缺失值
print(df.isnull().sum())

# 检测任何缺失值
print(df.isnull().any())

# 检测全部缺失
print(df.isnull().all())
```

### 1.2 删除缺失值

```python
# 删除包含缺失值的行
df_dropped = df.dropna()

# 删除全为缺失值的行
df_dropped = df.dropna(how='all')

# 删除包含缺失值的列
df_dropped = df.dropna(axis=1)

# 保留至少有n个非缺失值的行
df_dropped = df.dropna(thresh=2)
```

### 1.3 填充缺失值

```python
# 用标量填充
df_filled = df.fillna(0)

# 用均值填充
df['A'] = df['A'].fillna(df['A'].mean())

# 用中位数填充
df['B'] = df['B'].fillna(df['B'].median())

# 前向填充
df_ffill = df.fillna(method='ffill')

# 后向填充
df_bfill = df.fillna(method='bfill')

# 用字典填充不同列
df_filled = df.fillna({'A': 0, 'B': df['B'].mean()})

# 插值填充
df['A'] = df['A'].interpolate()
```

## 2. 处理重复数据

```python
df = pd.DataFrame({
    'name': ['Alice', 'Bob', 'Alice', 'Charlie'],
    'age': [25, 30, 25, 35]
})

# 检测重复行
duplicates = df.duplicated()
print(duplicates)

# 查看重复行
print(df[df.duplicated()])

# 删除重复行
df_unique = df.drop_duplicates()

# 保留最后一个
df_unique = df.drop_duplicates(keep='last')

# 基于指定列去重
df_unique = df.drop_duplicates(subset=['name'])
```

## 3. 数据类型转换

```python
df = pd.DataFrame({
    'A': ['1', '2', '3'],
    'B': ['4.5', '5.6', '6.7'],
    'C': ['2024-01-01', '2024-01-02', '2024-01-03']
})

# 查看数据类型
print(df.dtypes)

# 转换为整数
df['A'] = df['A'].astype(int)

# 转换为浮点数
df['B'] = df['B'].astype(float)

# 转换为日期时间
df['C'] = pd.to_datetime(df['C'])

# 转换为分类类型
df['category'] = pd.Categorical(['A', 'B', 'A'])

# 批量转换
df = df.astype({'A': int, 'B': float})
```

## 4. 字符串处理

```python
df = pd.DataFrame({
    'name': ['  Alice  ', 'bob', 'CHARLIE'],
    'email': ['alice@example.com', 'bob@test.com', 'charlie@demo.com']
})

# 去除空格
df['name'] = df['name'].str.strip()

# 转换大小写
df['name_upper'] = df['name'].str.upper()
df['name_lower'] = df['name'].str.lower()
df['name_title'] = df['name'].str.title()

# 替换
df['email'] = df['email'].str.replace('@', ' at ')

# 分割
df[['username', 'domain']] = df['email'].str.split('@', expand=True)

# 包含判断
mask = df['name'].str.contains('Alice')

# 提取
df['first_char'] = df['name'].str[0]

# 长度
df['name_length'] = df['name'].str.len()
```

## 5. 异常值处理

```python
import numpy as np

df = pd.DataFrame({
    'value': [10, 12, 11, 100, 13, 12, 11, -50, 14]
})

# 使用IQR方法
Q1 = df['value'].quantile(0.25)
Q3 = df['value'].quantile(0.75)
IQR = Q3 - Q1

lower_bound = Q1 - 1.5 * IQR
upper_bound = Q3 + 1.5 * IQR

# 识别异常值
outliers = (df['value'] < lower_bound) | (df['value'] > upper_bound)
print('异常值:\n', df[outliers])

# 移除异常值
df_clean = df[~outliers]

# 替换异常值
df.loc[outliers, 'value'] = df['value'].median()

# 使用Z-score方法
from scipy import stats
z_scores = np.abs(stats.zscore(df['value']))
outliers = z_scores > 3
```

## 6. 实战示例

### 示例1：清洗用户数据

```python
# 原始数据
users = pd.DataFrame({
    'user_id': [1, 2, 2, 3, 4],
    'name': ['  Alice  ', 'Bob', 'Bob', None, 'Charlie'],
    'age': ['25', '30', '30', 'unknown', '35'],
    'email': ['alice@test.com', 'bob@test.com', 'bob@test.com', 
              'invalid', 'charlie@test.com']
})

# 1. 删除重复用户
users = users.drop_duplicates(subset=['user_id'])

# 2. 处理缺失值
users['name'] = users['name'].fillna('Unknown')

# 3. 清洗字符串
users['name'] = users['name'].str.strip().str.title()

# 4. 处理年龄数据
users['age'] = pd.to_numeric(users['age'], errors='coerce')
users['age'] = users['age'].fillna(users['age'].median())

# 5. 验证邮箱
valid_email = users['email'].str.contains('@', na=False)
users = users[valid_email]

print('清洗后数据:\n', users)
```

### 示例2：清洗销售数据

```python
sales = pd.DataFrame({
    'date': ['2024-01-01', '2024/01/02', 'invalid', '2024-01-04'],
    'product': ['A', 'B', 'A', None],
    'quantity': [10, -5, 15, 20],
    'price': [100, 150, 100, 200]
})

# 1. 处理日期
sales['date'] = pd.to_datetime(sales['date'], errors='coerce')
sales = sales.dropna(subset=['date'])

# 2. 处理产品名称
sales['product'] = sales['product'].fillna('Unknown')

# 3. 处理负数数量
sales = sales[sales['quantity'] > 0]

# 4. 计算销售额
sales['revenue'] = sales['quantity'] * sales['price']

print('清洗后数据:\n', sales)
```

## 练习题

1. 处理包含缺失值的数据集
2. 删除重复的学生记录
3. 清洗包含格式不一致的日期数据
4. 识别并处理异常值

---

**下一节：** [数据转换](05-数据转换.md)
