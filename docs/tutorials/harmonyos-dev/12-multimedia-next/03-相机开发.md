---
title: 相机开发
date: 2025-01-22
---

# 相机开发

> 实现相机功能

## 📷 相机预览

```typescript
import { camera } from '@kit.CameraKit'

@Entry
@Component
struct CameraDemo {
  private xComponentController: XComponentController = new XComponentController()
  @State surfaceId: string = ''
  private cameraManager: camera.CameraManager | undefined
  private session: camera.PhotoSession | undefined
  
  async startCamera() {
    try {
      // 获取相机管理器
      this.cameraManager = camera.getCameraManager(getContext())
      
      // 获取相机列表
      const cameras = this.cameraManager.getSupportedCameras()
      const backCamera = cameras.find(cam => 
        cam.cameraPosition === camera.CameraPosition.CAMERA_POSITION_BACK
      )
      
      if (!backCamera) return
      
      // 创建相机输入
      const cameraInput = this.cameraManager.createCameraInput(backCamera)
      await cameraInput.open()
      
      // 创建预览输出
      const previewProfile = {
        format: camera.CameraFormat.CAMERA_FORMAT_YUV_420_SP,
        size: { width: 1920, height: 1080 }
      }
      const previewOutput = this.cameraManager.createPreviewOutput(
        previewProfile,
        this.surfaceId
      )
      
      // 创建会话
      this.session = this.cameraManager.createPhotoSession()
      this.session.beginConfig()
      this.session.addInput(cameraInput)
      this.session.addOutput(previewOutput)
      await this.session.commitConfig()
      await this.session.start()
      
    } catch (err) {
      console.error('启动相机失败:', err)
    }
  }
  
  build() {
    Stack() {
      XComponent({
        id: 'camera',
        type: 'surface',
        controller: this.xComponentController
      })
      .width('100%')
      .height('100%')
      .onLoad(() => {
        this.surfaceId = this.xComponentController.getXComponentSurfaceId()
        this.startCamera()
      })
      
      Button('拍照')
        .position({ x: '50%', y: '90%' })
        .translate({ x: '-50%', y: '-50%' })
    }
  }
}
```

## 📸 拍照功能

```typescript
async takePhoto() {
  try {
    // 创建拍照输出
    const photoProfile = {
      format: camera.ImageFormat.JPEG,
      size: { width: 4000, height: 3000 }
    }
    const photoOutput = this.cameraManager!.createPhotoOutput(photoProfile)
    
    // 监听拍照回调
    photoOutput.on('photoAvailable', (photo) => {
      console.log('拍照成功')
      // 保存照片
      this.savePhoto(photo)
    })
    
    // 触发拍照
    await photoOutput.capture()
    
  } catch (err) {
    console.error('拍照失败:', err)
  }
}
```

## 🎥 录像功能

```typescript
async startVideoRecord() {
  try {
    // 创建录像输出
    const videoProfile = {
      format: camera.CameraFormat.CAMERA_FORMAT_YUV_420_SP,
      size: { width: 1920, height: 1080 },
      frameRate: 30
    }
    const videoOutput = this.cameraManager!.createVideoOutput(videoProfile)
    
    // 开始录制
    await videoOutput.start()
    
  } catch (err) {
    console.error('录像失败:', err)
  }
}
```

## 💡 最佳实践

### 1. 权限申请

```json5
// module.json5
{
  "requestPermissions": [
    {
      "name": "ohos.permission.CAMERA"
    }
  ]
}
```

### 2. 释放资源

```typescript
aboutToDisappear() {
  if (this.session) {
    this.session.stop()
    this.session.release()
  }
}
```

## 📚 参考资源

- [相机开发指导](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/camera-preparation-0000001821000709-V5)
- [Camera API](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-camera-0000001820880753-V5)

---

**第12章完成！** 继续学习 → [第13章：服务与卡片](../13-service-card-next/)
