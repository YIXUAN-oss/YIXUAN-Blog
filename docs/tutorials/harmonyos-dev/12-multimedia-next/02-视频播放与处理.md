---
title: 视频播放与处理
date: 2025-01-22
---

# 视频播放与处理

> 实现视频播放和录制功能

## 🎬 视频播放

### Video 组件

```typescript
@Entry
@Component
struct VideoPlayerDemo {
  private videoController: VideoController = new VideoController()
  @State isPlaying: boolean = false
  @State currentTime: number = 0
  @State duration: number = 0
  
  build() {
    Column() {
      // 视频播放器
      Video({
        src: 'https://example.com/video.mp4',
        controller: this.videoController
      })
      .width('100%')
      .height(300)
      .controls(true)
      .autoPlay(false)
      .onStart(() => {
        console.log('开始播放')
        this.isPlaying = true
      })
      .onPause(() => {
        console.log('暂停播放')
        this.isPlaying = false
      })
      .onFinish(() => {
        console.log('播放完成')
        this.isPlaying = false
      })
      .onError(() => {
        console.error('播放错误')
      })
      .onPrepared((duration) => {
        this.duration = duration
        console.log('准备完成，时长:', duration)
      })
      .onUpdate((event) => {
        this.currentTime = event.time
      })
      
      // 控制栏
      Row({ space: 20 }) {
        Button('播放')
          .onClick(() => {
            this.videoController.start()
          })
          .enabled(!this.isPlaying)
        
        Button('暂停')
          .onClick(() => {
            this.videoController.pause()
          })
          .enabled(this.isPlaying)
        
        Button('停止')
          .onClick(() => {
            this.videoController.stop()
          })
      }
      .margin({ top: 20 })
      
      // 进度信息
      Text(`${this.formatTime(this.currentTime)} / ${this.formatTime(this.duration)}`)
        .margin({ top: 10 })
    }
    .padding(20)
  }
  
  formatTime(ms: number): string {
    const seconds = Math.floor(ms / 1000)
    const min = Math.floor(seconds / 60)
    const sec = seconds % 60
    return `${min}:${sec.toString().padStart(2, '0')}`
  }
}
```

### AVPlayer 高级播放

```typescript
import { media } from '@kit.MediaKit'

@Entry
@Component
struct AdvancedVideoPlayer {
  private avPlayer: media.AVPlayer | undefined
  @State surfaceId: string = ''
  private xComponentController: XComponentController = new XComponentController()
  
  async aboutToAppear() {
    await this.initPlayer()
  }
  
  async initPlayer() {
    try {
      this.avPlayer = await media.createAVPlayer()
      
      // 设置视频源
      this.avPlayer.url = 'https://example.com/video.mp4'
      
      // 监听状态
      this.avPlayer.on('stateChange', (state) => {
        console.log('播放器状态:', state)
        
        if (state === 'prepared') {
          // 设置显示窗口
          this.avPlayer!.surfaceId = this.surfaceId
        }
      })
      
      // 监听视频尺寸
      this.avPlayer.on('videoSizeChange', (width, height) => {
        console.log(`视频尺寸: ${width}x${height}`)
      })
      
    } catch (err) {
      console.error('初始化播放器失败:', err)
    }
  }
  
  build() {
    Column() {
      // XComponent 作为视频显示窗口
      XComponent({
        id: 'video_player',
        type: 'surface',
        controller: this.xComponentController
      })
      .width('100%')
      .height(300)
      .onLoad(() => {
        this.surfaceId = this.xComponentController.getXComponentSurfaceId()
      })
      
      Row({ space: 15 }) {
        Button('播放')
          .onClick(() => {
            this.avPlayer?.play()
          })
        
        Button('暂停')
          .onClick(() => {
            this.avPlayer?.pause()
          })
        
        Button('跳转到30秒')
          .onClick(() => {
            this.avPlayer?.seek(30000)
          })
      }
      .margin({ top: 20 })
    }
    .padding(20)
  }
  
  aboutToDisappear() {
    if (this.avPlayer) {
      this.avPlayer.release()
    }
  }
}
```

## 📹 视频录制

### AVRecorder 录制视频

```typescript
import { media } from '@kit.MediaKit'
import { camera } from '@kit.CameraKit'

@Entry
@Component
struct VideoRecorder {
  private avRecorder: media.AVRecorder | undefined
  private cameraManager: camera.CameraManager | undefined
  @State isRecording: boolean = false
  @State recordTime: number = 0
  private timer: number = -1
  
  async startRecord() {
    try {
      this.avRecorder = await media.createAVRecorder()
      
      // 配置录制参数
      const config: media.AVRecorderConfig = {
        audioSourceType: media.AudioSourceType.AUDIO_SOURCE_TYPE_MIC,
        videoSourceType: media.VideoSourceType.VIDEO_SOURCE_TYPE_SURFACE_YUV,
        profile: {
          audioBitrate: 48000,
          audioChannels: 2,
          audioCodec: media.CodecMimeType.AUDIO_AAC,
          audioSampleRate: 48000,
          fileFormat: media.ContainerFormatType.CFT_MPEG_4,
          videoBitrate: 2000000,
          videoCodec: media.CodecMimeType.VIDEO_AVC,
          videoFrameWidth: 1920,
          videoFrameHeight: 1080,
          videoFrameRate: 30
        },
        url: 'fd://' + await this.getFd(),
        rotation: 0
      }
      
      await this.avRecorder.prepare(config)
      
      // 获取录制surface
      const surfaceId = await this.avRecorder.getInputSurface()
      
      // 配置相机（此处简化）
      // 实际需要完整的相机初始化流程
      
      await this.avRecorder.start()
      
      this.isRecording = true
      this.startTimer()
      
    } catch (err) {
      console.error('开始录制失败:', err)
    }
  }
  
  async stopRecord() {
    if (this.avRecorder) {
      await this.avRecorder.stop()
      await this.avRecorder.release()
      
      this.isRecording = false
      this.stopTimer()
      this.recordTime = 0
    }
  }
  
  async getFd(): Promise<number> {
    // 获取文件描述符
    return 0  // 实际实现需要打开文件
  }
  
  startTimer() {
    this.timer = setInterval(() => {
      this.recordTime++
    }, 1000)
  }
  
  stopTimer() {
    if (this.timer >= 0) {
      clearInterval(this.timer)
    }
  }
  
  build() {
    Column({ space: 20 }) {
      Text('视频录制')
        .fontSize(24)
      
      Text(this.formatTime(this.recordTime))
        .fontSize(36)
        .fontColor(this.isRecording ? Color.Red : Color.Black)
      
      Row({ space: 15 }) {
        Button('开始录制')
          .onClick(() => {
            this.startRecord()
          })
          .enabled(!this.isRecording)
        
        Button('停止录制')
          .onClick(() => {
            this.stopRecord()
          })
          .enabled(this.isRecording)
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
  
  formatTime(seconds: number): string {
    const min = Math.floor(seconds / 60)
    const sec = seconds % 60
    return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`
  }
}
```

## 🎯 实战案例：短视频播放器

```typescript
@Entry
@Component
struct ShortVideoPlayer {
  @State videoList: VideoInfo[] = [
    { id: 1, url: 'https://example.com/video1.mp4', title: '视频1' },
    { id: 2, url: 'https://example.com/video2.mp4', title: '视频2' },
    { id: 3, url: 'https://example.com/video3.mp4', title: '视频3' }
  ]
  @State currentIndex: number = 0
  private swiperController: SwiperController = new SwiperController()
  
  build() {
    Stack() {
      // 视频列表
      Swiper(this.swiperController) {
        ForEach(this.videoList, (video: VideoInfo, index: number) => {
          VideoItem({
            video: video,
            isActive: this.currentIndex === index
          })
        })
      }
      .width('100%')
      .height('100%')
      .vertical(true)
      .indicator(false)
      .onChange((index) => {
        this.currentIndex = index
      })
      
      // 控制栏
      Column() {
        Blank()
        
        Row() {
          Text(this.videoList[this.currentIndex].title)
            .fontSize(18)
            .fontColor(Color.White)
        }
        .width('100%')
        .padding(20)
      }
      .width('100%')
      .height('100%')
    }
  }
}

@Component
struct VideoItem {
  @Prop video: VideoInfo
  @Prop isActive: boolean
  private videoController: VideoController = new VideoController()
  
  aboutToAppear() {
    if (this.isActive) {
      this.videoController.start()
    }
  }
  
  build() {
    Stack() {
      Video({
        src: this.video.url,
        controller: this.videoController
      })
      .width('100%')
      .height('100%')
      .objectFit(ImageFit.Cover)
      .controls(false)
      .autoPlay(this.isActive)
      .loop(true)
      .onClick(() => {
        if (this.isActive) {
          // 切换播放/暂停
        }
      })
    }
  }
}

interface VideoInfo {
  id: number
  url: string
  title: string
}
```

## 💡 最佳实践

### 1. 内存管理

```typescript
// ✅ 及时释放播放器
aboutToDisappear() {
  if (this.avPlayer) {
    this.avPlayer.release()
  }
}
```

### 2. 预加载

```typescript
// 预加载下一个视频
async preloadNext() {
  const nextVideo = this.videoList[this.currentIndex + 1]
  if (nextVideo) {
    // 创建预加载播放器
    const preloadPlayer = await media.createAVPlayer()
    preloadPlayer.url = nextVideo.url
  }
}
```

### 3. 错误处理

```typescript
.onError((error) => {
  console.error('播放错误:', error)
  // 显示错误提示
  // 尝试重新加载
})
```

## 📚 参考资源

- [视频播放](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-playback-0000001774121010-V5)
- [视频录制](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/video-recording-0000001820880741-V5)
- [Video组件](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-media-components-video-0000001815767544-V5)

---

**下一节** → [相机开发](03-相机开发.md)
