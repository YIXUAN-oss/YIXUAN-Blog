---
title: 卡片交互
date: 2025-01-22
---

# 卡片交互

> 实现卡片与应用的交互

## 🔗 卡片事件

### postCardAction 发送事件

```typescript
import { postCardAction } from '@kit.FormKit'

// 消息事件
postCardAction(this, {
  action: formInfo.FormAction.MESSAGE,
  params: JSON.stringify({
    method: 'refresh',
    data: { id: 123 }
  })
})

// 路由事件
postCardAction(this, {
  action: formInfo.FormAction.ROUTER_EVENT,
  abilityName: 'MainAbility',
  params: {
    page: 'pages/Detail',
    id: 123
  }
})
```

## 🎯 点击跳转

### 跳转到应用页面

```typescript
@Entry
@Component
struct WeatherCard {
  build() {
    Column() {
      Text('查看详情')
        .onClick(() => {
          postCardAction(this, {
            action: formInfo.FormAction.ROUTER_EVENT,
            abilityName: 'EntryAbility',
            params: {
              page: 'pages/WeatherDetail',
              city: '北京'
            }
          })
        })
    }
  }
}

// 应用中处理跳转
export default class EntryAbility extends UIAbility {
  onNewWant(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CARD) {
      const params = want.parameters
      const page = params?.['page']
      const city = params?.['city']
      
      // 跳转到指定页面
      router.pushUrl({
        url: page,
        params: { city }
      })
    }
  }
}
```

## 🔄 动态更新

### 主动更新卡片数据

```typescript
import { formProvider, formBindingData } from '@kit.FormKit'

class WeatherService {
  async updateWeatherCard(formId: string) {
    // 获取最新数据
    const weatherData = await this.fetchWeather()
    
    // 更新卡片
    const formData = {
      temperature: weatherData.temp,
      weather: weatherData.condition,
      updateTime: new Date().toLocaleTimeString()
    }
    
    try {
      await formProvider.updateForm(
        formId,
        formBindingData.createFormBindingData(formData)
      )
      console.log('卡片更新成功')
    } catch (err) {
      console.error('卡片更新失败:', err)
    }
  }
  
  async fetchWeather() {
    // 调用天气API
    return {
      temp: '28°C',
      condition: '晴天'
    }
  }
}
```

### 批量更新多个卡片

```typescript
async function updateAllCards() {
  // 获取所有卡片ID
  const formIds = await formHost.getAllFormsInfo()
  
  for (const formInfo of formIds) {
    await updateWeatherCard(formInfo.formId)
  }
}
```

## ⏰ 定时刷新

### 后台定时任务

```typescript
import { backgroundTaskManager } from '@kit.BackgroundTasksKit'

class CardUpdateService {
  private timerId: number = -1
  
  startPeriodicUpdate() {
    // 申请后台长时任务
    backgroundTaskManager.requestBackgroundRunning(getContext(), {
      bgMode: backgroundTaskManager.BackgroundMode.DATA_TRANSFER,
      wantAgent: null
    }, (err) => {
      if (!err) {
        // 启动定时器
        this.timerId = setInterval(() => {
          this.updateAllCards()
        }, 30 * 60 * 1000)  // 每30分钟更新
      }
    })
  }
  
  stopPeriodicUpdate() {
    if (this.timerId >= 0) {
      clearInterval(this.timerId)
      this.timerId = -1
    }
    
    backgroundTaskManager.stopBackgroundRunning(getContext())
  }
  
  async updateAllCards() {
    const formIds = await this.getAllCardIds()
    
    for (const formId of formIds) {
      await this.updateCard(formId)
    }
  }
}
```

## 🎯 实战案例：音乐播放卡片

```typescript
// FormExtensionAbility
export default class MusicFormAbility extends FormExtensionAbility {
  private musicPlayer: MusicPlayer = new MusicPlayer()
  
  onAddForm(want: Want) {
    const currentSong = this.musicPlayer.getCurrentSong()
    
    const formData = {
      title: currentSong?.title || '未播放',
      artist: currentSong?.artist || '--',
      isPlaying: this.musicPlayer.isPlaying(),
      coverUrl: currentSong?.coverUrl || ''
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  onFormEvent(formId: string, message: string) {
    const event = JSON.parse(message)
    
    switch (event.action) {
      case 'play':
        this.musicPlayer.play()
        this.updateCardData(formId)
        break
      
      case 'pause':
        this.musicPlayer.pause()
        this.updateCardData(formId)
        break
      
      case 'next':
        this.musicPlayer.next()
        this.updateCardData(formId)
        break
      
      case 'prev':
        this.musicPlayer.previous()
        this.updateCardData(formId)
        break
    }
  }
  
  async updateCardData(formId: string) {
    const currentSong = this.musicPlayer.getCurrentSong()
    
    const formData = {
      title: currentSong.title,
      artist: currentSong.artist,
      isPlaying: this.musicPlayer.isPlaying(),
      coverUrl: currentSong.coverUrl
    }
    
    await formProvider.updateForm(
      formId,
      formBindingData.createFormBindingData(formData)
    )
  }
}

// 卡片UI
@Entry
@Component
struct MusicCard {
  @LocalStorageProp('title') title: string = '未播放'
  @LocalStorageProp('artist') artist: string = '--'
  @LocalStorageProp('isPlaying') isPlaying: boolean = false
  @LocalStorageProp('coverUrl') coverUrl: string = ''
  
  sendAction(action: string) {
    postCardAction(this, {
      action: formInfo.FormAction.MESSAGE,
      params: JSON.stringify({ action })
    })
  }
  
  build() {
    Column() {
      // 封面和信息
      Row({ space: 15 }) {
        Image(this.coverUrl || $r('app.media.default_cover'))
          .width(80)
          .height(80)
          .borderRadius(8)
        
        Column({ space: 5 }) {
          Text(this.title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .maxLines(1)
          
          Text(this.artist)
            .fontSize(14)
            .fontColor(Color.Gray)
            .maxLines(1)
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(15)
      
      // 控制按钮
      Row({ space: 20 }) {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.icon_previous'))
            .width(24)
            .height(24)
        }
        .width(48)
        .height(48)
        .onClick(() => {
          this.sendAction('prev')
        })
        
        Button({ type: ButtonType.Circle }) {
          Image(this.isPlaying ? 
            $r('app.media.icon_pause') : 
            $r('app.media.icon_play')
          )
          .width(32)
          .height(32)
        }
        .width(56)
        .height(56)
        .onClick(() => {
          this.sendAction(this.isPlaying ? 'pause' : 'play')
        })
        
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.icon_next'))
            .width(24)
            .height(24)
        }
        .width(48)
        .height(48)
        .onClick(() => {
          this.sendAction('next')
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .padding({ bottom: 15 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}
```

## 💡 最佳实践

### 1. 事件处理

```typescript
// ✅ 使用try-catch处理事件
onFormEvent(formId: string, message: string) {
  try {
    const event = JSON.parse(message)
    this.handleEvent(event)
  } catch (err) {
    console.error('事件处理失败:', err)
  }
}
```

### 2. 更新频率控制

```typescript
// ✅ 避免频繁更新
private lastUpdateTime: Map<string, number> = new Map()

shouldUpdate(formId: string): boolean {
  const last = this.lastUpdateTime.get(formId) || 0
  const now = Date.now()
  
  if (now - last < 1000) {  // 1秒内不重复更新
    return false
  }
  
  this.lastUpdateTime.set(formId, now)
  return true
}
```

### 3. 错误处理

```typescript
// ✅ 优雅处理更新失败
async updateCard(formId: string) {
  try {
    await formProvider.updateForm(formId, data)
  } catch (err) {
    console.error('更新失败:', err)
    // 记录日志，不影响其他卡片
  }
}
```

## 📚 参考资源

- [卡片数据交互](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-ui-widget-event-formextensionability-0000001820880565-V5)
- [postCardAction](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-app-form-formBindingData-0000001821000653-V5)

---

**下一节** → [卡片最佳实践](03-卡片最佳实践.md)
