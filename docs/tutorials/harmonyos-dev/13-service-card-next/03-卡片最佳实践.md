---
title: 卡片最佳实践
date: 2025-01-22
---

# 卡片最佳实践

> 优化卡片性能和用户体验

## ⚡ 性能优化

### 1. 减少数据大小

```typescript
// ✅ 只传递必要数据
const formData = {
  title: 'xxx',
  value: 123
}

// ❌ 避免传递大量数据
const formData = {
  largeArray: Array(1000).fill({}),  // 太大
  complexObject: { /* 嵌套很深 */ }
}
```

### 2. 图片优化

```typescript
// ✅ 使用压缩图片
Image(this.smallThumbnail)  // 小尺寸缩略图
  .width(80)
  .height(80)

// ❌ 避免使用大图
Image(this.highResImage)  // 高分辨率原图
```

### 3. 更新频率控制

```typescript
class UpdateManager {
  private updateQueue: Map<string, number> = new Map()
  private readonly MIN_INTERVAL = 30000  // 30秒
  
  canUpdate(formId: string): boolean {
    const lastUpdate = this.updateQueue.get(formId) || 0
    const now = Date.now()
    
    if (now - lastUpdate < this.MIN_INTERVAL) {
      return false
    }
    
    this.updateQueue.set(formId, now)
    return true
  }
}
```

## 🎨 样式设计

### 1. 响应式布局

```typescript
@Entry
@Component
struct ResponsiveCard {
  @LocalStorageProp('dimension') dimension: number = 2
  
  build() {
    Column() {
      if (this.dimension === 2) {
        // 2x2 小卡片
        this.smallLayout()
      } else if (this.dimension === 4) {
        // 4x4 大卡片
        this.largeLayout()
      }
    }
  }
  
  @Builder
  smallLayout() {
    Column({ space: 5 }) {
      Text('标题')
        .fontSize(14)
      
      Text('内容')
        .fontSize(12)
    }
  }
  
  @Builder
  largeLayout() {
    Column({ space: 10 }) {
      Text('标题')
        .fontSize(18)
      
      List() {
        // 更多内容
      }
    }
  }
}
```

### 2. 深色模式适配

```typescript
@Entry
@Component
struct ThemeCard {
  @StorageProp('colorMode') colorMode: ColorMode = ColorMode.LIGHT
  
  build() {
    Column() {
      Text('内容')
        .fontColor(this.colorMode === ColorMode.DARK ? Color.White : Color.Black)
    }
    .backgroundColor(this.colorMode === ColorMode.DARK ? '#1E1E1E' : Color.White)
  }
}
```

## 📊 数据管理

### 1. 数据缓存

```typescript
class CardDataManager {
  private cache: Map<string, CachedData> = new Map()
  private readonly CACHE_DURATION = 5 * 60 * 1000  // 5分钟
  
  async getData(key: string): Promise<any> {
    const cached = this.cache.get(key)
    
    if (cached && Date.now() - cached.timestamp < this.CACHE_DURATION) {
      return cached.data
    }
    
    const freshData = await this.fetchData(key)
    this.cache.set(key, {
      data: freshData,
      timestamp: Date.now()
    })
    
    return freshData
  }
  
  async fetchData(key: string): Promise<any> {
    // 从网络或数据库获取
    return {}
  }
}

interface CachedData {
  data: any
  timestamp: number
}
```

### 2. 错误处理

```typescript
export default class WeatherFormAbility extends FormExtensionAbility {
  onUpdateForm(formId: string) {
    try {
      const data = this.getWeatherData()
      return formBindingData.createFormBindingData(data)
    } catch (err) {
      console.error('获取数据失败:', err)
      
      // 返回错误状态
      return formBindingData.createFormBindingData({
        error: true,
        message: '数据加载失败'
      })
    }
  }
}

// 卡片显示错误状态
@Entry
@Component
struct WeatherCard {
  @LocalStorageProp('error') error: boolean = false
  @LocalStorageProp('message') message: string = ''
  
  build() {
    if (this.error) {
      Column() {
        Text('⚠️')
          .fontSize(32)
        
        Text(this.message)
          .fontSize(14)
          .fontColor(Color.Red)
        
        Button('重试')
          .onClick(() => {
            postCardAction(this, {
              action: formInfo.FormAction.MESSAGE,
              params: JSON.stringify({ action: 'retry' })
            })
          })
      }
    } else {
      // 正常显示
    }
  }
}
```

## 🔋 电池优化

### 1. 智能更新策略

```typescript
class SmartUpdateManager {
  async shouldUpdate(): Promise<boolean> {
    // 检查电量
    const battery = await batteryInfo.getBatteryInfo()
    if (battery.batteryLevel < 20) {
      return false  // 低电量时不更新
    }
    
    // 检查网络
    const connection = await connection.getDefaultNet()
    if (connection.netCapabilities.bearerTypes.includes(NetBearerType.BEARER_CELLULAR)) {
      return false  // 移动网络时不更新
    }
    
    return true
  }
}
```

### 2. 后台任务管理

```typescript
class BackgroundTaskManager {
  startLongRunningTask() {
    backgroundTaskManager.requestBackgroundRunning(getContext(), {
      bgMode: backgroundTaskManager.BackgroundMode.DATA_TRANSFER,
      wantAgent: null
    }, (err) => {
      if (!err) {
        console.log('后台任务已启动')
      }
    })
  }
  
  stopLongRunningTask() {
    backgroundTaskManager.stopBackgroundRunning(getContext(), (err) => {
      if (!err) {
        console.log('后台任务已停止')
      }
    })
  }
}
```

## 💡 用户体验

### 1. 加载状态

```typescript
@Entry
@Component
struct LoadingCard {
  @LocalStorageProp('loading') loading: boolean = false
  @LocalStorageProp('data') data: any = null
  
  build() {
    Column() {
      if (this.loading) {
        LoadingProgress()
          .width(40)
          .height(40)
      } else if (this.data) {
        // 显示数据
        this.contentView()
      } else {
        // 空状态
        Text('暂无数据')
          .fontColor(Color.Gray)
      }
    }
  }
  
  @Builder
  contentView() {
    // 内容视图
  }
}
```

### 2. 平滑动画

```typescript
@Entry
@Component
struct AnimatedCard {
  @State value: number = 0
  
  build() {
    Column() {
      Text(`${this.value}`)
        .fontSize(32)
        .animation({
          duration: 500,
          curve: Curve.EaseInOut
        })
    }
  }
}
```

## 📚 参考资源

- [卡片开发指南](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-ui-widget-working-principles-0000001820880617-V5)

---

**第13章完成！** 继续学习 → [第14章：安全与隐私](../14-security-privacy/)
