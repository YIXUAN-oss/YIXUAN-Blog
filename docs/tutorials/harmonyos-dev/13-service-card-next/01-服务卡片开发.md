---
title: 服务卡片开发
date: 2025-01-22
---

# 服务卡片开发

> 开发桌面服务卡片

## 📇 卡片概述

服务卡片（Widget）是一种轻量级的应用展示形式，可以在桌面直接显示信息和提供快捷操作。

### 卡片类型

```
卡片规格
├─ 2x2（小卡片）
├─ 2x4（中等卡片）
├─ 4x4（大卡片）
└─ 自定义尺寸
```

## 🔧 创建 FormExtensionAbility

### 配置 module.json5

```json5
{
  "module": {
    "extensionAbilities": [
      {
        "name": "WeatherFormAbility",
        "srcEntry": "./ets/weatherformability/WeatherFormAbility.ets",
        "type": "form",
        "metadata": [
          {
            "name": "ohos.extension.form",
            "resource": "$profile:form_config"
          }
        ]
      }
    ]
  }
}
```

### 卡片配置文件

```json5
// resources/base/profile/form_config.json
{
  "forms": [
    {
      "name": "WeatherCard",
      "description": "天气卡片",
      "src": "./ets/widget/pages/WeatherCard.ets",
      "uiSyntax": "arkts",
      "window": {
        "designWidth": 720,
        "autoDesignWidth": true
      },
      "colorMode": "auto",
      "isDefault": true,
      "updateEnabled": true,
      "scheduledUpdateTime": "10:30",
      "updateDuration": 1,
      "defaultDimension": "2*2",
      "supportDimensions": ["2*2", "4*4"]
    }
  ]
}
```

## 📝 实现 FormExtensionAbility

```typescript
import { FormExtensionAbility, formBindingData, formInfo } from '@kit.FormKit'

export default class WeatherFormAbility extends FormExtensionAbility {
  // 创建卡片
  onAddForm(want: Want) {
    console.log('创建卡片')
    
    // 获取卡片信息
    const formId = want.parameters!['ohos.extra.param.key.form_identity'] as string
    const formName = want.parameters!['ohos.extra.param.key.form_name'] as string
    const dimension = want.parameters!['ohos.extra.param.key.form_dimension'] as number
    
    // 准备卡片数据
    const formData = {
      temperature: '25°C',
      weather: '晴天',
      city: '北京',
      updateTime: new Date().toLocaleTimeString()
    }
    
    // 返回卡片数据
    return formBindingData.createFormBindingData(formData)
  }
  
  // 更新卡片
  onUpdateForm(formId: string) {
    console.log('更新卡片:', formId)
    
    // 获取最新数据
    const formData = {
      temperature: '26°C',
      weather: '多云',
      city: '北京',
      updateTime: new Date().toLocaleTimeString()
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  // 删除卡片
  onRemoveForm(formId: string) {
    console.log('删除卡片:', formId)
  }
  
  // 卡片可见性变化
  onVisibilityChange(formEventsMap: Map<string, number>) {
    console.log('卡片可见性变化')
    
    formEventsMap.forEach((value, key) => {
      if (value === formInfo.FormVisibilityType.FORM_VISIBLE) {
        console.log('卡片可见:', key)
      } else {
        console.log('卡片不可见:', key)
      }
    })
  }
  
  // 卡片事件处理
  onFormEvent(formId: string, message: string) {
    console.log('收到卡片事件:', formId, message)
    
    // 处理卡片消息
    const event = JSON.parse(message)
    if (event.action === 'refresh') {
      // 刷新卡片
      this.updateFormData(formId)
    }
  }
  
  // 更新卡片数据
  async updateFormData(formId: string) {
    const formData = await this.fetchWeatherData()
    
    try {
      formProvider.updateForm(formId, formBindingData.createFormBindingData(formData))
    } catch (err) {
      console.error('更新卡片失败:', err)
    }
  }
  
  // 获取天气数据
  async fetchWeatherData() {
    // 实际应该调用天气API
    return {
      temperature: '27°C',
      weather: '阴天',
      city: '北京',
      updateTime: new Date().toLocaleTimeString()
    }
  }
}
```

## 🎨 卡片页面

### 卡片UI

```typescript
@Entry
@Component
struct WeatherCard {
  @LocalStorageProp('temperature') temperature: string = '--'
  @LocalStorageProp('weather') weather: string = '--'
  @LocalStorageProp('city') city: string = '--'
  @LocalStorageProp('updateTime') updateTime: string = '--'
  
  build() {
    Column() {
      // 标题栏
      Row() {
        Text(this.city)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(this.updateTime)
          .fontSize(12)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 10 })
      
      // 主要内容
      Column({ space: 5 }) {
        Text(this.temperature)
          .fontSize(48)
          .fontWeight(FontWeight.Bold)
          .fontColor('#007DFF')
        
        Text(this.weather)
          .fontSize(18)
          .fontColor(Color.Gray)
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      
      // 操作按钮
      Row() {
        Button('刷新')
          .fontSize(14)
          .height(32)
          .onClick(() => {
            // 发送刷新事件
            postCardAction(this, {
              action: formInfo.FormAction.ROUTER_EVENT,
              abilityName: 'WeatherFormAbility',
              params: {
                method: 'refresh'
              }
            })
          })
      }
      .width('100%')
      .padding({ left: 15, right: 15, bottom: 10 })
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}
```

## 🔄 定时更新

### 配置定时更新

```json5
{
  "forms": [{
    "updateEnabled": true,
    "scheduledUpdateTime": "10:30",  // 每天10:30更新
    "updateDuration": 1  // 每小时更新一次
  }]
}
```

### 主动更新卡片

```typescript
import { formProvider } from '@kit.FormKit'

async function updateForm(formId: string) {
  const formData = {
    temperature: '28°C',
    weather: '晴转多云',
    updateTime: new Date().toLocaleTimeString()
  }
  
  try {
    await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData))
    console.log('更新成功')
  } catch (err) {
    console.error('更新失败:', err)
  }
}
```

## 🎯 实战案例：待办事项卡片

```typescript
// FormExtensionAbility
export default class TodoFormAbility extends FormExtensionAbility {
  onAddForm(want: Want) {
    const todos = this.getTodoList()
    
    const formData = {
      todos: JSON.stringify(todos),
      totalCount: todos.length,
      doneCount: todos.filter(t => t.done).length
    }
    
    return formBindingData.createFormBindingData(formData)
  }
  
  onFormEvent(formId: string, message: string) {
    const event = JSON.parse(message)
    
    if (event.action === 'toggleTodo') {
      this.toggleTodo(event.todoId)
      this.updateFormData(formId)
    } else if (event.action === 'openApp') {
      // 拉起应用
      this.context.startAbility({
        bundleName: 'com.example.todoapp',
        abilityName: 'MainAbility'
      })
    }
  }
  
  getTodoList(): Todo[] {
    // 从数据库读取
    return [
      { id: 1, text: '完成项目文档', done: false },
      { id: 2, text: '参加会议', done: true },
      { id: 3, text: '代码review', done: false }
    ]
  }
  
  toggleTodo(todoId: number) {
    // 更新数据库
  }
}

// 卡片页面
@Entry
@Component
struct TodoCard {
  @LocalStorageProp('todos') todosStr: string = '[]'
  @LocalStorageProp('totalCount') totalCount: number = 0
  @LocalStorageProp('doneCount') doneCount: number = 0
  
  get todos(): Todo[] {
    try {
      return JSON.parse(this.todosStr)
    } catch {
      return []
    }
  }
  
  build() {
    Column() {
      // 标题
      Row() {
        Text('待办事项')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        
        Blank()
        
        Text(`${this.doneCount}/${this.totalCount}`)
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .padding(15)
      
      // 待办列表
      List({ space: 8 }) {
        ForEach(this.todos.slice(0, 3), (todo: Todo) => {
          ListItem() {
            Row({ space: 10 }) {
              Checkbox()
                .select(todo.done)
                .onChange((checked) => {
                  postCardAction(this, {
                    action: formInfo.FormAction.MESSAGE,
                    params: JSON.stringify({
                      action: 'toggleTodo',
                      todoId: todo.id
                    })
                  })
                })
              
              Text(todo.text)
                .fontSize(14)
                .decoration({
                  type: todo.done ? TextDecorationType.LineThrough : TextDecorationType.None
                })
                .layoutWeight(1)
            }
            .width('100%')
          }
        })
      }
      .layoutWeight(1)
      .padding({ left: 15, right: 15 })
      
      // 底部按钮
      Button('打开应用')
        .width('90%')
        .margin({ bottom: 10 })
        .onClick(() => {
          postCardAction(this, {
            action: formInfo.FormAction.ROUTER_EVENT,
            params: { action: 'openApp' }
          })
        })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

interface Todo {
  id: number
  text: string
  done: boolean
}
```

## 💡 最佳实践

### 1. 卡片大小限制

```typescript
// ✅ 控制卡片数据大小（<1MB）
const formData = {
  title: 'xxx',
  content: 'xxx'  // 精简数据
}
```

### 2. 性能优化

```typescript
// ✅ 避免频繁更新
let lastUpdateTime = 0
const UPDATE_INTERVAL = 30000  // 30秒

function shouldUpdate(): boolean {
  const now = Date.now()
  if (now - lastUpdateTime > UPDATE_INTERVAL) {
    lastUpdateTime = now
    return true
  }
  return false
}
```

### 3. 电池优化

```json5
// ✅ 合理设置更新频率
{
  "updateDuration": 4  // 4小时更新一次
}
```

## 📚 参考资源

- [服务卡片开发](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-ui-widget-working-principles-0000001820880617-V5)
- [FormExtensionAbility](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-app-form-formextensionability-0000001774121018-V5)

---

**下一节** → [卡片交互](02-卡片交互.md)
