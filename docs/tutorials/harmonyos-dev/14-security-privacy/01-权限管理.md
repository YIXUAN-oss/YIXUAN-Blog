---
title: 权限管理
date: 2025-01-22
---

# 权限管理

> 正确申请和使用应用权限

## 🔐 权限类型

### HarmonyOS 权限分类

```
权限类型
├─ normal（普通权限）- 自动授予
├─ system_basic（系统基础权限）- 需用户授权
├─ system_grant（系统授权）- ACL配置
└─ user_grant（用户授权）- 运行时请求
```

## 📝 声明权限

### 在 module.json5 中配置

```json5
{
  "module": {
    "requestPermissions": [
      {
        "name": "ohos.permission.INTERNET",
        "reason": "$string:reason_internet",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.CAMERA",
        "reason": "$string:reason_camera",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.LOCATION",
        "reason": "$string:reason_location",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "always"
        }
      }
    ]
  }
}
```

### 权限说明文本

```json
// resources/base/element/string.json
{
  "string": [
    {
      "name": "reason_internet",
      "value": "用于访问网络获取数据"
    },
    {
      "name": "reason_camera",
      "value": "用于拍照和扫码功能"
    },
    {
      "name": "reason_location",
      "value": "用于获取您的位置信息"
    }
  ]
}
```

## 🙋 动态权限申请

### 检查和请求权限

```typescript
import { abilityAccessCtrl, common, Permissions } from '@kit.AbilityKit'
import { BusinessError } from '@kit.BasicServicesKit'

class PermissionManager {
  private context: common.UIAbilityContext
  private atManager: abilityAccessCtrl.AtManager
  
  constructor(context: common.UIAbilityContext) {
    this.context = context
    this.atManager = abilityAccessCtrl.createAtManager()
  }
  
  // 检查权限
  async checkPermission(permission: Permissions): Promise<boolean> {
    try {
      const grantStatus = await this.atManager.checkAccessToken(
        this.context.applicationInfo.accessTokenId,
        permission
      )
      
      return grantStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
    } catch (err) {
      console.error('检查权限失败:', err)
      return false
    }
  }
  
  // 请求权限
  async requestPermission(permission: Permissions): Promise<boolean> {
    try {
      const data = await this.atManager.requestPermissionsFromUser(
        this.context,
        [permission]
      )
      
      return data.authResults[0] === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
    } catch (err) {
      console.error('请求权限失败:', err)
      return false
    }
  }
  
  // 批量请求权限
  async requestPermissions(permissions: Permissions[]): Promise<boolean[]> {
    try {
      const data = await this.atManager.requestPermissionsFromUser(
        this.context,
        permissions
      )
      
      return data.authResults.map(result => 
        result === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED
      )
    } catch (err) {
      console.error('批量请求权限失败:', err)
      return permissions.map(() => false)
    }
  }
  
  // 检查并请求权限
  async checkAndRequest(permission: Permissions): Promise<boolean> {
    const hasPermission = await this.checkPermission(permission)
    
    if (hasPermission) {
      return true
    }
    
    return await this.requestPermission(permission)
  }
}
```

## 📷 使用权限

### 相机权限示例

```typescript
@Entry
@Component
struct CameraPage {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  
  async openCamera() {
    // 检查并请求相机权限
    const hasPermission = await this.permissionManager.checkAndRequest(
      'ohos.permission.CAMERA'
    )
    
    if (hasPermission) {
      // 打开相机
      this.startCamera()
    } else {
      // 权限被拒绝
      promptAction.showToast({
        message: '需要相机权限才能使用此功能'
      })
      
      // 引导用户去设置
      this.openPermissionSettings()
    }
  }
  
  startCamera() {
    console.log('启动相机')
    // 相机逻辑
  }
  
  openPermissionSettings() {
    // 打开应用权限设置页面
    this.context.startAbility({
      bundleName: 'com.huawei.hmos.settings',
      abilityName: 'com.huawei.hmos.settings.MainAbility',
      uri: 'application_info_entry',
      parameters: {
        pushParams: this.context.abilityInfo.bundleName
      }
    })
  }
  
  build() {
    Column() {
      Button('打开相机')
        .onClick(() => {
          this.openCamera()
        })
    }
  }
}
```

### 位置权限示例

```typescript
@Entry
@Component
struct LocationPage {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  @State location: string = ''
  
  async getLocation() {
    // 请求多个位置相关权限
    const permissions: Permissions[] = [
      'ohos.permission.APPROXIMATELY_LOCATION',
      'ohos.permission.LOCATION'
    ]
    
    const results = await this.permissionManager.requestPermissions(permissions)
    
    if (results.some(r => r)) {
      // 至少有一个权限被授予
      this.fetchLocation()
    } else {
      promptAction.showToast({
        message: '需要位置权限'
      })
    }
  }
  
  async fetchLocation() {
    // 获取位置信息
    this.location = '北京市朝阳区'
  }
  
  build() {
    Column({ space: 20 }) {
      Text(this.location || '未获取位置')
        .fontSize(18)
      
      Button('获取位置')
        .onClick(() => {
          this.getLocation()
        })
    }
    .padding(20)
  }
}
```

## 🎯 实战案例：权限管理器

```typescript
@Entry
@Component
struct PermissionSettings {
  private permissionManager: PermissionManager = new PermissionManager(getContext(this))
  
  @State permissions: PermissionItem[] = [
    {
      name: 'ohos.permission.CAMERA',
      title: '相机',
      description: '用于拍照和扫码',
      granted: false
    },
    {
      name: 'ohos.permission.MICROPHONE',
      title: '麦克风',
      description: '用于录音功能',
      granted: false
    },
    {
      name: 'ohos.permission.LOCATION',
      title: '位置',
      description: '用于定位服务',
      granted: false
    },
    {
      name: 'ohos.permission.READ_MEDIA',
      title: '存储',
      description: '用于读取照片和文件',
      granted: false
    }
  ]
  
  async aboutToAppear() {
    await this.checkAllPermissions()
  }
  
  async checkAllPermissions() {
    for (let permission of this.permissions) {
      permission.granted = await this.permissionManager.checkPermission(
        permission.name as Permissions
      )
    }
  }
  
  async togglePermission(permission: PermissionItem) {
    if (permission.granted) {
      // 已授权，引导用户去设置取消
      this.openPermissionSettings()
    } else {
      // 未授权，请求权限
      const granted = await this.permissionManager.requestPermission(
        permission.name as Permissions
      )
      
      permission.granted = granted
      
      if (!granted) {
        promptAction.showDialog({
          title: '权限被拒绝',
          message: '该功能需要此权限才能使用，是否前往设置？',
          buttons: [
            { text: '取消' },
            { text: '去设置' }
          ]
        }).then((result) => {
          if (result.index === 1) {
            this.openPermissionSettings()
          }
        })
      }
    }
  }
  
  openPermissionSettings() {
    // 打开系统设置
  }
  
  build() {
    Column() {
      Text('权限管理')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .padding(20)
      
      List({ space: 10 }) {
        ForEach(this.permissions, (permission: PermissionItem) => {
          ListItem() {
            Row() {
              Column({ space: 5 }) {
                Text(permission.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                
                Text(permission.description)
                  .fontSize(14)
                  .fontColor(Color.Gray)
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              
              Toggle({ type: ToggleType.Switch, isOn: permission.granted })
                .onChange((checked) => {
                  this.togglePermission(permission)
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(8)
          }
        })
      }
      .layoutWeight(1)
      .padding({ left: 15, right: 15 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(0xF5F5F5)
  }
}

interface PermissionItem {
  name: string
  title: string
  description: string
  granted: boolean
}
```

## 💡 最佳实践

### 1. 按需请求

```typescript
// ✅ 在使用功能前请求
Button('拍照')
  .onClick(async () => {
    const granted = await checkAndRequestPermission('ohos.permission.CAMERA')
    if (granted) {
      openCamera()
    }
  })

// ❌ 避免在启动时请求所有权限
```

### 2. 说明权限用途

```typescript
// ✅ 先说明，再请求
AlertDialog.show({
  title: '需要相机权限',
  message: '用于扫描二维码和拍照功能',
  primaryButton: {
    value: '取消'
  },
  secondaryButton: {
    value: '授权',
    action: () => {
      requestPermission('ohos.permission.CAMERA')
    }
  }
})
```

### 3. 处理权限被拒绝

```typescript
const granted = await requestPermission('ohos.permission.LOCATION')

if (!granted) {
  // 提供替代方案或引导
  promptAction.showDialog({
    message: '没有位置权限，是否手动输入城市？'
  })
}
```

## 📚 参考资源

- [权限管理](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/accesstoken-overview-0000001820999637-V5)
- [权限列表](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/permissions-for-all-0000001774121106-V5)

---

**下一节** → [数据加密与存储](02-数据加密与存储.md)
