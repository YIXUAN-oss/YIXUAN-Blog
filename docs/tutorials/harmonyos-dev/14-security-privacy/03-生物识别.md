---
title: 生物识别
date: 2025-01-22
---

# 生物识别

> 实现生物识别认证

## 🔐 统一认证框架

### UserAuth 认证

```typescript
import { userAuth } from '@kit.UserAuthenticationKit'

class BiometricAuth {
  private authInstance: userAuth.UserAuthInstance | null = null
  
  // 检查生物识别可用性
  async checkBiometricAvailable(): Promise<boolean> {
    try {
      const authParam: userAuth.AuthParam = {
        challenge: new Uint8Array([1, 2, 3, 4]),
        authType: [userAuth.UserAuthType.FINGERPRINT, userAuth.UserAuthType.FACE],
        authTrustLevel: userAuth.AuthTrustLevel.ATL3
      }
      
      const widgetParam: userAuth.WidgetParam = {
        title: '请进行生物识别'
      }
      
      this.authInstance = userAuth.getUserAuthInstance(authParam, widgetParam)
      
      const availableStatus = await this.authInstance.checkAvailableStatus()
      return availableStatus === userAuth.UserAuthResultCode.SUCCESS
    } catch (err) {
      console.error('检查生物识别失败:', err)
      return false
    }
  }
  
  // 开始认证
  async authenticate(): Promise<boolean> {
    if (!this.authInstance) {
      await this.checkBiometricAvailable()
    }
    
    return new Promise((resolve) => {
      this.authInstance!.on('result', {
        onResult: (result) => {
          console.log('认证结果:', result.result)
          
          if (result.result === userAuth.UserAuthResultCode.SUCCESS) {
            resolve(true)
          } else {
            resolve(false)
          }
          
          // 释放实例
          this.authInstance!.cancel()
          this.authInstance = null
        }
      })
      
      // 开始认证
      this.authInstance!.start()
    })
  }
  
  // 取消认证
  cancelAuth() {
    if (this.authInstance) {
      this.authInstance.cancel()
      this.authInstance = null
    }
  }
}
```

## 🎯 实战案例：生物识别登录

```typescript
@Entry
@Component
struct BiometricLoginPage {
  private biometricAuth: BiometricAuth = new BiometricAuth()
  @State hasBiometric: boolean = false
  @State username: string = ''
  
  async aboutToAppear() {
    this.hasBiometric = await this.biometricAuth.checkBiometricAvailable()
    
    // 加载用户名
    const savedUsername = await preferences.get('username', '')
    this.username = savedUsername as string
  }
  
  async loginWithBiometric() {
    if (!this.hasBiometric) {
      promptAction.showToast({
        message: '设备不支持生物识别'
      })
      return
    }
    
    try {
      const success = await this.biometricAuth.authenticate()
      
      if (success) {
        // 认证成功
        promptAction.showToast({
          message: '认证成功'
        })
        
        // 跳转到首页
        router.replaceUrl({ url: 'pages/Home' })
      } else {
        // 认证失败
        promptAction.showToast({
          message: '认证失败，请重试'
        })
      }
    } catch (err) {
      console.error('生物识别错误:', err)
      promptAction.showToast({
        message: '认证出错'
      })
    }
  }
  
  build() {
    Column({ space: 30 }) {
      // Logo
      Image($r('app.media.app_icon'))
        .width(100)
        .height(100)
        .borderRadius(20)
      
      Text('欢迎回来')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
      
      if (this.username) {
        Text(this.username)
          .fontSize(18)
          .fontColor(Color.Gray)
      }
      
      // 生物识别按钮
      if (this.hasBiometric) {
        Column({ space: 15 }) {
          Button() {
            Image($r('app.media.icon_fingerprint'))
              .width(48)
              .height(48)
          }
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor(0x007DFF)
          .onClick(() => {
            this.loginWithBiometric()
          })
          
          Text('使用生物识别登录')
            .fontSize(14)
            .fontColor(Color.Gray)
        }
      }
      
      Divider()
        .width('80%')
      
      // 密码登录
      Button('使用密码登录')
        .width('80%')
        .type(ButtonType.Normal)
        .onClick(() => {
          router.pushUrl({ url: 'pages/PasswordLogin' })
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
}
```

## 🔑 实战案例：支付验证

```typescript
@Entry
@Component
struct PaymentPage {
  private biometricAuth: BiometricAuth = new BiometricAuth()
  @State amount: number = 99.00
  @State paymentMethod: string = '支付宝'
  
  async confirmPayment() {
    // 显示确认对话框
    const result = await promptAction.showDialog({
      title: '确认支付',
      message: `向${this.paymentMethod}支付 ¥${this.amount.toFixed(2)}`,
      buttons: [
        { text: '取消' },
        { text: '确认' }
      ]
    })
    
    if (result.index === 1) {
      // 进行生物识别验证
      await this.verifyAndPay()
    }
  }
  
  async verifyAndPay() {
    try {
      const success = await this.biometricAuth.authenticate()
      
      if (success) {
        // 认证成功，执行支付
        await this.processPayment()
        
        promptAction.showToast({
          message: '支付成功'
        })
        
        router.back()
      } else {
        promptAction.showToast({
          message: '认证失败，支付取消'
        })
      }
    } catch (err) {
      console.error('支付验证失败:', err)
    }
  }
  
  async processPayment() {
    // 实际支付逻辑
    console.log('处理支付:', this.amount)
  }
  
  build() {
    Column({ space: 20 }) {
      Text('支付确认')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      Column({ space: 10 }) {
        Row() {
          Text('支付金额')
            .layoutWeight(1)
          
          Text(`¥${this.amount.toFixed(2)}`)
            .fontSize(28)
            .fontColor(Color.Red)
            .fontWeight(FontWeight.Bold)
        }
        .width('100%')
        
        Row() {
          Text('支付方式')
            .layoutWeight(1)
          
          Text(this.paymentMethod)
        }
        .width('100%')
      }
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      
      Button('确认支付')
        .width('100%')
        .height(50)
        .onClick(() => {
          this.confirmPayment()
        })
    }
    .padding(20)
    .width('100%')
    .height('100%')
  }
}
```

## 💡 最佳实践

### 1. 优雅降级

```typescript
async login() {
  const hasBiometric = await checkBiometricAvailable()
  
  if (hasBiometric) {
    // 使用生物识别
    await biometricAuth()
  } else {
    // 降级到密码登录
    await passwordAuth()
  }
}
```

### 2. 错误处理

```typescript
try {
  const success = await authenticate()
  if (success) {
    // 成功处理
  }
} catch (err) {
  if (err.code === 'BIOMETRIC_LOCKED') {
    showMessage('生物识别已锁定，请稍后重试')
  } else {
    showMessage('认证失败')
  }
}
```

### 3. 用户体验

```typescript
// ✅ 提供取消选项
AlertDialog.show({
  title: '生物识别',
  message: '请使用指纹或面部识别',
  primaryButton: {
    value: '取消',
    action: () => {
      biometricAuth.cancelAuth()
    }
  }
})
```

## 📚 参考资源

- [用户认证](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/userauth-guidelines-0000001821000549-V5)
- [UserAuth API](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-useriam-userauth-0000001774121022-V5)

---

**第14章完成！** 继续学习 → [第15章：性能优化](../15-performance-optimization/)
