---
title: 页面栈管理
date: 2025-01-22
---

# 页面栈管理

> 掌握 Navigation 页面栈操作

## 📚 页面栈概念

### 栈结构

```
页面栈（后进先出）
┌─────────────┐
│  Page C     │ ← 栈顶（当前页面）
├─────────────┤
│  Page B     │
├─────────────┤
│  Page A     │ ← 栈底（首页）
└─────────────┘
```

## 🔄 页面栈操作

### 1. pushPath - 推入新页面

```typescript
@Entry
@Component
struct HomePage {
  pageStack: NavPathStack = new NavPathStack()
  
  build() {
    Navigation(this.pageStack) {
      Column() {
        Button('跳转到详情')
          .onClick(() => {
            // 推入新页面
            this.pageStack.pushPath({ name: 'DetailPage' })
          })
        
        Button('跳转并传参')
          .onClick(() => {
            this.pageStack.pushPath({
              name: 'DetailPage',
              param: { id: 123, title: '商品详情' }
            })
          })
      }
    }
  }
}
```

### 2. pop - 返回上一页

```typescript
Button('返回')
  .onClick(() => {
    // 返回上一页
    this.pageStack.pop()
  })

Button('返回并传递结果')
  .onClick(() => {
    // 返回并传递数据
    this.pageStack.pop({
      success: true,
      data: '处理结果'
    })
  })
```

### 3. popToName - 返回到指定页面

```typescript
Button('返回到首页')
  .onClick(() => {
    // 返回到指定名称的页面
    this.pageStack.popToName('HomePage')
  })
```

### 4. popToIndex - 返回到指定索引

```typescript
Button('返回到第一个页面')
  .onClick(() => {
    // 返回到栈底（索引0）
    this.pageStack.popToIndex(0)
  })
```

### 5. clear - 清空页面栈

```typescript
Button('清空并返回首页')
  .onClick(() => {
    // 清空所有页面
    this.pageStack.clear()
  })
```

### 6. replacePath - 替换当前页面

```typescript
Button('替换为登录页')
  .onClick(() => {
    // 替换当前页面（不可返回）
    this.pageStack.replacePath({ name: 'LoginPage' })
  })
```

## 📊 页面栈查询

### 获取栈信息

```typescript
@Entry
@Component
struct StackInfo {
  pageStack: NavPathStack = new NavPathStack()
  
  showStackInfo() {
    // 获取栈大小
    const size = this.pageStack.size()
    console.log('页面栈大小:', size)
    
    // 获取所有路径名称
    const names = this.pageStack.getAllPathName()
    console.log('所有页面:', names)
    
    // 获取指定索引的参数
    const param = this.pageStack.getParamByIndex(0)
    console.log('首页参数:', param)
    
    // 获取指定名称的参数
    const detailParam = this.pageStack.getParamByName('DetailPage')
    console.log('详情页参数:', detailParam)
  }
  
  build() {
    Navigation(this.pageStack) {
      Column() {
        Button('查看栈信息')
          .onClick(() => {
            this.showStackInfo()
          })
      }
    }
  }
}
```

## 🔙 返回拦截

### onBackPressed 拦截返回

```typescript
@Component
struct EditPage {
  @State hasUnsavedChanges: boolean = true
  pageStack: NavPathStack = new NavPathStack()
  
  build() {
    NavDestination() {
      Column() {
        TextInput({ placeholder: '编辑内容' })
          .onChange(() => {
            this.hasUnsavedChanges = true
          })
        
        Button('保存')
          .onClick(() => {
            this.hasUnsavedChanges = false
            this.pageStack.pop()
          })
      }
    }
    .title('编辑')
    .onBackPressed(() => {
      // 拦截返回
      if (this.hasUnsavedChanges) {
        AlertDialog.show({
          title: '提示',
          message: '有未保存的修改，确定要退出吗？',
          primaryButton: {
            value: '取消',
            action: () => {}
          },
          secondaryButton: {
            value: '确定',
            action: () => {
              this.pageStack.pop()
            }
          }
        })
        return true  // 拦截返回
      }
      return false  // 允许返回
    })
  }
}
```

## 📱 实战案例

### 电商应用导航

```typescript
// 主页
@Entry
@Component
struct ShopHome {
  pageStack: NavPathStack = new NavPathStack()
  
  build() {
    Navigation(this.pageStack) {
      Column() {
        // 商品列表
        List() {
          ForEach([1, 2, 3, 4], (item: number) => {
            ListItem() {
              Row() {
                Text(`商品 ${item}`)
                  .layoutWeight(1)
                
                Button('查看')
                  .onClick(() => {
                    this.pageStack.pushPath({
                      name: 'ProductDetail',
                      param: { productId: item }
                    })
                  })
              }
              .padding(15)
            }
          })
        }
      }
    }
    .title('商城首页')
  }
}

// 商品详情页
@Component
struct ProductDetail {
  pageStack: NavPathStack = new NavPathStack()
  @State productId: number = 0
  
  build() {
    NavDestination() {
      Column({ space: 20 }) {
        Text(`商品ID: ${this.productId}`)
          .fontSize(20)
        
        Button('加入购物车')
          .onClick(() => {
            // 返回并传递结果
            this.pageStack.pop({
              action: 'addToCart',
              productId: this.productId
            })
          })
        
        Button('立即购买')
          .onClick(() => {
            // 跳转到订单确认页
            this.pageStack.pushPath({
              name: 'OrderConfirm',
              param: { productId: this.productId }
            })
          })
        
        Button('返回首页')
          .onClick(() => {
            // 清空栈，回到首页
            this.pageStack.clear()
          })
      }
      .padding(20)
    }
    .title('商品详情')
    .onReady((context) => {
      const param = context.pathStack.getParamByName('ProductDetail')
      this.productId = param?.productId || 0
    })
  }
}

// 订单确认页
@Component
struct OrderConfirm {
  pageStack: NavPathStack = new NavPathStack()
  @State productId: number = 0
  
  submitOrder() {
    // 提交订单成功后，返回到首页
    this.pageStack.clear()
    
    // 或者返回到指定页面
    // this.pageStack.popToName('ShopHome')
  }
  
  build() {
    NavDestination() {
      Column({ space: 20 }) {
        Text('订单确认')
          .fontSize(24)
        
        Text(`商品ID: ${this.productId}`)
        
        Button('提交订单')
          .onClick(() => {
            this.submitOrder()
          })
      }
      .padding(20)
    }
    .title('订单确认')
    .onReady((context) => {
      const param = context.pathStack.getParamByName('OrderConfirm')
      this.productId = param?.productId || 0
    })
  }
}
```

## 💡 最佳实践

### 1. 合理管理页面栈

```typescript
// ✅ 登录后清空之前的页面
loginSuccess() {
  this.pageStack.clear()
  this.pageStack.pushPath({ name: 'HomePage' })
}

// ✅ 支付成功后返回到订单列表
paymentSuccess() {
  this.pageStack.popToName('OrderList')
}
```

### 2. 避免页面栈过深

```typescript
// ❌ 避免
HomePage → DetailA → DetailB → DetailC → DetailD (太深)

// ✅ 使用 replacePath 优化
HomePage → DetailA → DetailB (替换) → DetailC
```

### 3. 处理返回结果

```typescript
// 页面 A - 等待返回结果
this.pageStack.pushPath({
  name: 'SelectPage',
  onPop: (result) => {
    console.log('返回结果:', result)
    if (result?.selected) {
      this.handleSelection(result.selected)
    }
  }
})

// 页面 B - 返回结果
this.pageStack.pop({
  selected: this.selectedItem
})
```

## 📚 参考资源

- [Navigation 官方文档](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/ts-basic-components-navigation-0000001815767556-V5)

---

**下一节** → [路由参数传递](03-路由参数传递.md)
