---
title: 生命周期管理
date: 2025-01-22
---

# 生命周期管理

> 掌握 Ability 的生命周期

## 📊 UIAbility 生命周期

### 生命周期流程

```
创建 → onCreate()
  ↓
窗口创建 → onWindowStageCreate()
  ↓
前台显示 → onForeground()
  ↓
后台隐藏 → onBackground()
  ↓
窗口销毁 → onWindowStageDestroy()
  ↓
销毁 → onDestroy()
```

### 完整示例

```typescript
import UIAbility from '@ohos.app.ability.UIAbility'
import window from '@ohos.window'

export default class EntryAbility extends UIAbility {
  // 1. 创建
  onCreate(want, launchParam) {
    console.log('1. onCreate - Ability 创建')
    
    // 初始化全局数据
    AppStorage.SetOrCreate('appData', {
      isFirstLaunch: true,
      timestamp: Date.now()
    })
  }
  
  // 2. 窗口阶段创建
  onWindowStageCreate(windowStage: window.WindowStage) {
    console.log('2. onWindowStageCreate - 窗口创建')
    
    // 加载主页面
    windowStage.loadContent('pages/Index', (err, data) => {
      if (err.code) {
        console.error('加载页面失败')
        return
      }
      console.log('加载页面成功')
    })
  }
  
  // 3. 切换到前台
  onForeground() {
    console.log('3. onForeground - 进入前台')
    
    // 刷新数据
    this.refreshData()
    
    // 恢复动画
    this.resumeAnimations()
  }
  
  // 4. 切换到后台
  onBackground() {
    console.log('4. onBackground - 进入后台')
    
    // 保存状态
    this.saveState()
    
    // 暂停动画
    this.pauseAnimations()
    
    // 释放资源
    this.releaseResources()
  }
  
  // 5. 窗口阶段销毁
  onWindowStageDestroy() {
    console.log('5. onWindowStageDestroy - 窗口销毁')
    
    // 释放窗口相关资源
  }
  
  // 6. 销毁
  onDestroy() {
    console.log('6. onDestroy - Ability 销毁')
    
    // 清理定时器
    this.clearTimers()
    
    // 取消监听
    this.unsubscribeEvents()
    
    // 释放所有资源
    this.cleanup()
  }
  
  private refreshData() {
    console.log('刷新数据')
  }
  
  private resumeAnimations() {
    console.log('恢复动画')
  }
  
  private saveState() {
    console.log('保存状态')
  }
  
  private pauseAnimations() {
    console.log('暂停动画')
  }
  
  private releaseResources() {
    console.log('释放资源')
  }
  
  private clearTimers() {
    console.log('清理定时器')
  }
  
  private unsubscribeEvents() {
    console.log('取消监听')
  }
  
  private cleanup() {
    console.log('清理资源')
  }
}
```

## 💾 状态保存与恢复

### 保存状态

```typescript
import UIAbility from '@ohos.app.ability.UIAbility'
import AbilityConstant from '@ohos.app.ability.AbilityConstant'

export default class DataAbility extends UIAbility {
  private userData: UserData = {
    scrollPosition: 0,
    selectedTab: 0,
    formData: {}
  }
  
  // 保存状态
  onBackground() {
    // 保存到本地
    PersistentStorage.PersistProp('userData', this.userData)
    
    console.log('状态已保存')
  }
  
  // 恢复状态
  onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      // 从持久化存储恢复
      const saved = AppStorage.Get('userData')
      if (saved) {
        this.userData = saved
        console.log('状态已恢复')
      }
    }
  }
}
```

### 数据持久化

```typescript
import preferences from '@ohos.data.preferences'

export default class PersistentAbility extends UIAbility {
  private dataPreferences: preferences.Preferences
  
  async onCreate(want, launchParam) {
    // 获取 preferences 实例
    this.dataPreferences = await preferences.getPreferences(this.context, 'myData')
    
    // 恢复数据
    await this.restoreData()
  }
  
  async restoreData() {
    const userData = await this.dataPreferences.get('user', '')
    if (userData) {
      AppStorage.SetOrCreate('currentUser', JSON.parse(userData as string))
    }
  }
  
  async onBackground() {
    // 保存数据
    const user = AppStorage.Get('currentUser')
    if (user) {
      await this.dataPreferences.put('user', JSON.stringify(user))
      await this.dataPreferences.flush()
    }
  }
  
  async onDestroy() {
    // 清理 preferences
    await this.dataPreferences.clear()
  }
}
```

## ⏱️ 后台任务管理

### 长时任务

```typescript
import backgroundTaskManager from '@ohos.resourceschedule.backgroundTaskManager'

export default class BackgroundTaskAbility extends UIAbility {
  private bgTaskId: number = 0
  
  async onBackground() {
    // 申请长时任务
    const taskParam = {
      bgMode: backgroundTaskManager.BackgroundMode.DATA_TRANSFER,
      wantAgent: null
    }
    
    try {
      this.bgTaskId = await backgroundTaskManager.startBackgroundRunning(
        this.context,
        taskParam
      )
      console.log('长时任务已开始')
      
      // 执行后台任务
      this.performBackgroundTask()
    } catch (err) {
      console.error('启动长时任务失败:', err)
    }
  }
  
  async onDestroy() {
    // 停止长时任务
    if (this.bgTaskId) {
      await backgroundTaskManager.stopBackgroundRunning(this.context)
      console.log('长时任务已停止')
    }
  }
  
  private async performBackgroundTask() {
    // 执行数据传输等后台任务
    console.log('执行后台任务')
  }
}
```

### 延迟任务

```typescript
import workScheduler from '@ohos.resourceschedule.workScheduler'

export default class ScheduledTaskAbility extends UIAbility {
  onCreate(want, launchParam) {
    // 注册延迟任务
    this.scheduleWork()
  }
  
  scheduleWork() {
    const workInfo = {
      workId: 1,
      networkType: workScheduler.NetworkType.NETWORK_TYPE_WIFI,
      isCharging: false,
      isPersisted: true
    }
    
    workScheduler.startWork(workInfo)
      .then(() => {
        console.log('延迟任务已注册')
      })
      .catch((err) => {
        console.error('注册失败:', err)
      })
  }
  
  onDestroy() {
    // 取消延迟任务
    workScheduler.stopWork(1)
  }
}
```

## 🧹 内存管理

### 内存警告处理

```typescript
export default class MemoryAwareAbility extends UIAbility {
  private largeDataCache: Map<string, any> = new Map()
  
  onCreate(want, launchParam) {
    // 监听内存警告
    this.context.getApplicationContext().on('memoryLevel', (level) => {
      console.log('内存警告级别:', level)
      this.handleMemoryWarning(level)
    })
  }
  
  handleMemoryWarning(level: number) {
    if (level === 0) {
      // 内存正常
      console.log('内存正常')
    } else if (level === 1) {
      // 内存偏低 - 清理部分缓存
      console.log('清理部分缓存')
      this.clearPartialCache()
    } else if (level === 2) {
      // 内存严重不足 - 清理所有缓存
      console.log('清理所有缓存')
      this.clearAllCache()
    }
  }
  
  clearPartialCache() {
    // 清理50%的缓存
    const keysToDelete = Array.from(this.largeDataCache.keys()).slice(0, this.largeDataCache.size / 2)
    keysToDelete.forEach(key => this.largeDataCache.delete(key))
  }
  
  clearAllCache() {
    // 清理所有缓存
    this.largeDataCache.clear()
  }
  
  onDestroy() {
    // 取消监听
    this.context.getApplicationContext().off('memoryLevel')
  }
}
```

## 💡 最佳实践

### 1. 及时清理资源

```typescript
onBackground() {
  // ✅ 暂停动画
  this.stopAnimations()
  
  // ✅ 清理定时器
  clearInterval(this.timer)
  
  // ✅ 释放大对象
  this.largeData = null
}
```

### 2. 合理使用生命周期

```typescript
// ✅ onCreate - 一次性初始化
onCreate() {
  this.initDatabase()
  this.setupEventListeners()
}

// ✅ onForeground - 刷新数据
onForeground() {
  this.refreshUserData()
}

// ✅ onBackground - 保存状态
onBackground() {
  this.saveCurrentState()
}
```

### 3. 异常处理

```typescript
onCreate(want, launchParam) {
  try {
    this.initialize()
  } catch (err) {
    console.error('初始化失败:', err)
    // 降级处理
    this.fallbackInit()
  }
}
```

## 📚 参考资源

- [Ability 生命周期](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/uiability-lifecycle-0000001820999565-V5)

---

**下一节** → [进程模型](04-进程模型.md)
