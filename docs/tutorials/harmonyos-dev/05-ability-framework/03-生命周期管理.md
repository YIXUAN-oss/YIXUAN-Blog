---
title: ç”Ÿå‘½å‘¨æœŸç®¡ç†
date: 2025-01-22
---

# ç”Ÿå‘½å‘¨æœŸç®¡ç†

> æŒæ¡ Ability çš„ç”Ÿå‘½å‘¨æœŸ

## ğŸ“Š UIAbility ç”Ÿå‘½å‘¨æœŸ

### ç”Ÿå‘½å‘¨æœŸæµç¨‹

```
åˆ›å»º â†’ onCreate()
  â†“
çª—å£åˆ›å»º â†’ onWindowStageCreate()
  â†“
å‰å°æ˜¾ç¤º â†’ onForeground()
  â†“
åå°éšè— â†’ onBackground()
  â†“
çª—å£é”€æ¯ â†’ onWindowStageDestroy()
  â†“
é”€æ¯ â†’ onDestroy()
```

### å®Œæ•´ç¤ºä¾‹

```typescript
import UIAbility from '@ohos.app.ability.UIAbility'
import window from '@ohos.window'

export default class EntryAbility extends UIAbility {
  // 1. åˆ›å»º
  onCreate(want, launchParam) {
    console.log('1. onCreate - Ability åˆ›å»º')
    
    // åˆå§‹åŒ–å…¨å±€æ•°æ®
    AppStorage.SetOrCreate('appData', {
      isFirstLaunch: true,
      timestamp: Date.now()
    })
  }
  
  // 2. çª—å£é˜¶æ®µåˆ›å»º
  onWindowStageCreate(windowStage: window.WindowStage) {
    console.log('2. onWindowStageCreate - çª—å£åˆ›å»º')
    
    // åŠ è½½ä¸»é¡µé¢
    windowStage.loadContent('pages/Index', (err, data) => {
      if (err.code) {
        console.error('åŠ è½½é¡µé¢å¤±è´¥')
        return
      }
      console.log('åŠ è½½é¡µé¢æˆåŠŸ')
    })
  }
  
  // 3. åˆ‡æ¢åˆ°å‰å°
  onForeground() {
    console.log('3. onForeground - è¿›å…¥å‰å°')
    
    // åˆ·æ–°æ•°æ®
    this.refreshData()
    
    // æ¢å¤åŠ¨ç”»
    this.resumeAnimations()
  }
  
  // 4. åˆ‡æ¢åˆ°åå°
  onBackground() {
    console.log('4. onBackground - è¿›å…¥åå°')
    
    // ä¿å­˜çŠ¶æ€
    this.saveState()
    
    // æš‚åœåŠ¨ç”»
    this.pauseAnimations()
    
    // é‡Šæ”¾èµ„æº
    this.releaseResources()
  }
  
  // 5. çª—å£é˜¶æ®µé”€æ¯
  onWindowStageDestroy() {
    console.log('5. onWindowStageDestroy - çª—å£é”€æ¯')
    
    // é‡Šæ”¾çª—å£ç›¸å…³èµ„æº
  }
  
  // 6. é”€æ¯
  onDestroy() {
    console.log('6. onDestroy - Ability é”€æ¯')
    
    // æ¸…ç†å®šæ—¶å™¨
    this.clearTimers()
    
    // å–æ¶ˆç›‘å¬
    this.unsubscribeEvents()
    
    // é‡Šæ”¾æ‰€æœ‰èµ„æº
    this.cleanup()
  }
  
  private refreshData() {
    console.log('åˆ·æ–°æ•°æ®')
  }
  
  private resumeAnimations() {
    console.log('æ¢å¤åŠ¨ç”»')
  }
  
  private saveState() {
    console.log('ä¿å­˜çŠ¶æ€')
  }
  
  private pauseAnimations() {
    console.log('æš‚åœåŠ¨ç”»')
  }
  
  private releaseResources() {
    console.log('é‡Šæ”¾èµ„æº')
  }
  
  private clearTimers() {
    console.log('æ¸…ç†å®šæ—¶å™¨')
  }
  
  private unsubscribeEvents() {
    console.log('å–æ¶ˆç›‘å¬')
  }
  
  private cleanup() {
    console.log('æ¸…ç†èµ„æº')
  }
}
```

## ğŸ’¾ çŠ¶æ€ä¿å­˜ä¸æ¢å¤

### ä¿å­˜çŠ¶æ€

```typescript
import UIAbility from '@ohos.app.ability.UIAbility'
import AbilityConstant from '@ohos.app.ability.AbilityConstant'

export default class DataAbility extends UIAbility {
  private userData: UserData = {
    scrollPosition: 0,
    selectedTab: 0,
    formData: {}
  }
  
  // ä¿å­˜çŠ¶æ€
  onBackground() {
    // ä¿å­˜åˆ°æœ¬åœ°
    PersistentStorage.PersistProp('userData', this.userData)
    
    console.log('çŠ¶æ€å·²ä¿å­˜')
  }
  
  // æ¢å¤çŠ¶æ€
  onCreate(want, launchParam) {
    if (launchParam.launchReason === AbilityConstant.LaunchReason.CONTINUATION) {
      // ä»æŒä¹…åŒ–å­˜å‚¨æ¢å¤
      const saved = AppStorage.Get('userData')
      if (saved) {
        this.userData = saved
        console.log('çŠ¶æ€å·²æ¢å¤')
      }
    }
  }
}
```

### æ•°æ®æŒä¹…åŒ–

```typescript
import preferences from '@ohos.data.preferences'

export default class PersistentAbility extends UIAbility {
  private dataPreferences: preferences.Preferences
  
  async onCreate(want, launchParam) {
    // è·å– preferences å®ä¾‹
    this.dataPreferences = await preferences.getPreferences(this.context, 'myData')
    
    // æ¢å¤æ•°æ®
    await this.restoreData()
  }
  
  async restoreData() {
    const userData = await this.dataPreferences.get('user', '')
    if (userData) {
      AppStorage.SetOrCreate('currentUser', JSON.parse(userData as string))
    }
  }
  
  async onBackground() {
    // ä¿å­˜æ•°æ®
    const user = AppStorage.Get('currentUser')
    if (user) {
      await this.dataPreferences.put('user', JSON.stringify(user))
      await this.dataPreferences.flush()
    }
  }
  
  async onDestroy() {
    // æ¸…ç† preferences
    await this.dataPreferences.clear()
  }
}
```

## â±ï¸ åå°ä»»åŠ¡ç®¡ç†

### é•¿æ—¶ä»»åŠ¡

```typescript
import backgroundTaskManager from '@ohos.resourceschedule.backgroundTaskManager'

export default class BackgroundTaskAbility extends UIAbility {
  private bgTaskId: number = 0
  
  async onBackground() {
    // ç”³è¯·é•¿æ—¶ä»»åŠ¡
    const taskParam = {
      bgMode: backgroundTaskManager.BackgroundMode.DATA_TRANSFER,
      wantAgent: null
    }
    
    try {
      this.bgTaskId = await backgroundTaskManager.startBackgroundRunning(
        this.context,
        taskParam
      )
      console.log('é•¿æ—¶ä»»åŠ¡å·²å¼€å§‹')
      
      // æ‰§è¡Œåå°ä»»åŠ¡
      this.performBackgroundTask()
    } catch (err) {
      console.error('å¯åŠ¨é•¿æ—¶ä»»åŠ¡å¤±è´¥:', err)
    }
  }
  
  async onDestroy() {
    // åœæ­¢é•¿æ—¶ä»»åŠ¡
    if (this.bgTaskId) {
      await backgroundTaskManager.stopBackgroundRunning(this.context)
      console.log('é•¿æ—¶ä»»åŠ¡å·²åœæ­¢')
    }
  }
  
  private async performBackgroundTask() {
    // æ‰§è¡Œæ•°æ®ä¼ è¾“ç­‰åå°ä»»åŠ¡
    console.log('æ‰§è¡Œåå°ä»»åŠ¡')
  }
}
```

### å»¶è¿Ÿä»»åŠ¡

```typescript
import workScheduler from '@ohos.resourceschedule.workScheduler'

export default class ScheduledTaskAbility extends UIAbility {
  onCreate(want, launchParam) {
    // æ³¨å†Œå»¶è¿Ÿä»»åŠ¡
    this.scheduleWork()
  }
  
  scheduleWork() {
    const workInfo = {
      workId: 1,
      networkType: workScheduler.NetworkType.NETWORK_TYPE_WIFI,
      isCharging: false,
      isPersisted: true
    }
    
    workScheduler.startWork(workInfo)
      .then(() => {
        console.log('å»¶è¿Ÿä»»åŠ¡å·²æ³¨å†Œ')
      })
      .catch((err) => {
        console.error('æ³¨å†Œå¤±è´¥:', err)
      })
  }
  
  onDestroy() {
    // å–æ¶ˆå»¶è¿Ÿä»»åŠ¡
    workScheduler.stopWork(1)
  }
}
```

## ğŸ§¹ å†…å­˜ç®¡ç†

### å†…å­˜è­¦å‘Šå¤„ç†

```typescript
export default class MemoryAwareAbility extends UIAbility {
  private largeDataCache: Map<string, any> = new Map()
  
  onCreate(want, launchParam) {
    // ç›‘å¬å†…å­˜è­¦å‘Š
    this.context.getApplicationContext().on('memoryLevel', (level) => {
      console.log('å†…å­˜è­¦å‘Šçº§åˆ«:', level)
      this.handleMemoryWarning(level)
    })
  }
  
  handleMemoryWarning(level: number) {
    if (level === 0) {
      // å†…å­˜æ­£å¸¸
      console.log('å†…å­˜æ­£å¸¸')
    } else if (level === 1) {
      // å†…å­˜åä½ - æ¸…ç†éƒ¨åˆ†ç¼“å­˜
      console.log('æ¸…ç†éƒ¨åˆ†ç¼“å­˜')
      this.clearPartialCache()
    } else if (level === 2) {
      // å†…å­˜ä¸¥é‡ä¸è¶³ - æ¸…ç†æ‰€æœ‰ç¼“å­˜
      console.log('æ¸…ç†æ‰€æœ‰ç¼“å­˜')
      this.clearAllCache()
    }
  }
  
  clearPartialCache() {
    // æ¸…ç†50%çš„ç¼“å­˜
    const keysToDelete = Array.from(this.largeDataCache.keys()).slice(0, this.largeDataCache.size / 2)
    keysToDelete.forEach(key => this.largeDataCache.delete(key))
  }
  
  clearAllCache() {
    // æ¸…ç†æ‰€æœ‰ç¼“å­˜
    this.largeDataCache.clear()
  }
  
  onDestroy() {
    // å–æ¶ˆç›‘å¬
    this.context.getApplicationContext().off('memoryLevel')
  }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. åŠæ—¶æ¸…ç†èµ„æº

```typescript
onBackground() {
  // âœ… æš‚åœåŠ¨ç”»
  this.stopAnimations()
  
  // âœ… æ¸…ç†å®šæ—¶å™¨
  clearInterval(this.timer)
  
  // âœ… é‡Šæ”¾å¤§å¯¹è±¡
  this.largeData = null
}
```

### 2. åˆç†ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸ

```typescript
// âœ… onCreate - ä¸€æ¬¡æ€§åˆå§‹åŒ–
onCreate() {
  this.initDatabase()
  this.setupEventListeners()
}

// âœ… onForeground - åˆ·æ–°æ•°æ®
onForeground() {
  this.refreshUserData()
}

// âœ… onBackground - ä¿å­˜çŠ¶æ€
onBackground() {
  this.saveCurrentState()
}
```

### 3. å¼‚å¸¸å¤„ç†

```typescript
onCreate(want, launchParam) {
  try {
    this.initialize()
  } catch (err) {
    console.error('åˆå§‹åŒ–å¤±è´¥:', err)
    // é™çº§å¤„ç†
    this.fallbackInit()
  }
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [Ability ç”Ÿå‘½å‘¨æœŸ](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/uiability-lifecycle-0000001820999565-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [è¿›ç¨‹æ¨¡å‹](04-è¿›ç¨‹æ¨¡å‹.md)
