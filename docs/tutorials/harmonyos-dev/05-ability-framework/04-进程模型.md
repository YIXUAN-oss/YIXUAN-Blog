---
title: 进程模型
date: 2025-01-22
---

# 进程模型

> 理解 HarmonyOS 的进程架构

## 🏗️ 进程架构

### 进程类型

```
HarmonyOS 进程模型
├─ 主进程（Main Process）
│   └─ 运行 UIAbility
├─ 渲染进程（Render Process）
│   └─ UI 渲染
└─ Extension 进程
    ├─ FormExtension
    └─ ServiceExtension
```

### 进程配置

```json5
// module.json5
{
  "module": {
    "process": "com.example.myapp:main",  // 进程名
    "abilities": [
      {
        "name": "MainAbility",
        "process": ""  // 使用默认进程
      },
      {
        "name": "IsolatedAbility",
        "process": "com.example.myapp:isolated"  // 独立进程
      }
    ]
  }
}
```

## 🔄 进程间通信（IPC）

### 使用 RPC

```typescript
import rpc from '@ohos.rpc'

// 服务端
class MyStub extends rpc.RemoteObject {
  constructor(descriptor: string) {
    super(descriptor)
  }
  
  onRemoteRequest(code: number, data: rpc.MessageParcel, 
                  reply: rpc.MessageParcel, option: rpc.MessageOption): boolean {
    console.log('收到请求, code:', code)
    
    if (code === 1) {
      // 读取数据
      const value = data.readInt()
      console.log('接收到:', value)
      
      // 写入返回值
      reply.writeInt(value * 2)
      return true
    }
    
    return false
  }
}

// 客户端
async function callRemoteService() {
  const proxy = /* 获取远程对象代理 */
  
  const data = rpc.MessageParcel.create()
  const reply = rpc.MessageParcel.create()
  const option = new rpc.MessageOption()
  
  // 写入数据
  data.writeInt(10)
  
  // 发送请求
  await proxy.sendRequest(1, data, reply, option)
  
  // 读取结果
  const result = reply.readInt()
  console.log('结果:', result)  // 20
  
  data.reclaim()
  reply.reclaim()
}
```

## 🔐 进程隔离

### 数据隔离

```typescript
// 进程 A
AppStorage.SetOrCreate('processA_data', 'Data from Process A')

// 进程 B（无法访问进程 A 的数据）
const data = AppStorage.Get('processA_data')  // undefined
```

### 安全隔离

```
安全沙箱
├─ 进程 A
│   └─ 独立的文件系统
│   └─ 独立的内存空间
└─ 进程 B
    └─ 独立的文件系统
    └─ 独立的内存空间
```

## ⚡ 性能优化

### 1. 进程复用

```json5
// 多个 Ability 共享同一进程
{
  "abilities": [
    {
      "name": "MainAbility",
      "process": "com.example.myapp:main"
    },
    {
      "name": "DetailAbility",
      "process": "com.example.myapp:main"  // 共享进程
    }
  ]
}
```

### 2. 按需创建

```typescript
// 延迟加载重进程服务
async function loadHeavyService() {
  if (!this.heavyServiceLoaded) {
    await this.context.startServiceExtensionAbility(want)
    this.heavyServiceLoaded = true
  }
}
```

### 3. 资源限制

```typescript
// 监控进程内存
import process from '@ohos.process'

function checkMemoryUsage() {
  const memInfo = process.getMemoryInfo()
  console.log('内存使用:', memInfo.rss / 1024 / 1024, 'MB')
  
  if (memInfo.rss > 200 * 1024 * 1024) {
    // 超过200MB，清理资源
    this.cleanupResources()
  }
}
```

## 💡 最佳实践

### 1. 合理划分进程

```typescript
// ✅ 主进程 - 轻量级 UI
MainAbility → main process

// ✅ 独立进程 - 重量级服务
DataProcessService → isolated process
```

### 2. 避免过度通信

```typescript
// ❌ 频繁IPC
for (let i = 0; i < 1000; i++) {
  await sendIPC(i)
}

// ✅ 批量处理
const batch = Array.from({ length: 1000 }, (_, i) => i)
await sendBatchIPC(batch)
```

## 📚 参考资源

- [进程模型官方文档](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/process-model-stage-0000001428061460-V3)

---

**第5章完成！** 继续学习 → [第6章：导航与路由](../06-navigation-router/)
