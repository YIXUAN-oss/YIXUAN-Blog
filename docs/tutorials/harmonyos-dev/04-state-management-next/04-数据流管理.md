---
title: æ•°æ®æµç®¡ç†
date: 2025-01-22
---

# æ•°æ®æµç®¡ç†

> æ„å»ºæ¸…æ™°çš„æ•°æ®æµå‘

## ğŸ”„ å•å‘æ•°æ®æµ

### æ¦‚å¿µ

```
å•å‘æ•°æ®æµ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   State     â”‚ æ•°æ®æº
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     UI      â”‚ è§†å›¾
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Actions   â”‚ æ“ä½œ
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
   Update State
```

### å®ç°

```typescript
// æ•°æ®æ¨¡å‹
@ObservedV2
class TodoStore {
  @Trace items: TodoItem[] = []
  
  // æ“ä½œæ–¹æ³•
  addItem(text: string) {
    this.items.push({
      id: Date.now(),
      text,
      done: false
    })
  }
  
  removeItem(id: number) {
    const index = this.items.findIndex(item => item.id === id)
    if (index >= 0) {
      this.items.splice(index, 1)
    }
  }
  
  toggleItem(id: number) {
    const item = this.items.find(i => i.id === id)
    if (item) {
      item.done = !item.done
    }
  }
}

// è§†å›¾ç»„ä»¶
@Entry
@Component
struct TodoApp {
  @Local store: TodoStore = new TodoStore()
  @State newTodo: string = ''
  
  build() {
    Column() {
      // è¾“å…¥
      Row() {
        TextInput({ text: this.newTodo })
          .onChange((value) => {
            this.newTodo = value
          })
        
        Button('æ·»åŠ ')
          .onClick(() => {
            // Action â†’ Update State
            this.store.addItem(this.newTodo)
            this.newTodo = ''
          })
      }
      
      // åˆ—è¡¨æ¸²æŸ“
      List() {
        ForEach(this.store.items, (item: TodoItem) => {
          ListItem() {
            Row() {
              Checkbox()
                .select(item.done)
                .onChange((checked) => {
                  // Action â†’ Update State
                  this.store.toggleItem(item.id)
                })
              
              Text(item.text)
              
              Button('åˆ é™¤')
                .onClick(() => {
                  // Action â†’ Update State
                  this.store.removeItem(item.id)
                })
            }
          }
        })
      }
    }
  }
}
```

## â¬†ï¸â¬‡ï¸ åŒå‘æ•°æ®ç»‘å®š

### @Link åŒå‘ç»‘å®š

```typescript
// çˆ¶ç»„ä»¶
@Entry
@Component
struct Parent {
  @State count: number = 0
  
  build() {
    Column() {
      Text(`Parent: ${this.count}`)
      
      // ä½¿ç”¨ $ ä¼ é€’å¼•ç”¨
      Child({ count: $count })
    }
  }
}

// å­ç»„ä»¶
@Component
struct Child {
  @Link count: number  // åŒå‘ç»‘å®š
  
  build() {
    Column() {
      Text(`Child: ${this.count}`)
      
      Button('å­ç»„ä»¶ä¿®æ”¹')
        .onClick(() => {
          this.count++  // çˆ¶ç»„ä»¶ä¹Ÿä¼šæ›´æ–°
        })
    }
  }
}
```

### è¡¨å•åŒå‘ç»‘å®š

```typescript
@Entry
@Component
struct FormExample {
  @State formData: FormData = {
    username: '',
    email: '',
    age: 0
  }
  
  build() {
    Column({ space: 15 }) {
      TextInput({ text: this.formData.username })
        .onChange((value) => {
          this.formData.username = value
        })
      
      TextInput({ text: this.formData.email })
        .onChange((value) => {
          this.formData.email = value
        })
      
      Counter({ value: $$(this.formData.age) })  // åŒå‘ç»‘å®š
      
      Button('æäº¤')
        .onClick(() => {
          console.log('è¡¨å•æ•°æ®:', this.formData)
        })
    }
  }
}

@Component
struct Counter {
  @Link value: number
  
  build() {
    Row() {
      Button('-')
        .onClick(() => this.value--)
      Text(`${this.value}`)
      Button('+')
        .onClick(() => this.value++)
    }
  }
}
```

## ğŸ“¤ çŠ¶æ€æå‡

### å…„å¼Ÿç»„ä»¶é€šä¿¡

```typescript
// çŠ¶æ€æå‡åˆ°çˆ¶ç»„ä»¶
@Entry
@Component
struct Parent {
  @State selectedId: number = 0  // æå‡çš„çŠ¶æ€
  
  build() {
    Column() {
      // å…„å¼Ÿç»„ä»¶ A
      ProductList({
        selectedId: this.selectedId,
        onSelect: (id) => {
          this.selectedId = id
        }
      })
      
      // å…„å¼Ÿç»„ä»¶ B
      ProductDetail({
        productId: this.selectedId
      })
    }
  }
}

@Component
struct ProductList {
  @Prop selectedId: number
  @Prop onSelect: (id: number) => void
  @State products: Product[] = []
  
  build() {
    List() {
      ForEach(this.products, (product: Product) => {
        ListItem() {
          Row() {
            Text(product.name)
          }
          .backgroundColor(this.selectedId === product.id ? Color.Blue : Color.White)
          .onClick(() => {
            this.onSelect(product.id)
          })
        }
      })
    }
  }
}

@Component
struct ProductDetail {
  @Prop productId: number
  @State product: Product = null
  
  aboutToAppear() {
    this.loadProduct(this.productId)
  }
  
  build() {
    Column() {
      if (this.product) {
        Text(this.product.name)
        Text(this.product.description)
      }
    }
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### è´­ç‰©è½¦æ•°æ®æµ

```typescript
// 1. æ•°æ®æ¨¡å‹
@ObservedV2
class CartStore {
  @Trace items: CartItem[] = []
  
  get totalPrice(): number {
    return this.items.reduce((sum, item) => sum + item.price * item.quantity, 0)
  }
  
  get totalItems(): number {
    return this.items.reduce((sum, item) => sum + item.quantity, 0)
  }
  
  addItem(product: Product) {
    const existing = this.items.find(item => item.id === product.id)
    
    if (existing) {
      existing.quantity++
    } else {
      this.items.push({
        id: product.id,
        name: product.name,
        price: product.price,
        quantity: 1
      })
    }
  }
  
  removeItem(id: number) {
    const index = this.items.findIndex(item => item.id === id)
    if (index >= 0) {
      this.items.splice(index, 1)
    }
  }
  
  updateQuantity(id: number, quantity: number) {
    const item = this.items.find(i => i.id === id)
    if (item) {
      item.quantity = quantity
    }
  }
}

// 2. å•†å“åˆ—è¡¨é¡µ
@Entry
@Component
struct ProductList {
  @Provide('cart') cart: CartStore = new CartStore()
  @State products: Product[] = []
  
  build() {
    Column() {
      // é¡¶éƒ¨è´­ç‰©è½¦
      CartBadge()
      
      // å•†å“åˆ—è¡¨
      List() {
        ForEach(this.products, (product: Product) => {
          ListItem() {
            ProductItem({ product: product })
          }
        })
      }
    }
  }
}

// 3. å•†å“é¡¹ç»„ä»¶
@Component
struct ProductItem {
  @Prop product: Product
  @Consume('cart') cart: CartStore
  
  build() {
    Row() {
      Image(this.product.image)
        .width(80)
        .height(80)
      
      Column({ space: 5 }) {
        Text(this.product.name)
          .fontSize(16)
        
        Text(`Â¥${this.product.price}`)
          .fontSize(18)
          .fontColor(Color.Red)
      }
      .layoutWeight(1)
      
      Button('åŠ å…¥è´­ç‰©è½¦')
        .onClick(() => {
          this.cart.addItem(this.product)
        })
    }
    .padding(15)
  }
}

// 4. è´­ç‰©è½¦è§’æ ‡
@Component
struct CartBadge {
  @Consume('cart') cart: CartStore
  
  build() {
    Badge({
      value: `${this.cart.totalItems}`,
      position: BadgePosition.RightTop
    }) {
      Image($r('app.media.icon_cart'))
        .width(24)
        .height(24)
    }
  }
}

// 5. è´­ç‰©è½¦é¡µé¢
@Entry
@Component
struct CartPage {
  @Provide('cart') cart: CartStore = new CartStore()
  
  build() {
    Column() {
      List() {
        ForEach(this.cart.items, (item: CartItem) => {
          ListItem() {
            CartItemView({ item: item })
          }
        })
      }
      
      // åº•éƒ¨ç»“ç®—
      Row() {
        Column({ space: 5 }) {
          Text(`å…± ${this.cart.totalItems} ä»¶`)
          Text(`Â¥${this.cart.totalPrice}`)
            .fontSize(20)
            .fontColor(Color.Red)
        }
        
        Button('ç»“ç®—')
          .width(120)
      }
      .padding(20)
    }
  }
}

@Component
struct CartItemView {
  @Prop item: CartItem
  @Consume('cart') cart: CartStore
  
  build() {
    Row() {
      Text(this.item.name)
        .layoutWeight(1)
      
      Row() {
        Button('-')
          .onClick(() => {
            if (this.item.quantity > 1) {
              this.cart.updateQuantity(this.item.id, this.item.quantity - 1)
            }
          })
        
        Text(`${this.item.quantity}`)
          .width(40)
          .textAlign(TextAlign.Center)
        
        Button('+')
          .onClick(() => {
            this.cart.updateQuantity(this.item.id, this.item.quantity + 1)
          })
      }
      
      Button('åˆ é™¤')
        .onClick(() => {
          this.cart.removeItem(this.item.id)
        })
    }
  }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä¿æŒæ•°æ®æµæ¸…æ™°

```typescript
// âœ… å•å‘æ•°æ®æµ
State â†’ View â†’ Actions â†’ Update State

// âŒ é¿å…åŒå‘æ··ä¹±
View â†” State â†” View
```

### 2. åˆç†ä½¿ç”¨åŒå‘ç»‘å®š

```typescript
// âœ… è¡¨å•è¾“å…¥ä½¿ç”¨åŒå‘ç»‘å®š
TextInput({ text: $username })

// âŒ é¿å…è¿‡åº¦ä½¿ç”¨
// å¤æ‚æ•°æ®ä»ç„¶ä½¿ç”¨å•å‘æµ
```

### 3. çŠ¶æ€æå‡åŸåˆ™

```typescript
// âœ… å…±äº«çŠ¶æ€æå‡åˆ°æœ€è¿‘å…¬å…±çˆ¶ç»„ä»¶
Parent (state)
â”œâ”€ ChildA (ä½¿ç”¨state)
â””â”€ ChildB (ä½¿ç”¨state)

// âŒ é¿å…è¿‡åº¦æå‡
Root (state) â†’ å¤ªé«˜å±‚çº§
â””â”€ ... many levels
    â””â”€ DeepChild (ä½¿ç”¨state)
```

## ğŸ“š å‚è€ƒèµ„æº

- [çŠ¶æ€ç®¡ç†å®˜æ–¹æ–‡æ¡£](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/arkts-state-management-0000001524537145-V3)

---

**ç¬¬4ç« å®Œæˆï¼** ç»§ç»­å­¦ä¹  â†’ [ç¬¬5ç« ï¼šAbility æ¡†æ¶å‡çº§](../05-ability-framework/)
