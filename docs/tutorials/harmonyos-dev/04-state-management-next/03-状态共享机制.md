---
title: çŠ¶æ€å…±äº«æœºåˆ¶
date: 2025-01-22
---

# çŠ¶æ€å…±äº«æœºåˆ¶

> è·¨ç»„ä»¶ã€è·¨é¡µé¢çš„çŠ¶æ€ç®¡ç†

## ğŸ”— @Provide / @Consume

### åŸºç¡€ç”¨æ³•

```typescript
// ç¥–å…ˆç»„ä»¶ - æä¾›çŠ¶æ€
@Entry
@Component
struct GrandParent {
  @Provide('theme') theme: string = 'light'
  @Provide('fontSize') fontSize: number = 16
  
  build() {
    Column() {
      Text('ç¥–å…ˆç»„ä»¶')
        .fontSize(this.fontSize)
      
      Parent()  // ä¸éœ€è¦ä¼ é€’ props
      
      Button('åˆ‡æ¢ä¸»é¢˜')
        .onClick(() => {
          this.theme = this.theme === 'light' ? 'dark' : 'light'
        })
    }
  }
}

// ä¸­é—´ç»„ä»¶ - é€ä¼ 
@Component
struct Parent {
  build() {
    Column() {
      Text('çˆ¶ç»„ä»¶')
      Child()  // ä¸éœ€è¦ä¼ é€’ props
    }
  }
}

// åä»£ç»„ä»¶ - æ¶ˆè´¹çŠ¶æ€
@Component
struct Child {
  @Consume('theme') theme: string
  @Consume('fontSize') fontSize: number
  
  build() {
    Column() {
      Text(`å½“å‰ä¸»é¢˜: ${this.theme}`)
        .fontSize(this.fontSize)
        .backgroundColor(this.theme === 'light' ? Color.White : Color.Black)
        .fontColor(this.theme === 'light' ? Color.Black : Color.White)
    }
  }
}
```

### åº”ç”¨åœºæ™¯

```typescript
// å…¨å±€ä¸»é¢˜ç®¡ç†
@Entry
@Component
struct App {
  @Provide('themeConfig') themeConfig: ThemeConfig = {
    primaryColor: '#007DFF',
    backgroundColor: '#FFFFFF',
    textColor: '#000000'
  }
  
  build() {
    Navigation() {
      HomePage()
    }
  }
}

// ä»»æ„æ·±å±‚ç»„ä»¶éƒ½å¯ä»¥è®¿é—®
@Component
struct DeepComponent {
  @Consume('themeConfig') themeConfig: ThemeConfig
  
  build() {
    Text('æ·±å±‚ç»„ä»¶')
      .fontColor(this.themeConfig.textColor)
      .backgroundColor(this.themeConfig.backgroundColor)
  }
}
```

## ğŸ’¾ LocalStorage

### é¡µé¢çº§å­˜å‚¨

```typescript
// åˆ›å»º LocalStorage å®ä¾‹
const storage = new LocalStorage({
  'count': 0,
  'message': 'Hello'
})

@Entry(storage)
@Component
struct PageA {
  @LocalStorageLink('count') count: number = 0
  @LocalStorageProp('message') message: string = ''
  
  build() {
    Column({ space: 15 }) {
      Text(`Count: ${this.count}`)
      Text(`Message: ${this.message}`)
      
      Button('å¢åŠ ')
        .onClick(() => {
          this.count++  // æ›´æ–° LocalStorage
        })
    }
  }
}

// åŒä¸€ä¸ª storage å®ä¾‹çš„å…¶ä»–ç»„ä»¶ä¹Ÿä¼šåŒæ­¥æ›´æ–°
@Component
struct PageB {
  @LocalStorageLink('count') count: number = 0
  
  build() {
    Text(`PageB Count: ${this.count}`)
  }
}
```

### @LocalStorageLink vs @LocalStorageProp

```typescript
@Entry(storage)
@Component
struct StorageExample {
  // @LocalStorageLink - åŒå‘ç»‘å®š
  @LocalStorageLink('username') username: string = ''
  
  // @LocalStorageProp - å•å‘ç»‘å®šï¼ˆåªè¯»ï¼‰
  @LocalStorageProp('appVersion') appVersion: string = ''
  
  build() {
    Column({ space: 15 }) {
      // å¯ä»¥ä¿®æ”¹ usernameï¼ˆåŒå‘ï¼‰
      TextInput({ text: this.username })
        .onChange((value) => {
          this.username = value  // âœ… æ›´æ–°åˆ° storage
        })
      
      // ä¸èƒ½ä¿®æ”¹ appVersionï¼ˆå•å‘ï¼‰
      Text(`ç‰ˆæœ¬: ${this.appVersion}`)
      
      Button('å°è¯•ä¿®æ”¹ç‰ˆæœ¬')
        .onClick(() => {
          // this.appVersion = '2.0'  // âŒ ç¼–è¯‘é”™è¯¯
        })
    }
  }
}
```

## ğŸŒ AppStorage

### åº”ç”¨çº§å­˜å‚¨

```typescript
// åˆå§‹åŒ–å…¨å±€çŠ¶æ€
AppStorage.SetOrCreate('userInfo', {
  name: 'Guest',
  isLogin: false
})

AppStorage.SetOrCreate('cartCount', 0)

// ä»»æ„ç»„ä»¶è®¿é—®
@Entry
@Component
struct HomePage {
  @StorageLink('userInfo') userInfo: UserInfo
  @StorageLink('cartCount') cartCount: number
  
  build() {
    Column({ space: 15 }) {
      Text(`æ¬¢è¿, ${this.userInfo.name}`)
      
      if (!this.userInfo.isLogin) {
        Button('ç™»å½•')
          .onClick(() => {
            this.userInfo = {
              name: 'Alice',
              isLogin: true
            }
          })
      }
      
      Button(`è´­ç‰©è½¦ (${this.cartCount})`)
        .onClick(() => {
          this.cartCount++
        })
    }
  }
}

// å…¶ä»–é¡µé¢ä¹Ÿèƒ½è®¿é—®
@Component
struct ProfilePage {
  @StorageLink('userInfo') userInfo: UserInfo
  
  build() {
    Column() {
      if (this.userInfo.isLogin) {
        Text(`ç”¨æˆ·: ${this.userInfo.name}`)
        
        Button('é€€å‡ºç™»å½•')
          .onClick(() => {
            this.userInfo = {
              name: 'Guest',
              isLogin: false
            }
          })
      }
    }
  }
}
```

### @StorageLink vs @StorageProp

```typescript
@Entry
@Component
struct AppStorageExample {
  // @StorageLink - åŒå‘åŒæ­¥
  @StorageLink('globalCount') globalCount: number = 0
  
  // @StorageProp - å•å‘åŒæ­¥
  @StorageProp('appName') appName: string = ''
  
  build() {
    Column({ space: 15 }) {
      Button(`Global Count: ${this.globalCount}`)
        .onClick(() => {
          this.globalCount++  // âœ… åŒæ­¥åˆ° AppStorage
        })
      
      Text(`App Name: ${this.appName}`)  // åªè¯»
    }
  }
}
```

## ğŸ’¿ PersistentStorage

### æŒä¹…åŒ–å­˜å‚¨

```typescript
// æŒä¹…åŒ–åˆ°ç£ç›˜
PersistentStorage.PersistProp('userSettings', {
  theme: 'light',
  language: 'zh-CN',
  notifications: true
})

PersistentStorage.PersistProp('lastVisit', Date.now())

@Entry
@Component
struct SettingsPage {
  @StorageLink('userSettings') settings: UserSettings
  
  build() {
    Column({ space: 15 }) {
      Row() {
        Text('ä¸»é¢˜')
        Toggle({ type: ToggleType.Switch, isOn: this.settings.theme === 'dark' })
          .onChange((checked) => {
            this.settings = {
              ...this.settings,
              theme: checked ? 'dark' : 'light'
            }
          })
      }
      
      Row() {
        Text('è¯­è¨€')
        Select([
          { value: 'ä¸­æ–‡', data: 'zh-CN' },
          { value: 'English', data: 'en-US' }
        ])
        .selected(this.settings.language === 'zh-CN' ? 0 : 1)
        .onSelect((index) => {
          this.settings = {
            ...this.settings,
            language: index === 0 ? 'zh-CN' : 'en-US'
          }
        })
      }
      
      Text('è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°')
        .fontSize(12)
        .fontColor(Color.Gray)
    }
    .padding(20)
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†

```typescript
// å®šä¹‰ç”¨æˆ·çŠ¶æ€
interface AuthState {
  isAuthenticated: boolean
  user: User | null
  token: string
}

// åˆå§‹åŒ–å¹¶æŒä¹…åŒ–
PersistentStorage.PersistProp('authState', {
  isAuthenticated: false,
  user: null,
  token: ''
})

// ç™»å½•é¡µé¢
@Entry
@Component
struct LoginPage {
  @StorageLink('authState') authState: AuthState
  @State username: string = ''
  @State password: string = ''
  
  async login() {
    try {
      const response = await authService.login(this.username, this.password)
      
      // æ›´æ–°å…¨å±€è®¤è¯çŠ¶æ€
      this.authState = {
        isAuthenticated: true,
        user: response.user,
        token: response.token
      }
      
      // è·³è½¬åˆ°é¦–é¡µ
      router.pushUrl({ url: 'pages/Home' })
    } catch (error) {
      console.error('ç™»å½•å¤±è´¥:', error)
    }
  }
  
  build() {
    Column({ space: 20 }) {
      TextInput({ placeholder: 'ç”¨æˆ·å' })
        .onChange((value) => {
          this.username = value
        })
      
      TextInput({ placeholder: 'å¯†ç ' })
        .type(InputType.Password)
        .onChange((value) => {
          this.password = value
        })
      
      Button('ç™»å½•')
        .onClick(() => {
          this.login()
        })
    }
    .padding(20)
  }
}

// é¦–é¡µ - è‡ªåŠ¨åŒæ­¥è®¤è¯çŠ¶æ€
@Entry
@Component
struct HomePage {
  @StorageLink('authState') authState: AuthState
  
  aboutToAppear() {
    // æ£€æŸ¥è®¤è¯çŠ¶æ€
    if (!this.authState.isAuthenticated) {
      router.replaceUrl({ url: 'pages/Login' })
    }
  }
  
  logout() {
    this.authState = {
      isAuthenticated: false,
      user: null,
      token: ''
    }
    router.replaceUrl({ url: 'pages/Login' })
  }
  
  build() {
    Column() {
      if (this.authState.user) {
        Text(`æ¬¢è¿, ${this.authState.user.name}`)
        
        Button('é€€å‡ºç™»å½•')
          .onClick(() => {
            this.logout()
          })
      }
    }
  }
}
```

### è´­ç‰©è½¦çŠ¶æ€ç®¡ç†

```typescript
// è´­ç‰©è½¦çŠ¶æ€
interface CartState {
  items: CartItem[]
  totalPrice: number
  totalItems: number
}

// åˆå§‹åŒ–
AppStorage.SetOrCreate('cart', {
  items: [],
  totalPrice: 0,
  totalItems: 0
})

// å•†å“åˆ—è¡¨é¡µ
@Entry
@Component
struct ProductList {
  @StorageLink('cart') cart: CartState
  @State products: Product[] = []
  
  addToCart(product: Product) {
    const existingItem = this.cart.items.find(item => item.id === product.id)
    
    if (existingItem) {
      existingItem.quantity++
    } else {
      this.cart.items.push({
        id: product.id,
        name: product.name,
        price: product.price,
        quantity: 1
      })
    }
    
    // æ›´æ–°æ±‡æ€»
    this.updateCartSummary()
  }
  
  updateCartSummary() {
    this.cart = {
      ...this.cart,
      totalItems: this.cart.items.reduce((sum, item) => sum + item.quantity, 0),
      totalPrice: this.cart.items.reduce((sum, item) => sum + item.price * item.quantity, 0)
    }
  }
  
  build() {
    Column() {
      List() {
        ForEach(this.products, (product: Product) => {
          ListItem() {
            Row() {
              Text(product.name)
                .layoutWeight(1)
              Text(`Â¥${product.price}`)
              Button('åŠ å…¥è´­ç‰©è½¦')
                .onClick(() => {
                  this.addToCart(product)
                })
            }
          }
        })
      }
      
      // æ˜¾ç¤ºè´­ç‰©è½¦æ±‡æ€»
      Text(`è´­ç‰©è½¦: ${this.cart.totalItems} ä»¶`)
    }
  }
}

// è´­ç‰©è½¦é¡µé¢ - è‡ªåŠ¨åŒæ­¥
@Entry
@Component
struct CartPage {
  @StorageLink('cart') cart: CartState
  
  build() {
    Column() {
      List() {
        ForEach(this.cart.items, (item: CartItem) => {
          ListItem() {
            Row() {
              Text(item.name)
              Text(`Â¥${item.price} x ${item.quantity}`)
            }
          }
        })
      }
      
      Text(`æ€»ä»·: Â¥${this.cart.totalPrice}`)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
    }
  }
}
```

## ğŸ’¡ é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹æ¡ˆ

| å­˜å‚¨æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | ç”Ÿå‘½å‘¨æœŸ |
|---------|---------|---------|
| **@Provide/@Consume** | ç»„ä»¶æ ‘å†…å…±äº« | ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ |
| **LocalStorage** | é¡µé¢å†…å…±äº« | é¡µé¢ç”Ÿå‘½å‘¨æœŸ |
| **AppStorage** | åº”ç”¨å†…å…±äº« | åº”ç”¨ç”Ÿå‘½å‘¨æœŸ |
| **PersistentStorage** | éœ€è¦æŒä¹…åŒ– | æ°¸ä¹…ä¿å­˜ |

## ğŸ“š å‚è€ƒèµ„æº

- [çŠ¶æ€ç®¡ç†å®˜æ–¹æ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-state-management-overview-0000001820879537-V5)

---

**ä¸‹ä¸€èŠ‚** â†’ [æ•°æ®æµç®¡ç†](04-æ•°æ®æµç®¡ç†.md)
