---
title: çŠ¶æ€ç®¡ç†æ–°æ¶æ„
date: 2025-01-22
---

# çŠ¶æ€ç®¡ç†æ–°æ¶æ„

> HarmonyOS NEXT çŠ¶æ€ç®¡ç†çš„é©æ–°

## ğŸ”„ çŠ¶æ€ç®¡ç†æ¼”è¿›

### ç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ | ç‰¹ç‚¹ |
|------|------------|------|
| HarmonyOS 4.0 | @Observed + @ObjectLink | æ•´ä½“ç›‘å¬ï¼Œæ€§èƒ½ä¸€èˆ¬ |
| HarmonyOS NEXT | @ObservedV2 + @Trace | ç»†ç²’åº¦ç›‘å¬ï¼Œæ€§èƒ½ä¼˜å¼‚ â­ |

## ğŸ¯ æ–°æ¶æ„æ ¸å¿ƒæ¦‚å¿µ

### ç»†ç²’åº¦ç›‘å¬

```typescript
// æ—§ç‰ˆæœ¬ - æ•´ä½“ç›‘å¬
@Observed
class UserInfo {
  name: string = ''
  age: number = 0
  city: string = ''
}
// ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè§¦å‘æ•´ä¸ªå¯¹è±¡çš„æ›´æ–°

// æ–°ç‰ˆæœ¬ - ç»†ç²’åº¦ç›‘å¬
@ObservedV2
class UserInfo {
  @Trace name: string = ''      // åªç›‘å¬ name
  @Trace age: number = 0         // åªç›‘å¬ age
  city: string = ''              // ä¸ç›‘å¬
}
// åªæœ‰è¢« @Trace æ ‡è®°çš„å±æ€§å˜åŒ–æ‰ä¼šæ›´æ–°
```

### æ€§èƒ½å¯¹æ¯”

```
æ›´æ–° 10000 æ¬¡æµ‹è¯•ï¼š
â”œâ”€ @Observedï¼ˆæ—§ç‰ˆï¼‰: 1200ms
â””â”€ @ObservedV2 + @Traceï¼ˆæ–°ç‰ˆï¼‰: 300ms
æ€§èƒ½æå‡ï¼š75%
```

## ğŸ“¦ @ObservedV2 è¯¦è§£

### åŸºæœ¬ç”¨æ³•

```typescript
@ObservedV2
class Product {
  @Trace name: string = ''
  @Trace price: number = 0
  @Trace stock: number = 0
  description: string = ''  // ä¸ç›‘å¬å˜åŒ–
  
  // è®¡ç®—å±æ€§
  get totalValue(): number {
    return this.price * this.stock
  }
}

@Entry
@Component
struct ProductPage {
  @Local product: Product = new Product()
  
  aboutToAppear() {
    this.product.name = 'iPhone 15'
    this.product.price = 5999
    this.product.stock = 100
  }
  
  build() {
    Column({ space: 20 }) {
      Text(`å•†å“: ${this.product.name}`)
      Text(`ä»·æ ¼: Â¥${this.product.price}`)
      Text(`åº“å­˜: ${this.product.stock}`)
      Text(`æ€»ä»·å€¼: Â¥${this.product.totalValue}`)
      
      Button('å‡å°‘åº“å­˜')
        .onClick(() => {
          this.product.stock--  // UI è‡ªåŠ¨æ›´æ–°
        })
      
      Button('ä¿®æ”¹æè¿°')
        .onClick(() => {
          this.product.description = 'æ–°æè¿°'  // UI ä¸æ›´æ–°
        })
    }
    .padding(20)
  }
}
```

### åµŒå¥—å¯¹è±¡

```typescript
@ObservedV2
class Address {
  @Trace city: string = ''
  @Trace street: string = ''
}

@ObservedV2
class User {
  @Trace name: string = ''
  @Trace age: number = 0
  @Trace address: Address = new Address()  // åµŒå¥—å¯¹è±¡
}

@Entry
@Component
struct UserProfile {
  @Local user: User = new User()
  
  build() {
    Column({ space: 10 }) {
      Text(`å§“å: ${this.user.name}`)
      Text(`å¹´é¾„: ${this.user.age}`)
      Text(`åŸå¸‚: ${this.user.address.city}`)
      Text(`è¡—é“: ${this.user.address.street}`)
      
      Button('ä¿®æ”¹åœ°å€')
        .onClick(() => {
          this.user.address.city = 'åŒ—äº¬'
          this.user.address.street = 'ä¸­å…³æ‘å¤§è¡—'
        })
    }
    .padding(20)
  }
}
```

### æ•°ç»„å’Œé›†åˆ

```typescript
@ObservedV2
class TodoList {
  @Trace items: string[] = []
  
  addItem(item: string) {
    this.items.push(item)  // è§¦å‘æ›´æ–°
  }
  
  removeItem(index: number) {
    this.items.splice(index, 1)  // è§¦å‘æ›´æ–°
  }
}

@Entry
@Component
struct TodoApp {
  @Local todoList: TodoList = new TodoList()
  @State newItem: string = ''
  
  build() {
    Column({ space: 20 }) {
      Row({ space: 10 }) {
        TextInput({ placeholder: 'æ–°ä»»åŠ¡' })
          .onChange((value) => {
            this.newItem = value
          })
        
        Button('æ·»åŠ ')
          .onClick(() => {
            if (this.newItem) {
              this.todoList.addItem(this.newItem)
              this.newItem = ''
            }
          })
      }
      
      List({ space: 10 }) {
        ForEach(this.todoList.items, (item: string, index: number) => {
          ListItem() {
            Row() {
              Text(item)
                .layoutWeight(1)
              
              Button('åˆ é™¤')
                .onClick(() => {
                  this.todoList.removeItem(index)
                })
            }
            .width('100%')
            .padding(10)
            .backgroundColor(Color.White)
          }
        }, (item: string, index: number) => `${index}-${item}`)
      }
    }
    .padding(20)
  }
}
```

## ğŸ”— @Local è£…é¥°å™¨

### æœ¬åœ°çŠ¶æ€ç®¡ç†

```typescript
@Entry
@Component
struct LocalExample {
  @Local counter: number = 0
  @Local user: User = new User()
  
  // @Local ç”¨äºç»„ä»¶å†…éƒ¨çŠ¶æ€
  // ä¸ä¼šä¼ é€’ç»™å­ç»„ä»¶
  
  build() {
    Column() {
      Text(`Counter: ${this.counter}`)
      Button('å¢åŠ ')
        .onClick(() => {
          this.counter++
        })
    }
  }
}
```

### ä¸ @State çš„åŒºåˆ«

```typescript
@Entry
@Component
struct ComparisonExample {
  // @State - å¯ä»¥ä¼ é€’ç»™å­ç»„ä»¶
  @State stateValue: number = 0
  
  // @Local - ä»…ç»„ä»¶å†…éƒ¨ä½¿ç”¨
  @Local localValue: number = 0
  
  build() {
    Column() {
      // âœ… å¯ä»¥ä¼ é€’ @State
      ChildComponent({ value: this.stateValue })
      
      // âŒ ä¸èƒ½ä¼ é€’ @Local
      // ChildComponent({ value: this.localValue })
    }
  }
}
```

## ğŸ“Š çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

### 1. åˆç†é€‰æ‹©è£…é¥°å™¨

```typescript
// âœ… ç®€å•æ•°æ®ç”¨ @State
@Entry
@Component
struct SimpleState {
  @State count: number = 0
  @State message: string = ''
}

// âœ… å¤æ‚å¯¹è±¡ç”¨ @ObservedV2
@ObservedV2
class ComplexData {
  @Trace field1: string = ''
  @Trace field2: number = 0
}

@Entry
@Component
struct ComplexState {
  @Local data: ComplexData = new ComplexData()
}
```

### 2. æœ€å°åŒ–ç›‘å¬èŒƒå›´

```typescript
// âœ… åªç›‘å¬éœ€è¦çš„å±æ€§
@ObservedV2
class User {
  @Trace name: string = ''        // UI éœ€è¦æ˜¾ç¤º
  @Trace avatar: string = ''      // UI éœ€è¦æ˜¾ç¤º
  id: number = 0                  // ä¸éœ€è¦ç›‘å¬
  createdAt: Date = new Date()    // ä¸éœ€è¦ç›‘å¬
}

// âŒ é¿å…è¿‡åº¦ç›‘å¬
@ObservedV2
class User {
  @Trace id: number = 0           // ä¸å¿…è¦
  @Trace createdAt: Date = new Date()  // ä¸å¿…è¦
}
```

### 3. çŠ¶æ€æå‡

```typescript
// âœ… å°†å…±äº«çŠ¶æ€æå‡åˆ°çˆ¶ç»„ä»¶
@Entry
@Component
struct Parent {
  @State sharedData: string = ''
  
  build() {
    Column() {
      ChildA({ data: this.sharedData })
      ChildB({ data: this.sharedData })
    }
  }
}

@Component
struct ChildA {
  @Prop data: string
  
  build() {
    Text(this.data)
  }
}

@Component
struct ChildB {
  @Prop data: string
  
  build() {
    Text(this.data)
  }
}
```

### 4. é¿å…å¾ªç¯ä¾èµ–

```typescript
// âŒ é¿å…
@ObservedV2
class A {
  @Trace b: B = new B()
}

@ObservedV2
class B {
  @Trace a: A = new A()  // å¾ªç¯ä¾èµ–
}

// âœ… ä½¿ç”¨æ¥å£è§£è€¦
interface IDataProvider {
  getData(): string
}

@ObservedV2
class A implements IDataProvider {
  @Trace value: string = ''
  
  getData(): string {
    return this.value
  }
}
```

## ğŸ¯ å®æˆ˜æ¡ˆä¾‹

### è´­ç‰©è½¦ç¤ºä¾‹

```typescript
@ObservedV2
class CartItem {
  @Trace id: number = 0
  @Trace name: string = ''
  @Trace price: number = 0
  @Trace quantity: number = 1
  
  get total(): number {
    return this.price * this.quantity
  }
}

@ObservedV2
class ShoppingCart {
  @Trace items: CartItem[] = []
  
  get totalAmount(): number {
    return this.items.reduce((sum, item) => sum + item.total, 0)
  }
  
  addItem(item: CartItem) {
    const existing = this.items.find(i => i.id === item.id)
    if (existing) {
      existing.quantity++
    } else {
      this.items.push(item)
    }
  }
  
  removeItem(id: number) {
    const index = this.items.findIndex(i => i.id === id)
    if (index >= 0) {
      this.items.splice(index, 1)
    }
  }
  
  updateQuantity(id: number, quantity: number) {
    const item = this.items.find(i => i.id === id)
    if (item) {
      item.quantity = quantity
    }
  }
}

@Entry
@Component
struct ShoppingCartPage {
  @Local cart: ShoppingCart = new ShoppingCart()
  
  aboutToAppear() {
    // åˆå§‹åŒ–è´­ç‰©è½¦
    this.cart.addItem({
      id: 1,
      name: 'iPhone 15',
      price: 5999,
      quantity: 1
    } as CartItem)
  }
  
  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('è´­ç‰©è½¦')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Text(`å…± ${this.cart.items.length} ä»¶`)
          .fontSize(16)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(20)
      
      // å•†å“åˆ—è¡¨
      List({ space: 10 }) {
        ForEach(this.cart.items, (item: CartItem) => {
          ListItem() {
            Row({ space: 10 }) {
              Column({ space: 5 }) {
                Text(item.name)
                  .fontSize(16)
                Text(`Â¥${item.price}`)
                  .fontSize(14)
                  .fontColor(Color.Red)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Row({ space: 10 }) {
                Button('-')
                  .width(30)
                  .height(30)
                  .onClick(() => {
                    if (item.quantity > 1) {
                      this.cart.updateQuantity(item.id, item.quantity - 1)
                    }
                  })
                
                Text(`${item.quantity}`)
                  .width(40)
                  .textAlign(TextAlign.Center)
                
                Button('+')
                  .width(30)
                  .height(30)
                  .onClick(() => {
                    this.cart.updateQuantity(item.id, item.quantity + 1)
                  })
              }
              
              Button('åˆ é™¤')
                .onClick(() => {
                  this.cart.removeItem(item.id)
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(8)
          }
        }, (item: CartItem) => `${item.id}`)
      }
      .layoutWeight(1)
      .padding({ left: 20, right: 20 })
      
      // åº•éƒ¨ç»“ç®—
      Row() {
        Column({ space: 5 }) {
          Text('åˆè®¡')
            .fontSize(14)
            .fontColor(Color.Gray)
          Text(`Â¥${this.cart.totalAmount}`)
            .fontSize(24)
            .fontColor(Color.Red)
            .fontWeight(FontWeight.Bold)
        }
        .alignItems(HorizontalAlign.Start)
        
        Button('å»ç»“ç®—')
          .width(120)
          .height(50)
          .onClick(() => {
            console.log('ç»“ç®—')
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(20)
      .backgroundColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
```

## ğŸ“š å‚è€ƒèµ„æº

- [çŠ¶æ€ç®¡ç†å®˜æ–¹æ–‡æ¡£](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/arkts-state-management-0000001524537145-V3)
- [@ObservedV2 API](https://developer.harmonyos.com/cn/docs/documentation/doc-references-V3/ts-state-management-0000001478061717-V3)

---

**ä¸‹ä¸€èŠ‚** â†’ [@ObservedV2 ä¸ @Trace](02-@ObservedV2ä¸@Trace.md)
