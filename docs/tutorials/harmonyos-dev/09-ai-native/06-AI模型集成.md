---
title: AI 模型集成
date: 2025-01-22
---

# AI 模型集成

> 自定义 AI 模型部署

## 🔄 模型格式转换

### MindSpore 模型

```typescript
// MindSpore Lite 模型可直接使用
const model = await aiEngine.loadModel({
  modelPath: '/data/storage/el2/base/files/model.ms',
  modelType: 'MindSpore'
})
```

### ONNX 模型转换

```bash
# 使用转换工具
converter_lite --fmk=ONNX \
  --modelFile=model.onnx \
  --outputFile=model.ms \
  --optimize=general
```

### TensorFlow 模型转换

```bash
converter_lite --fmk=TFLITE \
  --modelFile=model.tflite \
  --outputFile=model.ms \
  --optimize=general
```

## 📦 模型部署

### 本地模型加载

```typescript
import { modelManager } from '@ohos.ai.model'

class LocalModelManager {
  private model: Model
  
  async loadModel(modelName: string) {
    const modelPath = `/data/storage/el2/base/files/${modelName}.ms`
    
    this.model = await modelManager.load({
      path: modelPath,
      enableNPU: true,
      precision: 'FP16'
    })
  }
  
  async predict(input: ArrayBuffer) {
    const output = await this.model.infer(input)
    return this.parseOutput(output)
  }
  
  private parseOutput(output: ArrayBuffer) {
    // 解析输出数据
    return output
  }
}
```

### 动态模型更新

```typescript
class ModelUpdater {
  async checkUpdate(): Promise<boolean> {
    const response = await http.request('https://api.example.com/model/version')
    const serverVersion = response.version
    const localVersion = await this.getLocalVersion()
    
    return serverVersion > localVersion
  }
  
  async downloadModel(url: string): Promise<string> {
    const savePath = '/data/storage/el2/base/files/new_model.ms'
    
    await http.downloadFile(url, savePath, {
      onProgress: (progress) => {
        console.log(`下载进度: ${progress}%`)
      }
    })
    
    return savePath
  }
  
  async updateModel() {
    if (await this.checkUpdate()) {
      const url = 'https://cdn.example.com/models/latest.ms'
      const modelPath = await this.downloadModel(url)
      
      // 加载新模型
      await modelManager.load({ path: modelPath })
      
      // 更新版本号
      await this.saveVersion()
    }
  }
}
```

## ⚡ 模型优化

### 量化优化

```typescript
// 使用 FP16 半精度
const model = await modelManager.load({
  path: modelPath,
  precision: 'FP16'  // 减少内存，提升速度
})
```

### 硬件加速

```typescript
// 启用 NPU 加速
const config = {
  path: modelPath,
  enableNPU: true,      // NPU 加速
  enableGPU: false,     // GPU 加速
  threads: 4            // CPU 线程数
}

const model = await modelManager.load(config)
```

## 🎯 实战案例：自定义图像分类

```typescript
class CustomImageClassifier {
  private model: Model
  private labels: string[] = []
  
  async init() {
    // 加载模型
    this.model = await modelManager.load({
      path: '/data/storage/el2/base/files/custom_classifier.ms',
      enableNPU: true,
      precision: 'FP16'
    })
    
    // 加载标签
    this.labels = await this.loadLabels()
  }
  
  async loadLabels(): Promise<string[]> {
    const labelsPath = '/data/storage/el2/base/files/labels.txt'
    const content = await fs.readFile(labelsPath)
    return content.split('\n')
  }
  
  async classify(imagePath: string) {
    // 1. 加载图像
    const image = await this.loadImage(imagePath)
    
    // 2. 预处理
    const input = await this.preprocess(image)
    
    // 3. 推理
    const output = await this.model.infer(input)
    
    // 4. 后处理
    const results = this.postprocess(output)
    
    return results
  }
  
  private async loadImage(path: string): Promise<ImageData> {
    // 加载图像
    return await image.load(path)
  }
  
  private async preprocess(image: ImageData): Promise<ArrayBuffer> {
    // 调整大小到 224x224
    const resized = await image.resize(224, 224)
    
    // 归一化 [0, 1]
    const normalized = resized.normalize()
    
    // 转换为模型输入格式
    return normalized.toArrayBuffer()
  }
  
  private postprocess(output: ArrayBuffer): ClassifyResult[] {
    const probabilities = new Float32Array(output)
    
    // 获取 Top-5
    const results: ClassifyResult[] = []
    const indices = this.getTopK(probabilities, 5)
    
    indices.forEach((index, rank) => {
      results.push({
        label: this.labels[index],
        confidence: probabilities[index],
        rank: rank + 1
      })
    })
    
    return results
  }
  
  private getTopK(arr: Float32Array, k: number): number[] {
    const indexed = Array.from(arr).map((val, idx) => ({ val, idx }))
    indexed.sort((a, b) => b.val - a.val)
    return indexed.slice(0, k).map(item => item.idx)
  }
}

// 使用
const classifier = new CustomImageClassifier()
await classifier.init()

const results = await classifier.classify('/path/to/image.jpg')
results.forEach(result => {
  console.log(`${result.rank}. ${result.label}: ${result.confidence.toFixed(2)}`)
})
```

## 💡 最佳实践

### 1. 模型版本管理

```typescript
interface ModelInfo {
  version: string
  path: string
  updateTime: number
}

class ModelVersionManager {
  async getCurrentModel(): Promise<ModelInfo> {
    const info = await preferences.get('currentModel')
    return JSON.parse(info)
  }
  
  async updateModel(newModel: ModelInfo) {
    await preferences.put('currentModel', JSON.stringify(newModel))
  }
}
```

### 2. 模型预热

```typescript
// 首次推理较慢，提前预热
async function warmupModel(model: Model) {
  const dummyInput = new ArrayBuffer(224 * 224 * 3 * 4)
  await model.infer(dummyInput)
}
```

### 3. 内存管理

```typescript
// 及时释放模型
onDestroy() {
  if (this.model) {
    this.model.release()
  }
}
```

## 📚 参考资源

- [MindSpore Lite推理](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/mindspore-lite-guidelines-0000001774121034-V5)

---

**下一节** → [AI应用实战](07-AI应用实战.md)
