---
title: 分布式硬件虚拟化
date: 2025-01-22
---

# 分布式硬件虚拟化

> HarmonyOS NEXT 的核心竞争力

## 🌐 什么是分布式硬件虚拟化

### 核心概念

**硬件虚拟化**：将多个设备的硬件能力虚拟成一个统一的硬件资源池，应用可以像调用本地硬件一样调用远程设备的硬件。

```
传统方式：
手机 → 只能用手机的相机
平板 → 只能用平板的相机

分布式硬件虚拟化：
手机 → 可以调用平板的相机
平板 → 可以调用手机的相机
```

### 技术架构

```
┌─────────────────────────────────┐
│      应用层                      │
│  (统一的硬件调用接口)             │
├─────────────────────────────────┤
│   分布式硬件管理框架              │
│  ├─ 设备发现                     │
│  ├─ 能力协商                     │
│  └─ 资源调度                     │
├─────────────────────────────────┤
│      分布式软总线                │
│  (设备间通信)                    │
├─────────────────────────────────┤
│   本地设备  ←→  远程设备          │
└─────────────────────────────────┘
```

## 🎯 支持的硬件类型

### 1. 相机（Camera）

```typescript
import distributedHardware from '@ohos.distributedHardware'

// 获取所有可用相机（包括远程设备）
const cameras = await distributedHardware.getCameraList()

cameras.forEach(camera => {
  console.log('相机ID:', camera.cameraId)
  console.log('设备ID:', camera.deviceId)
  console.log('是否本地:', camera.isLocal)
  console.log('相机位置:', camera.position)  // FRONT/BACK
})

// 使用远程设备的相机
const remoteCamera = cameras.find(c => !c.isLocal)
if (remoteCamera) {
  const cameraSession = await camera.createCameraSession(remoteCamera.cameraId)
  // 拍照
  await cameraSession.takePicture()
}
```

### 2. 屏幕（Display）

```typescript
// 投屏到远程设备
import screenShare from '@ohos.distributedHardware.screenShare'

// 发现可投屏设备
const displays = await screenShare.getAvailableDisplays()

// 开始投屏
await screenShare.startShare({
  targetDeviceId: displays[0].deviceId,
  quality: 'HIGH',  // 画质：HIGH/MEDIUM/LOW
  fps: 60           // 帧率
})

// 停止投屏
await screenShare.stopShare()
```

### 3. 扬声器（Speaker）

```typescript
import audio from '@ohos.multimedia.audio'

// 获取所有音频输出设备
const audioDevices = await audio.getDevices(audio.DeviceType.OUTPUT)

// 选择远程设备的扬声器
const remoteSpeaker = audioDevices.find(d => 
  d.deviceType === audio.DeviceType.SPEAKER && 
  !d.isLocal
)

if (remoteSpeaker) {
  // 设置音频输出到远程设备
  await audio.selectOutputDevice([remoteSpeaker.id])
}
```

### 4. 传感器（Sensor）

```typescript
import sensor from '@ohos.sensor'

// 获取远程设备的传感器数据
sensor.on(sensor.SensorId.ACCELEROMETER, (data) => {
  console.log('加速度:', data.x, data.y, data.z)
  console.log('设备ID:', data.deviceId)
}, {
  deviceId: 'remote-device-id',  // 指定远程设备
  interval: 100  // 采样间隔（毫秒）
})
```

## 🔍 设备发现与连接

### 设备发现

```typescript
import deviceManager from '@ohos.distributedDeviceManager'

@Entry
@Component
struct DeviceDiscovery {
  @State devices: DeviceInfo[] = []
  private dmInstance: deviceManager.DeviceManager
  
  async aboutToAppear() {
    // 创建设备管理实例
    this.dmInstance = await deviceManager.createDeviceManager('com.example.app')
    
    // 获取可信设备列表
    this.devices = this.dmInstance.getAvailableDeviceListSync()
    
    // 监听设备上线
    this.dmInstance.on('discoverSuccess', (device) => {
      console.log('发现设备:', device.deviceName)
      this.devices.push(device)
    })
    
    // 监听设备下线
    this.dmInstance.on('discoverFailure', (device) => {
      console.log('设备离线:', device.deviceName)
      this.devices = this.devices.filter(d => d.deviceId !== device.deviceId)
    })
    
    // 开始发现设备
    this.dmInstance.startDiscovering({
      discoverTargetType: deviceManager.TargetType.ALL
    })
  }
  
  aboutToDisappear() {
    // 停止发现
    this.dmInstance.stopDiscovering()
  }
  
  build() {
    Column() {
      Text('可用设备')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      List() {
        ForEach(this.devices, (device: DeviceInfo) => {
          ListItem() {
            Row() {
              Column({ space: 5 }) {
                Text(device.deviceName)
                  .fontSize(18)
                Text(device.deviceType)
                  .fontSize(14)
                  .fontColor(Color.Gray)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              Text(device.isOnline ? '在线' : '离线')
                .fontColor(device.isOnline ? Color.Green : Color.Gray)
            }
            .width('100%')
            .padding(15)
          }
        })
      }
    }
    .padding(20)
  }
}
```

### 设备认证

```typescript
// 发起设备认证
async authenticateDevice(deviceId: string) {
  try {
    await this.dmInstance.authenticateDevice({
      deviceId: deviceId,
      authType: deviceManager.AuthType.PIN,  // PIN 码认证
      extraInfo: {
        pinCode: '123456'
      }
    })
    
    console.log('认证成功')
  } catch (err) {
    console.error('认证失败:', err)
  }
}
```

## 📸 实战案例：跨设备拍照

### 完整示例

```typescript
import distributedHardware from '@ohos.distributedHardware'
import camera from '@ohos.multimedia.camera'
import deviceManager from '@ohos.distributedDeviceManager'

@Entry
@Component
struct RemoteCameraApp {
  @State devices: DeviceInfo[] = []
  @State selectedDevice: DeviceInfo = null
  @State photoUri: string = ''
  private dmInstance: deviceManager.DeviceManager
  
  async aboutToAppear() {
    // 初始化设备管理
    this.dmInstance = await deviceManager.createDeviceManager('com.example.remotecamera')
    this.devices = this.dmInstance.getAvailableDeviceListSync()
  }
  
  async takePictureWithRemoteCamera() {
    if (!this.selectedDevice) {
      return
    }
    
    try {
      // 1. 获取远程设备的相机列表
      const cameras = await distributedHardware.getCameraList({
        deviceId: this.selectedDevice.deviceId
      })
      
      if (cameras.length === 0) {
        console.error('远程设备没有可用相机')
        return
      }
      
      // 2. 选择后置相机
      const backCamera = cameras.find(c => 
        c.position === camera.CameraPosition.BACK
      ) || cameras[0]
      
      // 3. 创建相机会话
      const cameraManager = camera.getCameraManager()
      const cameraInput = await cameraManager.createCameraInput(backCamera)
      const previewOutput = await cameraManager.createPreviewOutput()
      const photoOutput = await cameraManager.createPhotoOutput()
      
      const session = await cameraManager.createCaptureSession()
      await session.beginConfig()
      await session.addInput(cameraInput)
      await session.addOutput(previewOutput)
      await session.addOutput(photoOutput)
      await session.commitConfig()
      
      // 4. 拍照
      await session.start()
      const photo = await photoOutput.capture()
      
      // 5. 保存照片
      this.photoUri = photo.uri
      console.log('照片已保存:', this.photoUri)
      
      // 6. 释放资源
      await session.stop()
      await session.release()
      
    } catch (err) {
      console.error('拍照失败:', err)
    }
  }
  
  build() {
    Column({ space: 20 }) {
      Text('跨设备拍照')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      // 设备选择
      Text('选择设备:')
        .fontSize(18)
      
      List() {
        ForEach(this.devices, (device: DeviceInfo) => {
          ListItem() {
            Row() {
              Text(device.deviceName)
                .layoutWeight(1)
              
              Radio({ value: device.deviceId, group: 'device' })
                .checked(this.selectedDevice?.deviceId === device.deviceId)
                .onChange((isChecked) => {
                  if (isChecked) {
                    this.selectedDevice = device
                  }
                })
            }
            .width('100%')
            .padding(10)
          }
        })
      }
      .height(200)
      
      // 拍照按钮
      Button('使用远程相机拍照')
        .width('80%')
        .height(50)
        .enabled(this.selectedDevice !== null)
        .onClick(() => {
          this.takePictureWithRemoteCamera()
        })
      
      // 显示照片
      if (this.photoUri) {
        Image(this.photoUri)
          .width('100%')
          .height(300)
          .objectFit(ImageFit.Contain)
      }
    }
    .width('100%')
    .height('100%')
    .padding(20)
  }
}
```

## 🎵 实战案例：分布式音乐播放

```typescript
import audio from '@ohos.multimedia.audio'
import deviceManager from '@ohos.distributedDeviceManager'

@Entry
@Component
struct DistributedMusicPlayer {
  @State devices: DeviceInfo[] = []
  @State selectedDevices: string[] = []  // 多个设备同时播放
  @State isPlaying: boolean = false
  private audioRenderer: audio.AudioRenderer
  
  async playOnMultipleDevices() {
    try {
      // 1. 获取所有音频输出设备
      const audioDevices = await audio.getDevices(audio.DeviceType.OUTPUT)
      
      // 2. 筛选选中的设备
      const targetDevices = audioDevices.filter(d => 
        this.selectedDevices.includes(d.deviceId)
      )
      
      // 3. 设置多设备输出
      await audio.selectOutputDevice(targetDevices.map(d => d.id))
      
      // 4. 开始播放
      await this.audioRenderer.start()
      this.isPlaying = true
      
      console.log(`正在 ${targetDevices.length} 个设备上播放音乐`)
      
    } catch (err) {
      console.error('播放失败:', err)
    }
  }
  
  build() {
    Column({ space: 20 }) {
      Text('分布式音乐播放')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      Text('选择播放设备（可多选）:')
        .fontSize(18)
      
      List() {
        ForEach(this.devices, (device: DeviceInfo) => {
          ListItem() {
            Row() {
              Text(device.deviceName)
                .layoutWeight(1)
              
              Checkbox()
                .select(this.selectedDevices.includes(device.deviceId))
                .onChange((checked) => {
                  if (checked) {
                    this.selectedDevices.push(device.deviceId)
                  } else {
                    const index = this.selectedDevices.indexOf(device.deviceId)
                    if (index >= 0) {
                      this.selectedDevices.splice(index, 1)
                    }
                  }
                })
            }
            .width('100%')
            .padding(10)
          }
        })
      }
      
      Button(this.isPlaying ? '停止' : '播放')
        .width('80%')
        .onClick(() => {
          if (this.isPlaying) {
            this.audioRenderer.stop()
            this.isPlaying = false
          } else {
            this.playOnMultipleDevices()
          }
        })
    }
    .padding(20)
  }
}
```

## 🔒 安全与权限

### 权限声明

```json5
// module.json5
{
  "module": {
    "requestPermissions": [
      {
        "name": "ohos.permission.DISTRIBUTED_DATASYNC",
        "reason": "用于设备间数据同步",
        "usedScene": {
          "abilities": ["MainAbility"],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.CAMERA",
        "reason": "用于访问相机",
        "usedScene": {
          "abilities": ["MainAbility"],
          "when": "inuse"
        }
      }
    ]
  }
}
```

### 运行时权限请求

```typescript
import abilityAccessCtrl from '@ohos.abilityAccessCtrl'

async requestPermissions() {
  const atManager = abilityAccessCtrl.createAtManager()
  
  try {
    await atManager.requestPermissionsFromUser(this.context, [
      'ohos.permission.DISTRIBUTED_DATASYNC',
      'ohos.permission.CAMERA'
    ])
    
    console.log('权限已授予')
  } catch (err) {
    console.error('权限请求失败:', err)
  }
}
```

## 💡 最佳实践

### 1. 设备在线检测

```typescript
// 定期检查设备在线状态
setInterval(() => {
  this.devices.forEach(device => {
    deviceManager.isDeviceOnline(device.deviceId).then(isOnline => {
      device.isOnline = isOnline
    })
  })
}, 5000)
```

### 2. 网络质量检测

```typescript
// 检查网络质量
const quality = await distributedHardware.getConnectionQuality(deviceId)

if (quality === 'POOR') {
  console.warn('网络质量差，可能影响使用')
}
```

### 3. 降级策略

```typescript
async takePicture() {
  try {
    // 优先使用远程设备
    await this.useRemoteCamera()
  } catch (err) {
    console.warn('远程相机不可用，使用本地相机')
    // 降级到本地相机
    await this.useLocalCamera()
  }
}
```

## 📚 参考资源

- [分布式硬件官方文档](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/distributed-hardware-overview-0000001478341037-V3)
- [设备管理 API](https://developer.harmonyos.com/cn/docs/documentation/doc-references-V3/js-apis-distributedDeviceManager-0000001478341433-V3)

---

**下一节** → [跨设备流转](02-跨设备流转.md)
