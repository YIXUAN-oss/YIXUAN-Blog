---
title: 分布式组件
date: 2025-01-22
---

# 分布式组件

> 跨设备的分布式能力组件

## 🔗 分布式数据对象

### 创建分布式对象

```typescript
import { distributedDataObject } from '@kit.ArkData'

// 创建分布式对象
const source = {
  name: 'Alice',
  age: 25,
  score: 0
}

const distributedObj = distributedDataObject.create(context, source)

// 设置会话ID（同一会话的设备可以同步）
distributedObj.setSessionId('session_123')

// 监听数据变化
distributedObj.on('change', (sessionId, fields) => {
  console.log('数据变化:', fields)
  fields.forEach(field => {
    console.log(`${field}: ${distributedObj[field]}`)
  })
})

// 修改数据（会自动同步到其他设备）
distributedObj.name = 'Bob'
distributedObj.score = 100
```

### 实战：协同绘图

```typescript
@Entry
@Component
struct CollaborativeDrawing {
  @State strokes: Stroke[] = []
  private distributedObj: distributedDataObject.DataObject
  private canvas: CanvasRenderingContext2D
  
  async aboutToAppear() {
    // 创建分布式对象
    this.distributedObj = distributedDataObject.create(getContext(this), {
      strokes: []
    })
    
    // 加入会话
    this.distributedObj.setSessionId('drawing_session')
    
    // 监听其他设备的绘制
    this.distributedObj.on('change', (sessionId, fields) => {
      if (fields.includes('strokes')) {
        this.strokes = JSON.parse(JSON.stringify(this.distributedObj['strokes']))
        this.redrawCanvas()
      }
    })
  }
  
  onTouchMove(event: TouchEvent) {
    const x = event.touches[0].x
    const y = event.touches[0].y
    
    // 添加笔触
    const stroke = { x, y, timestamp: Date.now() }
    this.strokes.push(stroke)
    
    // 同步到其他设备
    this.distributedObj['strokes'] = this.strokes
    
    // 绘制
    this.drawStroke(stroke)
  }
  
  drawStroke(stroke: Stroke) {
    this.canvas.lineTo(stroke.x, stroke.y)
    this.canvas.stroke()
  }
  
  redrawCanvas() {
    this.canvas.clearRect(0, 0, 800, 600)
    this.strokes.forEach(stroke => {
      this.drawStroke(stroke)
    })
  }
  
  build() {
    Column() {
      Text('协同绘图板')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      Text('多设备实时同步')
        .fontSize(14)
        .fontColor(Color.Gray)
      
      Canvas(this.canvas)
        .width('100%')
        .height(600)
        .backgroundColor(Color.White)
        .border({ width: 1, color: Color.Gray })
        .onReady(() => {
          this.canvas.lineWidth = 3
          this.canvas.strokeStyle = '#007DFF'
        })
        .onTouch((event) => {
          if (event.type === TouchType.Move) {
            this.onTouchMove(event)
          }
        })
      
      Row({ space: 10 }) {
        Button('清空画布')
          .onClick(() => {
            this.strokes = []
            this.distributedObj['strokes'] = []
            this.canvas.clearRect(0, 0, 800, 600)
          })
      }
      .margin({ top: 20 })
    }
    .padding(20)
  }
}

interface Stroke {
  x: number
  y: number
  timestamp: number
}
```

## 🔔 跨设备通知

### 发送分布式通知

```typescript
import { notificationManager } from '@kit.NotificationKit'
import { wantAgent } from '@kit.AbilityKit'

async function sendDistributedNotification() {
  // 创建通知请求
  const notificationRequest = {
    id: 1,
    content: {
      notificationContentType: notificationManager.ContentType.NOTIFICATION_CONTENT_BASIC_TEXT,
      normal: {
        title: '分布式通知',
        text: '您有新消息',
        additionalText: '来自手机'
      }
    },
    // 分布式通知配置
    isDistributed: true,
    deviceId: 'target_device_id'
  }
  
  // 发布通知
  await notificationManager.publish(notificationRequest)
}
```

## 🚀 远程拉起

### 拉起远程设备应用

```typescript
import { deviceManager } from '@kit.DistributedServiceKit'
import { Want } from '@kit.AbilityKit'

async function startRemoteAbility(deviceId: string) {
  const want: Want = {
    bundleName: 'com.example.myapp',
    abilityName: 'MainAbility',
    deviceId: deviceId,  // 目标设备ID
    parameters: {
      message: '来自远程设备'
    }
  }
  
  try {
    await this.context.startAbility(want)
    console.log('远程拉起成功')
  } catch (err) {
    console.error('远程拉起失败:', err)
  }
}
```

## 🎯 实战：多设备协同笔记

```typescript
@Entry
@Component
struct CollaborativeNotes {
  @State notes: Note[] = []
  private distributedObj: distributedDataObject.DataObject
  @State currentDeviceName: string = ''
  
  async aboutToAppear() {
    // 初始化分布式对象
    this.distributedObj = distributedDataObject.create(getContext(this), {
      notes: []
    })
    
    // 获取当前设备名
    this.currentDeviceName = await this.getDeviceName()
    
    // 加入协同会话
    this.distributedObj.setSessionId('notes_collaboration')
    
    // 监听数据变化
    this.distributedObj.on('change', (sessionId, fields) => {
      if (fields.includes('notes')) {
        this.notes = JSON.parse(JSON.stringify(this.distributedObj['notes']))
        this.sortNotes()
      }
    })
    
    // 加载初始数据
    this.loadNotes()
  }
  
  async getDeviceName(): Promise<string> {
    // 获取设备信息
    return 'Device-1'
  }
  
  loadNotes() {
    const savedNotes = this.distributedObj['notes'] || []
    this.notes = JSON.parse(JSON.stringify(savedNotes))
  }
  
  addNote(content: string) {
    const newNote: Note = {
      id: Date.now().toString(),
      content: content,
      deviceName: this.currentDeviceName,
      timestamp: Date.now()
    }
    
    this.notes.push(newNote)
    this.distributedObj['notes'] = this.notes
  }
  
  deleteNote(id: string) {
    this.notes = this.notes.filter(note => note.id !== id)
    this.distributedObj['notes'] = this.notes
  }
  
  sortNotes() {
    this.notes.sort((a, b) => b.timestamp - a.timestamp)
  }
  
  build() {
    Column() {
      // 标题
      Row({ space: 10 }) {
        Text('协同笔记')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Text(`(${this.currentDeviceName})`)
          .fontSize(14)
          .fontColor(Color.Gray)
      }
      .width('100%')
      .margin({ bottom: 20 })
      
      // 添加笔记
      Row({ space: 10 }) {
        TextInput({ placeholder: '输入新笔记' })
          .layoutWeight(1)
          .onSubmit((value) => {
            if (value.trim()) {
              this.addNote(value)
            }
          })
        
        Button('添加')
          .onClick(() => {
            // 通过输入框添加
          })
      }
      .margin({ bottom: 20 })
      
      // 笔记列表
      List({ space: 10 }) {
        ForEach(this.notes, (note: Note) => {
          ListItem() {
            Row() {
              Column({ space: 5 }) {
                Text(note.content)
                  .fontSize(16)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                
                Row({ space: 10 }) {
                  Text(note.deviceName)
                    .fontSize(12)
                    .fontColor(Color.Gray)
                  
                  Text(this.formatTime(note.timestamp))
                    .fontSize(12)
                    .fontColor(Color.Gray)
                }
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              
              Button('删除')
                .fontSize(14)
                .onClick(() => {
                  this.deleteNote(note.id)
                })
            }
            .width('100%')
            .padding(15)
            .backgroundColor(Color.White)
            .borderRadius(8)
          }
        })
      }
      .layoutWeight(1)
      
      Text(`共 ${this.notes.length} 条笔记`)
        .fontSize(14)
        .fontColor(Color.Gray)
        .margin({ top: 10 })
    }
    .padding(20)
    .width('100%')
    .height('100%')
    .backgroundColor(0xF5F5F5)
  }
  
  formatTime(timestamp: number): string {
    const date = new Date(timestamp)
    return `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`
  }
}

interface Note {
  id: string
  content: string
  deviceName: string
  timestamp: number
}
```

## 💡 最佳实践

### 1. 会话管理

```typescript
// ✅ 使用有意义的会话ID
distributedObj.setSessionId('room_123_whiteboard')

// ✅ 及时退出会话
distributedObj.setSessionId('')  // 退出会话
```

### 2. 数据同步优化

```typescript
// ✅ 批量更新
const updates = {
  field1: value1,
  field2: value2,
  field3: value3
}
Object.assign(distributedObj, updates)

// ❌ 避免频繁单个更新
distributedObj.field1 = value1
distributedObj.field2 = value2
distributedObj.field3 = value3
```

### 3. 冲突处理

```typescript
// 使用时间戳解决冲突
interface DataWithTimestamp {
  value: any
  timestamp: number
  deviceId: string
}

distributedObj.on('change', (sessionId, fields) => {
  fields.forEach(field => {
    const remote = distributedObj[field]
    const local = localData[field]
    
    // 时间戳较新的优先
    if (remote.timestamp > local.timestamp) {
      localData[field] = remote
    }
  })
})
```

## 📚 参考资源

- [分布式数据对象](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/data-object-guidelines-0000001774280566-V5)
- [分布式通知](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/notification-guidelines-0000001815767648-V5)

---

**下一节** → [多端协同开发](04-多端协同开发.md)
