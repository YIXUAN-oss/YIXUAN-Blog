---
title: 关系型数据库
date: 2025-01-22
---

# 关系型数据库

> 使用 RDB 管理结构化数据

## 📚 RDB 概述

关系型数据库（RDB）适用于存储大量结构化数据。

### 适用场景

```
✅ 适合
├─ 大量数据存储
├─ 复杂查询
├─ 数据关联
└─ 事务处理

❌ 不适合
└─ 简单键值对（用 Preferences）
```

## 🔧 基本操作

### 创建数据库

```typescript
import relationalStore from '@ohos.data.relationalStore'

// 数据库配置
const STORE_CONFIG = {
  name: 'MyDatabase.db',
  securityLevel: relationalStore.SecurityLevel.S1
}

// 创建表的 SQL
const SQL_CREATE_TABLE = `
  CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    age INTEGER,
    email TEXT UNIQUE,
    created_at INTEGER
  )
`

// 获取数据库实例
const store = await relationalStore.getRdbStore(context, STORE_CONFIG)

// 创建表
await store.executeSql(SQL_CREATE_TABLE)
```

### 插入数据

```typescript
// 插入单条
const valueBucket = {
  name: 'Alice',
  age: 25,
  email: 'alice@example.com',
  created_at: Date.now()
}

const rowId = await store.insert('users', valueBucket)
console.log('插入成功，ID:', rowId)

// 批量插入
const users = [
  { name: 'Bob', age: 30, email: 'bob@example.com', created_at: Date.now() },
  { name: 'Charlie', age: 28, email: 'charlie@example.com', created_at: Date.now() }
]

for (const user of users) {
  await store.insert('users', user)
}
```

### 查询数据

```typescript
// 查询所有
const predicates = new relationalStore.RdbPredicates('users')
const resultSet = await store.query(predicates)

const users = []
while (resultSet.goToNextRow()) {
  users.push({
    id: resultSet.getLong(resultSet.getColumnIndex('id')),
    name: resultSet.getString(resultSet.getColumnIndex('name')),
    age: resultSet.getLong(resultSet.getColumnIndex('age')),
    email: resultSet.getString(resultSet.getColumnIndex('email'))
  })
}
resultSet.close()

console.log('查询结果:', users)

// 条件查询
const predicates2 = new relationalStore.RdbPredicates('users')
predicates2.equalTo('name', 'Alice')
const resultSet2 = await store.query(predicates2)
```

### 更新数据

```typescript
const valueBucket = {
  age: 26
}

const predicates = new relationalStore.RdbPredicates('users')
predicates.equalTo('name', 'Alice')

const rows = await store.update(valueBucket, predicates)
console.log('更新行数:', rows)
```

### 删除数据

```typescript
const predicates = new relationalStore.RdbPredicates('users')
predicates.equalTo('name', 'Bob')

const rows = await store.delete(predicates)
console.log('删除行数:', rows)
```

## 🎯 实战案例

### 笔记应用数据库

```typescript
import relationalStore from '@ohos.data.relationalStore'

class NotesDatabase {
  private store: relationalStore.RdbStore
  
  async init(context) {
    const config = {
      name: 'notes.db',
      securityLevel: relationalStore.SecurityLevel.S1
    }
    
    this.store = await relationalStore.getRdbStore(context, config)
    await this.createTables()
  }
  
  async createTables() {
    // 创建笔记表
    const sqlCreateNotes = `
      CREATE TABLE IF NOT EXISTS notes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        content TEXT,
        category_id INTEGER,
        created_at INTEGER,
        updated_at INTEGER,
        FOREIGN KEY (category_id) REFERENCES categories(id)
      )
    `
    
    // 创建分类表
    const sqlCreateCategories = `
      CREATE TABLE IF NOT EXISTS categories (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        color TEXT
      )
    `
    
    await this.store.executeSql(sqlCreateNotes)
    await this.store.executeSql(sqlCreateCategories)
  }
  
  // 添加笔记
  async addNote(note: { title: string, content: string, categoryId?: number }) {
    const valueBucket = {
      title: note.title,
      content: note.content,
      category_id: note.categoryId || null,
      created_at: Date.now(),
      updated_at: Date.now()
    }
    
    return await this.store.insert('notes', valueBucket)
  }
  
  // 获取所有笔记
  async getAllNotes() {
    const predicates = new relationalStore.RdbPredicates('notes')
    predicates.orderByDesc('updated_at')
    
    const resultSet = await this.store.query(predicates)
    const notes = []
    
    while (resultSet.goToNextRow()) {
      notes.push({
        id: resultSet.getLong(resultSet.getColumnIndex('id')),
        title: resultSet.getString(resultSet.getColumnIndex('title')),
        content: resultSet.getString(resultSet.getColumnIndex('content')),
        categoryId: resultSet.getLong(resultSet.getColumnIndex('category_id')),
        createdAt: resultSet.getLong(resultSet.getColumnIndex('created_at')),
        updatedAt: resultSet.getLong(resultSet.getColumnIndex('updated_at'))
      })
    }
    
    resultSet.close()
    return notes
  }
  
  // 按分类获取笔记
  async getNotesByCategory(categoryId: number) {
    const predicates = new relationalStore.RdbPredicates('notes')
    predicates.equalTo('category_id', categoryId)
    predicates.orderByDesc('updated_at')
    
    const resultSet = await this.store.query(predicates)
    // ... 处理结果
    resultSet.close()
  }
  
  // 搜索笔记
  async searchNotes(keyword: string) {
    const predicates = new relationalStore.RdbPredicates('notes')
    predicates.like('title', `%${keyword}%`)
      .or()
      .like('content', `%${keyword}%`)
    
    const resultSet = await this.store.query(predicates)
    // ... 处理结果
    resultSet.close()
  }
  
  // 更新笔记
  async updateNote(id: number, updates: { title?: string, content?: string }) {
    const valueBucket = {
      ...updates,
      updated_at: Date.now()
    }
    
    const predicates = new relationalStore.RdbPredicates('notes')
    predicates.equalTo('id', id)
    
    return await this.store.update(valueBucket, predicates)
  }
  
  // 删除笔记
  async deleteNote(id: number) {
    const predicates = new relationalStore.RdbPredicates('notes')
    predicates.equalTo('id', id)
    
    return await this.store.delete(predicates)
  }
  
  // 添加分类
  async addCategory(name: string, color: string) {
    const valueBucket = {
      name: name,
      color: color
    }
    
    return await this.store.insert('categories', valueBucket)
  }
  
  // 获取所有分类
  async getAllCategories() {
    const predicates = new relationalStore.RdbPredicates('categories')
    const resultSet = await this.store.query(predicates)
    
    const categories = []
    while (resultSet.goToNextRow()) {
      categories.push({
        id: resultSet.getLong(resultSet.getColumnIndex('id')),
        name: resultSet.getString(resultSet.getColumnIndex('name')),
        color: resultSet.getString(resultSet.getColumnIndex('color'))
      })
    }
    
    resultSet.close()
    return categories
  }
}

// 使用
@Entry
@Component
struct NotesApp {
  private notesDb: NotesDatabase = new NotesDatabase()
  @State notes: Note[] = []
  
  async aboutToAppear() {
    await this.notesDb.init(getContext(this))
    await this.loadNotes()
  }
  
  async loadNotes() {
    this.notes = await this.notesDb.getAllNotes()
  }
  
  async addNote() {
    const id = await this.notesDb.addNote({
      title: '新笔记',
      content: '笔记内容'
    })
    
    await this.loadNotes()
  }
  
  build() {
    Column() {
      List() {
        ForEach(this.notes, (note: Note) => {
          ListItem() {
            Text(note.title)
          }
        })
      }
      
      Button('添加笔记')
        .onClick(() => {
          this.addNote()
        })
    }
  }
}
```

## 💡 最佳实践

### 1. 使用事务

```typescript
await store.beginTransaction()
try {
  await store.insert('users', user1)
  await store.insert('users', user2)
  await store.commit()
} catch (err) {
  await store.rollback()
  console.error('事务失败:', err)
}
```

### 2. 及时关闭 ResultSet

```typescript
// ✅ 使用完立即关闭
const resultSet = await store.query(predicates)
// 处理数据
resultSet.close()

// ❌ 忘记关闭会导致内存泄漏
```

### 3. 使用索引

```typescript
// 创建索引提高查询性能
const sqlCreateIndex = `
  CREATE INDEX IF NOT EXISTS idx_email ON users(email)
`
await store.executeSql(sqlCreateIndex)
```

## 📚 参考资源

- [RDB 官方文档](https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/js-apis-data-relationalstore-0000001820880609-V5)

---

**下一节** → [分布式数据服务](03-分布式数据服务.md)
