---
title: 分布式数据服务
date: 2025-01-22
---

# 分布式数据服务

> 跨设备数据同步

## 🌐 分布式数据概述

分布式数据服务支持在多设备间自动同步数据。

### 核心特性

```
分布式数据服务
├─ 自动同步（无需手动处理）
├─ 数据一致性（最终一致）
├─ 冲突解决（自动/手动）
└─ 离线支持（断网后恢复同步）
```

## 🔧 分布式数据库

### 创建分布式数据库

```typescript
import distributedKVStore from '@ohos.data.distributedKVStore'

// KV存储配置
const kvManagerConfig = {
  context: context,
  bundleName: 'com.example.myapp'
}

// 创建 KVManager
const kvManager = distributedKVStore.createKVManager(kvManagerConfig)

// 数据库配置
const options = {
  createIfMissing: true,
  encrypt: false,
  backup: false,
  autoSync: true,  // 自动同步
  kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
  securityLevel: distributedKVStore.SecurityLevel.S1
}

// 创建分布式数据库
const kvStore = await kvManager.getKVStore('myStore', options)
```

### 写入数据

```typescript
// 写入单个键值对
await kvStore.put('username', 'Alice')
await kvStore.put('age', 25)

// 写入对象（需要序列化）
const user = {
  name: 'Alice',
  age: 25,
  email: 'alice@example.com'
}
await kvStore.put('user', JSON.stringify(user))
```

### 读取数据

```typescript
// 读取单个值
const username = await kvStore.get('username')
console.log('用户名:', username)

// 读取并解析对象
const userStr = await kvStore.get('user')
const user = JSON.parse(userStr)
console.log('用户:', user)
```

### 删除数据

```typescript
// 删除单个键
await kvStore.delete('username')

// 删除多个键
await kvStore.deleteBatch(['key1', 'key2', 'key3'])
```

## 🔄 数据同步

### 自动同步

```typescript
// 创建时启用自动同步
const options = {
  autoSync: true,  // 自动同步到其他设备
  // ... 其他配置
}

const kvStore = await kvManager.getKVStore('syncStore', options)

// 写入数据会自动同步
await kvStore.put('sharedData', 'This data will sync')
```

### 手动同步

```typescript
import deviceManager from '@ohos.distributedDeviceManager'

// 获取可用设备列表
const dmInstance = deviceManager.createDeviceManager('com.example.myapp')
const devices = dmInstance.getAvailableDeviceListSync()

// 同步到指定设备
const deviceIds = devices.map(d => d.deviceId)
await kvStore.sync(deviceIds, distributedKVStore.SyncMode.PUSH_PULL)
```

### 监听同步完成

```typescript
// 监听同步完成事件
kvStore.on('syncComplete', (data) => {
  console.log('同步完成')
  
  data.forEach((result) => {
    console.log('设备:', result.deviceId)
    console.log('状态:', result.status)
  })
})
```

## 🎯 实战案例

### 跨设备待办事项

```typescript
import distributedKVStore from '@ohos.data.distributedKVStore'

class DistributedTodoStore {
  private kvStore: distributedKVStore.SingleKVStore
  private kvManager: distributedKVStore.KVManager
  
  async init(context) {
    // 创建 KVManager
    const config = {
      context: context,
      bundleName: 'com.example.todoapp'
    }
    this.kvManager = distributedKVStore.createKVManager(config)
    
    // 创建分布式数据库
    const options = {
      createIfMissing: true,
      encrypt: false,
      backup: true,
      autoSync: true,
      kvStoreType: distributedKVStore.KVStoreType.SINGLE_VERSION,
      securityLevel: distributedKVStore.SecurityLevel.S1
    }
    
    this.kvStore = await this.kvManager.getKVStore('todoStore', options)
    
    // 监听数据变化
    this.kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, (data) => {
      console.log('数据变化:', data)
      this.handleDataChange(data)
    })
  }
  
  // 添加待办
  async addTodo(todo: Todo) {
    const key = `todo_${todo.id}`
    await this.kvStore.put(key, JSON.stringify(todo))
  }
  
  // 获取所有待办
  async getAllTodos(): Promise<Todo[]> {
    const entries = await this.kvStore.getEntries('todo_')
    
    const todos: Todo[] = []
    entries.forEach((entry) => {
      try {
        const todo = JSON.parse(entry.value.value)
        todos.push(todo)
      } catch (err) {
        console.error('解析失败:', err)
      }
    })
    
    return todos.sort((a, b) => a.createdAt - b.createdAt)
  }
  
  // 更新待办
  async updateTodo(id: string, updates: Partial<Todo>) {
    const key = `todo_${id}`
    const todoStr = await this.kvStore.get(key)
    
    if (todoStr) {
      const todo = JSON.parse(todoStr)
      const updated = { ...todo, ...updates }
      await this.kvStore.put(key, JSON.stringify(updated))
    }
  }
  
  // 删除待办
  async deleteTodo(id: string) {
    const key = `todo_${id}`
    await this.kvStore.delete(key)
  }
  
  // 处理数据变化
  private handleDataChange(data) {
    // 通知UI更新
    console.log('其他设备同步了数据')
  }
  
  // 同步到指定设备
  async syncToDevice(deviceId: string) {
    await this.kvStore.sync([deviceId], distributedKVStore.SyncMode.PUSH_PULL)
  }
}

interface Todo {
  id: string
  title: string
  done: boolean
  createdAt: number
}

// 使用
@Entry
@Component
struct TodoApp {
  private todoStore: DistributedTodoStore = new DistributedTodoStore()
  @State todos: Todo[] = []
  
  async aboutToAppear() {
    await this.todoStore.init(getContext(this))
    await this.loadTodos()
  }
  
  async loadTodos() {
    this.todos = await this.todoStore.getAllTodos()
  }
  
  async addTodo(title: string) {
    const todo: Todo = {
      id: Date.now().toString(),
      title: title,
      done: false,
      createdAt: Date.now()
    }
    
    await this.todoStore.addTodo(todo)
    await this.loadTodos()
  }
  
  async toggleTodo(id: string) {
    const todo = this.todos.find(t => t.id === id)
    if (todo) {
      await this.todoStore.updateTodo(id, { done: !todo.done })
      await this.loadTodos()
    }
  }
  
  build() {
    Column() {
      Text('跨设备待办事项')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
      
      List() {
        ForEach(this.todos, (todo: Todo) => {
          ListItem() {
            Row({ space: 10 }) {
              Checkbox()
                .select(todo.done)
                .onChange((checked) => {
                  this.toggleTodo(todo.id)
                })
              
              Text(todo.title)
                .decoration({
                  type: todo.done ? TextDecorationType.LineThrough : TextDecorationType.None
                })
            }
            .padding(10)
          }
        })
      }
      
      Text('数据会自动同步到其他设备')
        .fontSize(12)
        .fontColor(Color.Gray)
        .margin({ top: 10 })
    }
    .padding(20)
  }
}
```

## ⚖️ 冲突解决

### 自动解决

```typescript
// 默认策略：最后写入获胜（Last Write Wins）
// 时间戳越新的数据会覆盖旧数据
```

### 手动解决

```typescript
kvStore.on('dataChange', distributedKVStore.SubscribeType.SUBSCRIBE_TYPE_ALL, async (data) => {
  for (const entry of data.updateEntries) {
    const key = entry.key
    const localValue = await kvStore.get(key)
    const remoteValue = entry.value.value
    
    // 自定义冲突解决逻辑
    const resolved = resolveConflict(localValue, remoteValue)
    await kvStore.put(key, resolved)
  }
})

function resolveConflict(local, remote) {
  // 自定义解决策略
  // 例如：合并数据、选择较大值等
  return local  // 或 remote
}
```

## 💡 最佳实践

### 1. 合理使用分布式数据库

```typescript
// ✅ 适合分布式存储
- 用户偏好设置
- 待办事项
- 笔记数据
- 购物清单

// ❌ 不适合分布式存储
- 大文件
- 敏感数据
- 临时数据
```

### 2. 数据版本管理

```typescript
interface DataWithVersion {
  data: any
  version: number
  updatedAt: number
}

async function putWithVersion(key: string, data: any) {
  const item: DataWithVersion = {
    data: data,
    version: 1,
    updatedAt: Date.now()
  }
  
  await kvStore.put(key, JSON.stringify(item))
}
```

### 3. 错误处理

```typescript
try {
  await kvStore.put('key', 'value')
} catch (err) {
  console.error('写入失败:', err)
  // 降级到本地存储
}
```

## 📚 参考资源

- [分布式数据服务官方文档](https://developer.harmonyos.com/cn/docs/documentation/doc-references-V3/js-apis-distributedkvstore-0000001428061992-V3)

---

**第7章完成！** 继续学习 → [第8章：网络与连接](../08-network-connect/)
