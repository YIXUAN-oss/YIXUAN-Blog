import{_ as l,c as i,d as t,e as n,f as a,b as p,w as c,r as o,o as r}from"./app-CJnNnfV_.js";const u={};function d(v,s){const e=o("RouteLink");return r(),i("div",null,[s[3]||(s[3]=t(`<h1 id="_05-elasticsearch集群与优化" tabindex="-1"><a class="header-anchor" href="#_05-elasticsearch集群与优化"><span>05 - Elasticsearch集群与优化</span></a></h1><h2 id="🎯-学习目标" tabindex="-1"><a class="header-anchor" href="#🎯-学习目标"><span>🎯 学习目标</span></a></h2><ul><li>理解Elasticsearch集群架构</li><li>掌握集群搭建方法</li><li>学会分片和副本配置</li><li>掌握性能优化策略</li><li>了解监控和调优</li></ul><h2 id="🏗️-集群架构" tabindex="-1"><a class="header-anchor" href="#🏗️-集群架构"><span>🏗️ 集群架构</span></a></h2><h3 id="节点类型" tabindex="-1"><a class="header-anchor" href="#节点类型"><span>节点类型</span></a></h3><table><thead><tr><th>节点类型</th><th>说明</th><th>配置</th></tr></thead><tbody><tr><td>Master Node</td><td>集群管理、索引创建删除</td><td>node.master: true<br>node.data: false</td></tr><tr><td>Data Node</td><td>存储数据、执行查询</td><td>node.master: false<br>node.data: true</td></tr><tr><td>Coordinating Node</td><td>路由请求、合并结果</td><td>node.master: false<br>node.data: false</td></tr><tr><td>Ingest Node</td><td>数据预处理</td><td>node.ingest: true</td></tr></tbody></table><h3 id="集群结构" tabindex="-1"><a class="header-anchor" href="#集群结构"><span>集群结构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Master Node (x3)</span>
<span class="line">    ↓</span>
<span class="line">Data Node (x5)</span>
<span class="line">    ↓</span>
<span class="line">Coordinating Node (x2)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🔧-集群搭建" tabindex="-1"><a class="header-anchor" href="#🔧-集群搭建"><span>🔧 集群搭建</span></a></h2><h3 id="docker-compose搭建" tabindex="-1"><a class="header-anchor" href="#docker-compose搭建"><span>Docker Compose搭建</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#39;3.8&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">es-master-1</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.17.0</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>cluster</span>
<span class="line">      <span class="token punctuation">-</span> node.name=master<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">-</span> node.master=true</span>
<span class="line">      <span class="token punctuation">-</span> node.data=false</span>
<span class="line">      <span class="token punctuation">-</span> discovery.seed_hosts=es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">2</span><span class="token punctuation">,</span>es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line">      <span class="token punctuation">-</span> cluster.initial_master_nodes=master<span class="token punctuation">-</span><span class="token number">1</span><span class="token punctuation">,</span>master<span class="token punctuation">-</span><span class="token number">2</span><span class="token punctuation">,</span>master<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;9200:9200&quot;</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elastic</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">es-master-2</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.17.0</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">2</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>cluster</span>
<span class="line">      <span class="token punctuation">-</span> node.name=master<span class="token punctuation">-</span><span class="token number">2</span></span>
<span class="line">      <span class="token punctuation">-</span> node.master=true</span>
<span class="line">      <span class="token punctuation">-</span> node.data=false</span>
<span class="line">      <span class="token punctuation">-</span> discovery.seed_hosts=es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">1</span><span class="token punctuation">,</span>es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line">      <span class="token punctuation">-</span> cluster.initial_master_nodes=master<span class="token punctuation">-</span><span class="token number">1</span><span class="token punctuation">,</span>master<span class="token punctuation">-</span><span class="token number">2</span><span class="token punctuation">,</span>master<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elastic</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">es-data-1</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>7.17.0</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>data<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> cluster.name=es<span class="token punctuation">-</span>cluster</span>
<span class="line">      <span class="token punctuation">-</span> node.name=data<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">      <span class="token punctuation">-</span> node.master=false</span>
<span class="line">      <span class="token punctuation">-</span> node.data=true</span>
<span class="line">      <span class="token punctuation">-</span> discovery.seed_hosts=es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">1</span><span class="token punctuation">,</span>es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">2</span><span class="token punctuation">,</span>es<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">&quot;ES_JAVA_OPTS=-Xms1g -Xmx1g&quot;</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> elastic</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">elastic</span><span class="token punctuation">:</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置文件-elasticsearch-yml" tabindex="-1"><a class="header-anchor" href="#配置文件-elasticsearch-yml"><span>配置文件（elasticsearch.yml）</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token comment"># 集群名称</span></span>
<span class="line"><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>cluster</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 节点名称</span></span>
<span class="line"><span class="token key atrule">node.name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 节点角色</span></span>
<span class="line"><span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">node.ingest</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 网络配置</span></span>
<span class="line"><span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0</span>
<span class="line"><span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span></span>
<span class="line"><span class="token key atrule">transport.port</span><span class="token punctuation">:</span> <span class="token number">9300</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 集群发现</span></span>
<span class="line"><span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> 192.168.1.101<span class="token punctuation">:</span><span class="token number">9300</span></span>
<span class="line">  <span class="token punctuation">-</span> 192.168.1.102<span class="token punctuation">:</span><span class="token number">9300</span></span>
<span class="line">  <span class="token punctuation">-</span> 192.168.1.103<span class="token punctuation">:</span><span class="token number">9300</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 初始主节点</span></span>
<span class="line"><span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> node<span class="token punctuation">-</span><span class="token number">1</span></span>
<span class="line">  <span class="token punctuation">-</span> node<span class="token punctuation">-</span><span class="token number">2</span></span>
<span class="line">  <span class="token punctuation">-</span> node<span class="token punctuation">-</span><span class="token number">3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># JVM配置</span></span>
<span class="line"><span class="token punctuation">-</span>Xms2g</span>
<span class="line"><span class="token punctuation">-</span>Xmx2g</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="📊-分片与副本" tabindex="-1"><a class="header-anchor" href="#📊-分片与副本"><span>📊 分片与副本</span></a></h2><h3 id="分片策略" tabindex="-1"><a class="header-anchor" href="#分片策略"><span>分片策略</span></a></h3><p><strong>分片数计算公式：</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">分片数 = 数据总量 / 单分片大小（建议20-50GB）</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>示例：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 创建索引，设置3个主分片，2个副本</span></span>
<span class="line">PUT /products</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;settings&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;number_of_shards&quot;</span><span class="token builtin class-name">:</span> <span class="token number">3</span>,</span>
<span class="line">    <span class="token string">&quot;number_of_replicas&quot;</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,</span>
<span class="line">    <span class="token string">&quot;refresh_interval&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;30s&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 动态调整副本数</span></span>
<span class="line">PUT /products/_settings</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;number_of_replicas&quot;</span><span class="token builtin class-name">:</span> <span class="token number">1</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="分片分配" tabindex="-1"><a class="header-anchor" href="#分片分配"><span>分片分配</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看分片分配</span></span>
<span class="line">GET /_cat/shards/products?v</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 手动分配分片</span></span>
<span class="line">POST /_cluster/reroute</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;commands&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string">&quot;move&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;index&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;products&quot;</span>,</span>
<span class="line">        <span class="token string">&quot;shard&quot;</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,</span>
<span class="line">        <span class="token string">&quot;from_node&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;node-1&quot;</span>,</span>
<span class="line">        <span class="token string">&quot;to_node&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;node-2&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🚀-性能优化" tabindex="-1"><a class="header-anchor" href="#🚀-性能优化"><span>🚀 性能优化</span></a></h2><h3 id="_1-索引优化" tabindex="-1"><a class="header-anchor" href="#_1-索引优化"><span>1. 索引优化</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 批量写入时关闭refresh</span></span>
<span class="line">PUT /products/_settings</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;refresh_interval&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;-1&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 写入完成后恢复</span></span>
<span class="line">PUT /products/_settings</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;refresh_interval&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1s&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 合并段</span></span>
<span class="line">POST /products/_forcemerge?max_num_segments<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-查询优化" tabindex="-1"><a class="header-anchor" href="#_2-查询优化"><span>2. 查询优化</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token comment">// 使用filter代替must（不计算评分）</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;bool&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string">&quot;filter&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;term&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;category&quot;</span><span class="token operator">:</span> <span class="token string">&quot;手机&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&quot;range&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;price&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">&quot;gte&quot;</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 控制返回字段</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;_source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 避免深分页，使用search_after</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;size&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;query&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;search_after&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;12345&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;sort&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;sales&quot;</span><span class="token operator">:</span> <span class="token string">&quot;desc&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;asc&quot;</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-硬件优化" tabindex="-1"><a class="header-anchor" href="#_3-硬件优化"><span>3. 硬件优化</span></a></h3><p><strong>推荐配置：</strong></p><ul><li>CPU：16核+</li><li>内存：64GB+（JVM堆内存不超过32GB）</li><li>磁盘：SSD</li><li>网络：万兆网卡</li></ul><p><strong>JVM配置：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># jvm.options</span></span>
<span class="line"><span class="token parameter variable">-Xms16g</span></span>
<span class="line"><span class="token parameter variable">-Xmx16g</span></span>
<span class="line"><span class="token parameter variable">-XX:+UseG1GC</span></span>
<span class="line"><span class="token parameter variable">-XX:MaxGCPauseMillis</span><span class="token operator">=</span><span class="token number">200</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-系统优化" tabindex="-1"><a class="header-anchor" href="#_4-系统优化"><span>4. 系统优化</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 增加文件描述符</span></span>
<span class="line"><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span> <span class="token number">65536</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 增加虚拟内存</span></span>
<span class="line"><span class="token function">sysctl</span> <span class="token parameter variable">-w</span> <span class="token assign-left variable">vm.max_map_count</span><span class="token operator">=</span><span class="token number">262144</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 禁用交换分区</span></span>
<span class="line">swapoff <span class="token parameter variable">-a</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="📈-监控方案" tabindex="-1"><a class="header-anchor" href="#📈-监控方案"><span>📈 监控方案</span></a></h2><h3 id="_1-cat-api监控" tabindex="-1"><a class="header-anchor" href="#_1-cat-api监控"><span>1. _cat API监控</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 集群健康</span></span>
<span class="line">GET /_cat/health?v</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 节点信息</span></span>
<span class="line">GET /_cat/nodes?v</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 索引信息</span></span>
<span class="line">GET /_cat/indices?v</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 分片信息</span></span>
<span class="line">GET /_cat/shards?v</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 线程池</span></span>
<span class="line">GET /_cat/thread_pool?v</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-cluster-api" tabindex="-1"><a class="header-anchor" href="#_2-cluster-api"><span>2. _cluster API</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 集群状态</span></span>
<span class="line">GET /_cluster/health</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 集群统计</span></span>
<span class="line">GET /_cluster/stats</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 节点统计</span></span>
<span class="line">GET /_nodes/stats</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-kibana监控" tabindex="-1"><a class="header-anchor" href="#_3-kibana监控"><span>3. Kibana监控</span></a></h3><p>访问：<code>http://localhost:5601</code></p><p><strong>监控指标：</strong></p><ul><li>集群健康状态</li><li>索引性能</li><li>查询性能</li><li>JVM堆内存使用</li><li>磁盘使用率</li></ul><h3 id="_4-prometheus-grafana" tabindex="-1"><a class="header-anchor" href="#_4-prometheus-grafana"><span>4. Prometheus + Grafana</span></a></h3><p><strong>elasticsearch_exporter：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--name</span> elasticsearch-exporter <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-p</span> <span class="token number">9114</span>:9114 <span class="token punctuation">\\</span></span>
<span class="line">  prometheuscommunity/elasticsearch-exporter:latest <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--es.uri</span><span class="token operator">=</span>http://elasticsearch:9200</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Prometheus配置：</strong></p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre><code><span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&#39;elasticsearch&#39;</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;localhost:9114&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="🔍-常见问题排查" tabindex="-1"><a class="header-anchor" href="#🔍-常见问题排查"><span>🔍 常见问题排查</span></a></h2><h3 id="_1-集群状态为yellow" tabindex="-1"><a class="header-anchor" href="#_1-集群状态为yellow"><span>1. 集群状态为Yellow</span></a></h3><p><strong>原因：</strong> 部分副本未分配</p><p><strong>解决：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看未分配的分片</span></span>
<span class="line">GET /_cat/shards?h<span class="token operator">=</span>index,shard,prirep,state,unassigned.reason</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 手动分配</span></span>
<span class="line">POST /_cluster/reroute</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-查询慢" tabindex="-1"><a class="header-anchor" href="#_2-查询慢"><span>2. 查询慢</span></a></h3><p><strong>排查步骤：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查看慢查询日志</span></span>
<span class="line">GET /_cat/indices?v<span class="token operator">&amp;</span><span class="token assign-left variable">h</span><span class="token operator">=</span>index,search.query_time_in_millis</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 分析查询</span></span>
<span class="line">GET /products/_search</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string">&quot;profile&quot;</span><span class="token builtin class-name">:</span> true,</span>
<span class="line">  <span class="token string">&quot;query&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">..</span>.<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>优化方案：</strong></p><ul><li>使用filter代替query</li><li>减少返回字段</li><li>合理设置分片数</li><li>使用路由</li></ul><h3 id="_3-内存溢出" tabindex="-1"><a class="header-anchor" href="#_3-内存溢出"><span>3. 内存溢出</span></a></h3><p><strong>解决方案：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 调整JVM堆内存</span></span>
<span class="line"><span class="token parameter variable">-Xms8g</span></span>
<span class="line"><span class="token parameter variable">-Xmx8g</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理缓存</span></span>
<span class="line">POST /_cache/clear</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置断路器</span></span>
<span class="line">indices.breaker.total.limit: <span class="token number">70</span>%</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="⚙️-调优建议" tabindex="-1"><a class="header-anchor" href="#⚙️-调优建议"><span>⚙️ 调优建议</span></a></h2><h3 id="索引层面" tabindex="-1"><a class="header-anchor" href="#索引层面"><span>索引层面</span></a></h3><ol><li><strong>合理设置分片数</strong> - 避免过多或过少</li><li><strong>使用索引模板</strong> - 统一管理索引配置</li><li><strong>定期删除过期索引</strong> - 释放存储空间</li><li><strong>使用索引生命周期管理（ILM）</strong></li></ol><h3 id="查询层面" tabindex="-1"><a class="header-anchor" href="#查询层面"><span>查询层面</span></a></h3><ol><li><strong>使用bool filter</strong> - 代替must，不计算评分</li><li><strong>避免通配符开头</strong> - 如 <code>*abc</code></li><li><strong>避免script查询</strong> - 性能差</li><li><strong>合理使用聚合</strong> - 限制聚合数量</li></ol><h3 id="集群层面" tabindex="-1"><a class="header-anchor" href="#集群层面"><span>集群层面</span></a></h3><ol><li><strong>主节点高可用</strong> - 至少3个</li><li><strong>数据节点扩容</strong> - 水平扩展</li><li><strong>冷热数据分离</strong> - 热数据SSD，冷数据HDD</li><li><strong>负载均衡</strong> - 使用协调节点</li></ol><h2 id="💡-最佳实践" tabindex="-1"><a class="header-anchor" href="#💡-最佳实践"><span>💡 最佳实践</span></a></h2><ol><li><strong>集群规划</strong> - 根据数据量合理规划</li><li><strong>监控告警</strong> - 实时监控集群状态</li><li><strong>定期备份</strong> - 使用快照备份数据</li><li><strong>版本升级</strong> - 保持版本更新</li><li><strong>压力测试</strong> - 上线前充分测试</li></ol><h2 id="🎯-小结" tabindex="-1"><a class="header-anchor" href="#🎯-小结"><span>🎯 小结</span></a></h2><p>本节学习了Elasticsearch集群与优化：</p><ul><li>✅ 集群架构和搭建</li><li>✅ 分片和副本策略</li><li>✅ 性能优化方法</li><li>✅ 监控和调优</li><li>✅ 常见问题排查</li></ul><hr>`,73)),n("p",null,[s[1]||(s[1]=n("strong",null,"下一节：",-1)),s[2]||(s[2]=a()),p(e,{to:"/tutorials/java-backend/elasticsearch/06-Elasticsearch%E9%9D%A2%E8%AF%95%E9%A2%98.html"},{default:c(()=>[...s[0]||(s[0]=[a("06-Elasticsearch面试题",-1)])]),_:1})])])}const k=l(u,[["render",d]]),b=JSON.parse('{"path":"/tutorials/java-backend/elasticsearch/05-Elasticsearchjiqunyuyouhua.html","title":"Elasticsearch集群与优化","lang":"zh-CN","frontmatter":{"title":"Elasticsearch集群与优化"},"headers":[{"level":2,"title":"🎯 学习目标","slug":"🎯-学习目标","link":"#🎯-学习目标","children":[]},{"level":2,"title":"🏗️ 集群架构","slug":"🏗️-集群架构","link":"#🏗️-集群架构","children":[{"level":3,"title":"节点类型","slug":"节点类型","link":"#节点类型","children":[]},{"level":3,"title":"集群结构","slug":"集群结构","link":"#集群结构","children":[]}]},{"level":2,"title":"🔧 集群搭建","slug":"🔧-集群搭建","link":"#🔧-集群搭建","children":[{"level":3,"title":"Docker Compose搭建","slug":"docker-compose搭建","link":"#docker-compose搭建","children":[]},{"level":3,"title":"配置文件（elasticsearch.yml）","slug":"配置文件-elasticsearch-yml","link":"#配置文件-elasticsearch-yml","children":[]}]},{"level":2,"title":"📊 分片与副本","slug":"📊-分片与副本","link":"#📊-分片与副本","children":[{"level":3,"title":"分片策略","slug":"分片策略","link":"#分片策略","children":[]},{"level":3,"title":"分片分配","slug":"分片分配","link":"#分片分配","children":[]}]},{"level":2,"title":"🚀 性能优化","slug":"🚀-性能优化","link":"#🚀-性能优化","children":[{"level":3,"title":"1. 索引优化","slug":"_1-索引优化","link":"#_1-索引优化","children":[]},{"level":3,"title":"2. 查询优化","slug":"_2-查询优化","link":"#_2-查询优化","children":[]},{"level":3,"title":"3. 硬件优化","slug":"_3-硬件优化","link":"#_3-硬件优化","children":[]},{"level":3,"title":"4. 系统优化","slug":"_4-系统优化","link":"#_4-系统优化","children":[]}]},{"level":2,"title":"📈 监控方案","slug":"📈-监控方案","link":"#📈-监控方案","children":[{"level":3,"title":"1. _cat API监控","slug":"_1-cat-api监控","link":"#_1-cat-api监控","children":[]},{"level":3,"title":"2. _cluster API","slug":"_2-cluster-api","link":"#_2-cluster-api","children":[]},{"level":3,"title":"3. Kibana监控","slug":"_3-kibana监控","link":"#_3-kibana监控","children":[]},{"level":3,"title":"4. Prometheus + Grafana","slug":"_4-prometheus-grafana","link":"#_4-prometheus-grafana","children":[]}]},{"level":2,"title":"🔍 常见问题排查","slug":"🔍-常见问题排查","link":"#🔍-常见问题排查","children":[{"level":3,"title":"1. 集群状态为Yellow","slug":"_1-集群状态为yellow","link":"#_1-集群状态为yellow","children":[]},{"level":3,"title":"2. 查询慢","slug":"_2-查询慢","link":"#_2-查询慢","children":[]},{"level":3,"title":"3. 内存溢出","slug":"_3-内存溢出","link":"#_3-内存溢出","children":[]}]},{"level":2,"title":"⚙️ 调优建议","slug":"⚙️-调优建议","link":"#⚙️-调优建议","children":[{"level":3,"title":"索引层面","slug":"索引层面","link":"#索引层面","children":[]},{"level":3,"title":"查询层面","slug":"查询层面","link":"#查询层面","children":[]},{"level":3,"title":"集群层面","slug":"集群层面","link":"#集群层面","children":[]}]},{"level":2,"title":"💡 最佳实践","slug":"💡-最佳实践","link":"#💡-最佳实践","children":[]},{"level":2,"title":"🎯 小结","slug":"🎯-小结","link":"#🎯-小结","children":[]}],"git":{"createdTime":1760959407000,"updatedTime":1760959407000,"contributors":[{"name":"YIXUAN","email":"byyi.xuan@outlook.com","commits":1}]},"filePathRelative":"tutorials/java-backend/elasticsearch/05-Elasticsearch集群与优化.md"}');export{k as comp,b as data};
